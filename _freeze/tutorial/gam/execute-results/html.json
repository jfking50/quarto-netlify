{
  "hash": "b2a7b80b0c6f38436992865287d1e179",
  "result": {
    "markdown": "---\ntitle: \"Generalized Additive Models\"\nauthor: \"John King\"\ndate: \"5/29/2020\"\nformat:\n  html:\n    toc: true\n    code-copy: true\n    df-print: paged\nexecute: \n  warning: false\n  echo: true\nbibliography: references.bib\nlink-citations: true\n---\n\n\n\n\nRecall that if there is a non-linear relationship between predictor and response, we can attempt to transform the predictor using a known function (log, reciprocal, polynomial, etc.) to improve the model structure and fit. What if the relationship is more complex and is not well captured with a known function? Generalized additive models may be used in these cases.\n\nRecall that a linear model takes the form:\n\n$$y=\\beta_{0}+\\beta_{1}x_{1}+\\beta_{2}x_{2}+...+\\varepsilon$$\n\nAdditive models replace the linear terms (the $\\beta$s) with flexible smoothing functions and take the form:\n\n$$y=\\beta_{0}+f_{1}(x_{1})+f_{2}(x_{2})+...+\\varepsilon$$\n\nThere are many techniques and options for selecting the smoothing functions, but for this tutorial, we'll discuss two: locally weighted error sum of squares (lowess and also commonly abbreviated as loess) and smoothing splines.\n\n### Loess\n\nFor the theory behind loess smoothing, please read [this page](https://www.itl.nist.gov/div898/handbook/pmd/section1/pmd144.htm) on the NIST website. This chapter will focus on implementing loess smoothing in *R*.\n\nAll smoothers have a tuning parameter that controls how smooth the smoother is. The tuning parameter in loess is referred to as the span with larger values producing more smoothness.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nset.seed(42)\n\ndf = tibble(\n  x = runif(100, 1.5, 5.5),\n  y = sin(x*pi) + 2 + runif(100, 0, 0.5)\n)\n\nex1.ls = loess(y~x, span=0.25, data=df)\nex2.ls = loess(y~x, span=0.5, data=df)\nex3.ls = loess(y~x, span=0.75, data=df)\nxseq = seq(1.6, 5.4,length=100)\n\ndf = df %>% mutate(\n  span25 = predict(ex1.ls, newdata=tibble(x=xseq)),\n  span50 = predict(ex2.ls, newdata=tibble(x=xseq)),\n  span75 = predict(ex3.ls, newdata=tibble(x=xseq))\n  )\n\nggplot(df) +\n  geom_point(aes(x, y)) +\n  geom_line(aes(x=xseq, span25, linetype='span = 0.25'), color='red') +\n  geom_line(aes(x=xseq, span50, linetype='span = 0.50'), color='red') +\n  geom_line(aes(x=xseq, span75, linetype='span = 0.75'), color='red') +\n  scale_linetype_manual(name=\"Legend\", values=c(1,2,3)) +\n  ggtitle(\"Loess Smoother Example\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](gam_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\nFrom this plot, a span of 0.75 provided too much smoothness, whereas the lower values of span we tested appear to be a better fit. Now let's apply this to the `airqaulity` data set from the previous chapter. Initially, we'll just consider the response(`Ozone`) and one predictor (`Solar.R`).\n\n\n::: {.cell}\n\n```{.r .cell-code}\naq1.ls = loess(Ozone ~ Solar.R, span=0.25, data=airquality)\naq2.ls = loess(Ozone ~ Solar.R, span=0.5, data=airquality)\naq3.ls = loess(Ozone ~ Solar.R, span=0.75, data=airquality)\nsrseq = seq(10, 330, length=nrow(airquality))\n\naq = airquality %>% mutate(\n  span25 = predict(aq1.ls, newdata=tibble(Solar.R=srseq)),\n  span50 = predict(aq2.ls, newdata=tibble(Solar.R=srseq)),\n  span75 = predict(aq3.ls, newdata=tibble(Solar.R=srseq))\n  )\n\nggplot(aq) +\n  geom_point(aes(Solar.R, Ozone)) +\n  geom_line(aes(x=srseq, span25, linetype='span = 0.25'), color='red') +\n  geom_line(aes(x=srseq, span50, linetype='span = 0.50'), color='red') +\n  geom_line(aes(x=srseq, span75, linetype='span = 0.75'), color='red') +\n  scale_linetype_manual(name=\"Legend\", values=c(1,2,3)) +\n  ggtitle(\"Loess Smoother Example\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](gam_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nHere we can see that the higher span values appear to provide a better fit. In this case, choosing a low span value would be akin to over fitting a linear model with too high of a degree of polynomial. We can repeat this process to determine appropriate values of span for the other predictors.\n\nIncluding loess smoothers in a GAM is as simple as including the non-linear terms within `lo()`. The `gam` package provides the needed functionality. The script below applies loess smoothers to three of the predictors and displays the model summary (note that the default value for span is 0.5).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(gam)\n\naq.gam = gam(Ozone ~ lo(Solar.R, span=0.75) + lo(Wind) + lo(Temp), data=airquality, na=na.gam.replace)\nsummary(aq.gam)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall: gam(formula = Ozone ~ lo(Solar.R, span = 0.75) + lo(Wind) + lo(Temp), \n    data = airquality, na.action = na.gam.replace)\nDeviance Residuals:\n    Min      1Q  Median      3Q     Max \n-47.076  -9.601  -2.721   8.977  76.583 \n\n(Dispersion Parameter for gaussian family taken to be 319.3603)\n\n    Null Deviance: 125143.1 on 115 degrees of freedom\nResidual Deviance: 33679.85 on 105.4604 degrees of freedom\nAIC: 1010.117 \n\nNumber of Local Scoring Iterations: NA \n\nAnova for Parametric Effects\n                             Df Sum Sq Mean Sq F value    Pr(>F)    \nlo(Solar.R, span = 0.75)   1.00  14248   14248  44.615 1.160e-09 ***\nlo(Wind)                   1.00  35734   35734 111.894 < 2.2e-16 ***\nlo(Temp)                   1.00  15042   15042  47.099 4.794e-10 ***\nResiduals                105.46  33680     319                      \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nAnova for Nonparametric Effects\n                         Npar Df Npar F     Pr(F)    \n(Intercept)                                          \nlo(Solar.R, span = 0.75)     1.2 2.9766 0.0804893 .  \nlo(Wind)                     2.8 9.2752 2.617e-05 ***\nlo(Temp)                     2.5 6.8089 0.0006584 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow=c(1,3))\nplot(aq.gam, se=TRUE)\n```\n\n::: {.cell-output-display}\n![](gam_files/figure-html/unnamed-chunk-4-1.png){width=960}\n:::\n:::\n\n\n### Splines\n\nSpline smoothing can be conceptualized by imagining that your task is to bend a strip of soft metal into a curved shape. One way to do this would be to place pegs on a board (referred to as \"knots\" in non-linear regression parlance) to control the bends, and then guide the strip of metal over and under the pegs. Mathematically, this is accomplished by combining cubic regression at each knot with calculus to smoothly join the individual bends. The tuning parameter in the `smooth.splines` function is `spar`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\naq = aq %>% drop_na()\n\nss25 = smooth.spline(aq$Solar.R,aq$Ozone,spar=0.25)\nss50 = smooth.spline(aq$Solar.R,aq$Ozone,spar=0.5)\nss75 = smooth.spline(aq$Solar.R,aq$Ozone,spar=0.75)\n\nggplot() +\n  geom_point(data=aq, aes(Solar.R, Ozone)) +\n  geom_line(aes(x=ss25$x, ss25$y, linetype='spar = 0.25'), color='red') +\n  geom_line(aes(x=ss50$x, ss50$y, linetype='spar = 0.50'), color='red') +\n  geom_line(aes(x=ss75$x, ss75$y, linetype='spar = 0.75'), color='red') +\n  scale_linetype_manual(name=\"Legend\", values=c(1,2,3)) +\n  ggtitle(\"Spline Smoother Example\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](gam_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n### Cross Validation\n\nComparing the spline smoother plot to the one generated with loess smoothers, we can see that the two methods essentially accomplish the same thing. It's just a matter of finding the right amount of smoothness, which can be done through cross validation. The `fANCOVA` package contains a function `loess.aq()` that includes a criterion parameter that we can set to `gcv` for generalized cross validation, which is an approximation for leave-one-out cross-validation @hastie2008. Applying this function to the `airquality` data with `Solar.R` as the predictor and `Ozone` as the response, we can obtain a cross validated value for span.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(fANCOVA)\n\naq.solar.cv = loess.as(aq$Solar.R, aq$Ozone, criterion=\"gcv\")\nsummary(aq.solar.cv)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\nloess(formula = y ~ x, data = data.bind, span = span1, degree = degree, \n    family = family)\n\nNumber of Observations: 111 \nEquivalent Number of Parameters: 3.09 \nResidual Standard Error: 29.42 \nTrace of smoother matrix: 3.56  (exact)\n\nControl settings:\n  span     :  0.6991628 \n  degree   :  1 \n  family   :  gaussian\n  surface  :  interpolate\t  cell = 0.2\n  normalize:  TRUE\n parametric:  FALSE\ndrop.square:  FALSE \n```\n:::\n:::\n\n\n`loess.as` also includes a plot method so we can visualize the loess smoother.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nloess.as(aq$Solar.R, aq$Ozone, criterion=\"gcv\", plot=TRUE)\n```\n\n::: {.cell-output-display}\n![](gam_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\nloess(formula = y ~ x, data = data.bind, span = span1, degree = degree, \n    family = family)\n\nNumber of Observations: 111 \nEquivalent Number of Parameters: 3.09 \nResidual Standard Error: 29.42 \n```\n:::\n:::\n\n\nCross validation is also built in to `smooth.spline()` and is set to generalized cross validation by default. Instead of specifying `spar` in the call to `smooth.spline()`, we just leave it out to invoke cross validation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\naq.spl = smooth.spline(aq$Solar.R, aq$Ozone)\naq.spl\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\nsmooth.spline(x = aq$Solar.R, y = aq$Ozone)\n\nSmoothing Parameter  spar= 0.9837718  lambda= 0.01867197 (12 iterations)\nEquivalent Degrees of Freedom (Df): 4.060081\nPenalized Criterion (RSS): 66257.74\nGCV: 892.29\n```\n:::\n:::\n\n\nPlotting the cross validated spline smoother, we get a line that looks very similar to the lasso smoother.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_point(data=aq, aes(Solar.R, Ozone)) +\n  geom_line(aes(x=aq.spl$x, aq.spl$y), color='red') +\n  ggtitle(\"CV Spline Smoother\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](gam_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "gam_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}