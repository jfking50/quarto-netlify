{
  "hash": "73a1486b18830de7bd24d4905c2eb2ea",
  "result": {
    "markdown": "---\ntitle: \"Stock Picker\"\ndescription: \"Train a model to predict future stock prices.\"\nauthor: \"John King\"\ndate: \"1/16/2023\"\nformat:\n  html:\n    toc: true\n    code-fold: true\n    code-tools: true\n    code-copy: true\n    df-print: paged\nexecute: \n  warning: false\n  message: false\ncategories:\n  - R\n  - predictive modeling\n  - machine learning\n  - stocks\nimage: \"teaser.jpg\"\n---\n\n\nIn the Summer of 2022, a colleague shared some scripts he had written to identify stocks that had a high probability of increasing their value 20 days in the future. I don't want to give away his methodology, so I'll just say that the scripts fit two models for each individual stock, and there were more than 7,000 stocks. It was an interesting approach, and I worked on just getting the scripts to be more efficient. Eventually, I was able to get the whole process to run about 2.5x faster, which translated into several hours.\n\nHe said that he had very good success with the model results, but occasionally would make a bad pick that would tank. Another downside was that each time he was ready to buy a new stock, he'd have to re-run the script to get the most up to date predictions. His approach got me interested in trying a completely different method. It seemed to me that there ought to be some fundamental similarities about stock market behavior that all stocks share, so instead of fitting one model for every stock, how about fitting one model for any stock. To reduce the risk of buying something that would completely tank, I decided to just limit the data to just S&P 500 stocks.\n\nTo test that idea out, this script downloads market indices (`idx`) and S&P 500 stock histories (`sp500`) since 2007. Stock and index data are joined into one large dataframe `df_joined`. The data is then ordered and split into training and test sets. A `tabnet` model is tuned on the training set, and the hyperparameters from the best fit model are used to train the final model. Although the model is trained on S&P 500 stocks only, the stock symbol was not included as a predictor variable, and so the model may be used to predict any stock's future close price . There is only one predictive model, and it's a regression model that predicts a stock's closing price 3 days in the future.\n\nSo here we go. First, load some packages.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(quantmod)   # quantitative financial modeling\nlibrary(purrr)      # for map and reduce functions\nlibrary(lubridate)\nlibrary(tidymodels) # for model fitting\nlibrary(tabnet)     # the predictive model\nlibrary(plotly)\n```\n:::\n\n\nOther packages used but not loaded into the namespace are:\n\n-   `yfR`: a yahoo finance for R package.\n-   `future`: for parallel processing.\n-   `zoo`: for rolling functions.\n-   `TTR`: Technical Trading Rules for stock market indicator functions.\n-   `vip`: for variable importance plots.\n-   `cvms`: for a nice looking confusion matrix.\n-   `torch`: for the `tabnet` neural network engine.\n\n## S&P 500 Historical Stock Prices\n\nSince this takes a while, you might want to save it to disk so you can re-use the data without having to re-download everything.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfuture::plan(\"future::multisession\")\n\nsp500 <- yfR::yf_collection_get(\"SP500\", \n                                do_parallel = TRUE, \n                                first_date = \"2007-01-01\")\n\nfuture::plan(\"sequential\")\n```\n:::\n\n::: {.cell}\n\n:::\n\n\nClean up the dataframe and rename columns.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsp500 <- sp500 %>%\n  select(-ret_adjusted_prices, -ret_closing_prices) %>%\n  rename_with(~c(\"Symbol\", \"Date\", \"Open\", \"High\", \"Low\", \"Close\", \"Volume\", \"Adj_Close\" ))\n```\n:::\n\n\n## Add Predictor Variables\n\nGroup by stock symbol and do some feature engineering to add predictor variables.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsp500 <- sp500 %>%\n  group_by(Symbol) %>%\n  mutate(\n    Date = as.Date(Date,format=\"%Y-%m-%d\"),\n    Day_of_week = as.factor(weekdays(Date)),\n    Month = as.factor(month(Date)),\n    Volatility = (High - Low) / Close,\n    seven_day_volume_avg = zoo::rollmean(Volume, k=7, fill=NA, align = \"right\"),\n    seven_day_volatility_avg = zoo::rollmean(Volatility, k=7, fill=NA, align = \"right\"),\n    seven_day_trend = (Close-(dplyr::lag(Close,n=7,default = NA))) / dplyr::lag(Close,n=7,default = NA),\n    seven_day_volume_trend = (seven_day_volume_avg-(dplyr::lag(seven_day_volume_avg, n=7, default = NA))) /\n      (dplyr::lag(seven_day_volume_avg, n=7, default = NA)),\n    local_20_max = zoo::rollapplyr(Close, 20, max, partial=TRUE),\n    local_20_min = zoo::rollapplyr(Close, 20, min, partial=TRUE),\n    diff_from_local_max = Close - local_20_max,\n    diff_from_local_min = Close - local_20_min,\n    local_range = (local_20_max - local_20_min) / Close,\n    trade_vol_5mov_avg = zoo::rollmean(Volume, k = 5, fill = NA, align = \"right\"),\n    diff_ma_20 = Close - zoo::rollmean(Close, k = 20, fill = NA, align = \"right\")\n  )\n```\n:::\n\n\nI iterated on this a while to assess model performance using different additional predictor variables. This is what I eventually settled on.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsp500 <- sp500 %>% mutate(\n  three_day_change = Close - dplyr::lag(Close, n=3),\n  rel_strength_index = TTR::RSI(Close, n=14),\n  MACD = TTR::MACD(Close, nFast=12, nSlow=26, nSig=9, maType=\"EMA\"),\n  macd = unlist(MACD)[, 1],\n  macd_signal = unlist(MACD)[, 2],\n  macd_above_signal = macd - macd_signal,\n  SO = TTR::stoch(Close),\n  fastK = unlist(SO)[, 1],\n  fastD = unlist(SO)[, 2],\n  slowD = unlist(SO)[, 3],\n  BB = TTR::BBands(Close),\n  bb_dn = unlist(BB)[, 1],\n  bb_mavg = unlist(BB)[, 2],\n  bb_up = unlist(BB)[, 3],\n  bb_pctB = unlist(BB)[, 4],\n  y = dplyr::lead(Close, n=3, default = NA) # the response (or outcome) variable\n) %>% select(-MACD, -SO, -BB)\n\nhead(sp500)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"Symbol\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"Date\"],\"name\":[2],\"type\":[\"date\"],\"align\":[\"right\"]},{\"label\":[\"Open\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"High\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Low\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Close\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Volume\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Adj_Close\"],\"name\":[8],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Day_of_week\"],\"name\":[9],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"Month\"],\"name\":[10],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"Volatility\"],\"name\":[11],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"seven_day_volume_avg\"],\"name\":[12],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"seven_day_volatility_avg\"],\"name\":[13],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"seven_day_trend\"],\"name\":[14],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"seven_day_volume_trend\"],\"name\":[15],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"local_20_max\"],\"name\":[16],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"local_20_min\"],\"name\":[17],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"diff_from_local_max\"],\"name\":[18],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"diff_from_local_min\"],\"name\":[19],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"local_range\"],\"name\":[20],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"trade_vol_5mov_avg\"],\"name\":[21],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"diff_ma_20\"],\"name\":[22],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"three_day_change\"],\"name\":[23],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"rel_strength_index\"],\"name\":[24],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"macd\"],\"name\":[25],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"macd_signal\"],\"name\":[26],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"macd_above_signal\"],\"name\":[27],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"fastK\"],\"name\":[28],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"fastD\"],\"name\":[29],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"slowD\"],\"name\":[30],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"bb_dn\"],\"name\":[31],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"bb_mavg\"],\"name\":[32],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"bb_up\"],\"name\":[33],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"bb_pctB\"],\"name\":[34],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"y\"],\"name\":[35],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"MMM\",\"2\":\"2007-01-03\",\"3\":\"77.53\",\"4\":\"78.85\",\"5\":\"77.38\",\"6\":\"78.26\",\"7\":\"3781500\",\"8\":\"50.88114\",\"9\":\"Wednesday\",\"10\":\"1\",\"11\":\"0.01878355\",\"12\":\"NA\",\"13\":\"NA\",\"14\":\"NA\",\"15\":\"NA\",\"16\":\"78.26\",\"17\":\"78.26\",\"18\":\"0.000000\",\"19\":\"0.000000\",\"20\":\"0.000000000\",\"21\":\"NA\",\"22\":\"NA\",\"23\":\"NA\",\"24\":\"NA\",\"25\":\"NA\",\"26\":\"NA\",\"27\":\"NA\",\"28\":\"NA\",\"29\":\"NA\",\"30\":\"NA\",\"31\":\"NA\",\"32\":\"NA\",\"33\":\"NA\",\"34\":\"NA\",\"35\":\"77.59\"},{\"1\":\"MMM\",\"2\":\"2007-01-04\",\"3\":\"78.40\",\"4\":\"78.41\",\"5\":\"77.45\",\"6\":\"77.95\",\"7\":\"2968400\",\"8\":\"50.67959\",\"9\":\"Thursday\",\"10\":\"1\",\"11\":\"0.01231568\",\"12\":\"NA\",\"13\":\"NA\",\"14\":\"NA\",\"15\":\"NA\",\"16\":\"78.26\",\"17\":\"77.95\",\"18\":\"-0.310005\",\"19\":\"0.000000\",\"20\":\"0.003976973\",\"21\":\"NA\",\"22\":\"NA\",\"23\":\"NA\",\"24\":\"NA\",\"25\":\"NA\",\"26\":\"NA\",\"27\":\"NA\",\"28\":\"NA\",\"29\":\"NA\",\"30\":\"NA\",\"31\":\"NA\",\"32\":\"NA\",\"33\":\"NA\",\"34\":\"NA\",\"35\":\"77.68\"},{\"1\":\"MMM\",\"2\":\"2007-01-05\",\"3\":\"77.89\",\"4\":\"77.90\",\"5\":\"77.01\",\"6\":\"77.42\",\"7\":\"2765200\",\"8\":\"50.33502\",\"9\":\"Friday\",\"10\":\"1\",\"11\":\"0.01149574\",\"12\":\"NA\",\"13\":\"NA\",\"14\":\"NA\",\"15\":\"NA\",\"16\":\"78.26\",\"17\":\"77.42\",\"18\":\"-0.840004\",\"19\":\"0.000000\",\"20\":\"0.010849962\",\"21\":\"NA\",\"22\":\"NA\",\"23\":\"NA\",\"24\":\"NA\",\"25\":\"NA\",\"26\":\"NA\",\"27\":\"NA\",\"28\":\"NA\",\"29\":\"NA\",\"30\":\"NA\",\"31\":\"NA\",\"32\":\"NA\",\"33\":\"NA\",\"34\":\"NA\",\"35\":\"77.85\"},{\"1\":\"MMM\",\"2\":\"2007-01-08\",\"3\":\"77.42\",\"4\":\"78.04\",\"5\":\"76.97\",\"6\":\"77.59\",\"7\":\"2434500\",\"8\":\"50.44556\",\"9\":\"Monday\",\"10\":\"1\",\"11\":\"0.01379044\",\"12\":\"NA\",\"13\":\"NA\",\"14\":\"NA\",\"15\":\"NA\",\"16\":\"78.26\",\"17\":\"77.42\",\"18\":\"-0.670006\",\"19\":\"0.169998\",\"20\":\"0.010826189\",\"21\":\"NA\",\"22\":\"NA\",\"23\":\"-0.670006\",\"24\":\"NA\",\"25\":\"NA\",\"26\":\"NA\",\"27\":\"NA\",\"28\":\"NA\",\"29\":\"NA\",\"30\":\"NA\",\"31\":\"NA\",\"32\":\"NA\",\"33\":\"NA\",\"34\":\"NA\",\"35\":\"78.65\"},{\"1\":\"MMM\",\"2\":\"2007-01-09\",\"3\":\"78.00\",\"4\":\"78.23\",\"5\":\"77.44\",\"6\":\"77.68\",\"7\":\"1896800\",\"8\":\"50.50405\",\"9\":\"Tuesday\",\"10\":\"1\",\"11\":\"0.01016994\",\"12\":\"NA\",\"13\":\"NA\",\"14\":\"NA\",\"15\":\"NA\",\"16\":\"78.26\",\"17\":\"77.42\",\"18\":\"-0.580002\",\"19\":\"0.260002\",\"20\":\"0.010813646\",\"21\":\"2769280\",\"22\":\"NA\",\"23\":\"-0.269997\",\"24\":\"NA\",\"25\":\"NA\",\"26\":\"NA\",\"27\":\"NA\",\"28\":\"NA\",\"29\":\"NA\",\"30\":\"NA\",\"31\":\"NA\",\"32\":\"NA\",\"33\":\"NA\",\"34\":\"NA\",\"35\":\"79.36\"},{\"1\":\"MMM\",\"2\":\"2007-01-10\",\"3\":\"77.31\",\"4\":\"77.96\",\"5\":\"77.04\",\"6\":\"77.85\",\"7\":\"1787500\",\"8\":\"50.61459\",\"9\":\"Wednesday\",\"10\":\"1\",\"11\":\"0.01181757\",\"12\":\"NA\",\"13\":\"NA\",\"14\":\"NA\",\"15\":\"NA\",\"16\":\"78.26\",\"17\":\"77.42\",\"18\":\"-0.410004\",\"19\":\"0.430000\",\"20\":\"0.010790032\",\"21\":\"2370480\",\"22\":\"NA\",\"23\":\"0.430000\",\"24\":\"NA\",\"25\":\"NA\",\"26\":\"NA\",\"27\":\"NA\",\"28\":\"NA\",\"29\":\"NA\",\"30\":\"NA\",\"31\":\"NA\",\"32\":\"NA\",\"33\":\"NA\",\"34\":\"NA\",\"35\":\"79.56\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nNow that I have the S&P 500 stocks, I'm going to get the historical data for five major stock indexes, `IV_vars`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nIV_vars <- c(\"NDAQ\",\"SPY\",\"CBOE\",\"GS\",\"^VIX\") \n\nidx <- IV_vars %>% map(function(symbol){\n  \n  df <- as_tibble(\n    getSymbols(Symbols = symbol, \n               reload.Symbols = FALSE, \n               warnings = FALSE, \n               auto.assign = FALSE),\n    rownames = \"Date\") %>%\n    rename_with(~c(\"Date\",\"Open\",\"High\",\"Low\",\"Close\",\"Volume\",\"Adj_Close\" ))\n  \n  if (symbol == \"^VIX\"){symbol <- \"VIX\"}\n\n  df <- df %>%\n    mutate(\n      Date = as.Date(Date, format=\"%Y-%m-%d\"),\n      Volatility = (High - Low) / Close,\n      seven_day_volume_avg = zoo::rollmean(Volume, k=7, fill=NA, align = \"right\"),\n      seven_day_volatility_avg = zoo::rollmean(Volatility, k=7, fill=NA, align = \"right\"),\n      seven_day_trend = (Close-(dplyr::lag(Close,n=7,default = NA))) / dplyr::lag(Close,n=7,default = NA),\n      local_20_max = zoo::rollapplyr(Close, 20, max, partial=TRUE),\n      local_20_min = zoo::rollapplyr(Close, 20, min, partial=TRUE),\n      diff_from_local_max = Close - local_20_max,\n      diff_from_local_min = Close - local_20_min,\n      local_range = (local_20_max - local_20_min) / Close\n    ) %>%\n    select(-Open, -High, -Low, -Adj_Close, -local_20_min, -local_20_max)\n    \n  colnames(df) <- c(\"Date\", paste(symbol, colnames(df)[2:10], sep=\"_\"))\n  \n  df\n\n}) %>% reduce(left_join, by=\"Date\")\n\nhead(idx)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"Date\"],\"name\":[1],\"type\":[\"date\"],\"align\":[\"right\"]},{\"label\":[\"NDAQ_Close\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"NDAQ_Volume\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"NDAQ_Volatility\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"NDAQ_seven_day_volume_avg\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"NDAQ_seven_day_volatility_avg\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"NDAQ_seven_day_trend\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"NDAQ_diff_from_local_max\"],\"name\":[8],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"NDAQ_diff_from_local_min\"],\"name\":[9],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"NDAQ_local_range\"],\"name\":[10],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"SPY_Close\"],\"name\":[11],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"SPY_Volume\"],\"name\":[12],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"SPY_Volatility\"],\"name\":[13],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"SPY_seven_day_volume_avg\"],\"name\":[14],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"SPY_seven_day_volatility_avg\"],\"name\":[15],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"SPY_seven_day_trend\"],\"name\":[16],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"SPY_diff_from_local_max\"],\"name\":[17],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"SPY_diff_from_local_min\"],\"name\":[18],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"SPY_local_range\"],\"name\":[19],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CBOE_Close\"],\"name\":[20],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CBOE_Volume\"],\"name\":[21],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CBOE_Volatility\"],\"name\":[22],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CBOE_seven_day_volume_avg\"],\"name\":[23],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CBOE_seven_day_volatility_avg\"],\"name\":[24],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CBOE_seven_day_trend\"],\"name\":[25],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CBOE_diff_from_local_max\"],\"name\":[26],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CBOE_diff_from_local_min\"],\"name\":[27],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CBOE_local_range\"],\"name\":[28],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"GS_Close\"],\"name\":[29],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"GS_Volume\"],\"name\":[30],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"GS_Volatility\"],\"name\":[31],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"GS_seven_day_volume_avg\"],\"name\":[32],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"GS_seven_day_volatility_avg\"],\"name\":[33],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"GS_seven_day_trend\"],\"name\":[34],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"GS_diff_from_local_max\"],\"name\":[35],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"GS_diff_from_local_min\"],\"name\":[36],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"GS_local_range\"],\"name\":[37],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"VIX_Close\"],\"name\":[38],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"VIX_Volume\"],\"name\":[39],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"VIX_Volatility\"],\"name\":[40],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"VIX_seven_day_volume_avg\"],\"name\":[41],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"VIX_seven_day_volatility_avg\"],\"name\":[42],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"VIX_seven_day_trend\"],\"name\":[43],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"VIX_diff_from_local_max\"],\"name\":[44],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"VIX_diff_from_local_min\"],\"name\":[45],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"VIX_local_range\"],\"name\":[46],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"2007-01-03\",\"2\":\"10.33667\",\"3\":\"16054800\",\"4\":\"0.02386330\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"NA\",\"8\":\"0.00\",\"9\":\"0.000000\",\"10\":\"0.00000000\",\"11\":\"141.37\",\"12\":\"94807600\",\"13\":\"0.016198586\",\"14\":\"NA\",\"15\":\"NA\",\"16\":\"NA\",\"17\":\"0.000000\",\"18\":\"0.000000\",\"19\":\"0.000000000\",\"20\":\"NA\",\"21\":\"NA\",\"22\":\"NA\",\"23\":\"NA\",\"24\":\"NA\",\"25\":\"NA\",\"26\":\"NA\",\"27\":\"NA\",\"28\":\"NA\",\"29\":\"200.72\",\"30\":\"6494900\",\"31\":\"0.02740135\",\"32\":\"NA\",\"33\":\"NA\",\"34\":\"NA\",\"35\":\"0.000000\",\"36\":\"0.000000\",\"37\":\"0.000000000\",\"38\":\"12.04\",\"39\":\"0\",\"40\":\"0.10132890\",\"41\":\"NA\",\"42\":\"NA\",\"43\":\"NA\",\"44\":\"0.00\",\"45\":\"0.00\",\"46\":\"0.00000000\"},{\"1\":\"2007-01-04\",\"2\":\"10.63000\",\"3\":\"9840900\",\"4\":\"0.04703669\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"NA\",\"8\":\"0.00\",\"9\":\"0.293333\",\"10\":\"0.02759483\",\"11\":\"141.67\",\"12\":\"69620600\",\"13\":\"0.010164481\",\"14\":\"NA\",\"15\":\"NA\",\"16\":\"NA\",\"17\":\"0.000000\",\"18\":\"0.300003\",\"19\":\"0.002117618\",\"20\":\"NA\",\"21\":\"NA\",\"22\":\"NA\",\"23\":\"NA\",\"24\":\"NA\",\"25\":\"NA\",\"26\":\"NA\",\"27\":\"NA\",\"28\":\"NA\",\"29\":\"198.85\",\"30\":\"6460200\",\"31\":\"0.01307514\",\"32\":\"NA\",\"33\":\"NA\",\"34\":\"NA\",\"35\":\"-1.869995\",\"36\":\"0.000000\",\"37\":\"0.009404048\",\"38\":\"11.51\",\"39\":\"0\",\"40\":\"0.09904431\",\"41\":\"NA\",\"42\":\"NA\",\"43\":\"NA\",\"44\":\"-0.53\",\"45\":\"0.00\",\"46\":\"0.04604692\"},{\"1\":\"2007-01-05\",\"2\":\"11.03333\",\"3\":\"11149200\",\"4\":\"0.04561931\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"NA\",\"8\":\"0.00\",\"9\":\"0.696666\",\"10\":\"0.06314194\",\"11\":\"140.54\",\"12\":\"76645300\",\"13\":\"0.007257642\",\"14\":\"NA\",\"15\":\"NA\",\"16\":\"NA\",\"17\":\"-1.130005\",\"18\":\"0.000000\",\"19\":\"0.008040452\",\"20\":\"NA\",\"21\":\"NA\",\"22\":\"NA\",\"23\":\"NA\",\"24\":\"NA\",\"25\":\"NA\",\"26\":\"NA\",\"27\":\"NA\",\"28\":\"NA\",\"29\":\"199.05\",\"30\":\"5892900\",\"31\":\"0.01055014\",\"32\":\"NA\",\"33\":\"NA\",\"34\":\"NA\",\"35\":\"-1.669998\",\"36\":\"0.199997\",\"37\":\"0.009394599\",\"38\":\"12.14\",\"39\":\"0\",\"40\":\"0.04695222\",\"41\":\"NA\",\"42\":\"NA\",\"43\":\"NA\",\"44\":\"0.00\",\"45\":\"0.63\",\"46\":\"0.05189456\"},{\"1\":\"2007-01-08\",\"2\":\"11.34667\",\"3\":\"10998300\",\"4\":\"0.04289074\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"NA\",\"8\":\"0.00\",\"9\":\"1.010000\",\"10\":\"0.08901292\",\"11\":\"141.19\",\"12\":\"71655000\",\"13\":\"0.008215908\",\"14\":\"NA\",\"15\":\"NA\",\"16\":\"NA\",\"17\":\"-0.479996\",\"18\":\"0.650009\",\"19\":\"0.008003435\",\"20\":\"NA\",\"21\":\"NA\",\"22\":\"NA\",\"23\":\"NA\",\"24\":\"NA\",\"25\":\"NA\",\"26\":\"NA\",\"27\":\"NA\",\"28\":\"NA\",\"29\":\"203.73\",\"30\":\"7851000\",\"31\":\"0.02871443\",\"32\":\"NA\",\"33\":\"NA\",\"34\":\"NA\",\"35\":\"0.000000\",\"36\":\"4.879990\",\"37\":\"0.023953223\",\"38\":\"12.00\",\"39\":\"0\",\"40\":\"0.08750000\",\"41\":\"NA\",\"42\":\"NA\",\"43\":\"NA\",\"44\":\"-0.14\",\"45\":\"0.49\",\"46\":\"0.05250000\"},{\"1\":\"2007-01-09\",\"2\":\"11.27667\",\"3\":\"9531600\",\"4\":\"0.03133319\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"NA\",\"8\":\"-0.07\",\"9\":\"0.940000\",\"10\":\"0.08956547\",\"11\":\"141.07\",\"12\":\"75680100\",\"13\":\"0.008506500\",\"14\":\"NA\",\"15\":\"NA\",\"16\":\"NA\",\"17\":\"-0.599991\",\"18\":\"0.530014\",\"19\":\"0.008010243\",\"20\":\"NA\",\"21\":\"NA\",\"22\":\"NA\",\"23\":\"NA\",\"24\":\"NA\",\"25\":\"NA\",\"26\":\"NA\",\"27\":\"NA\",\"28\":\"NA\",\"29\":\"204.08\",\"30\":\"7147100\",\"31\":\"0.01421008\",\"32\":\"NA\",\"33\":\"NA\",\"34\":\"NA\",\"35\":\"0.000000\",\"36\":\"5.229996\",\"37\":\"0.025627185\",\"38\":\"11.91\",\"39\":\"0\",\"40\":\"0.06549118\",\"41\":\"NA\",\"42\":\"NA\",\"43\":\"NA\",\"44\":\"-0.23\",\"45\":\"0.40\",\"46\":\"0.05289673\"},{\"1\":\"2007-01-10\",\"2\":\"11.76000\",\"3\":\"11197200\",\"4\":\"0.06632653\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"NA\",\"8\":\"0.00\",\"9\":\"1.423333\",\"10\":\"0.12103172\",\"11\":\"141.54\",\"12\":\"72428000\",\"13\":\"0.008972757\",\"14\":\"NA\",\"15\":\"NA\",\"16\":\"NA\",\"17\":\"-0.130005\",\"18\":\"1.000000\",\"19\":\"0.007983645\",\"20\":\"NA\",\"21\":\"NA\",\"22\":\"NA\",\"23\":\"NA\",\"24\":\"NA\",\"25\":\"NA\",\"26\":\"NA\",\"27\":\"NA\",\"28\":\"NA\",\"29\":\"208.11\",\"30\":\"8025700\",\"31\":\"0.03334776\",\"32\":\"NA\",\"33\":\"NA\",\"34\":\"NA\",\"35\":\"0.000000\",\"36\":\"9.259995\",\"37\":\"0.044495675\",\"38\":\"11.47\",\"39\":\"0\",\"40\":\"0.09328684\",\"41\":\"NA\",\"42\":\"NA\",\"43\":\"NA\",\"44\":\"-0.67\",\"45\":\"0.00\",\"46\":\"0.05841325\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nNow I join the stock dataframe to the index dataframe, eliminate some columns, and drop `NA`s.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_joined <- sp500 %>% ungroup() %>%\n  left_join(idx, by = \"Date\") %>% \n  select(\n    y,\n    Symbol,\n    Close, \n    Date,\n    diff_ma_20,\n    macd,\n    macd_signal,\n    macd_above_signal,\n    three_day_change,\n    rel_strength_index,\n    fastK,\n    fastD,\n    slowD,\n    bb_dn,\n    bb_mavg,\n    bb_up,\n    bb_pctB,\n    Volume, \n    Volatility, \n    seven_day_volume_avg, \n    seven_day_volatility_avg, \n    seven_day_trend, \n    seven_day_volume_trend, \n    local_20_max, \n    local_20_min, \n    diff_from_local_max, \n    diff_from_local_min, \n    local_range, \n    NDAQ_Close, \n    NDAQ_Volatility, \n    NDAQ_Volume, \n    NDAQ_Volume, \n    NDAQ_seven_day_volume_avg, \n    NDAQ_seven_day_volatility_avg, \n    NDAQ_seven_day_trend, \n    NDAQ_diff_from_local_max, \n    NDAQ_diff_from_local_min, \n    NDAQ_local_range, \n    SPY_Close, \n    SPY_Volatility, \n    SPY_Volume, \n    SPY_seven_day_volume_avg, \n    SPY_seven_day_volatility_avg, \n    SPY_seven_day_trend, \n    SPY_diff_from_local_max, \n    SPY_diff_from_local_min, \n    SPY_local_range, \n    GS_Close, \n    GS_Volatility, \n    GS_Volume, \n    GS_seven_day_volume_avg, \n    GS_seven_day_volatility_avg, \n    GS_seven_day_trend, \n    GS_diff_from_local_max, \n    GS_diff_from_local_min, \n    GS_local_range, \n    CBOE_Close, \n    CBOE_Volatility, \n    CBOE_Volume, \n    CBOE_seven_day_volume_avg, \n    CBOE_seven_day_volatility_avg, \n    CBOE_seven_day_trend, \n    CBOE_diff_from_local_max, \n    CBOE_diff_from_local_min, \n    CBOE_local_range, \n    VIX_Close, \n    VIX_Volatility, \n    VIX_seven_day_volatility_avg, \n    VIX_seven_day_trend\n  ) %>%\n  drop_na()\n\nhead(df_joined)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"y\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Symbol\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"Close\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Date\"],\"name\":[4],\"type\":[\"date\"],\"align\":[\"right\"]},{\"label\":[\"diff_ma_20\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"macd\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"macd_signal\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"macd_above_signal\"],\"name\":[8],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"three_day_change\"],\"name\":[9],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"rel_strength_index\"],\"name\":[10],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"fastK\"],\"name\":[11],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"fastD\"],\"name\":[12],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"slowD\"],\"name\":[13],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"bb_dn\"],\"name\":[14],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"bb_mavg\"],\"name\":[15],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"bb_up\"],\"name\":[16],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"bb_pctB\"],\"name\":[17],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Volume\"],\"name\":[18],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Volatility\"],\"name\":[19],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"seven_day_volume_avg\"],\"name\":[20],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"seven_day_volatility_avg\"],\"name\":[21],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"seven_day_trend\"],\"name\":[22],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"seven_day_volume_trend\"],\"name\":[23],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"local_20_max\"],\"name\":[24],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"local_20_min\"],\"name\":[25],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"diff_from_local_max\"],\"name\":[26],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"diff_from_local_min\"],\"name\":[27],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"local_range\"],\"name\":[28],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"NDAQ_Close\"],\"name\":[29],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"NDAQ_Volatility\"],\"name\":[30],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"NDAQ_Volume\"],\"name\":[31],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"NDAQ_seven_day_volume_avg\"],\"name\":[32],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"NDAQ_seven_day_volatility_avg\"],\"name\":[33],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"NDAQ_seven_day_trend\"],\"name\":[34],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"NDAQ_diff_from_local_max\"],\"name\":[35],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"NDAQ_diff_from_local_min\"],\"name\":[36],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"NDAQ_local_range\"],\"name\":[37],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"SPY_Close\"],\"name\":[38],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"SPY_Volatility\"],\"name\":[39],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"SPY_Volume\"],\"name\":[40],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"SPY_seven_day_volume_avg\"],\"name\":[41],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"SPY_seven_day_volatility_avg\"],\"name\":[42],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"SPY_seven_day_trend\"],\"name\":[43],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"SPY_diff_from_local_max\"],\"name\":[44],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"SPY_diff_from_local_min\"],\"name\":[45],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"SPY_local_range\"],\"name\":[46],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"GS_Close\"],\"name\":[47],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"GS_Volatility\"],\"name\":[48],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"GS_Volume\"],\"name\":[49],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"GS_seven_day_volume_avg\"],\"name\":[50],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"GS_seven_day_volatility_avg\"],\"name\":[51],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"GS_seven_day_trend\"],\"name\":[52],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"GS_diff_from_local_max\"],\"name\":[53],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"GS_diff_from_local_min\"],\"name\":[54],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"GS_local_range\"],\"name\":[55],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CBOE_Close\"],\"name\":[56],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CBOE_Volatility\"],\"name\":[57],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CBOE_Volume\"],\"name\":[58],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CBOE_seven_day_volume_avg\"],\"name\":[59],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CBOE_seven_day_volatility_avg\"],\"name\":[60],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CBOE_seven_day_trend\"],\"name\":[61],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CBOE_diff_from_local_max\"],\"name\":[62],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CBOE_diff_from_local_min\"],\"name\":[63],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CBOE_local_range\"],\"name\":[64],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"VIX_Close\"],\"name\":[65],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"VIX_Volatility\"],\"name\":[66],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"VIX_seven_day_volatility_avg\"],\"name\":[67],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"VIX_seven_day_trend\"],\"name\":[68],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"78.49\",\"2\":\"MMM\",\"3\":\"78.18\",\"4\":\"2010-06-24\",\"5\":\"-0.46849925\",\"6\":\"-0.5667265\",\"7\":\"-1.0445828\",\"8\":\"0.4778563\",\"9\":\"-3.290001\",\"10\":\"42.80790\",\"11\":\"0.5111442\",\"12\":\"0.6988609\",\"13\":\"0.8297837\",\"14\":\"74.36808\",\"15\":\"78.6485\",\"16\":\"82.92892\",\"17\":\"0.4452741\",\"18\":\"4340100\",\"19\":\"0.02519817\",\"20\":\"4240000\",\"21\":\"0.02055968\",\"22\":\"-0.01993227\",\"23\":\"-0.16764355\",\"24\":\"81.47\",\"25\":\"74.74\",\"26\":\"-3.290001\",\"27\":\"3.440002\",\"28\":\"0.08608344\",\"29\":\"6.113333\",\"30\":\"0.02071979\",\"31\":\"6785400\",\"32\":\"6003514\",\"33\":\"0.02189276\",\"34\":\"-0.06856273\",\"35\":\"-0.450000\",\"36\":\"0.040000\",\"37\":\"0.08015268\",\"38\":\"107.42\",\"39\":\"0.01573267\",\"40\":\"268523600\",\"41\":\"232746571\",\"42\":\"0.01477042\",\"43\":\"-0.04089287\",\"44\":\"-4.720001\",\"45\":\"1.930000\",\"46\":\"0.06190655\",\"47\":\"134.98\",\"48\":\"0.02126237\",\"49\":\"9967900\",\"50\":\"8747171\",\"51\":\"0.02141229\",\"52\":\"-0.014024822\",\"53\":\"-9.970001\",\"54\":\"1.539994\",\"55\":\"0.08527186\",\"56\":\"33.29\",\"57\":\"0.04265551\",\"58\":\"1600800\",\"59\":\"1352085.7\",\"60\":\"0.04055380\",\"61\":\"0.02462293\",\"62\":\"-0.189999\",\"63\":\"2.280001\",\"64\":\"0.07419645\",\"65\":\"29.74\",\"66\":\"0.09213178\",\"67\":\"0.07977728\",\"68\":\"0.1495941\"},{\"1\":\"78.99\",\"2\":\"MMM\",\"3\":\"78.90\",\"4\":\"2010-06-25\",\"5\":\"0.37800265\",\"6\":\"-0.5858054\",\"7\":\"-0.9528273\",\"8\":\"0.3670219\",\"9\":\"-1.129997\",\"10\":\"45.86789\",\"11\":\"0.6152696\",\"12\":\"0.6419399\",\"13\":\"0.7342046\",\"14\":\"74.43259\",\"15\":\"78.5220\",\"16\":\"82.61141\",\"17\":\"0.5462173\",\"18\":\"4339900\",\"19\":\"0.01533586\",\"20\":\"4094300\",\"21\":\"0.01920028\",\"22\":\"-0.02448065\",\"23\":\"-0.18276979\",\"24\":\"81.47\",\"25\":\"74.74\",\"26\":\"-2.569999\",\"27\":\"4.160004\",\"28\":\"0.08529788\",\"29\":\"6.296667\",\"30\":\"0.03282165\",\"31\":\"9883800\",\"32\":\"6705129\",\"33\":\"0.02431513\",\"34\":\"-0.03326500\",\"35\":\"-0.266666\",\"36\":\"0.223334\",\"37\":\"0.07781895\",\"38\":\"107.87\",\"39\":\"0.01529620\",\"40\":\"238726500\",\"41\":\"235939786\",\"42\":\"0.01539891\",\"43\":\"-0.03653087\",\"44\":\"-4.269996\",\"45\":\"2.380005\",\"46\":\"0.06164829\",\"47\":\"139.66\",\"48\":\"0.03916655\",\"49\":\"14332300\",\"50\":\"9783543\",\"51\":\"0.02434967\",\"52\":\"0.018969838\",\"53\":\"-5.169998\",\"54\":\"6.220002\",\"55\":\"0.08155520\",\"56\":\"32.07\",\"57\":\"0.03991263\",\"58\":\"640100\",\"59\":\"1135128.6\",\"60\":\"0.04260288\",\"61\":\"0.00000000\",\"62\":\"-1.410000\",\"63\":\"1.060000\",\"64\":\"0.07701902\",\"65\":\"28.53\",\"66\":\"0.08201892\",\"67\":\"0.08388846\",\"68\":\"0.1006945\"},{\"1\":\"78.55\",\"2\":\"MMM\",\"3\":\"78.98\",\"4\":\"2010-06-28\",\"5\":\"0.47450340\",\"6\":\"-0.5861417\",\"7\":\"-0.8794902\",\"8\":\"0.2933485\",\"9\":\"-1.140000\",\"10\":\"46.21225\",\"11\":\"0.6272458\",\"12\":\"0.5845532\",\"13\":\"0.6417847\",\"14\":\"74.42629\",\"15\":\"78.5055\",\"16\":\"82.58471\",\"17\":\"0.5581612\",\"18\":\"3094000\",\"19\":\"0.01823249\",\"20\":\"3968243\",\"21\":\"0.01921329\",\"22\":\"-0.02529922\",\"23\":\"-0.12694591\",\"24\":\"81.47\",\"25\":\"74.74\",\"26\":\"-2.489998\",\"27\":\"4.240005\",\"28\":\"0.08521148\",\"29\":\"6.286667\",\"30\":\"0.01378584\",\"31\":\"6531600\",\"32\":\"6933643\",\"33\":\"0.02273713\",\"34\":\"-0.02431443\",\"35\":\"-0.276666\",\"36\":\"0.213334\",\"37\":\"0.07794273\",\"38\":\"107.53\",\"39\":\"0.01097369\",\"40\":\"169218600\",\"41\":\"222515900\",\"42\":\"0.01533597\",\"43\":\"-0.04110933\",\"44\":\"-4.610000\",\"45\":\"2.040001\",\"46\":\"0.06184322\",\"47\":\"136.66\",\"48\":\"0.02817215\",\"49\":\"9908100\",\"50\":\"10041229\",\"51\":\"0.02508683\",\"52\":\"-0.004806313\",\"53\":\"-8.169998\",\"54\":\"3.220002\",\"55\":\"0.08334553\",\"56\":\"32.78\",\"57\":\"0.03935323\",\"58\":\"718200\",\"59\":\"1028057.1\",\"60\":\"0.04264653\",\"61\":\"0.04063489\",\"62\":\"-0.700001\",\"63\":\"1.769999\",\"64\":\"0.07535083\",\"65\":\"29.00\",\"66\":\"0.04931038\",\"67\":\"0.08186522\",\"68\":\"0.1576847\"},{\"1\":\"77.67\",\"2\":\"MMM\",\"3\":\"78.49\",\"4\":\"2010-06-29\",\"5\":\"-0.03650150\",\"6\":\"-0.6290896\",\"7\":\"-0.8294101\",\"8\":\"0.2003205\",\"9\":\"0.309998\",\"10\":\"44.35121\",\"11\":\"0.2623757\",\"12\":\"0.5016304\",\"13\":\"0.5760412\",\"14\":\"74.45215\",\"15\":\"78.5265\",\"16\":\"82.60085\",\"17\":\"0.4955206\",\"18\":\"8545400\",\"19\":\"0.02790168\",\"20\":\"4438186\",\"21\":\"0.02143948\",\"22\":\"-0.03313627\",\"23\":\"-0.03725201\",\"24\":\"81.47\",\"25\":\"74.74\",\"26\":\"-2.980003\",\"27\":\"3.750000\",\"28\":\"0.08574345\",\"29\":\"6.016667\",\"30\":\"0.03213291\",\"31\":\"7984200\",\"32\":\"7044814\",\"33\":\"0.02494286\",\"34\":\"-0.05842457\",\"35\":\"-0.546666\",\"36\":\"0.000000\",\"37\":\"0.09085861\",\"38\":\"104.21\",\"39\":\"0.03800018\",\"40\":\"373649500\",\"41\":\"251036314\",\"42\":\"0.01979284\",\"43\":\"-0.06730514\",\"44\":\"-7.930000\",\"45\":\"0.000000\",\"46\":\"0.07609634\",\"47\":\"133.76\",\"48\":\"0.02003595\",\"49\":\"10338100\",\"50\":\"10067400\",\"51\":\"0.02567465\",\"52\":\"-0.031987250\",\"53\":\"-11.070007\",\"54\":\"0.319993\",\"55\":\"0.08515252\",\"56\":\"31.76\",\"57\":\"0.03243070\",\"58\":\"622300\",\"59\":\"955214.3\",\"60\":\"0.04317943\",\"61\":\"0.02418575\",\"62\":\"-1.720000\",\"63\":\"0.750000\",\"64\":\"0.07777078\",\"65\":\"34.13\",\"66\":\"0.12217990\",\"67\":\"0.08989509\",\"68\":\"0.4250522\"},{\"1\":\"78.14\",\"2\":\"MMM\",\"3\":\"78.99\",\"4\":\"2010-06-30\",\"5\":\"0.45099850\",\"6\":\"-0.6053773\",\"7\":\"-0.7846035\",\"8\":\"0.1792262\",\"9\":\"0.089996\",\"10\":\"46.70953\",\"11\":\"0.2552548\",\"12\":\"0.3816254\",\"13\":\"0.4892697\",\"14\":\"74.46058\",\"15\":\"78.5390\",\"16\":\"82.61742\",\"17\":\"0.5552908\",\"18\":\"6942900\",\"19\":\"0.02544628\",\"20\":\"4849457\",\"21\":\"0.02169043\",\"22\":\"-0.03044069\",\"23\":\"0.12669895\",\"24\":\"81.47\",\"25\":\"74.74\",\"26\":\"-2.480003\",\"27\":\"4.250000\",\"28\":\"0.08520070\",\"29\":\"5.926667\",\"30\":\"0.02587188\",\"31\":\"8521800\",\"32\":\"7312243\",\"33\":\"0.02472905\",\"34\":\"-0.06421042\",\"35\":\"-0.636666\",\"36\":\"0.000000\",\"37\":\"0.10742395\",\"38\":\"103.22\",\"39\":\"0.01937609\",\"40\":\"284101700\",\"41\":\"261173600\",\"42\":\"0.01947060\",\"43\":\"-0.07351228\",\"44\":\"-8.919998\",\"45\":\"0.000000\",\"46\":\"0.08641734\",\"47\":\"131.27\",\"48\":\"0.02498666\",\"49\":\"9139800\",\"50\":\"10131514\",\"51\":\"0.02629867\",\"52\":\"-0.046972563\",\"53\":\"-12.769989\",\"54\":\"0.000000\",\"55\":\"0.09728033\",\"56\":\"32.55\",\"57\":\"0.03072203\",\"58\":\"402400\",\"59\":\"860285.7\",\"60\":\"0.03869546\",\"61\":\"0.01591754\",\"62\":\"-0.930001\",\"63\":\"1.539999\",\"64\":\"0.07588326\",\"65\":\"34.54\",\"66\":\"0.08367113\",\"67\":\"0.08594321\",\"68\":\"0.3882638\"},{\"1\":\"80.52\",\"2\":\"MMM\",\"3\":\"78.55\",\"4\":\"2010-07-01\",\"5\":\"0.00050315\",\"6\":\"-0.6242735\",\"7\":\"-0.7525375\",\"8\":\"0.1282640\",\"9\":\"-0.430000\",\"10\":\"44.90604\",\"11\":\"0.1231243\",\"12\":\"0.2135849\",\"13\":\"0.3656136\",\"14\":\"74.47210\",\"15\":\"78.5495\",\"16\":\"82.62690\",\"17\":\"0.5000617\",\"18\":\"6811700\",\"19\":\"0.01973259\",\"20\":\"5377300\",\"21\":\"0.02095712\",\"22\":\"-0.01849302\",\"23\":\"0.31529457\",\"24\":\"81.47\",\"25\":\"74.74\",\"26\":\"-2.919998\",\"27\":\"3.810005\",\"28\":\"0.08567795\",\"29\":\"5.900000\",\"30\":\"0.04067797\",\"31\":\"9065100\",\"32\":\"7716643\",\"33\":\"0.02671434\",\"34\":\"-0.05195496\",\"35\":\"-0.663333\",\"36\":\"0.000000\",\"37\":\"0.11242932\",\"38\":\"102.76\",\"39\":\"0.02296614\",\"40\":\"382924800\",\"41\":\"281683514\",\"42\":\"0.01950503\",\"43\":\"-0.06215203\",\"44\":\"-9.379997\",\"45\":\"0.000000\",\"46\":\"0.09128062\",\"47\":\"131.14\",\"48\":\"0.03240811\",\"49\":\"11645300\",\"50\":\"10509100\",\"51\":\"0.02757927\",\"52\":\"-0.027079117\",\"53\":\"-11.110001\",\"54\":\"0.000000\",\"55\":\"0.08471863\",\"56\":\"30.31\",\"57\":\"0.08248103\",\"58\":\"1023200\",\"59\":\"862342.9\",\"60\":\"0.04462257\",\"61\":\"-0.07280514\",\"62\":\"-3.170001\",\"63\":\"0.000000\",\"64\":\"0.10458598\",\"65\":\"32.86\",\"66\":\"0.14790021\",\"67\":\"0.09312938\",\"68\":\"0.2147875\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nAgain, you might want to save this to disk so you don't have to keep repeating the above steps.\n\nOne stock (NVR) trades at over \\$4,000/share. It's so much higher than all of the others, I decided to eliminate it from training and testing.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_joined %>% filter(Close > 4000) %>% distinct(Symbol)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"Symbol\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"NVR\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nFor speed purposes, I'm going to train on just the data since 2017.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_joined5 <- df_joined %>% filter(Date >= \"2017-01-01\" & Symbol != \"NVR\") %>% arrange(Date)\n```\n:::\n\n\nThis demonstrates how a naive stock picker would have fared in 2022 (as of Summer 2022). I'll need to at least beat this benchmark.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_joined %>%\n  filter(Date >= \"2022-01-01\") %>%\n  mutate(inc = y > Close) %>%\n  summarize(year_2022 = sum(inc)) / 58033\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"year_2022\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"0.4676822\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n## Hyperparameter Tuning\n\nNow I create train and test data sets. I'll train on data up to 2022-01-01, and the test data will be from that day forward. Functions below are from `tidymodels`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_split <- initial_time_split(df_joined5, \n                                 prop = df_joined5 %>% filter(Date < \"2022-01-01\") %>% nrow() / nrow(df_joined5))\ntrain_data <- training(data_split) \ntest_data  <- testing(data_split)\nval_set <- validation_split(train_data, prop = 0.80)\n```\n:::\n\n\nCreate the neural net recipe.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnn_rec <- recipe(y ~ ., data = train_data %>% select(-Symbol, -Date)) %>%\n  step_normalize(all_numeric_predictors())\n```\n:::\n\n\nDefine the model and parameters for tuning. Use large values for batch size. Batch size should be 2 to the order of something. Virtual batch size should be 1/8 of the batch size. Use trial and error to see how large you can go based on your GPU's dedicated memory. Mine's old and wimpy, so with validation, I have to keep it to $2^{13}$. Without validation, I can go up to $2^{15}$. This took many hours on my machine to complete, and some models failed.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnn_mod <-\n  tabnet(epochs = 10, \n         batch_size = 2^13,\n         virtual_batch_size = 2^10,\n         decision_width = tune(), \n         attention_width = tune(),\n         num_steps = tune(), \n         penalty = tune(), \n         momentum = tune(),\n         feature_reusage = tune(), \n         learn_rate = tune()) %>% \n  set_engine(\"torch\", device=\"cuda\", verbose=TRUE) %>%\n  set_mode(\"regression\")\n```\n:::\n\n\nDefine the workflow.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnn_wf <- \n  workflow() %>%\n  add_model(nn_mod) %>%\n  add_recipe(nn_rec)\n```\n:::\n\n\nFit 25 models for tuning.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nnn_fit <-\n  nn_wf %>%\n  tune_grid(val_set,\n            grid = 25,\n            control = control_grid())\n\n# see how the models performed\nnn_fit %>% collect_metrics()\n```\n:::\n\n\nShow the top 5 models based on root mean squared error (RMSE) and R-squared.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnn_fit %>% show_best(metric = \"rmse\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"penalty\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"learn_rate\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"decision_width\"],\"name\":[3],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"attention_width\"],\"name\":[4],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"num_steps\"],\"name\":[5],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"feature_reusage\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"momentum\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\".metric\"],\"name\":[8],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\".estimator\"],\"name\":[9],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"mean\"],\"name\":[10],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"n\"],\"name\":[11],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"std_err\"],\"name\":[12],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\".config\"],\"name\":[13],\"type\":[\"chr\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"1.887354e-06\",\"2\":\"0.023897007\",\"3\":\"20\",\"4\":\"56\",\"5\":\"6\",\"6\":\"1.777806\",\"7\":\"0.1526991\",\"8\":\"rmse\",\"9\":\"standard\",\"10\":\"12.15408\",\"11\":\"1\",\"12\":\"NA\",\"13\":\"Preprocessor1_Model05\"},{\"1\":\"4.889441e-09\",\"2\":\"0.009163333\",\"3\":\"23\",\"4\":\"28\",\"5\":\"4\",\"6\":\"1.669124\",\"7\":\"0.3590279\",\"8\":\"rmse\",\"9\":\"standard\",\"10\":\"13.17872\",\"11\":\"1\",\"12\":\"NA\",\"13\":\"Preprocessor1_Model15\"},{\"1\":\"1.615767e-04\",\"2\":\"0.099516739\",\"3\":\"19\",\"4\":\"16\",\"5\":\"7\",\"6\":\"1.130779\",\"7\":\"0.3935718\",\"8\":\"rmse\",\"9\":\"standard\",\"10\":\"13.41399\",\"11\":\"1\",\"12\":\"NA\",\"13\":\"Preprocessor1_Model25\"},{\"1\":\"1.553904e-03\",\"2\":\"0.001215648\",\"3\":\"26\",\"4\":\"40\",\"5\":\"7\",\"6\":\"1.351638\",\"7\":\"0.2830284\",\"8\":\"rmse\",\"9\":\"standard\",\"10\":\"81.56733\",\"11\":\"1\",\"12\":\"NA\",\"13\":\"Preprocessor1_Model08\"},{\"1\":\"6.741420e-08\",\"2\":\"0.000202984\",\"3\":\"44\",\"4\":\"32\",\"5\":\"5\",\"6\":\"1.729842\",\"7\":\"0.3120057\",\"8\":\"rmse\",\"9\":\"standard\",\"10\":\"199.09685\",\"11\":\"1\",\"12\":\"NA\",\"13\":\"Preprocessor1_Model04\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nnn_fit %>% show_best(metric = \"rsq\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"penalty\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"learn_rate\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"decision_width\"],\"name\":[3],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"attention_width\"],\"name\":[4],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"num_steps\"],\"name\":[5],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"feature_reusage\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"momentum\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\".metric\"],\"name\":[8],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\".estimator\"],\"name\":[9],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"mean\"],\"name\":[10],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"n\"],\"name\":[11],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"std_err\"],\"name\":[12],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\".config\"],\"name\":[13],\"type\":[\"chr\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"1.615767e-04\",\"2\":\"0.0995167386\",\"3\":\"19\",\"4\":\"16\",\"5\":\"7\",\"6\":\"1.130779\",\"7\":\"0.39357185\",\"8\":\"rsq\",\"9\":\"standard\",\"10\":\"0.9966011\",\"11\":\"1\",\"12\":\"NA\",\"13\":\"Preprocessor1_Model25\"},{\"1\":\"1.887354e-06\",\"2\":\"0.0238970068\",\"3\":\"20\",\"4\":\"56\",\"5\":\"6\",\"6\":\"1.777806\",\"7\":\"0.15269911\",\"8\":\"rsq\",\"9\":\"standard\",\"10\":\"0.9949211\",\"11\":\"1\",\"12\":\"NA\",\"13\":\"Preprocessor1_Model05\"},{\"1\":\"4.889441e-09\",\"2\":\"0.0091633335\",\"3\":\"23\",\"4\":\"28\",\"5\":\"4\",\"6\":\"1.669124\",\"7\":\"0.35902790\",\"8\":\"rsq\",\"9\":\"standard\",\"10\":\"0.9944811\",\"11\":\"1\",\"12\":\"NA\",\"13\":\"Preprocessor1_Model15\"},{\"1\":\"1.553904e-03\",\"2\":\"0.0012156482\",\"3\":\"26\",\"4\":\"40\",\"5\":\"7\",\"6\":\"1.351638\",\"7\":\"0.28302841\",\"8\":\"rsq\",\"9\":\"standard\",\"10\":\"0.8530734\",\"11\":\"1\",\"12\":\"NA\",\"13\":\"Preprocessor1_Model08\"},{\"1\":\"6.915258e-01\",\"2\":\"0.0001043431\",\"3\":\"48\",\"4\":\"54\",\"5\":\"3\",\"6\":\"1.823148\",\"7\":\"0.09684035\",\"8\":\"rsq\",\"9\":\"standard\",\"10\":\"0.5257241\",\"11\":\"1\",\"12\":\"NA\",\"13\":\"Preprocessor1_Model01\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nYou can save and reload the model results for another day.\n\n## The Final Fit\n\nFor the final fit, I went back to 2012. I tried 2007, but I kept running out of GPU memory when using the best hyperparameters ID'ed above. Side note - if I use default hyperparameter values, I can train on data back to 2007, so one or more of the hyperparameters is memory intensive.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(42)\n\ndata_split <- initial_time_split(df_joined5, \n                                 prop = df_joined5 %>% \n                                   filter(Date < \"2022-01-01\") %>% \n                                   nrow() / nrow(df_joined5))\ntrain_data <- training(data_split) \ntest_data  <- testing(data_split)\n\nnn_rec <- recipe(y ~ ., data = train_data %>% select(-Symbol, -Date)) %>%\n  step_normalize(all_numeric_predictors())\n```\n:::\n\n\nFinal model. I did this in 5-epoch increments just in case there were any errors.I stopped after 15 epochs since the loss had stabilized. Better to use a validation set here and stop when the validation loss bottoms out, but I had memory limitations.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_fit <-\n  tabnet_fit(\n    nn_rec,\n    data = train_data %>% select(-Symbol, -Date),\n    tabnet_model = model_fit,\n    from_epoch = 10,\n    epochs = 5,\n    checkpoint_epochs = 5,\n    batch_size = 2^13,\n    virtual_batch_size = 2^10,\n    decision_width = 23, \n    attention_width = 28,\n    num_steps = 4, \n    penalty = 4.89e-9, \n    momentum = 0.359,\n    feature_reusage = 1.67, \n    learn_rate = 0.00916,\n    device = \"cuda\",\n    verbose = TRUE\n  )\n```\n:::\n\n\nSave the final model! I highly recommend it because this model can be used for months without re-training.\n\n\n::: {.cell}\n\n:::\n\n\nCheck variable importance. Pretty heavily dominated by a small number of predictors, which isn't great.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvip::vip(model_fit, num_features = 20) + theme_bw()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n:::\n\n\nFor convenience, I make a dataframe `res` (short for results) with actual and predicted close prices and use it for checking performance.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nres <- tibble(\n  date = test_data$Date,\n  symbol = test_data$Symbol,\n  close = test_data$Close,\n  new_close = test_data$y,\n  pred = predict(model_fit, test_data) %>% .$`.pred`\n)\n```\n:::\n\n\nCalculate the RMSE for the final model. Shouldn't be too different from the RMSE for the training data,\n\n\n::: {.cell}\n\n```{.r .cell-code}\nres %>% \n  mutate(er = (pred - new_close)^2) %>% \n  summarize(rmse = sqrt(mean(er)))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"rmse\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"22.58211\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nEven though this is a regression problem, we can also look at it as if it was a classification problem and get the confusion matrix. We want lots of true-positives, of course. I'm not that concerned if the model predicts a stock will go down and it actually goes up because with a downward prediction, I wouldn't have looked at it further or risked any money on it. What I don't want are many upward predictions that actually go down.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nres <- res %>% mutate(\n  pred_diff = pred - close,\n  act_diff = new_close - close,\n  correct = ifelse((pred_diff > 0 & act_diff > 0) | (pred_diff < 0 & act_diff < 0) , 1, 0),\n  target = ifelse(new_close > close, 1, 0),\n  predict = ifelse(pred > close, 1, 0)\n)\n\nconf_mat <- cvms::confusion_matrix(\n  targets = res %>% .$target,\n  predictions = res %>% .$predict)\n\ncvms::plot_confusion_matrix(conf_mat$`Confusion Matrix`[[1]]) + \n  ggtitle(\"Tabnet Regression Accuracy\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-26-1.png){width=672}\n:::\n:::\n\n\n## Results\n\nMy results were true positives around 50% - right around the benchmark. But that got me thinking. What I'm showing is how good the model is at predicting the stock price in exactly three days. What if I buy a stock, and after three days it hasn't gone up? I'd probably hang on to it a little longer in case it goes up after 4 or 5 or \\_\\_ days. Plus, if I stick to S&P 500 stocks,I'm not too concerned about losing everything, so might as well hold on. Furthermore, if a stock did go up, I might also want to hang on longer to see if it keeps going up. Basically, I need a sell strategy. This might be a place for a new model, but for now I'll just hard code an approximate strategy.\n\nFor each stock and each date, get the maximum close price over the next 10 days. Here, I'm not concerned about the amount a stock goes up or down, just that it did or did not increase in value at some point in the next 10 days. If I do this, I get a much higher true positive rate.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nres <- res %>%\n  group_by(symbol) %>%\n  mutate(\n    windowmax = zoo::rollmax(close, k=10, fill=NA, align = \"left\"),\n    target = ifelse(predict > target & windowmax > close, 1, target)) %>% \n  drop_na()\n\nconf_mat <- cvms::confusion_matrix(\n  targets = res %>% .$target,\n  predictions = res %>% .$predict)\n\ncvms::plot_confusion_matrix(conf_mat$`Confusion Matrix`[[1]]) + \n  ggtitle(\"Tabnet Regression Accuracy\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n\n\nHere, I'm getting the average return using the above sell strategy.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nres %>%\n  group_by(symbol) %>%\n  mutate(\n    windowmax = rollmax(close, k=10, fill=NA, align = \"left\"),\n    pred_new = ifelse(predict > target & windowmax > close, windowmax, pred)) %>%\n  filter(predict == 1) %>%\n  mutate(gain = pred_new / close) %>%\n  ungroup() %>%\n  summarize(mean_gain = mean(gain, na.rm=T))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"mean_gain\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"1.077511\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n### Simulate Buys And Sells\n\nGiven the above sell strategy and the regression model, I now conduct 30 simulations of buying and selling stocks in 2021. I'll assume I start with \\$50,000 to invest, and I'll buy stocks \\$5,000 at a time. I'll sell when a stock has gained at least 6%. Below is a summary of the distribution of the profits from all simulations. At least there **is** profit for 2022, which actually pretty good.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(furrr)\nfuture::plan(\"future::multisession\")\n\nres <- res %>% ungroup()\n\ntemp <- 1:30 %>% future_map(function(x){\n  bank <- 50000\n  buy_amt <- 5000\n  thresh <- 1.06\n  for (d in unique(res$date)){\n    d <- as.Date(d)\n    if (d == \"2022-01-03\"){\n      buy <- res %>% filter(date == d & pred > close)\n      id <- sample(1:nrow(buy), bank/buy_amt, replace = FALSE)\n      cur_stocks <- buy %>% slice(id) %>% select(-new_close, -pred)\n      bank <- 0\n    }\n    \n    today <- res %>% filter(date == d & symbol %in% (cur_stocks %>% .$symbol)) %>% \n      select(-new_close, -pred) %>%\n      rename(\"new_close\" = \"close\", \"new_date\" = \"date\")\n    \n    sell <- cur_stocks %>% \n      left_join(today, by = \"symbol\") %>%\n      mutate(gain = new_close / close) %>%\n      filter(gain >= thresh)\n    \n    if (nrow(sell) > 0){\n      bank <- bank + sell %>% mutate(dollars = gain * buy_amt) %>% select(dollars) %>% sum()\n      if(exists(\"actions\")){actions <- actions %>% bind_rows(sell)}else{actions <- sell}\n      cur_stocks <- cur_stocks %>% filter(!symbol %in% (sell %>% .$symbol))\n      \n      buy <- res %>% filter(date == d & pred > close)\n      id <- sample(1:nrow(buy), floor(bank / buy_amt), replace = FALSE)\n      bank <- bank - floor(bank / buy_amt) * buy_amt\n      cur_stocks <- cur_stocks %>% bind_rows(buy %>% slice(id) %>% select(-new_close, -pred))\n      \n    }\n    \n  }\n  \n  actions %>% \n    mutate(dollars = gain * buy_amt) %>% \n    select(dollars) %>% \n    sum() - buy_amt * nrow(actions)\n  \n}, .options = furrr_options(seed = T)) %>% unlist()\n\nsummary(temp)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n   2567    3950    4786    5054    5907    8634 \n```\n:::\n:::\n\n\n### Some Plots\n\nPredicted versus actual close price. There's a noticeable error or predicting slightly higher than the actual close price.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nres %>%\n  ggplot() +\n  geom_abline(slope=1, color='red', linewidth=1) +\n  geom_point(aes(x=new_close, y=pred), alpha=0.2) +\n  xlab(\"Actual Close Price\") +\n  ylab(\"Predicted Close Price\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-30-1.png){width=672}\n:::\n:::\n\n\nThese were nine of the top performing stocks in 2021, if I remember right. Just seeing how they look in 2022 and how closely the model predictions match actual close prices for various individual stocks.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntop9 <- c(\"DXCM\", \"AMD\", \"URI\", \"NFLX\", \"NVDA\", \"MU\", \"FCX\", \"ABMD\", \"FTNT\")\n\nggplot(res %>% filter(date >= \"2022-01-01\" & symbol %in% top9)) +\n  geom_line(aes(x=date, y=new_close, group=symbol), size=1) +\n  geom_line(aes(x=date-3, y=pred), color=\"red\", size=2, alpha=0.5) +\n  coord_trans(y=\"log10\") +\n  facet_wrap(~symbol) +\n  ylab(\"Close\") +\n  ggtitle(\"2022 Closing Prices\\nActual: Black, Predicted: Red\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-31-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}