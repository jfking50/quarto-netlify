{"title":"Adjusted Statistics","markdown":{"yaml":{"title":"Adjusted Statistics","description":"Adjusted statistics for college football teams based on strength of schedule.","author":"John King","date":"3/20/2022","format":{"html":{"toc":true,"code-fold":false,"code-tools":true,"code-copy":true,"df-print":"paged"}},"execute":{"warning":false,"message":false,"echo":true},"categories":["R","ggplot2","college football","sports analytics"],"image":"teaser.gif"},"headingText":"Get the Data","containsRefs":false,"markdown":"\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = TRUE)\n```\n\nThe idea for this post started off as essentially a replication of [this post](https://blog.collegefootballdata.com/opponent-adjusted-stats-ridge-regression/) but using R and Tidymodels instead of Python. Once I got that done, I had an idea of making an animated plot instead of the static plot at the end of the post I referenced. I also wanted to get that code worked out because I noticed that a couple of animated images in a tutorial I had written weren't rendering.\n\n\nI'm not going to go through all the detail about why I'm going through these steps because, again, it's just re-creating what was done in the above link. In a nutshell, I'm going to calculate adjusted offense and defense scores for FBS college football teams based on each team's strength of schedule week by week through the 2021 season.\n\nI'm also not going to go over making API calls because 1) I covered that [here](https://jfking.netlify.app/posts/oregon-football/), and 2) I've already downloaded that data and saved it to disk. You can see the code necessary for the API calls commented out, but really I'm just reading the data from disk that I saved earlier. The first data set `games` is basic information about each game of the season.\n\n```{r message=FALSE, warning=FALSE}\nlibrary(httr)\nlibrary(tidyjson)\nlibrary(tidymodels)\nlibrary(tidyr)\n\n# get game info for 2021\n# df <-\n#   httr::GET(\n#     url = \"https://api.collegefootballdata.com/games?year=2021\",\n#     httr::add_headers(\n#       Authorization = paste(\"Bearer\", Sys.getenv(\"YOUR_API_TOKEN\"))))\n# \n# games21 <- tibble(data = content(df, \"parsed\")) %>% unnest_wider(data)\n# \n# rm(df)\n# \n# games21 <-\n#   games21 %>%\n#   select(id, season, week, neutral_site, home_team, home_conference, home_pregame_elo,\n#          away_team, away_conference, away_pregame_elo)\n# \n# saveRDS(games21, \"games21.RData\")\n\ngames <- readRDS(\"games21.RData\")\n\nhead(games)\n```\n\nThen I get a dataset that identifies which teams are FBS teams, so I can filter out the games against non-FBS opponents.\n\n```{r}\n# get the ID of non-FBS games\n# fbs_teams <-\n#   httr::GET(\n#     url = \"https://api.collegefootballdata.com/teams/fbs?year=2021\",\n#     httr::add_headers(\n#       Authorization = paste(\"Bearer\", Sys.getenv(\"YOUR_API_TOKEN\"))))\n# \n# fbs <- \n#   tibble(data = content(fbs_teams, \"parsed\")) %>% \n#   unnest_wider(data) %>% \n#   unnest_wider(logos) %>%\n#   rename(\"logo\" = \"...1\", \"logo2\" = \"...2\") %>%\n#   select(-location)\n# \n# saveRDS(fbs, \"fbs_teams.RData\")\n# rm(fbs_teams)\n\nfbs <- readRDS(\"fbs_teams.RData\")\n\nfbsIDs <- \n  games %>% \n  filter(home_team %in% (fbs %>% .$school) & \n         away_team %in% (fbs %>% .$school)) %>% .$id\n\ngames <- games %>% filter(id %in% fbsIDs)\n```\n\nThe last dataset contains play-by-play statistics for each games. I'm primarily interested in the `ppa` column, which is the predicted points added of each play and apparently is the same thing as EPA - expected points added. I also do some manipulation to account for home field advantage.\n\n```{r}\n# get PBP data\n# for (wk in 1:max(games$week)){\n#   print(wk)\n#   df <-\n#     httr::GET(\n#       url = paste0(\"https://api.collegefootballdata.com/plays?year=2021&week=\", as.character(wk)),\n#       httr::add_headers(\n#         Authorization = paste(\"Bearer\", Sys.getenv(\"YOUR_API_TOKEN\"))))\n#   \n#   if (wk == 1){pbp21 <- tibble(data = content(df, \"parsed\")) %>% unnest_wider(data)}\n#   else{pbp21 <- pbp21 %>% bind_rows(tibble(data = content(df, \"parsed\")) %>% unnest_wider(data))}\n# }\n# \n# rm(df, wk)\n# saveRDS(pbp21, \"pbp21.RData\")\n\npbp21 <- readRDS(\"pbp21.RData\")\n\npbp21 <-\n  pbp21 %>% \n  filter(game_id %in% fbsIDs) %>%\n  select(game_id, offense, defense, home, ppa) %>% \n  drop_na() %>%\n  left_join(games %>% \n              select(id, neutral_site, week), \n            by = c(\"game_id\" = \"id\")) %>%\n  mutate(\n    hfa = case_when(\n      home == offense ~ 1,\n      home == defense ~ -1),\n    hfa = ifelse(neutral_site, 0, hfa)) %>%\n  select(offense, hfa, defense, ppa, week) %>%\n  mutate_if(is.character, factor)\n\npbp21 <- pbp21 %>% mutate(ppa = as.numeric(as.character(ppa)))\n\nhead(pbp21)\n```\n\n## Ridge Regression\n\nThis block of code loops over the weeks of the season, tunes and fits a ridge regression model for each week. The regression model for week 1 includes all week 1 play-by-play data, the week 2 model includes week 1 and 2, and so on.\n\n```{r}\n# define the model\nlm_mod <- \n  linear_reg(penalty = tune(), mixture = 0) %>% \n  set_engine(\"glmnet\")\n\n# hyperparameter tuning grid\nlambda_grid <- tibble(penalty = c(0, 10^seq(-2, 2, length.out = 25)))\n\n# loop through the weeks\nfor (wk in 1:15){\n  \n  # define the recipe\n  lm_rec <-\n    recipe(ppa ~ ., data = pbp21 %>% filter(week <= wk) %>% select(-week)) %>%\n    step_dummy(all_nominal_predictors(), one_hot = TRUE)\n  \n  # cread cross-validation folds\n  folds <- vfold_cv(pbp21 %>% filter(week <= wk) %>% select(-week), v = 5)\n  \n  # define the workflow\n  lm_wflow <- \n    workflow() %>% \n    add_model(lm_mod) %>% \n    add_recipe(lm_rec)\n  \n  # get the tuning results\n  lm_res <- \n    lm_wflow %>% \n    tune_grid(\n      resamples = folds,\n      grid = lambda_grid,\n      control = control_grid(save_pred = TRUE)\n    )\n  \n  # get the model with the lowest root mean squared error\n  lowest_rmse <- lm_res %>% select_best(\"rmse\")\n  \n  # finalize the workflow with the best model\n  lm_final_wf <- \n    lm_wflow %>% \n    finalize_workflow(lowest_rmse)\n  \n  # get the final fit\n  lm_final_fit <- \n    lm_final_wf %>%\n    fit(pbp21 %>% filter(week <= wk) %>% select(-week)) \n  \n  # extract the coefficients\n  adjStats <- \n    broom::tidy(lm_final_fit) %>%\n    separate(term, into = c(\"side\", \"team\"), sep = \"_\", fill = \"left\") %>%\n    select(-penalty)\n  \n  # separate the intercept and home field advantage coefficients\n  otherTerms <- \n    adjStats %>% \n    slice(1:2) %>% \n    select(-side)\n  \n  # get the remaining coefficients \n  adjStats <- \n    adjStats %>% \n    slice(3:nrow(adjStats))\n  \n  # add the intercept term to the other coefficients\n  adjStats <- \n    adjStats %>% \n    mutate(estimate = estimate + otherTerms %>% \n             filter(team == \"(Intercept)\") %>% .$estimate)\n  \n  # fix team name formatting (Oregon.State to Oregon State)\n  adjStats <- \n    adjStats %>% \n    mutate(team = stringr::str_replace_all(team, \"\\\\.\", \" \"))\n  \n  # make dataframe wider\n  adjStats <- \n    adjStats %>% \n    pivot_wider(names_from = side, values_from = estimate) %>%\n    rename(\"adjOff\" = \"offense\", \"adjDef\" = \"defense\")\n  \n  # get the unadjusted (raw) stats - although I don't need this for the plot later\n  rawOff <- \n    pbp21 %>% \n    group_by(offense) %>% \n    summarize(meanPPA = mean(ppa)) %>%\n    rename(\"team\" = \"offense\", \"rawOff\" = \"meanPPA\")\n  \n  # same thing for raw defense\n  rawDef <- \n    pbp21 %>% \n    group_by(defense) %>% \n    summarize(meanPPA = mean(ppa)) %>%\n    rename(\"team\" = \"defense\", \"rawDef\" = \"meanPPA\")\n  \n  # bind everything together into one dataframe\n  if (wk == 1){\n    df <- \n      adjStats %>% \n      left_join(rawOff, by = \"team\") %>% \n      left_join(rawDef, by = \"team\") %>% \n      mutate(week = wk)}\n  else{\n    df_new <- \n      adjStats %>% \n      left_join(rawOff, by = \"team\") %>% \n      left_join(rawDef, by = \"team\") %>% \n      mutate(week = wk)\n    \n    df <- df %>% bind_rows(df_new)\n  }\n}\n\nhead(df)\n```\n\n## Animated Plot\n\nNow the visualization. I'll use `gganimate` to animate the plot and `ggimage` to render team icons on the plot.\n\n```{r warning=FALSE}\nlibrary(gganimate)\nlibrary(ggimage)\n```\n\nPerforming ridge regression caused a team names to get messed up if they had non alphanumeric characters, so I'll fix that. There's also no week 0 to use as a starting point, so to get them roughly centered, I'll just set them as the mean of week 1 stats. Lastly, I add the links to the team logos.\n\n```{r}\ndf <-\n  df %>% mutate(team = case_when(\n  team == \"Hawai i\" ~ \"Hawai'i\",\n  team == \"Miami  OH \" ~ \"Miami (OH)\",\n  team == \"Texas A M\" ~ \"Texas A&M\",\n  TRUE ~ team\n))\n\n# Add a week 0\ndf <-\n  tibble(team = fbs$school,\n         adjOff = df %>% filter(week == 1) %>% .$adjOff %>% mean(),\n         adjDef = df %>% filter(week == 1) %>% .$adjDef %>% mean(),\n         rawOff = 0,\n         rawDef = 0,\n         week = 0) %>% \n  bind_rows(df)\n\n# add logos\ndf <- df %>% \n  left_join(fbs %>% select(school, logo), by = c(\"team\" = \"school\"))\n```\n\nTo generate the plots with team logos, I use `geom_image()`, and the last 5 lines are used by `gganimate` in a later code chunk. This block of code is fast to execute.\n\n```{r}\nstats_plot <-\n  ggplot(df, aes(x=adjOff, y=adjDef)) +\n  geom_image(aes(image = logo, group = seq_along(logo))) +\n  theme_bw() +\n  scale_y_reverse() +\n  xlab(\"Adjusted Offense\") +\n  ylab(\"Adjusted Defense\") +\n  ggtitle(\"Week {closest_state}\") +\n  transition_states(week, transition_length = 3, state_length = 3, wrap = FALSE) +\n  ease_aes(\"linear\")\n```\n\nFinally I'll create the animated gif. It took my laptop about 15 minutes to generate the graphic. One thing that could be improved for efficiency is that the `logo` column contains URLs for the team logos. There are 130 logos and 16 weeks (including week 0), so I'm getting the same 130 logos 16 times when I should only need to get them once. I haven't worked out how to solve that yet, but for now at least I have something that works.\n\n```{r}\nanimate(stats_plot, \n        width = 800, height = 800, \n        fps = 10, nframes = 90, end_pause = 10)\n```\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"paged","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":false,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":true,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../styles.css"],"toc":true,"output-file":"index.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.280","editor":"visual","theme":{"dark":"darkly","light":"flatly"},"title":"Adjusted Statistics","description":"Adjusted statistics for college football teams based on strength of schedule.","author":"John King","date":"3/20/2022","categories":["R","ggplot2","college football","sports analytics"],"image":"teaser.gif","code-copy":true},"extensions":{"book":{"multiFile":true}}}}}