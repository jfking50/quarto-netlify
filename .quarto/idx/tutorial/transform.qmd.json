{"title":"Variable Transformation","markdown":{"yaml":{"title":"Variable Transformation","author":"John King","date":"5/25/2020","format":{"html":{"toc":true,"code-copy":true,"df-print":"paged"}},"execute":{"warning":false,"echo":true},"bibliography":"references.bib","link-citations":true},"headingText":"Identifying Non-Linear Relationships","containsRefs":false,"markdown":"\n\n```{r setup, include=FALSE}\nlibrary(Cairo)\n\nknitr::opts_chunk$set(\n  dev.args = list(png = list(type = \"cairo\"))\n  )\n```\n\nIf we have data that includes factors with more than two levels, we have the ability to evaluate non-linear relationships between predictor and response variables. Incorporating non-linear terms in a linear model is accomplished by transforming either the response or predictors. For an overview of transformation, read [Transformations: an introduction](http://fmwww.bc.edu/RePEc/bocode/t/transint.html) by Nicholas J. Cox at Durham University. Skip the section titled \"How to do transformations in Stata\"; we'll replace that with \"How to do transformations in *R*\" below.\n\n\nI think the simplest way to screen your data for potential non-linear relationships is with a pairs plot that includes a smoother. To demonstrate, I'll create data using a central composite design and add a response, y, that has a non-linear relationship with the `speed` and `stealth` factors. I also subtracted 2 from the stealth factor to center it at 0.\n\n```{r}\n#| message: false\n#| warning: false\nlibrary(tidyverse)\nlibrary(GGally)\n\nset.seed(42)\n\nccdGrid = tibble(\n  x1 = c(c(1,3,2,2,2,2,2), rep(c(1,3), 4)),\n  x2 = c(c(2,2,1,3,2,2,2), rep(c(1,3,1,3), each = 2)),\n  x3 = c(c(2,2,2,2,1,3,2), rep(1,4), rep(3,4)),\n  star = c(rep('y', 7), rep('n',8)),\n  line = c(rep('line1',2), rep('line2',2), rep('line3',2), rep('none',9))\n)\n\n\nccd = tibble(speed = ccdGrid$x1, \n             stealth = ccdGrid$x2 - 2, \n             surv = ccdGrid$x3, \n             y = log(speed) - stealth^2 + surv)\n\nsmooth_fn <- function(data, mapping, ...){\n  ggplot(data = data, mapping = mapping) + \n    geom_point() + \n    geom_smooth(formula = y~x, method=loess, fill=\"red\", color=\"red\", se=FALSE, ...)\n}\n\nggpairs(ccd, lower=list(continuous=smooth_fn), progress=FALSE) + theme_bw()\n```\n\nA visual inspection of the last row of plots is enough to identify the non-linear relationships that speed and stealth have with the response. We can also look at the density plot for the response (the lower right curve) and see some skewness away from a normal distribution.\n\n### Checking Model Structure\n\nGenerating a pairs plot is a screening process only. For a more complete analysis, we need to check the model structure. Recall that one of the key assumptions of the linear regression model is that the regression errors are independent and identically distributed. If that assumption is not true, then the non-linear portion of the relationship between predictor and response will be contained in the (estimated) residuals, $\\hat{\\varepsilon}$. Plotting the residuals versus the individual predictors is one method of checking model structure. In *R*, we can do this with `termplot`.\n\n```{r}\n# first, we need a linear model\nccd.lm = lm(y ~ ., data=ccd)\npar(mfrow=c(1,3))\ntermplot(ccd.lm, partial.resid = TRUE, col.res='blue', main=\"Residuals vs. Predictor\")\n```\n\nIn these plots, we're checking for whether there is a non-linear shape to the data by looking for trends in the blue circles. The red lines are the coefficients from the linear model for reference. The non-linear shape to stealth is clearly visible, but we're missing the non-linearity in speed. Unfortunately, partial residual plots only *suggest* transformations for the predictors because they are influenced by other predictor variables, and (if present) influential observations and multicollinearity. The process is done manually in *R*. First, since stealth appears to be an inverse square, we'll transform that variable, then re-fit the model, and check the partial residuals again. Before we do that, we need to know how to transform variables.\n\n### How To Transform Variables In *R*\n\nTo account for non-linear relationships in a linear model, we need to transform the variables in the `lm` function. From the partial residuals plot, we know we should try a quadratic term for stealth. Summaries of linear models without and then with the transformation are shown below for the `ccd` data.\n\nWithout transformation:\n\n```{r}\nccd.lm = lm(y ~ speed + stealth + surv, data = ccd)\nsummary(ccd.lm)\n```\n\nWith transformation:\n\n```{r}\nccd_t.lm = lm(y ~ speed + I(stealth^2) + surv, data = ccd)\nsummary(ccd_t.lm)\n```\n\nNotice in the call to `lm` with the transformed variables, the polynomial term is surrounded by `I()`. This is to avoid confusion between arithmetic and symbolic uses of `+` in the `formula` function (see `?formula` for more details). Let's take another look at the partial residual plots with stealth transformed.\n\n```{r}\npar(mfrow=c(1,3))\n\ntermplot(ccd_t.lm, \n         partial.resid = TRUE, \n         col.res='blue', \n         main=\"Residuals vs. Predictor\")\n```\n\nStealth looks much better, and now we're able to see the non-linear relationship with speed. Re-fit and plot again with a log transformation on speed.\n\n```{r}\nccd_t2.lm = lm(y ~ log(speed) + I(stealth^2) + surv, data = ccd)\n\npar(mfrow=c(1,3))\n\ntermplot(ccd_t2.lm, \n         partial.resid = TRUE, \n         col.res='blue', \n         main=\"Residuals vs. Predictor\")\n```\n\nI didn't add any error to the data, so we now have a perfect fit. With real-world data, there will be noise, and the best transformation isn't known in advance. The following chart from [Stats With Cats](https://statswithcats.wordpress.com/2010/11/21/fifty-ways-to-fix-your-data/) is a useful guide when determining what transformations to try.\n\n![](https://statswithcats.files.wordpress.com/2010/11/independent-variable-transformations.jpg)\n\nNow consider results from the 17-point NOLH we created earlier. I added a response, y, with a non-linear relationship to one of the factors, and I added some noise to make this example more realistic. Plotting just these two variables with a linear regression line reveals a little curvature to the trend, but it's not extreme.\n\n```{r}\n#| include: false\nset.seed(42)\nnolh = tibble(x = 1:17, \n              y = x + x^3 + rnorm(17, sd = 5)\n              )\n```\n\n```{r}\nnolh.lm1 = lm(y~x, data=nolh)\ntermplot(nolh.lm1, partial.resid = TRUE, col.res='blue')\n```\n\nWe've picked up the non-linear shape, and it looks like we need some degree of polynomial as a transformation. For reference, let's look at the linear model summary.\n\n```{r}\nsummary(nolh.lm1)\n```\n\nThat's not a bad fit, but we can probably improve it by trying a transformation. The curvature suggests a polynomial might be better, so let's try a second degree polynomial fit. First the plot, then the linear model summary.\n\n```{r}\n#| echo: false\nnolh.lm2 = lm(y ~ I(x^2), data=nolh)\n\ntermplot(nolh.lm2, partial.resid = TRUE, col.res='blue')\n\nsummary(nolh.lm2)\n```\n\nThe plot looks better than the first one. This model also has a higher $R^{2}$ than the first one, so perhaps it is a better fit. What happens if we continue to add higher order polynomials? The `poly()` function is useful for this purpose.\n\n```{r}\nnolh.poly = lm(y~poly(x, 15), data = nolh)\nsummary(nolh.poly)\n```\n\nWith a 15th order polynomial we get an $R^{2}$ of `r summary(nolh.poly)$adj.r.squared`, which is a nearly perfect fit. Notice the p-values, though. They indicate that the best model is actually the one with the second order term. Why is the best model not the one with the highest $R^{2}$? What we've done is over-fit the model to the data. We can see this by plotting the two polynomial fits.\n\n```{r}\n#| echo: false\nggplot(nolh) +\n  geom_point(aes(x=x, y=y)) +\n  geom_smooth(aes(x=x, y=y, color=\"2nd Order\"), formula=y~poly(x, 2), method=\"lm\", se=FALSE) +\n  geom_smooth(aes(x=x, y=y, color=\"15th Order\"), formula=y~poly(x, 15), method=\"lm\", se=FALSE) +\n  scale_colour_manual(name=\"Legend\", values=c(\"blue\", \"red\")) +\n  ggtitle(\"2nd vs. 15th Order Polynomial Fit\") +\n  theme_bw()\n```\n\nWhile the model with a 15th order polynomial perfectly fits these data, the model with the second order polynomial will generalize much better and is preferred.\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"paged","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../styles.css"],"toc":true,"output-file":"transform.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.280","editor":"visual","theme":{"dark":"darkly","light":"flatly"},"title":"Variable Transformation","author":"John King","date":"5/25/2020","bibliography":["references.bib"],"link-citations":true,"code-copy":true},"extensions":{"book":{"multiFile":true}}}}}