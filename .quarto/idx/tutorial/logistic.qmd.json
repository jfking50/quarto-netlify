{"title":"Logistic Regression","markdown":{"yaml":{"title":"Logistic Regression","author":"John King","date":"5/26/2020","format":{"html":{"toc":true,"code-copy":true,"df-print":"paged"}},"execute":{"warning":false,"echo":true},"bibliography":"references.bib","link-citations":true},"headingText":"Motivating Example","containsRefs":false,"markdown":"\n\n```{r setup, include=FALSE}\nlibrary(Cairo)\n\nknitr::opts_chunk$set(\n  echo = TRUE,\n  message=FALSE, \n  warning=FALSE,\n  dev.args = list(png = list(type = \"cairo\"))\n  )\n```\n\nSo far, we've seen regression techniques for continuous and categorical response variables. There is a different form of regression called logistic regression for the case when the response is a binary variable.\n\n\nThe need for a different type of regression can be seen using an example. We'll look at just one predictor (`age`) and the response (`chd`) in the `SAheart` dataset from the `bestglm` package. Here the response, `chd` is a binary variable indicating whether someone did (1) or did not (0) develop coronoary heart disease. For now, we'll just look at the first 20 observations with a scatter plot.\n\n```{r}\nlibrary(tidyverse)\n\nSAheart = bestglm::SAheart\n\n# look at the first 20 observations only and only age vs. chd\nsaheart = SAheart[1:21, c('age', 'chd')]\n\nggplot(saheart[1:20,], aes(x=age, y=chd)) +\n  geom_point() +\n  ylim(0, 1) +\n  theme_bw()\n```\n\nThere's a clear trend here - younger typically didn't have heart disease while older people did - but what exactly is the nature of the relationship? We can also think about this relationship in terms of probability. People under 20 have a virtually 0 probability of heart disease, and people over 60 have a near 1.0 probability of heart disease. But how do we connect those two extremes? If we assume there is a linear relationship, we'd get the following plot.\n\n```{r}\nggplot(saheart[1:20,], aes(x=age, y=chd)) +\n  geom_point() +\n  geom_smooth(formula = y ~ x, method=lm, se=FALSE) +\n  ylim(0, 1) +\n  theme_bw()\n```\n\nThe 21st observation happens to be associated with a 20-year old who happened to have heart disease. If we include this new observation and re-fit the linear regression line, we get the following.\n\n```{r}\nggplot(saheart[1:21,], aes(x=age, y=chd)) +\n  geom_point() +\n  geom_smooth(formula = y ~ x, method=lm, se=FALSE) +\n  ylim(0, 1) +\n  theme_bw()\n```\n\nAdding the single observation didn't give us any new information about the probability of heart disease for people in their 40s, 50, and 60s, but considerably changed the fit. Additionally, if we were to extend the regression line to the right to predict the probability of heart disease of an 80-year old, we'd get a probability \\> 1. For these reasons, linear regression doesn't model the relationship well, so we need to find something better.\n\n### Logit Function\n\nAn alternative to linear regression is to use a *logit function*, $\\eta$ to replace $y$ in the linear regression equation.\n\n$$\\eta = \\beta_{0}+\\beta_{1}x_{1}+...+\\beta_{i}x_{i}+\\varepsilon$$\n\nwhere,\n\n$$\\eta = log\\left\\lgroup{\\frac{p}{1-p}}\\right\\rgroup$$\n\nand where $p$ is the probability of heart disease. In this form $\\eta$ can also be thought of in terms of $log(odds)$. To enforce $0\\le p \\le 1$, we further define $p$ as:\n\n$$p=\\frac{e^{\\eta}}{1+e^{\\eta}}$$\n\nWith one predictor, as in our case, we can rewrite this to become:\n\n$$p=\\frac{e^{\\beta_{0}+\\beta_{1}x_{1}}}{1+e^{\\beta_{0}+\\beta_{1}x_{1}}}$$\n\nIf we now set $\\beta_{0}=0$ and allow $\\beta_{1}$ to vary, we can see the shape of the response for different coefficient values.\n\n```{r}\n#| echo: false\ntibble(\n  x = seq(-5,5,0.1),\n  b05 = exp(0.5*x) / (1+exp(0.5*x)),\n  b1 = exp(x) / (1+exp(x)),\n  b5 = exp(5*x) / (1+exp(5*x))) %>%\nggplot() +\n  geom_line(aes(x=x, y=b05, linetype='beta_1 = 0.05'), color='blue') +\n  geom_line(aes(x=x, y=b1, linetype='beta_1 = 0.5'), color='blue') +\n  geom_line(aes(x=x, y=b5, linetype='beta_1 = 5'), color='blue') +\n  ylab(\"p\") +\n  scale_linetype_manual(name=\"Legend\", values=c(1,2,3)) +\n  theme_bw()\n```\n\nNote that if $\\beta_{1}=0$, that is the equivalent of saying that $p$ is not a function of $x$. The reverse (allowing $\\beta_{0}$ to vary while holding $\\beta_{1}=1$), shifts the curve horizontally.\n\n```{r}\n#| echo: false\ntibble(\n  x = seq(-10,10,0.1),\n  b7 = exp(-5+x) / (1+exp(-5+x)),\n  b0 = exp(x) / (1+exp(x)),\n  b2 = exp(2+x) / (1+exp(2+x))) %>%\nggplot() +\n  geom_line(aes(x=x, y=b7, linetype='beta_0 = -5'), color='blue') +\n  geom_line(aes(x=x, y=b0, linetype='beta_0 = 0'), color='blue') +\n  geom_line(aes(x=x, y=b2, linetype='beta_0 = 1'), color='blue') +\n  ylab(\"p\") +\n  scale_linetype_manual(name=\"Legend\", values=c(1,2,3)) +\n  theme_bw()\n```\n\n### Logistic Regression in *R*\n\nTo fit a logistic regression model in *R*, use `glm()` instead of `lm()` and specify `family=binomial`.\n\n```{r}\nsa.glm = glm(chd~age, family=binomial, data=SAheart)\nsummary(sa.glm)\n```\n\nFrom the summary, we see that $\\beta_{0} = -3.522$ and $\\beta_{1} = 0.064$, which gives us the equation for the estimated linear predictor:\n\n$$\\hat{\\eta} = -3.522 + 0.064x$$\n\nand the equation for the fitted probabilities.\n\n$$\\hat{p}=\\frac{e^{-3.522 + 0.064x}}{1+e^{-3.522 + 0.064x}}$$\n\nGiven a 40-year old, we find $\\hat{\\eta}=$ `r -3.522+0.064*(40)` and $\\hat{p}=$ `r exp(-3.522+0.064*(40)) / (1+exp(-3.522+0.064*(40)))`. This highlights an important distinction when using `predict()` with a binomial response. To calculate $\\hat{\\eta}$:\n\n```{r}\npredict(sa.glm, newdata=tibble(age=40))\n```\n\nbut to calculate $\\hat{p}$, we need to specify `type = \"response\"`.\n\n```{r}\np.hat = predict(sa.glm, newdata=tibble(age=40), type=\"response\")\np.hat\n```\n\nWe can see that this is a much lower estimate of the probability of heart disease than was estimated by the linear model produced by `lm()`. Since $\\beta_{0}$ is negative, the regression curve will be shifted to the right of the mean age, and a low value for $\\beta_{1}$ will stretch out the \"s\" curve. A plot of $\\hat{p}$ versus age with the binomial regression curve and our estimated probability for a 40-year old is shown below.\n\n```{r}\nages = seq(10, 80, length.out = nrow(SAheart))\npred = tibble(\n  p = predict(sa.glm, newdata=tibble(age=ages), type=\"response\"),\n  se = predict(sa.glm, newdata=tibble(age=ages), type=\"response\", se=TRUE)$se, # standard error\n  age = ages\n)\n\nggplot() +\n  geom_line(data = pred, aes(x=age, y=p), color='blue') +\n  geom_line(data = pred, aes(x=age, y=p+se), color='blue', linetype=3, size=0.5) +\n  geom_line(data = pred, aes(x=age, y=p-se), color='blue', linetype=3, size=0.5) +\n  geom_jitter(data = SAheart, aes(x=age, y=chd), shape=124, size = 4, width=0.2, height=0, alpha=0.5) +\n  geom_segment(aes(x=40, xend=40, y=0, yend=p.hat), color='red', linetype=2, size=0.5) +\n  geom_segment(aes(x=10, xend=40, y=p.hat, yend=p.hat), color='red', linetype=2, size=0.5) +\n  xlab(\"Age (years)\") +\n  ylab(\"Heart Disease (1=yes, 0=no)\\n p.hat\") +\n  theme_bw()\nrm(ages, p.hat)\n```\n\n### Logistic Regression Diagnostics\n\nDiagnostics for logistic regression follows the same philosophy as linear regression: we will check the model assumptions and look for outliers and high leverage observations. First, we'll look for violations of the equal variance assumption, but instead of using the raw residuals as we did in linear regression, we need to look at the *deviance residuals*. For logistic regression, we have the following definitions:\n\n-   Fitted values are $\\hat{\\eta} = \\hat{\\beta_0} + \\sum_{i=1}^n \\hat{\\beta_i}x_i$\n-   Raw residuals are $e_{i} = y_{i} - \\hat{p_{i}}$\n-   Deviance residuals are $r_{i} = sign(y_{i}-\\hat{p_{i}}) \\sqrt{-2 \\left\\{y_{i} ln(\\hat{p_{i}}) + (1-y_{i}) ln(1-\\hat{p_{i}})\\right\\}}$\n    -   where $y_{i}$ is either 0 or 1, so if $y_{i}=0$, then $sign() = +$\n\nAs with linear model diagnostics, we can plot fitted values and deviance residuals; however, the plot is not particularly useful. Note that the upper row of points correspond to $y_{i}=1$, and the lower row to $y_{i}=0$. With a sufficiently large dataset, we can generate a more useful diagnostic plot by binning the observations based on their predicted value, and calculating the mean deviance residual for each bin.\n\n```{r}\ndf = tibble(\n  resid = residuals(sa.glm), # for raw residuals, specify residuals(sa.glm, type = \"response\")\n  preds = predict(sa.glm))\n\nggplot(df) +\n  geom_rect(aes(xmin=-2.2, xmax=-1.8, ymin=-0.8, ymax=2.2), fill='lightgray', alpha=0.5) +\n  geom_point(aes(x=preds, y=resid)) +\n  annotate(\"text\", x=-2, y=1, label=\"Example\\nBin\") +\n    xlab(\"Fitted Linear Predictor\") +\n    ylab(\"Deviance Residuals\") +\n    theme_bw()\n\n# alternatively, plot(sa.glm, which=1)\n```\n\nA general guideline is to create bins with at least 30 observations each, which for the `SAheart` dataset, means `462 %/% 30 = 15` bins. Now we have a much more useful diagnostic plot.\n\n```{r}\ndf = df %>%\n  arrange(preds) %>%\n  mutate(bin = c(rep(1:15, each=30), rep(15, nrow(SAheart)-15*30)))\n\ndf %>%\n  group_by(bin) %>%\n  summarize(\n    meanResid = mean(resid),\n    meanPred = mean(preds), .groups = 'drop') %>%\n  ggplot() +\n    geom_point(aes(x=meanPred, y=meanResid)) +\n    xlab(\"Fitted Linear Predictor\") +\n    ylab(\"Deviance Residuals\") +\n    theme_bw()\n```\n\nWe identify unusual observations in logistic regression the same way as we did with linear regression but with slightly different definitions for residuals. We already covered raw residuals and deviance residuals. If we now represent the deviance residuals as $r_{D}$, then we have the following additional definitions:\n\n| Term                            |                         Definition                         |             *R* Command             |\n|-----------------|:------------------------:|:---------------------------:|\n| Standardized deviance residuals |             $r_{SD}=\\frac{r_{D}}{\\sqrt{1-h}}$              |         `rstandard(sa.glm)`         |\n| Pearson residuals               |    $r_{P}=\\frac{y-\\hat{p}}{\\sqrt{\\hat{p}(1-\\hat{p})}}$     | `residuals(sa.glm, type=\"pearson\")` |\n| Pearson standardized residuals  |             $r_{SP}=\\frac{r_{P}}{\\sqrt{1-h}}$              |                none                 |\n| Cook's Distance                 | $D=\\frac{(r_{SP})^{2}}{q+1} \\left({\\frac{h}{1-h}} \\right)$ |      `cooks.distance(sa.glm)`       |\n\nApply the same rules of thumb when identifying unusual observations as with linear regression.\n\nLastly, we can assess the goodness of fit for a model using several methods. A simple approximation akin to measuring $R^2$ is:\n\n$$R^{2}=\\frac{D_{NULL}-D}{D_{NULL}}$$\n\nwhere $D_{NULL}$ is the null model devience (i.e., the total sum of squares) and $D$ is the logistic regression model deviance. From the calculation below, we find that approximately 12% of the variance in `chd` is explained by `age`.\n\n```{r}\n(sa.glm$null - sa.glm$dev) / sa.glm$null\n```\n\n@faraway2006 proposes a more sophisticated measure:\n\n$$R^{2}=\\frac{1 - exp\\left\\{ (D-D_{NULL})/N \\right\\}} {1 - exp\\left\\{-D_{NULL}/N \\right\\}}$$\n\nwhere $N$ is the number of binary trials.\n\n```{r}\n(1-exp( (sa.glm$dev - sa.glm$null)/nrow(SAheart))) / (1-exp( (- sa.glm$null)/nrow(SAheart)))\n```\n\nLastly, there's the Hosmer-Lemeshow goodness of fit test where the null hypothesis is the the model fit is \"good\", and the alternative hypothesis is the the model is saturated (i.e, not a good fit). For our example, we fail to reject the null hypothesis at the 95% confidence level. For a detailed treatment of the test, read [this article](https://en.wikipedia.org/wiki/Hosmer%E2%80%93Lemeshow_test).\n\n```{r}\nlibrary(ResourceSelection)\n\np.hat = predict(sa.glm, type=\"response\")\nhoslem.test(SAheart$chd, p.hat)\n```\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"paged","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../styles.css"],"toc":true,"output-file":"logistic.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.280","editor":"visual","theme":{"dark":"darkly","light":"flatly"},"title":"Logistic Regression","author":"John King","date":"5/26/2020","bibliography":["references.bib"],"link-citations":true,"code-copy":true},"extensions":{"book":{"multiFile":true}}}}}