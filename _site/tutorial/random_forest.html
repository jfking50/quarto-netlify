<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="John King">
<meta name="dcterms.date" content="2020-06-01">

<title>A Random Walk - Random Forests</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../tutorial/nn_regression.html" rel="next">
<link href="../tutorial/svm.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script src="../site_libs/htmlwidgets-1.6.0/htmlwidgets.js"></script>
<script src="../site_libs/plotly-binding-4.10.1/plotly.js"></script>
<script src="../site_libs/typedarray-0.1/typedarray.min.js"></script>
<script src="../site_libs/jquery-3.5.1/jquery.min.js"></script>
<link href="../site_libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="../site_libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>
<link href="../site_libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="../site_libs/plotly-main-2.11.1/plotly-latest.min.js"></script>
<link href="../site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="../site_libs/pagedtable-1.1/js/pagedtable.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">A Random Walk</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorials" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Tutorials</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tutorials">    
        <li>
    <a class="dropdown-item" href="../tutorial/slr.html">
 <span class="dropdown-text">Simple Linear Regression</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorial/lm_assumptions.html">
 <span class="dropdown-text">Linear Model Assumptions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorial/mlr.html">
 <span class="dropdown-text">Multiple Linear Regression</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorial/model_selection.html">
 <span class="dropdown-text">Model Selection</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorial/transform.html">
 <span class="dropdown-text">Variable Transformation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorial/logistic.html">
 <span class="dropdown-text">Logistic Regression</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorial/advanced.html">
 <span class="dropdown-text">Advanced Designs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorial/np_anova.html">
 <span class="dropdown-text">Nonparametric ANOVA</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorial/gam.html">
 <span class="dropdown-text">Generalized Additive Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorial/svm.html">
 <span class="dropdown-text">Support Vector Machines</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorial/random_forest.html">
 <span class="dropdown-text">Random Forests</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorial/nn_regression.html">
 <span class="dropdown-text">Neural Network Regression</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-presentations" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Presentations</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-presentations">    
        <li>
    <a class="dropdown-item" href="../presentations/doe.qmd">
 <span class="dropdown-text">Design of Experiments</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../blog.html">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jfking50"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Random Forests</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorial/slr.html" class="sidebar-item-text sidebar-link">Simple Linear Regression</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorial/lm_assumptions.html" class="sidebar-item-text sidebar-link">Linear Model Assumptions</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorial/mlr.html" class="sidebar-item-text sidebar-link">Multiple Linear Regression</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorial/model_selection.html" class="sidebar-item-text sidebar-link">Model Selection</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorial/transform.html" class="sidebar-item-text sidebar-link">Variable Transformation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorial/logistic.html" class="sidebar-item-text sidebar-link">Logistic Regression</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorial/advanced.html" class="sidebar-item-text sidebar-link">Advanced Designs</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorial/np_anova.html" class="sidebar-item-text sidebar-link">Nonparametric ANOVA</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorial/gam.html" class="sidebar-item-text sidebar-link">Generalized Additive Models</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorial/svm.html" class="sidebar-item-text sidebar-link">Support Vector Machines</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorial/random_forest.html" class="sidebar-item-text sidebar-link active">Random Forests</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorial/nn_regression.html" class="sidebar-item-text sidebar-link">Neural Network Regression</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#regression-trees" id="toc-regression-trees" class="nav-link active" data-scroll-target="#regression-trees">Regression Trees</a></li>
  <li><a href="#random-forest-regression" id="toc-random-forest-regression" class="nav-link" data-scroll-target="#random-forest-regression">Random Forest Regression</a></li>
  <li><a href="#random-forest-classification" id="toc-random-forest-classification" class="nav-link" data-scroll-target="#random-forest-classification">Random Forest Classification</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Random Forests</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>John King </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 1, 2020</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>As with support vector machines, and as the name implies, classification and regression trees (CART) can be used for either classification or regression tasks. Again, we’ll start with regression and then move to classification.</p>
<section id="regression-trees" class="level3">
<h3 class="anchored" data-anchor-id="regression-trees">Regression Trees</h3>
<p>The algorithm is best explained as we walk through an example, and we’ll continue to use the <code>airquality</code> data set. The basic machine learning algorithm used in tree-based methods follows these steps:</p>
<ol type="1">
<li><p>Consider the entire data set including all predictors and the response. We call this the <strong>root node</strong>, and it is represented by the top center node in the figure below. The information displayed in the node includes the mean response for that node (42.1 is the mean of <code>Ozone</code> for the whole data set), the number of observations in the node (<code>n=116</code>), and the percent of the overall observations in the node.</p></li>
<li><p>Iterate through each predictor, <span class="math inline">\(k\)</span>, and split the data into two subsets (referred to as the left and right <strong>child nodes</strong>) using some threshold, <span class="math inline">\(t_k\)</span>. For example, with the <code>airquality</code> data set, the predictor and threshold could be <code>Temp &gt;= 83</code>. The choice of <span class="math inline">\(k\)</span> and <span class="math inline">\(t_k\)</span> for a given split is the pair that increases the “purity” of the child nodes (weighted by their size) the most. We’ll explicitly define purity shortly. If you equate a data split with a decision, then at this point, we have a basic decision tree.</p></li>
</ol>
<div class="cell">
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<ol start="3" type="1">
<li>Each child node in turn becomes the new parent node and the process is repeated. Below is the decision tree produced by the first two splits. Notice that the first split is on the <code>Temp</code> predictor, and the second split is on the <code>Wind</code> predictor. Although we don’t have coefficients for these two predictors like we would in a linear model, we can still interpret the order of the splits as the predictor’s relative significance. In this case, <code>Temp</code> is the most significant predictor of <code>Ozone</code> followed by <code>Wind</code>. After two splits, the decision tree has three <strong>leaf nodes</strong>, which are those in the bottom row. We can also define the <strong>depth</strong> of the tree as the number rows in the tree below the root node (in this case depth = 2). Note that the sum of the observations in the leaf nodes equals the total number of observations (69 + 10 + 37 = 116), and so the percentages shown in the leaf nodes sum to 100%.</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<ol start="4" type="1">
<li>Continuing the process once more, we see that the third split is again on <code>Temp</code> but at a different <span class="math inline">\(t_k\)</span>.</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>If we continued to repeat the process until each observation was in its own node, then we would have drastically over-fit the model. To control over-fitting, we stop the splitting process when some user-defined condition (or set of conditions) is met. Example stopping conditions include a minimum number of observations in a node or a maximum depth of the tree. We can also use cross validation with a 1 standard error rule to limit the complexity of the final model.</p>
<p>We’ll stop at this point and visually represent this model as a scatter plot. The above leaves from left to right are labeled as Leaf 1 - 4 on the scatter plot.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Plotting predicted <code>Ozone</code> on the z-axis produces the following response surface, which highlights the step-like characteristic of regression tree predictions.</p>
<div class="cell">
<div class="cell-output-display">
<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-5249e8e8f8bb0bce3ec2" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-5249e8e8f8bb0bce3ec2">{"x":{"visdat":{"26584c71491c":["function () ","plotlyVisDat"],"265810a83aa4":["function () ","data"]},"cur_data":"265810a83aa4","attrs":{"26584c71491c":{"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21],"y":[57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97],"z":{},"type":"surface","opacity":0.9,"showlegend":false,"inherit":true},"265810a83aa4":{"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"x":{},"y":{},"z":{},"type":"scatter3d","mode":"markers","marker":{"color":"black","size":3},"showlegend":false,"inherit":true}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"CART Response Surface","showlegend":false,"scene":{"xaxis":{"title":"Wind"},"yaxis":{"title":"Temp"},"zaxis":{"title":"z"}},"hovermode":"closest"},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"colorbar":{"title":"z<br />Ozone","ticklen":2},"colorscale":[["0","rgba(68,1,84,1)"],["0.0416666666666667","rgba(70,19,97,1)"],["0.0833333333333333","rgba(72,32,111,1)"],["0.125","rgba(71,45,122,1)"],["0.166666666666667","rgba(68,58,128,1)"],["0.208333333333333","rgba(64,70,135,1)"],["0.25","rgba(60,82,138,1)"],["0.291666666666667","rgba(56,93,140,1)"],["0.333333333333333","rgba(49,104,142,1)"],["0.375","rgba(46,114,142,1)"],["0.416666666666667","rgba(42,123,142,1)"],["0.458333333333333","rgba(38,133,141,1)"],["0.5","rgba(37,144,140,1)"],["0.541666666666667","rgba(33,154,138,1)"],["0.583333333333333","rgba(39,164,133,1)"],["0.625","rgba(47,174,127,1)"],["0.666666666666667","rgba(53,183,121,1)"],["0.708333333333333","rgba(79,191,110,1)"],["0.75","rgba(98,199,98,1)"],["0.791666666666667","rgba(119,207,85,1)"],["0.833333333333333","rgba(147,214,70,1)"],["0.875","rgba(172,220,52,1)"],["0.916666666666667","rgba(199,225,42,1)"],["0.958333333333333","rgba(226,228,40,1)"],["1","rgba(253,231,37,1)"]],"showscale":true,"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21],"y":[57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97],"z":[[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[55.6,55.6,55.6,55.6,55.6,55.6,55.6,55.6,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333,22.3333333333333],[62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95],[62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95],[62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95],[62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95],[62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95,62.95],[90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118],[90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118],[90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118],[90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118],[90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118],[90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118],[90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118],[90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118],[90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118],[90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118,90.0588235294118]],"type":"surface","opacity":0.9,"showlegend":false,"frame":null},{"x":[7.4,8,12.6,11.5,8.6,13.8,20.1,9.7,9.2,10.9,13.2,11.5,12,18.4,11.5,9.7,9.7,16.6,9.7,12,12,14.9,5.7,7.4,9.7,13.8,11.5,8,14.9,20.7,9.2,11.5,10.3,4.1,9.2,9.2,4.6,10.9,5.1,6.3,5.7,7.4,14.3,14.9,14.3,6.9,10.3,6.3,5.1,11.5,6.9,8.6,8,8.6,12,7.4,7.4,7.4,9.2,6.9,13.8,7.4,4,10.3,8,11.5,11.5,9.7,10.3,6.3,7.4,10.9,10.3,15.5,14.3,9.7,3.4,8,9.7,2.3,6.3,6.3,6.9,5.1,2.8,4.6,7.4,15.5,10.9,10.3,10.9,9.7,14.9,15.5,6.3,10.9,11.5,6.9,13.8,10.3,10.3,8,12.6,9.2,10.3,10.3,16.6,6.9,14.3,8,11.5],"y":[67,72,74,62,65,59,61,69,66,68,58,64,66,57,68,62,59,73,61,61,67,81,79,76,82,90,87,82,77,72,65,73,76,84,85,81,83,83,88,92,92,89,73,81,80,81,82,84,87,85,74,86,85,82,86,88,86,83,81,81,81,82,89,90,90,86,82,80,77,79,76,78,78,77,72,79,81,86,97,94,96,94,91,92,93,93,87,84,80,78,75,73,81,76,77,71,71,78,67,76,68,82,64,71,81,69,63,70,75,76,68],"z":[41,36,12,18,23,19,8,16,11,14,18,14,34,6,30,11,1,11,4,32,23,45,115,37,29,71,39,23,21,37,20,12,13,135,49,32,64,40,77,97,97,85,10,27,7,48,35,61,79,63,16,80,108,20,52,82,50,64,59,39,9,16,122,89,110,44,28,65,22,59,23,31,44,21,9,45,168,73,76,118,84,85,96,78,73,91,47,32,20,23,21,24,44,21,28,9,13,46,18,13,24,16,13,23,36,7,14,30,14,18,20],"type":"scatter3d","mode":"markers","marker":{"color":"black","size":3,"line":{"color":"rgba(255,127,14,1)"}},"showlegend":false,"error_y":{"color":"rgba(255,127,14,1)"},"error_x":{"color":"rgba(255,127,14,1)"},"line":{"color":"rgba(255,127,14,1)"},"frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Plotting just <code>Temp</code> versus <code>Ozone</code> in two dimensions further highlights a difference between this method and linear regression. From this plot we can infer that linear regression may outperform CART if there is a smooth trend in the relationship between the predictors and response because CART does not produce smooth estimates.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="impurity-measure" class="level4">
<h4 class="anchored" data-anchor-id="impurity-measure">Impurity Measure</h4>
<p>Previously, it was stated that the predictor-threshold pair chosen for a split was the pair that most increased the purity (or, decreased the impurity) of the child nodes. A node with all identical response values will have an impurity of 0, so that as a node becomes more impure, it’s impurity value increases. We will then define a node’s impurity to be proportional to the <strong>residual deviance</strong>, which for a continuous response variable like <code>Ozone</code>, is the residual sum of squares (RSS).</p>
<p><span class="math display">\[RSS = \sum\limits_{i\:in\: Node}{(y_{i} - \bar{y})^2}\]</span></p>
<p>where <span class="math inline">\(\bar{y}\)</span> is the mean of the y’s in the node.</p>
<p>We’ll start with the first split. To determine which predictor-threshold pair decreases impurity the most, start with the first factor, send the lowest <code>Ozone</code> value to the left node and the remainder to the right node, and calculate RSS for each child node (<span class="math inline">\(RSS_{left}\)</span> and <span class="math inline">\(RSS_{right}\)</span>). The decrease in impurity for this split is <span class="math inline">\(RSS_{root} - (RSS_{left} + RSS_{right})\)</span>. Then send the lowest two <code>Ozone</code> values to the left node and the remainder to the right. Repeat this process for each predictor-threshold pair, and split the data based using the pair that decreased impurity the most. Any regression tree package will iterate through all of these combinations for you, but to demonstrate the process explicitly, We’ll just consider the <code>Temp</code> predictor for the first split.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we'll do a lot of filtering, so convert dataframe to tibble for convenience</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we'll also drop the NA's for the calculations (but the regression tree</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># methodology itself doesn't care if there are NA's or not)</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>aq  <span class="ot">=</span> <span class="fu">as_tibble</span>(airquality) <span class="sc">%&gt;%</span> <span class="fu">drop_na</span>(Ozone)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># root node deviance</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>root_dev <span class="ot">=</span> <span class="fu">sum</span>((aq<span class="sc">$</span>Ozone <span class="sc">-</span> <span class="fu">mean</span>(aq<span class="sc">$</span>Ozone))<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># keep track of the highest decrease</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>best_split <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># iterate through all the unique Temp values</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(s <span class="cf">in</span> <span class="fu">sort</span>(<span class="fu">unique</span>(aq<span class="sc">$</span>Temp))){</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  left_node <span class="ot">=</span> aq <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Temp <span class="sc">&lt;=</span> s) <span class="sc">%&gt;%</span> .<span class="sc">$</span>Ozone</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  left_dev <span class="ot">=</span> <span class="fu">sum</span>((left_node <span class="sc">-</span> <span class="fu">mean</span>(left_node))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  right_node <span class="ot">=</span> aq <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Temp <span class="sc">&gt;</span> s) <span class="sc">%&gt;%</span> .<span class="sc">$</span>Ozone</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  right_dev <span class="ot">=</span> <span class="fu">sum</span>((right_node <span class="sc">-</span> <span class="fu">mean</span>(right_node))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  split_dev <span class="ot">=</span> root_dev <span class="sc">-</span> (left_dev <span class="sc">+</span> right_dev)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(split_dev <span class="sc">&gt;</span> best_split){</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    best_split <span class="ot">=</span> split_dev</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    temp <span class="ot">=</span> s <span class="sc">+</span> <span class="dv">1</span>}  <span class="co"># + 1 because we filtered Temp &lt;= s and Temp is integer</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Best split at Temp &lt;"</span>, temp), <span class="at">quote=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] Best split at Temp &lt; 83</code></pre>
</div>
</div>
</section>
<section id="tree-deviance" class="level4">
<h4 class="anchored" data-anchor-id="tree-deviance">Tree Deviance</h4>
<p>Armed with our impurity measure, we can also calculate the tree deviance, which we’ll use to calculate the regression tree equivalent of <span class="math inline">\(R^2\)</span>. For the tree with the four leaf nodes, we calculate the deviance for each leaf.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># leaf 1</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>leaf_1 <span class="ot">=</span> aq <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Temp <span class="sc">&lt;</span> <span class="dv">83</span> <span class="sc">&amp;</span> Wind <span class="sc">&gt;=</span> <span class="fl">7.15</span>) <span class="sc">%&gt;%</span> .<span class="sc">$</span>Ozone</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>leaf_1_dev <span class="ot">=</span> <span class="fu">sum</span>((leaf_1 <span class="sc">-</span> <span class="fu">mean</span>(leaf_1))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># leaf 2</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>leaf_2 <span class="ot">=</span> aq <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Temp <span class="sc">&lt;</span> <span class="dv">83</span> <span class="sc">&amp;</span> Wind <span class="sc">&lt;</span> <span class="fl">7.15</span>) <span class="sc">%&gt;%</span> .<span class="sc">$</span>Ozone</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>leaf_2_dev <span class="ot">=</span> <span class="fu">sum</span>((leaf_2 <span class="sc">-</span> <span class="fu">mean</span>(leaf_2))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># leaf 3</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>leaf_3 <span class="ot">=</span> aq <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Temp <span class="sc">&gt;=</span> <span class="dv">83</span> <span class="sc">&amp;</span> Temp <span class="sc">&lt;</span> <span class="dv">88</span>) <span class="sc">%&gt;%</span> <span class="fu">drop_na</span>(Ozone) <span class="sc">%&gt;%</span> .<span class="sc">$</span>Ozone</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>leaf_3_dev <span class="ot">=</span> <span class="fu">sum</span>((leaf_3 <span class="sc">-</span> <span class="fu">mean</span>(leaf_3))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># leaf 4</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>leaf_4 <span class="ot">=</span> aq <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Temp <span class="sc">&gt;=</span> <span class="dv">88</span>) <span class="sc">%&gt;%</span> <span class="fu">drop_na</span>(Ozone) <span class="sc">%&gt;%</span> .<span class="sc">$</span>Ozone</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>leaf_4_dev <span class="ot">=</span> <span class="fu">sum</span>((leaf_4 <span class="sc">-</span> <span class="fu">mean</span>(leaf_4))<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The tree deviance is the sum of the leaf node deviances, which we use to determine how much the entire tree decreases the root deviance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>tree_dev <span class="ot">=</span> <span class="fu">sum</span>(leaf_1_dev, leaf_2_dev, leaf_3_dev, leaf_4_dev)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>(root_dev <span class="sc">-</span> tree_dev) <span class="sc">/</span> root_dev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6119192</code></pre>
</div>
</div>
<p>The tree decreases the root deviance by 61.2%, which also means that 61.2% of the variability in <code>Ozone</code> is explained by the tree.</p>
</section>
<section id="prediction" class="level4">
<h4 class="anchored" data-anchor-id="prediction">Prediction</h4>
<p>Making a prediction with a new value is easy as following the logic of the decision tree until you end up in a leaf node. The mean of the response values for that leaf node is the prediction for the new value.</p>
</section>
<section id="pros-and-cons" class="level4">
<h4 class="anchored" data-anchor-id="pros-and-cons">Pros And Cons</h4>
<p>Regression trees have a lot of good things going for them:</p>
<ul>
<li>They are easy to explain combined with an intuitive graphic output</li>
<li>They can handle categorical and numeric predictor and response variables</li>
<li>They easily handle missing data</li>
<li>They are robust to outliers</li>
<li>They make no assumptions about normality</li>
<li>They can accommodate “wide” data (more predictors than observations)</li>
<li>They automatically include interactions</li>
</ul>
<p>Regression trees by themselves and as presented so far have two major drawbacks:</p>
<ul>
<li>They do not tend to perform as well as other methods (but there’s a plan for this that makes them one of the best prediction methods around)</li>
<li>They do not capture simple additive structure (there’s a plan for this, too)</li>
</ul>
</section>
<section id="regression-trees-in-r" class="level4">
<h4 class="anchored" data-anchor-id="regression-trees-in-r">Regression Trees in <em>R</em></h4>
<p>The regression trees shown above were grown using the <code>rpart</code> and <code>rpart.plot</code> packages. I didn’t show the code so that we could focus on the algorithm first. Growing a regression tree is as easy as a linear model. The object created by <code>rpart()</code> contains some useful information.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>aq.tree <span class="ot">=</span> <span class="fu">rpart</span>(Ozone <span class="sc">~</span> ., <span class="at">data=</span>airquality)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>aq.tree</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>n=116 (37 observations deleted due to missingness)

node), split, n, deviance, yval
      * denotes terminal node

 1) root 116 125143.1000 42.12931  
   2) Temp&lt; 82.5 79  42531.5900 26.54430  
     4) Wind&gt;=7.15 69  10919.3300 22.33333  
       8) Solar.R&lt; 79.5 18    777.1111 12.22222 *
       9) Solar.R&gt;=79.5 51   7652.5100 25.90196  
        18) Temp&lt; 77.5 33   2460.9090 21.18182 *
        19) Temp&gt;=77.5 18   3108.4440 34.55556 *
     5) Wind&lt; 7.15 10  21946.4000 55.60000 *
   3) Temp&gt;=82.5 37  22452.9200 75.40541  
     6) Temp&lt; 87.5 20  12046.9500 62.95000  
      12) Wind&gt;=8.9 7    617.7143 45.57143 *
      13) Wind&lt; 8.9 13   8176.7690 72.30769 *
     7) Temp&gt;=87.5 17   3652.9410 90.05882 *</code></pre>
</div>
</div>
<p>First, we see that the NAs were deleted, and then we see the tree structure in a text format that includes the node number, how the node was split, the number of observations in the node, the deviance, and the mean response. To plot the tree, use <code>rpart.plot()</code> or <code>prp()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(aq.tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><code>rpart.plot()</code> provides several options for customizing the plot, among them are <code>digits</code>, <code>type</code>, and <code>extra</code>, which I invoked to produce the earlier plots. Refer to the help to see all of the options.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(aq.tree, <span class="at">digits =</span> <span class="dv">3</span>, <span class="at">type=</span><span class="dv">4</span>, <span class="at">extra=</span><span class="dv">101</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Another useful function is <code>printcp()</code>, which provides a deeper glimpse into what’s going on in the algorithm. Here we see that just three predictors were used to grow the tree (<code>Solar.R</code>, <code>Temp</code>, and <code>Wind</code>). This means that the other predictors did not significantly contribute to increasing node purity, which is equivalent to a predictor in a linear model with a high p-value. We also see the root node error (weighted by the number of observations in the root node).</p>
<p>In the table, <code>printcp()</code> provides optimal tuning based on a <strong>complexity parameter</strong> (<code>CP</code>), which we can manipulate to manually “prune” the tree, if desired. The relative error column is the amount of reduction in root deviance for each split. For example, in our earlier example with three splits and four leaf nodes, we had a 61.2% reduction in root deviance, and below we see that at an <code>nsplit</code> of 3, we also get <span class="math inline">\(1.000 - 0.388 = 61.2\)</span>%.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> <code>xerror</code> and <code>xstd</code> are cross-validation error and standard deviation, respectfully, so we get cross validation built-in for free!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">printcp</span>(aq.tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Regression tree:
rpart(formula = Ozone ~ ., data = airquality)

Variables actually used in tree construction:
[1] Solar.R Temp    Wind   

Root node error: 125143/116 = 1078.8

n=116 (37 observations deleted due to missingness)

        CP nsplit rel error  xerror    xstd
1 0.480718      0   1.00000 1.01137 0.16829
2 0.077238      1   0.51928 0.56189 0.17935
3 0.053962      2   0.44204 0.60667 0.18095
4 0.025990      3   0.38808 0.52541 0.15202
5 0.019895      4   0.36209 0.50832 0.14892
6 0.016646      5   0.34220 0.48282 0.13541
7 0.010000      6   0.32555 0.47948 0.13535</code></pre>
</div>
</div>
<p>With <code>plotcp()</code> we can see the 1 standard error rule implemented in the same manner we’ve seen before to identify the best fit model. At the top of the plot, the number of splits is displayed so that we can choose two splits when defining the best fit model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotcp</span>(aq.tree, <span class="at">upper =</span> <span class="st">"splits"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Specify the best fit model using the <code>cp</code> parameter with a value slightly greater than shown in the table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>best_aq.tree <span class="ot">=</span> <span class="fu">rpart</span>(Ozone <span class="sc">~</span> ., <span class="at">cp=</span><span class="fl">0.055</span>, <span class="at">data=</span>airquality)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(best_aq.tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As with <code>lm()</code> objects, the <code>summary()</code> function provides a wealth of information. Note the results following variable importance. Earlier we opined that the first split on <code>Temp</code> indicated that is was the most significant predictor followed by <code>Wind</code>. The <code>rpart</code> documentation provides a detailed description of variable importance:</p>
<blockquote class="blockquote">
<p>An overall measure of variable importance is the sum of the goodness of split measures for each split for which it was the primary variable, plus goodness * (adjusted agreement) for all splits in which it was a surrogate.</p>
</blockquote>
<p>Note that the results are scaled so that they sum to 100, which is useful for directly comparing each predictor’s relative contribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(aq.tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
rpart(formula = Ozone ~ ., data = airquality)
  n=116 (37 observations deleted due to missingness)

          CP nsplit rel error    xerror      xstd
1 0.48071820      0 1.0000000 1.0113676 0.1682859
2 0.07723849      1 0.5192818 0.5618853 0.1793542
3 0.05396246      2 0.4420433 0.6066727 0.1809490
4 0.02598999      3 0.3880808 0.5254143 0.1520220
5 0.01989493      4 0.3620909 0.5083200 0.1489209
6 0.01664620      5 0.3421959 0.4828189 0.1354091
7 0.01000000      6 0.3255497 0.4794807 0.1353517

Variable importance
   Temp    Wind     Day Solar.R   Month 
     60      28       8       2       2 

Node number 1: 116 observations,    complexity param=0.4807182
  mean=42.12931, MSE=1078.819 
  left son=2 (79 obs) right son=3 (37 obs)
  Primary splits:
      Temp    &lt; 82.5  to the left,  improve=0.48071820, (0 missing)
      Wind    &lt; 6.6   to the right, improve=0.40426690, (0 missing)
      Solar.R &lt; 153   to the left,  improve=0.21080020, (5 missing)
      Month   &lt; 6.5   to the left,  improve=0.11595770, (0 missing)
      Day     &lt; 24.5  to the left,  improve=0.08216807, (0 missing)
  Surrogate splits:
      Wind &lt; 6.6   to the right, agree=0.776, adj=0.297, (0 split)
      Day  &lt; 10.5  to the right, agree=0.724, adj=0.135, (0 split)

Node number 2: 79 observations,    complexity param=0.07723849
  mean=26.5443, MSE=538.3746 
  left son=4 (69 obs) right son=5 (10 obs)
  Primary splits:
      Wind    &lt; 7.15  to the right, improve=0.22726310, (0 missing)
      Temp    &lt; 77.5  to the left,  improve=0.22489660, (0 missing)
      Day     &lt; 24.5  to the left,  improve=0.13807170, (0 missing)
      Solar.R &lt; 153   to the left,  improve=0.10449720, (2 missing)
      Month   &lt; 8.5   to the right, improve=0.01924449, (0 missing)

Node number 3: 37 observations,    complexity param=0.05396246
  mean=75.40541, MSE=606.8356 
  left son=6 (20 obs) right son=7 (17 obs)
  Primary splits:
      Temp    &lt; 87.5  to the left,  improve=0.300763900, (0 missing)
      Wind    &lt; 10.6  to the right, improve=0.273929800, (0 missing)
      Solar.R &lt; 273.5 to the right, improve=0.114526900, (3 missing)
      Day     &lt; 6.5   to the left,  improve=0.048950680, (0 missing)
      Month   &lt; 7.5   to the left,  improve=0.007595265, (0 missing)
  Surrogate splits:
      Wind  &lt; 6.6   to the right, agree=0.676, adj=0.294, (0 split)
      Month &lt; 7.5   to the left,  agree=0.649, adj=0.235, (0 split)
      Day   &lt; 27.5  to the left,  agree=0.622, adj=0.176, (0 split)

Node number 4: 69 observations,    complexity param=0.01989493
  mean=22.33333, MSE=158.2512 
  left son=8 (18 obs) right son=9 (51 obs)
  Primary splits:
      Solar.R &lt; 79.5  to the left,  improve=0.22543670, (1 missing)
      Temp    &lt; 77.5  to the left,  improve=0.21455360, (0 missing)
      Day     &lt; 27    to the left,  improve=0.05183544, (0 missing)
      Wind    &lt; 10.6  to the right, improve=0.04850548, (0 missing)
      Month   &lt; 8.5   to the right, improve=0.01998100, (0 missing)
  Surrogate splits:
      Temp &lt; 63.5  to the left,  agree=0.794, adj=0.222, (1 split)
      Wind &lt; 16.05 to the right, agree=0.750, adj=0.056, (0 split)

Node number 5: 10 observations
  mean=55.6, MSE=2194.64 

Node number 6: 20 observations,    complexity param=0.02598999
  mean=62.95, MSE=602.3475 
  left son=12 (7 obs) right son=13 (13 obs)
  Primary splits:
      Wind    &lt; 8.9   to the right, improve=0.269982600, (0 missing)
      Month   &lt; 7.5   to the right, improve=0.078628670, (0 missing)
      Day     &lt; 18.5  to the left,  improve=0.073966850, (0 missing)
      Solar.R &lt; 217.5 to the left,  improve=0.058145680, (3 missing)
      Temp    &lt; 85.5  to the right, improve=0.007674142, (0 missing)

Node number 7: 17 observations
  mean=90.05882, MSE=214.8789 

Node number 8: 18 observations
  mean=12.22222, MSE=43.17284 

Node number 9: 51 observations,    complexity param=0.0166462
  mean=25.90196, MSE=150.0492 
  left son=18 (33 obs) right son=19 (18 obs)
  Primary splits:
      Temp    &lt; 77.5  to the left,  improve=0.27221870, (0 missing)
      Wind    &lt; 10.6  to the right, improve=0.09788213, (0 missing)
      Day     &lt; 22.5  to the left,  improve=0.07292523, (0 missing)
      Month   &lt; 8.5   to the right, improve=0.04981065, (0 missing)
      Solar.R &lt; 255   to the right, improve=0.03603008, (1 missing)
  Surrogate splits:
      Month &lt; 6.5   to the left,  agree=0.686, adj=0.111, (0 split)
      Wind  &lt; 10.6  to the right, agree=0.667, adj=0.056, (0 split)

Node number 12: 7 observations
  mean=45.57143, MSE=88.2449 

Node number 13: 13 observations
  mean=72.30769, MSE=628.9822 

Node number 18: 33 observations
  mean=21.18182, MSE=74.573 

Node number 19: 18 observations
  mean=34.55556, MSE=172.6914 </code></pre>
</div>
</div>
<p>The best fit model contains two predictors and explains 55.8% of the variance in <code>Ozone</code> as shown below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">printcp</span>(best_aq.tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Regression tree:
rpart(formula = Ozone ~ ., data = airquality, cp = 0.055)

Variables actually used in tree construction:
[1] Temp Wind

Root node error: 125143/116 = 1078.8

n=116 (37 observations deleted due to missingness)

        CP nsplit rel error  xerror    xstd
1 0.480718      0   1.00000 1.01076 0.16854
2 0.077238      1   0.51928 0.59931 0.18107
3 0.055000      2   0.44204 0.66824 0.18089</code></pre>
</div>
</div>
<p>How does it compare to a linear model with the same two predictors? The linear model explains 56.1% of the variance in <code>Ozone</code>, which is only slightly more than the regression tree. Earlier I claimed there was a plan for improving the performance of regression trees. That plan is revealed in the next section on Random Forests.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(Ozone<span class="sc">~</span>Wind <span class="sc">+</span> Temp, <span class="at">data=</span>airquality))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Ozone ~ Wind + Temp, data = airquality)

Residuals:
    Min      1Q  Median      3Q     Max 
-41.251 -13.695  -2.856  11.390 100.367 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) -71.0332    23.5780  -3.013   0.0032 ** 
Wind         -3.0555     0.6633  -4.607 1.08e-05 ***
Temp          1.8402     0.2500   7.362 3.15e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 21.85 on 113 degrees of freedom
  (37 observations deleted due to missingness)
Multiple R-squared:  0.5687,    Adjusted R-squared:  0.5611 
F-statistic:  74.5 on 2 and 113 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
</section>
</section>
<section id="random-forest-regression" class="level3">
<h3 class="anchored" data-anchor-id="random-forest-regression">Random Forest Regression</h3>
<p>In 1994, Leo Breiman at UC, Berkeley published <a href="https://www.stat.berkeley.edu/~breiman/bagging.pdf">this paper</a> in which he presented a method he called <strong>Bootstrap AGGregation</strong> (or BAGGing) that improves the predictive power of regression trees by growing many trees (a forest) using bootstrapping techniques (thereby making it a random forest). The details are explained in the link to the paper above, but in short, we grow many trees, each on a bootstrapped sample of the training set (i.e., sample <span class="math inline">\(n\)</span> times <em>with replacement</em> from a data set of size <span class="math inline">\(n\)</span>). Then, to make a prediction, we either let each tree “vote” and predict based on the most votes, or we use the average of the estimated responses. Cross-validation isn’t necessary with this method because each bootstrapped tree has an internal error, referred to as the <strong>out-of-bag (OOB) error</strong>. With this method, about a third of the samples are left out of the bootstrapped sample, a prediction is made, and the OOB error calculated. The algorithm stops when the OOB error begins to increase.</p>
<p>A drawback of the method is that larger trees tend to be correlated with each other, and so <a href="https://www.stat.berkeley.edu/~breiman/randomforest2001.pdf">in a 2001 paper</a>, Breiman developed a method to lower the correlation between trees. For each bootstrapped sample, his idea was to use a random selection of predictors to split each node. The number of randomly selected predictors, <strong>mtry</strong>, is a function of the total number of predictors in the data set. For regression, the <code>randomForest()</code> function from the <code>randomForest</code> package uses <span class="math inline">\(1/k\)</span> as the default <code>mtry</code> value, but this can be manually specified. The following code chunks demonstrate the use of some of the <code>randomForest</code> functions. First, we fit a random forest model and specify that we want to assess the importance of predictors, omit <code>NA</code>s, and randomly sample two predictors at each split (<code>mtry</code>). There are a host of other parameters that can be specified, but we’ll keep them all at their default settings for this example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>aq.rf<span class="ot">&lt;-</span> <span class="fu">randomForest</span>(Ozone<span class="sc">~</span>., <span class="at">importance=</span><span class="cn">TRUE</span>, <span class="at">na.action=</span>na.omit, <span class="at">mtry=</span><span class="dv">2</span>, <span class="at">data=</span>airquality)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>aq.rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
 randomForest(formula = Ozone ~ ., data = airquality, importance = TRUE,      mtry = 2, na.action = na.omit) 
               Type of random forest: regression
                     Number of trees: 500
No. of variables tried at each split: 2

          Mean of squared residuals: 301.7377
                    % Var explained: 72.5</code></pre>
</div>
</div>
<p>This random forest model consists of 500 trees and explains 72.% of the variance in <code>Ozone</code>, which is a nice improvement over the 55.8% we got with the single regression tree. Plotting the <code>aq.rf</code> object shows the error as a function of the size of the forest. We want to see the error stabilize as the number of trees increases, which it does in the plot below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(aq.rf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="interpretation" class="level4">
<h4 class="anchored" data-anchor-id="interpretation">Interpretation</h4>
<p>When the relationships between predictors and response are non-linear and complex, random forest models generally perform better than standard linear models. However, the increase in predictive power comes with a corresponding decrease in interpretability. For this reason, random forests and some other machine learning-based models such as neural networks are sometimes referred to as “black box” models. If you are applying machine learning techniques to build a model that performs optical character recognition, you might not be terribly concerned about the interpretability of your model. However, if your model will be used to inform a decision maker, interpretability is much more important - especially if you are asked to explain the model to the decision maker. In fact, some machine learning practitioners argue against using black box models for all high stakes decision making. For example, read <a href="https://arxiv.org/pdf/1811.10154.pdf">this paper</a> by Cynthia Rudin, a computer scientist at Duke University. Recently, advancements have been made in improving the interpretability of some types of machine learning models (for example, download and read <a href="https://www.h2o.ai/resources/ebook/introduction-to-machine-learning-interpretability/">this paper from h2o.ai</a> or <a href="https://christophm.github.io/interpretable-ml-book/">this e-book</a> by Christoph Molnar, a Ph.D.&nbsp;candidate at the University of Munich), and we will explore these techniques below.</p>
<p>Linear models have coefficients (the <span class="math inline">\(\beta\)</span>s) that explain the nature of the relationship between predictors and the response. Classification and regression trees have an analogous concept of variable importance, which can be extended to random forest models. The documentation for <code>importance()</code> from the <code>randomForest</code> package provides the following definitions of two variable importance measures:</p>
<blockquote class="blockquote">
<p>The first measure is computed from permuting OOB data: For each tree, the prediction error on the out-of-bag portion of the data is recorded (error rate for classification, MSE for regression). Then the same is done after permuting each predictor variable. The difference between the two are then averaged over all trees, and normalized by the standard deviation of the differences. If the standard deviation of the differences is equal to 0 for a variable, the division is not done (but the average is almost always equal to 0 in that case).</p>
</blockquote>
<blockquote class="blockquote">
<p>The second measure is the total decrease in node impurities from splitting on the variable, averaged over all trees. For classification, the node impurity is measured by the Gini index. For regression, it is measured by residual sum of squares.</p>
</blockquote>
<p>These two measures can be accessed with:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">importance</span>(aq.rf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          %IncMSE IncNodePurity
Solar.R 13.495267     15939.238
Wind    19.989633     39498.922
Temp    37.489127     48112.583
Month    4.053344      4160.278
Day      3.052987      9651.722</code></pre>
</div>
</div>
<p>Alternatively, we can plot variable importance with <code>varImpPlot()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(aq.rf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Variable importance can be related to a linear model coefficient in that a large variable importance value is akin to a large coefficient value. However, it doesn’t indicate whether the coefficient is positive or negative. For example, from the above plot, we see that <code>Temp</code> is an important predictor of <code>Ozone</code>, but we don’t know if increasing temperatures result in increasing or decreasing ozone measurements (or if it’s a non-linear relationship). <strong>Partial dependence</strong> plots (PDP) were developed to solve this problem, and they can be interpreted in the same way as a loess or spline smoother.</p>
<p>For the <code>airquality</code> data, one would expect that increasing temperatures would increase ozone concentrations, and that increasing wind speed would decrease ozone concentrations. The <code>partialPlot()</code> function provided with the <code>randomForest</code> package produces PDPs, but they are basic and difficult to customize. Instead, we’ll use the <code>pdp</code> package, which works nicely with <code>ggplot2</code> and includes a loess smoother (another option is the <code>iml</code> package - for interpretable machine learning - which we’ll also explore).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">#library(pdp)</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">=</span> aq.rf <span class="sc">%&gt;%</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  pdp<span class="sc">::</span><span class="fu">partial</span>(<span class="at">pred.var =</span> <span class="st">"Temp"</span>) <span class="sc">%&gt;%</span>   <span class="co"># from the pdp package</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(<span class="at">smooth =</span> <span class="cn">TRUE</span>, <span class="at">ylab =</span> <span class="fu">expression</span>(<span class="fu">f</span>(Temp))) <span class="sc">+</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Partial Dependence of Temp"</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">=</span> aq.rf <span class="sc">%&gt;%</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  pdp<span class="sc">::</span><span class="fu">partial</span>(<span class="at">pred.var =</span> <span class="st">"Wind"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(<span class="at">smooth =</span> <span class="cn">TRUE</span>, <span class="at">ylab =</span> <span class="fu">expression</span>(<span class="fu">f</span>(Temp))) <span class="sc">+</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Partial Dependence of Wind"</span>)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(p3, p4, <span class="at">ncol=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Earlier, we produced a response surface plot based on a regression tree. Now we can produce a response surface based on the random forest model, which looks similar but more detailed. Specifying <code>chull = TRUE</code> (chull stands for convex hull) limits the plot to the range of values in the training data set, which prevents predictions being shown for regions in which there is no data. A 2D heat map and a 3D mesh are shown below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute partial dependence data for Wind and Temp</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>pd <span class="ot">=</span> pdp<span class="sc">::</span><span class="fu">partial</span>(aq.rf, <span class="at">pred.var =</span> <span class="fu">c</span>(<span class="st">"Wind"</span>, <span class="st">"Temp"</span>), <span class="at">chull =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Default PDP</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>pdp1 <span class="ot">=</span> pdp<span class="sc">::</span><span class="fu">plotPartial</span>(pd)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-D surface</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>pdp2 <span class="ot">=</span> pdp<span class="sc">::</span><span class="fu">plotPartial</span>(pd, <span class="at">levelplot =</span> <span class="cn">FALSE</span>, <span class="at">zlab =</span> <span class="st">"Ozone"</span>,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">screen =</span> <span class="fu">list</span>(<span class="at">z =</span> <span class="sc">-</span><span class="dv">20</span>, <span class="at">x =</span> <span class="sc">-</span><span class="dv">60</span>))</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(pdp1, pdp2, <span class="at">ncol=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The <code>iml</code> package was developed by Christoph Molnar, the Ph.D.&nbsp;candidate referred to earlier, and contains a number of useful functions to aid in model interpretation. In machine learning vernacular, predictors are commonly called features, so instead of variable importance, we’ll get feature importance. With this package, we can calculate feature importance and produce PDPs as well, and a grid of partial dependence plots are shown below. Note the addition of a rug plot at the bottom of each subplot, which helps identify regions where observations are sparse and where the model might not perform as well.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># library(iml) # for interpretable machine learning</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># library(patchwork) # for arranging plots - similar to gridExtra</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># iml doesn't like NAs, so we'll drop them from the data and re-fit the model</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>aq <span class="ot">=</span> airquality <span class="sc">%&gt;%</span> <span class="fu">drop_na</span>()</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>aq.rf2 <span class="ot">=</span> <span class="fu">randomForest</span>(Ozone<span class="sc">~</span>., <span class="at">importance=</span><span class="cn">TRUE</span>, <span class="at">na.action=</span>na.omit, <span class="at">mtry=</span><span class="dv">2</span>, <span class="at">data=</span>aq)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co"># provide the random forest model, the features, and the response</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>predictor <span class="ot">=</span> iml<span class="sc">::</span>Predictor<span class="sc">$</span><span class="fu">new</span>(aq.rf2, <span class="at">data =</span> aq[, <span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>], <span class="at">y =</span> aq<span class="sc">$</span>Ozone)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>PDP <span class="ot">=</span> iml<span class="sc">::</span>FeatureEffects<span class="sc">$</span><span class="fu">new</span>(predictor, <span class="at">method=</span><span class="st">'pdp'</span>)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>PDP<span class="sc">$</span><span class="fu">plot</span>() <span class="sc">&amp;</span> <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>PDPs show the average feature effect, but if we’re interested in the effect for one or more individual observations, then an Individual Conditional Expectation (ICE) plot is useful. In the following plot, each black line represents one of the 111 observations in the data set, and the global partial dependence is shown in yellow. Since the individual lines are generally parallel, we can see that each individual observation follows the same general trend: increasing temperatures have little effect on ozone until around 76 degrees, at which point all observations increase. In the mid 80s, there are a few observations that have a decreasing trend while the majority continue to increase, which indicates temperature may be interacting with one or more other features. Generally speaking, however, since the individual lines are largely parallel, we can conclude that the partial dependence measure is a good representation of the whole data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>ice <span class="ot">=</span> iml<span class="sc">::</span>FeatureEffect<span class="sc">$</span><span class="fu">new</span>(predictor, <span class="at">feature =</span> <span class="st">"Temp"</span>, <span class="at">method=</span><span class="st">'pdp+ice'</span>) </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>ice<span class="sc">$</span><span class="fu">plot</span>() <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>One of the nice attributes of tree-based models is their ability to capture interactions. The interaction effects can be explicitly measured and plotted as shown below. The x-axis scale is the percent of variance explained by interaction for each feature, so <code>Wind</code>, <code>Temp</code>, and <code>Solar.R</code> all have more than 10% of their variance explained by an interaction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>interact <span class="ot">=</span> iml<span class="sc">::</span>Interaction<span class="sc">$</span><span class="fu">new</span>(predictor)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(interact) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>To identify what the feature is interacting with, just specify the feature name. For example, <code>Temp</code> interactions are shown below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>interact <span class="ot">=</span> iml<span class="sc">::</span>Interaction<span class="sc">$</span><span class="fu">new</span>(predictor, <span class="at">feature=</span><span class="st">'Temp'</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(interact) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="predictions" class="level4">
<h4 class="anchored" data-anchor-id="predictions">Predictions</h4>
<p>Predictions for new data are made the usual way with <code>predict()</code>, which is demonstrated below using the first two rows of the <code>airquality</code> data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(aq.rf, airquality[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       1        2 
38.50243 31.39827 </code></pre>
</div>
</div>
</section>
</section>
<section id="random-forest-classification" class="level3">
<h3 class="anchored" data-anchor-id="random-forest-classification">Random Forest Classification</h3>
<p>For a classification example, we’ll skip over simple classification trees and jump straight to random forests. There is very little difference in syntax with the <code>randomForest()</code> function when performing classification instead of regression. For this demonstration, we’ll use the <code>iris</code> data set so we can compare results with the SVC results. We’ll use the same training and test sets as earlier.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> caTools<span class="sc">::</span><span class="fu">sample.split</span>(iris, <span class="at">SplitRatio =</span> <span class="fl">0.8</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>iris_train <span class="ot">=</span> <span class="fu">subset</span>(iris, train <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>iris_test <span class="ot">=</span> <span class="fu">subset</span>(iris, train <span class="sc">==</span> <span class="cn">FALSE</span>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>iris.rf <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(Species <span class="sc">~</span> ., <span class="at">data=</span>iris_train, <span class="at">importance=</span><span class="cn">TRUE</span>)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(iris.rf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
 randomForest(formula = Species ~ ., data = iris_train, importance = TRUE) 
               Type of random forest: classification
                     Number of trees: 500
No. of variables tried at each split: 2

        OOB estimate of  error rate: 5%
Confusion matrix:
           setosa versicolor virginica class.error
setosa         40          0         0       0.000
versicolor      0         37         3       0.075
virginica       0          3        37       0.075</code></pre>
</div>
</div>
<p>The model seems to have a little trouble distinguishing virginica from versicolor. The linear SVC misclassified two observations in the test set, and the radial SVC misclassified one. Before we see how the random forest does, let’s make sure we grew enough trees. We can make a visual check by plotting the random forest object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(iris.rf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>No issue there! Looks like 500 trees was plenty. Taking a look at variable importance shows that petal width and length are far more important than sepal width and length.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(iris.rf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Since the response variable is categorical with three levels, a little work is required to get partial dependence plots for each predictor-response combination. Below are the partial dependence plots for <code>Petal.Width</code> for each species. The relationship between petal width and species varies significantly based on the species, which is what makes petal width have a high variable importance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_tibble</span>(iris.rf <span class="sc">%&gt;%</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># which.class refers to the factor level</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  pdp<span class="sc">::</span><span class="fu">partial</span>(<span class="at">pred.var =</span> <span class="st">"Petal.Width"</span>, <span class="at">which.class=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Species =</span> <span class="fu">levels</span>(iris<span class="sc">$</span>Species)[<span class="dv">1</span>])) <span class="sc">%&gt;%</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">as_tibble</span>(iris.rf <span class="sc">%&gt;%</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  pdp<span class="sc">::</span><span class="fu">partial</span>(<span class="at">pred.var =</span> <span class="st">"Petal.Width"</span>, <span class="at">which.class=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Species =</span> <span class="fu">levels</span>(iris<span class="sc">$</span>Species)[<span class="dv">2</span>]))) <span class="sc">%&gt;%</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">as_tibble</span>(iris.rf <span class="sc">%&gt;%</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  pdp<span class="sc">::</span><span class="fu">partial</span>(<span class="at">pred.var =</span> <span class="st">"Petal.Width"</span>, <span class="at">which.class=</span><span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Species =</span> <span class="fu">levels</span>(iris<span class="sc">$</span>Species)[<span class="dv">3</span>]))) <span class="sc">%&gt;%</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>Petal.Width, <span class="at">y=</span>yhat, <span class="at">col=</span>Species), <span class="at">size=</span><span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Partial Dependence of Petal.Width"</span>) <span class="sc">+</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Enough visualizing. Time to get the confusion matrix for the random forest model using the test set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the confusion matrix</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>rf_conf_mat <span class="ot">=</span> cvms<span class="sc">::</span><span class="fu">confusion_matrix</span>(</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">targets =</span> iris_test[, <span class="dv">5</span>],</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">predictions =</span> <span class="fu">predict</span>(iris.rf, <span class="at">newdata =</span> iris_test[<span class="sc">-</span><span class="dv">5</span>]))</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the confusion matrix</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>cvms<span class="sc">::</span><span class="fu">plot_confusion_matrix</span>(rf_conf_mat<span class="sc">$</span><span class="st">`</span><span class="at">Confusion Matrix</span><span class="st">`</span>[[<span class="dv">1</span>]]) <span class="sc">+</span> </span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Random Forest"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random_forest_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="672"></p>
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>It’s always nice to see that I didn’t mess up the manual calculations.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'alternate';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../tutorial/svm.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Support Vector Machines</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../tutorial/nn_regression.html" class="pagination-link">
        <span class="nav-page-text">Neural Network Regression</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2022, John King</div>   
  </div>
</footer>



</body></html>