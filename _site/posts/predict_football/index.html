<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="John King">
<meta name="dcterms.date" content="2022-03-12">
<meta name="description" content="A variety of machine learning models to predict beating the spread.">

<title>A Random Walk - Predictive Modeling</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<link href="../../site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="../../site_libs/pagedtable-1.1/js/pagedtable.js"></script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">A Random Walk</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorials" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Tutorials</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tutorials">    
        <li>
    <a class="dropdown-item" href="../../tutorial/slr.html">
 <span class="dropdown-text">Simple Linear Regression</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/lm_assumptions.html">
 <span class="dropdown-text">Linear Model Assumptions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/mlr.html">
 <span class="dropdown-text">Multiple Linear Regression</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/model_selection.html">
 <span class="dropdown-text">Model Selection</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/transform.html">
 <span class="dropdown-text">Variable Transformation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/logistic.html">
 <span class="dropdown-text">Logistic Regression</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/advanced.html">
 <span class="dropdown-text">Advanced Designs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/np_anova.html">
 <span class="dropdown-text">Nonparametric ANOVA</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/gam.html">
 <span class="dropdown-text">Generalized Additive Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/svm.html">
 <span class="dropdown-text">Support Vector Machines</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/random_forest.html">
 <span class="dropdown-text">Random Forests</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/nn_regression.html">
 <span class="dropdown-text">Neural Network Regression</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-presentations" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Presentations</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-presentations">    
        <li>
    <a class="dropdown-item" href="../../presentations/doe.qmd">
 <span class="dropdown-text">Design of Experiments</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jfking50"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#get-the-data" id="toc-get-the-data" class="nav-link active" data-scroll-target="#get-the-data">Get the Data</a></li>
  <li><a href="#feature-selection-with-lasso-regression" id="toc-feature-selection-with-lasso-regression" class="nav-link" data-scroll-target="#feature-selection-with-lasso-regression">Feature Selection With Lasso Regression</a></li>
  <li><a href="#random-forest-model" id="toc-random-forest-model" class="nav-link" data-scroll-target="#random-forest-model">Random Forest Model</a></li>
  <li><a href="#gradient-boost-machine-model" id="toc-gradient-boost-machine-model" class="nav-link" data-scroll-target="#gradient-boost-machine-model">Gradient Boost Machine Model</a></li>
  <li><a href="#neural-net-model" id="toc-neural-net-model" class="nav-link" data-scroll-target="#neural-net-model">Neural Net Model</a>
  <ul class="collapse">
  <li><a href="#interpretability-plots" id="toc-interpretability-plots" class="nav-link" data-scroll-target="#interpretability-plots">Interpretability Plots</a></li>
  </ul></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next Steps</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Predictive Modeling</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">R</div>
    <div class="quarto-category">ggplot2</div>
    <div class="quarto-category">college football</div>
    <div class="quarto-category">sports analytics</div>
    <div class="quarto-category">machine learning</div>
  </div>
  </div>

<div>
  <div class="description">
    A variety of machine learning models to predict beating the spread.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>John King </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 12, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>Continuing with the streak of posts about college football posts, here I finally get into developing some models to predict the winning team and margin of victory of college football games. For this analysis, I was inspired by <a href="https://blog.collegefootballdata.com/lessons-from-picking-the-2022-cfb-season/">this post</a> that mentioned a leader board for people who picked winners from the 2021-2022 season. Reminds me of Kaggle competitions, which I did once for fun and <a href="https://jfking.netlify.app/blog/ames/">wrote about it</a>.</p>
<p>I also found <a href="https://content.iospress.com/articles/journal-of-sports-analytics/jsa190314">this published paper</a> both extremely interesting and helpful because it lays out in detail the author’s analytic methodology for building their predictive model. The first part of this post is my attempt at replicating their technique using a different data source (collegefootball.com’s <a href="https://api.collegefootballdata.com/api/docs/?url=/api-docs.json">API</a>) and using data from the 2017-2020 seasons to predict games of the 2021 season. Spoiler, my initial tree-based models don’t perform nearly as well as theirs, and I eventually try a neural network with much better success.</p>
<section id="get-the-data" class="level2">
<h2 class="anchored" data-anchor-id="get-the-data">Get the Data</h2>
<p>First, I’ll load data I previously obtained via the API I mentioned above. If you want to see how to make those API calls, I explain it in <a href="https://jfking.netlify.app/blog/oregon-football/">this post</a>. The data in <code>/games/teams</code> has a bunch of game result data that are similar to the data used in the article above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>gs <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"gameStats.RData"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>gs <span class="ot">&lt;-</span> <span class="fu">type.convert</span>(gs, <span class="at">as.is =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["id"],"name":[1],"type":["int"],"align":["right"]},{"label":["school"],"name":[2],"type":["chr"],"align":["left"]},{"label":["homeAway"],"name":[3],"type":["chr"],"align":["left"]},{"label":["points"],"name":[4],"type":["int"],"align":["right"]},{"label":["week"],"name":[5],"type":["int"],"align":["right"]},{"label":["year"],"name":[6],"type":["int"],"align":["right"]},{"label":["rushingTDs"],"name":[7],"type":["int"],"align":["right"]},{"label":["puntReturnYards"],"name":[8],"type":["int"],"align":["right"]},{"label":["puntReturnTDs"],"name":[9],"type":["int"],"align":["right"]},{"label":["puntReturns"],"name":[10],"type":["int"],"align":["right"]},{"label":["passingTDs"],"name":[11],"type":["int"],"align":["right"]},{"label":["kickReturnYards"],"name":[12],"type":["int"],"align":["right"]},{"label":["kickReturnTDs"],"name":[13],"type":["int"],"align":["right"]},{"label":["kickReturns"],"name":[14],"type":["int"],"align":["right"]},{"label":["kickingPoints"],"name":[15],"type":["int"],"align":["right"]},{"label":["interceptionYards"],"name":[16],"type":["int"],"align":["right"]},{"label":["interceptionTDs"],"name":[17],"type":["int"],"align":["right"]},{"label":["passesIntercepted"],"name":[18],"type":["int"],"align":["right"]},{"label":["fumblesRecovered"],"name":[19],"type":["int"],"align":["right"]},{"label":["totalFumbles"],"name":[20],"type":["int"],"align":["right"]},{"label":["tacklesForLoss"],"name":[21],"type":["dbl"],"align":["right"]},{"label":["defensiveTDs"],"name":[22],"type":["int"],"align":["right"]},{"label":["tackles"],"name":[23],"type":["int"],"align":["right"]},{"label":["sacks"],"name":[24],"type":["dbl"],"align":["right"]},{"label":["qbHurries"],"name":[25],"type":["int"],"align":["right"]},{"label":["passesDeflected"],"name":[26],"type":["int"],"align":["right"]},{"label":["firstDowns"],"name":[27],"type":["int"],"align":["right"]},{"label":["thirdDownEff"],"name":[28],"type":["chr"],"align":["left"]},{"label":["fourthDownEff"],"name":[29],"type":["chr"],"align":["left"]},{"label":["totalYards"],"name":[30],"type":["int"],"align":["right"]},{"label":["netPassingYards"],"name":[31],"type":["int"],"align":["right"]},{"label":["completionAttempts"],"name":[32],"type":["chr"],"align":["left"]},{"label":["yardsPerPass"],"name":[33],"type":["dbl"],"align":["right"]},{"label":["rushingYards"],"name":[34],"type":["int"],"align":["right"]},{"label":["rushingAttempts"],"name":[35],"type":["int"],"align":["right"]},{"label":["yardsPerRushAttempt"],"name":[36],"type":["dbl"],"align":["right"]},{"label":["totalPenaltiesYards"],"name":[37],"type":["chr"],"align":["left"]},{"label":["turnovers"],"name":[38],"type":["int"],"align":["right"]},{"label":["fumblesLost"],"name":[39],"type":["int"],"align":["right"]},{"label":["interceptions"],"name":[40],"type":["int"],"align":["right"]},{"label":["possessionTime"],"name":[41],"type":["chr"],"align":["left"]}],"data":[{"1":"400935247","2":"Arizona State","3":"home","4":"37","5":"1","6":"2017","7":"2","8":"6","9":"0","10":"2","11":"2","12":"51","13":"0","14":"1","15":"7","16":"49","17":"1","18":"2","19":"0","20":"1","21":"8","22":"1","23":"56","24":"6","25":"0","26":"3","27":"19","28":"5-15","29":"1-1","30":"400","31":"321","32":"24-30","33":"10.7","34":"79","35":"40","36":"2.0","37":"1-10","38":"0","39":"0","40":"0","41":"29:40","_rn_":"1"},{"1":"400935247","2":"New Mexico State","3":"away","4":"31","5":"1","6":"2017","7":"2","8":"0","9":"0","10":"1","11":"3","12":"27","13":"0","14":"1","15":"1","16":"NA","17":"NA","18":"NA","19":"0","20":"1","21":"14","22":"0","23":"64","24":"7","25":"0","26":"0","27":"27","28":"11-18","29":"0-1","30":"549","31":"398","32":"40-58","33":"6.9","34":"151","35":"30","36":"5.0","37":"6-59","38":"2","39":"0","40":"2","41":"30:20","_rn_":"2"},{"1":"400944827","2":"Sacramento State","3":"away","4":"6","5":"1","6":"2017","7":"0","8":"12","9":"0","10":"3","11":"0","12":"77","13":"0","14":"3","15":"6","16":"0","17":"0","18":"2","19":"2","20":"1","21":"8","22":"0","23":"45","24":"4","25":"0","26":"1","27":"8","28":"1-15","29":"0-1","30":"190","31":"95","32":"10-25","33":"3.8","34":"95","35":"35","36":"2.7","37":"1-2","38":"0","39":"0","40":"0","41":"29:06","_rn_":"3"},{"1":"400944827","2":"Idaho","3":"home","4":"28","5":"1","6":"2017","7":"2","8":"23","9":"0","10":"3","11":"2","12":"NA","13":"NA","14":"NA","15":"4","16":"NA","17":"NA","18":"NA","19":"0","20":"2","21":"6","22":"0","23":"37","24":"4","25":"0","26":"2","27":"15","28":"2-11","29":"2-3","30":"360","31":"163","32":"14-19","33":"8.6","34":"197","35":"44","36":"4.5","37":"3-20","38":"3","39":"1","40":"2","41":"30:54","_rn_":"4"},{"1":"400934573","2":"Temple","3":"away","4":"16","5":"1","6":"2017","7":"0","8":"2","9":"0","10":"2","11":"2","12":"142","13":"0","14":"6","15":"4","16":"43","17":"0","18":"1","19":"0","20":"1","21":"4","22":"0","23":"37","24":"2","25":"6","26":"3","27":"18","28":"5-17","29":"0-2","30":"330","31":"245","32":"19-35","33":"7.0","34":"85","35":"37","36":"2.3","37":"6-42","38":"1","39":"1","40":"0","41":"33:49","_rn_":"5"},{"1":"400934573","2":"Notre Dame","3":"home","4":"49","5":"1","6":"2017","7":"5","8":"0","9":"0","10":"1","11":"2","12":"48","13":"0","14":"2","15":"7","16":"NA","17":"NA","18":"NA","19":"1","20":"0","21":"11","22":"0","23":"44","24":"3","25":"4","26":"3","27":"26","28":"6-13","29":"1-2","30":"606","31":"184","32":"17-30","33":"6.1","34":"422","35":"44","36":"9.6","37":"4-20","38":"1","39":"0","40":"1","41":"26:11","_rn_":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>I also want to get the list of all of the FBS teams because I want to filter out the games played against non-FBS teams. There’s a bunch of data in that table, but I’m really only interested in the <code>school</code> column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>fbs <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"fbs_teams.RData"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(fbs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["id"],"name":[1],"type":["int"],"align":["right"]},{"label":["school"],"name":[2],"type":["chr"],"align":["left"]},{"label":["mascot"],"name":[3],"type":["chr"],"align":["left"]},{"label":["abbreviation"],"name":[4],"type":["chr"],"align":["left"]},{"label":["alt_name1"],"name":[5],"type":["chr"],"align":["left"]},{"label":["alt_name2"],"name":[6],"type":["chr"],"align":["left"]},{"label":["alt_name3"],"name":[7],"type":["chr"],"align":["left"]},{"label":["conference"],"name":[8],"type":["chr"],"align":["left"]},{"label":["division"],"name":[9],"type":["chr"],"align":["left"]},{"label":["color"],"name":[10],"type":["chr"],"align":["left"]},{"label":["alt_color"],"name":[11],"type":["chr"],"align":["left"]},{"label":["logo"],"name":[12],"type":["chr"],"align":["left"]},{"label":["logo2"],"name":[13],"type":["chr"],"align":["left"]}],"data":[{"1":"2005","2":"Air Force","3":"Falcons","4":"AFA","5":"NA","6":"AFA","7":"Air Force","8":"Mountain West","9":"Mountain","10":"#004a7b","11":"#ffffff","12":"http://a.espncdn.com/i/teamlogos/ncaa/500/2005.png","13":"http://a.espncdn.com/i/teamlogos/ncaa/500-dark/2005.png","_rn_":"1"},{"1":"2006","2":"Akron","3":"Zips","4":"AKR","5":"NA","6":"AKR","7":"Akron","8":"Mid-American","9":"East","10":"#00285e","11":"#84754e","12":"http://a.espncdn.com/i/teamlogos/ncaa/500/2006.png","13":"http://a.espncdn.com/i/teamlogos/ncaa/500-dark/2006.png","_rn_":"2"},{"1":"333","2":"Alabama","3":"Crimson Tide","4":"ALA","5":"NA","6":"ALA","7":"Alabama","8":"SEC","9":"West","10":"#690014","11":"#f1f2f3","12":"http://a.espncdn.com/i/teamlogos/ncaa/500/333.png","13":"http://a.espncdn.com/i/teamlogos/ncaa/500-dark/333.png","_rn_":"3"},{"1":"2026","2":"Appalachian State","3":"Mountaineers","4":"APP","5":"NA","6":"APP","7":"Appalachian St","8":"Sun Belt","9":"NA","10":"#000000","11":"#ffcd00","12":"http://a.espncdn.com/i/teamlogos/ncaa/500/2026.png","13":"http://a.espncdn.com/i/teamlogos/ncaa/500-dark/2026.png","_rn_":"4"},{"1":"12","2":"Arizona","3":"Wildcats","4":"ARIZ","5":"NA","6":"ARIZ","7":"Arizona","8":"Pac-12","9":"South","10":"#002449","11":"#00205b","12":"http://a.espncdn.com/i/teamlogos/ncaa/500/12.png","13":"http://a.espncdn.com/i/teamlogos/ncaa/500-dark/12.png","_rn_":"5"},{"1":"9","2":"Arizona State","3":"Sun Devils","4":"ASU","5":"NA","6":"ASU","7":"Arizona State","8":"Pac-12","9":"South","10":"#942139","11":"#f1f2f3","12":"http://a.espncdn.com/i/teamlogos/ncaa/500/9.png","13":"http://a.espncdn.com/i/teamlogos/ncaa/500-dark/9.png","_rn_":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Now I’ll get a vector of all of the game IDs from the first table in which a non-FBS team played. Here are the first three.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr) <span class="co"># I'm going to need to do some data wrangling</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>fcsIDs <span class="ot">&lt;-</span> gs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>school <span class="sc">%in%</span> (fbs <span class="sc">%&gt;%</span> .<span class="sc">$</span>school)) <span class="sc">%&gt;%</span> .<span class="sc">$</span>id</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>fcsIDs[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 400944827 400944827 400933835</code></pre>
</div>
</div>
<p>Now I apply the filter and separate out some of the columns. For example, the <code>totalPenaltiesYards</code> column is formatted as penalties-yards, so for example 3-25. I’ll then create a new column that divides one of those values by the other so that I get a single <code>yardsPerPenalty</code> value. I’ll also convert the time of possession into minutes and get rid of columns I no longer need.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr) <span class="co"># needed for the separate function below</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>gs <span class="ot">&lt;-</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  gs <span class="sc">%&gt;%</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>id <span class="sc">%in%</span> fcsIDs) <span class="sc">%&gt;%</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(totalPenaltiesYards, </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"penalties"</span>, <span class="st">"penaltiesYards"</span>), <span class="at">convert =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(completionAttempts, </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"passCompletions"</span>, <span class="st">"passAttempts"</span>), <span class="at">convert =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(possessionTime, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"posMM"</span>, <span class="st">"posSS"</span>), <span class="at">convert =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">posTime =</span> posMM <span class="sc">*</span> <span class="dv">60</span> <span class="sc">+</span> posSS,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">yardsPerPenalty =</span> penaltiesYards <span class="sc">/</span> penalties,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">passEfficiency =</span> passCompletions <span class="sc">/</span> passAttempts,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">yardsPerPlay =</span> (yardsPerPass <span class="sc">+</span> yardsPerRushAttempt) <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>totalYards, <span class="sc">-</span>posMM, <span class="sc">-</span>posSS, <span class="sc">-</span>fourthDownEff, <span class="sc">-</span>thirdDownEff)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I found that there are a number of NAs in the data. For this demonstration, I’ll just convert them all to 0. If I was cleaning this data for an actual competition or to try to beat Vegas, I’d take a much harder look at those NAs and treat them carefully.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>gs[<span class="fu">is.na</span>(gs)] <span class="ot">&lt;-</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I also found that there’s a game ID that’s repeated, so I’ll filter out the repeat.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># there's an id that's repeated - there should be two games for each ID</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>gs <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> <span class="fu">count</span>() <span class="sc">%&gt;%</span> <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["id"],"name":[1],"type":["int"],"align":["right"]},{"label":["n"],"name":[2],"type":["int"],"align":["right"]}],"data":[{"1":"401309547","2":"4"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># take a look at that ID</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>gs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(id <span class="sc">==</span> <span class="dv">401309547</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["id"],"name":[1],"type":["int"],"align":["right"]},{"label":["school"],"name":[2],"type":["chr"],"align":["left"]},{"label":["homeAway"],"name":[3],"type":["chr"],"align":["left"]},{"label":["points"],"name":[4],"type":["int"],"align":["right"]},{"label":["week"],"name":[5],"type":["int"],"align":["right"]},{"label":["year"],"name":[6],"type":["int"],"align":["right"]},{"label":["rushingTDs"],"name":[7],"type":["int"],"align":["right"]},{"label":["puntReturnYards"],"name":[8],"type":["int"],"align":["right"]},{"label":["puntReturnTDs"],"name":[9],"type":["int"],"align":["right"]},{"label":["puntReturns"],"name":[10],"type":["int"],"align":["right"]},{"label":["passingTDs"],"name":[11],"type":["int"],"align":["right"]},{"label":["kickReturnYards"],"name":[12],"type":["int"],"align":["right"]},{"label":["kickReturnTDs"],"name":[13],"type":["int"],"align":["right"]},{"label":["kickReturns"],"name":[14],"type":["int"],"align":["right"]},{"label":["kickingPoints"],"name":[15],"type":["int"],"align":["right"]},{"label":["interceptionYards"],"name":[16],"type":["int"],"align":["right"]},{"label":["interceptionTDs"],"name":[17],"type":["int"],"align":["right"]},{"label":["passesIntercepted"],"name":[18],"type":["int"],"align":["right"]},{"label":["fumblesRecovered"],"name":[19],"type":["int"],"align":["right"]},{"label":["totalFumbles"],"name":[20],"type":["int"],"align":["right"]},{"label":["tacklesForLoss"],"name":[21],"type":["dbl"],"align":["right"]},{"label":["defensiveTDs"],"name":[22],"type":["int"],"align":["right"]},{"label":["tackles"],"name":[23],"type":["int"],"align":["right"]},{"label":["sacks"],"name":[24],"type":["dbl"],"align":["right"]},{"label":["qbHurries"],"name":[25],"type":["int"],"align":["right"]},{"label":["passesDeflected"],"name":[26],"type":["int"],"align":["right"]},{"label":["firstDowns"],"name":[27],"type":["int"],"align":["right"]},{"label":["netPassingYards"],"name":[28],"type":["int"],"align":["right"]},{"label":["passCompletions"],"name":[29],"type":["int"],"align":["right"]},{"label":["passAttempts"],"name":[30],"type":["int"],"align":["right"]},{"label":["yardsPerPass"],"name":[31],"type":["dbl"],"align":["right"]},{"label":["rushingYards"],"name":[32],"type":["int"],"align":["right"]},{"label":["rushingAttempts"],"name":[33],"type":["int"],"align":["right"]},{"label":["yardsPerRushAttempt"],"name":[34],"type":["dbl"],"align":["right"]},{"label":["penalties"],"name":[35],"type":["int"],"align":["right"]},{"label":["penaltiesYards"],"name":[36],"type":["int"],"align":["right"]},{"label":["turnovers"],"name":[37],"type":["int"],"align":["right"]},{"label":["fumblesLost"],"name":[38],"type":["int"],"align":["right"]},{"label":["interceptions"],"name":[39],"type":["int"],"align":["right"]},{"label":["posTime"],"name":[40],"type":["dbl"],"align":["right"]},{"label":["yardsPerPenalty"],"name":[41],"type":["dbl"],"align":["right"]},{"label":["passEfficiency"],"name":[42],"type":["dbl"],"align":["right"]},{"label":["yardsPerPlay"],"name":[43],"type":["dbl"],"align":["right"]}],"data":[{"1":"401309547","2":"Wyoming","3":"away","4":"50","5":"2","6":"2021","7":"4","8":"17","9":"0","10":"2","11":"2","12":"0","13":"0","14":"0","15":"6","16":"33","17":"1","18":"3","19":"0","20":"2","21":"12","22":"2","23":"82","24":"4","25":"0","26":"8","27":"24","28":"204","29":"13","30":"23","31":"8.9","32":"191","33":"45","34":"4.2","35":"4","36":"30","37":"1","38":"1","39":"0","40":"1828","41":"7.5","42":"0.5652174","43":"6.55"},{"1":"401309547","2":"Wyoming","3":"away","4":"50","5":"2","6":"2021","7":"0","8":"0","9":"0","10":"0","11":"0","12":"0","13":"0","14":"0","15":"0","16":"0","17":"0","18":"0","19":"0","20":"0","21":"6","22":"1","23":"41","24":"2","25":"0","26":"4","27":"0","28":"0","29":"0","30":"0","31":"0.0","32":"0","33":"0","34":"0.0","35":"0","36":"0","37":"0","38":"0","39":"0","40":"0","41":"0.0","42":"0.0000000","43":"0.00"},{"1":"401309547","2":"Northern Illinois","3":"home","4":"43","5":"2","6":"2021","7":"5","8":"0","9":"0","10":"0","11":"1","12":"88","13":"0","14":"4","15":"7","16":"0","17":"0","18":"0","19":"1","20":"0","21":"8","22":"0","23":"72","24":"2","25":"8","26":"8","27":"22","28":"233","29":"19","30":"36","31":"6.5","32":"244","33":"38","34":"6.4","35":"5","36":"50","37":"3","38":"0","39":"3","40":"1772","41":"10.0","42":"0.5277778","43":"6.45"},{"1":"401309547","2":"Northern Illinois","3":"home","4":"43","5":"2","6":"2021","7":"0","8":"0","9":"0","10":"0","11":"0","12":"0","13":"0","14":"0","15":"0","16":"0","17":"0","18":"0","19":"0","20":"0","21":"4","22":"0","23":"36","24":"1","25":"4","26":"4","27":"0","28":"0","29":"0","30":"0","31":"0.0","32":"0","33":"0","34":"0.0","35":"0","36":"0","37":"0","38":"0","39":"0","40":"0","41":"0.0","42":"0.0000000","43":"0.00"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># filter out the ID with zeros in the rushingTDs column</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>gs <span class="ot">&lt;-</span> gs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>(id <span class="sc">==</span> <span class="dv">401309547</span> <span class="sc">&amp;</span> rushingTDs <span class="sc">==</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the article, they did some feature engineering that I’ll replicate here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>gs <span class="ot">&lt;-</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  gs <span class="sc">%&gt;%</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">offensePoints =</span> (rushingTDs <span class="sc">+</span> passingTDs) <span class="sc">*</span> <span class="dv">7</span> <span class="sc">+</span> kickingPoints,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">offenseYards =</span> netPassingYards <span class="sc">+</span> rushingYards) <span class="sc">%&gt;%</span> </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>They also created some features for one team based on how the other team performed. Doing this in the original <code>gs</code> dataframe made my head hurt, so I split it into separate dataframes for the home and away teams. While I’m at it, I’ll also calculate <code>MOV</code>, the margin of victory.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>home <span class="ot">&lt;-</span> gs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(homeAway <span class="sc">==</span> <span class="st">"home"</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>away <span class="ot">&lt;-</span> gs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(homeAway <span class="sc">==</span> <span class="st">"away"</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>home <span class="ot">&lt;-</span> </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  home <span class="sc">%&gt;%</span> </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">defensePointsAllowed =</span> away<span class="sc">$</span>offensePoints,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">defenseYPPAAllowed =</span> away<span class="sc">$</span>yardsPerPass,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">defenseYPRAAllowed =</span> away<span class="sc">$</span>yardsPerRushAttempt,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">defensePassYardsAllowed =</span> away<span class="sc">$</span>netPassingYards,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">defenseRushYardsAllowed =</span> away<span class="sc">$</span>rushingYards,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">defenseYardsPerPlayAllowed =</span> away<span class="sc">$</span>yardsPerPlay,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">forcedPenaltyYards =</span> away<span class="sc">$</span>penaltiesYards,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">forcedTO =</span> away<span class="sc">$</span>turnovers,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">MOV =</span> points <span class="sc">-</span> away<span class="sc">$</span>points</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>away <span class="ot">&lt;-</span> </span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  away <span class="sc">%&gt;%</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">defensePointsAllowed =</span> home<span class="sc">$</span>offensePoints,</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">defenseYPPAAllowed =</span> home<span class="sc">$</span>yardsPerPass,</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">defenseYPRAAllowed =</span> home<span class="sc">$</span>yardsPerRushAttempt,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">defensePassYardsAllowed =</span> home<span class="sc">$</span>netPassingYards,</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">defenseRushYardsAllowed =</span> home<span class="sc">$</span>rushingYards,</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">defenseYardsPerPlayAllowed =</span> home<span class="sc">$</span>yardsPerPlay,</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">forcedPenaltyYards =</span> home<span class="sc">$</span>penaltiesYards,</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">forcedTO =</span> home<span class="sc">$</span>turnovers,</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">MOV =</span> points <span class="sc">-</span> home<span class="sc">$</span>points</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I also wanted to get each team’s Elo score,which I found in the <code>/games</code> data via the API. For some reason, I grabbed the pregame Elo score instead of the post-game Elo, but that’s fine. I’ll account for that later. I’ll also filter out those games using the game IDs in the <code>home</code> dataframe. The <code>/games</code> data also contains a boolean <code>neutral_site</code>, which will be useful. There’s always a home and away team in every game (as indicated in the <code>homeAway</code> column) even if the game is played on a neutral site. If I want to correctly factor in whether a team has a home field advantage, I’ll need to account for those games played at a neutral site.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>eloSite <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"eloSite.RData"</span>) <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>eloSite <span class="ot">&lt;-</span> eloSite <span class="sc">%&gt;%</span> <span class="fu">filter</span>(id <span class="sc">%in%</span> (home <span class="sc">%&gt;%</span> .<span class="sc">$</span>id))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(eloSite)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["id"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["home_team"],"name":[2],"type":["chr"],"align":["left"]},{"label":["home_pregame_elo"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["away_team"],"name":[4],"type":["chr"],"align":["left"]},{"label":["away_pregame_elo"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["neutral_site"],"name":[6],"type":["lgl"],"align":["right"]},{"label":["..JSON"],"name":[7],"type":["list"],"align":["right"]}],"data":[{"1":"400935282","2":"Colorado State","3":"1546","4":"Oregon State","5":"1412","6":"FALSE","7":"<named list [30]>"},{"1":"400938887","2":"UMass","3":"1230","4":"Hawai'i","5":"1273","6":"FALSE","7":"<named list [30]>"},{"1":"400941786","2":"San José State","3":"1266","4":"South Florida","5":"1626","6":"FALSE","7":"<named list [30]>"},{"1":"400935257","2":"Rice","3":"1239","4":"Stanford","5":"1666","6":"TRUE","7":"<named list [30]>"},{"1":"400938591","2":"UCF","3":"1446","4":"Florida International","5":"1272","6":"FALSE","7":"<named list [30]>"},{"1":"400935230","2":"Minnesota","3":"1600","4":"Buffalo","5":"1219","6":"FALSE","7":"<named list [30]>"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Now I’ll combine that data with the <code>home</code> and <code>away</code> dataframes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>home <span class="ot">&lt;-</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  home <span class="sc">%&gt;%</span> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(eloSite <span class="sc">%&gt;%</span> </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(id, home_team, home_pregame_elo, neutral_site),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"id"</span> <span class="ot">=</span> <span class="st">"id"</span>, <span class="st">"school"</span> <span class="ot">=</span> <span class="st">"home_team"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="st">"elo"</span> <span class="ot">=</span> <span class="st">"home_pregame_elo"</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>away <span class="ot">&lt;-</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  away <span class="sc">%&gt;%</span> </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(eloSite <span class="sc">%&gt;%</span> </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(id, away_team, away_pregame_elo, neutral_site),</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"id"</span> <span class="ot">=</span> <span class="st">"id"</span>, <span class="st">"school"</span> <span class="ot">=</span> <span class="st">"away_team"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="st">"elo"</span> <span class="ot">=</span> <span class="st">"away_pregame_elo"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The authors explained that their methodology didn’t use raw game results. Instead, they used seasonal cumulative means. Let’s take <code>rushingTDs</code> for an example. Say a given team in week 1 had 1 rushing TD. Week 1 results are unchanged. If they scored 2 rushing TDs in week 2, then the cumulative mean becomes 1.5 and so on through the weeks. At the beginning of the next season, reset and start over. Hopefully, that makes sense.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># re-combine the home and away dataframes into one long dataframe</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>ha <span class="ot">&lt;-</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(home, away) <span class="sc">%&gt;%</span> </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(school, year, week)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># I want to calculate the cumulative MOV mean, but I also need to preserve the</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># actual MOV as the response variable.</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>mov_actual <span class="ot">&lt;-</span> ha <span class="sc">%&gt;%</span> .<span class="sc">$</span>MOV </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># now calculate the cumulative means</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>cmeans<span class="ot">&lt;-</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  ha <span class="sc">%&gt;%</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(school, year) <span class="sc">%&gt;%</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize_at</span>(<span class="fu">vars</span>(<span class="fu">c</span>(<span class="dv">3</span><span class="sc">:</span><span class="dv">52</span>)), cummean) <span class="sc">%&gt;%</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cmeans)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["school"],"name":[1],"type":["chr"],"align":["left"]},{"label":["year"],"name":[2],"type":["int"],"align":["right"]},{"label":["points"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["week"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["rushingTDs"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["puntReturnYards"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["puntReturnTDs"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["puntReturns"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["passingTDs"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["kickReturnYards"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["kickReturnTDs"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["kickReturns"],"name":[12],"type":["dbl"],"align":["right"]},{"label":["kickingPoints"],"name":[13],"type":["dbl"],"align":["right"]},{"label":["interceptionYards"],"name":[14],"type":["dbl"],"align":["right"]},{"label":["interceptionTDs"],"name":[15],"type":["dbl"],"align":["right"]},{"label":["passesIntercepted"],"name":[16],"type":["dbl"],"align":["right"]},{"label":["fumblesRecovered"],"name":[17],"type":["dbl"],"align":["right"]},{"label":["totalFumbles"],"name":[18],"type":["dbl"],"align":["right"]},{"label":["tacklesForLoss"],"name":[19],"type":["dbl"],"align":["right"]},{"label":["defensiveTDs"],"name":[20],"type":["dbl"],"align":["right"]},{"label":["tackles"],"name":[21],"type":["dbl"],"align":["right"]},{"label":["sacks"],"name":[22],"type":["dbl"],"align":["right"]},{"label":["qbHurries"],"name":[23],"type":["dbl"],"align":["right"]},{"label":["passesDeflected"],"name":[24],"type":["dbl"],"align":["right"]},{"label":["firstDowns"],"name":[25],"type":["dbl"],"align":["right"]},{"label":["netPassingYards"],"name":[26],"type":["dbl"],"align":["right"]},{"label":["passCompletions"],"name":[27],"type":["dbl"],"align":["right"]},{"label":["passAttempts"],"name":[28],"type":["dbl"],"align":["right"]},{"label":["yardsPerPass"],"name":[29],"type":["dbl"],"align":["right"]},{"label":["rushingYards"],"name":[30],"type":["dbl"],"align":["right"]},{"label":["rushingAttempts"],"name":[31],"type":["dbl"],"align":["right"]},{"label":["yardsPerRushAttempt"],"name":[32],"type":["dbl"],"align":["right"]},{"label":["penalties"],"name":[33],"type":["dbl"],"align":["right"]},{"label":["penaltiesYards"],"name":[34],"type":["dbl"],"align":["right"]},{"label":["turnovers"],"name":[35],"type":["dbl"],"align":["right"]},{"label":["fumblesLost"],"name":[36],"type":["dbl"],"align":["right"]},{"label":["interceptions"],"name":[37],"type":["dbl"],"align":["right"]},{"label":["posTime"],"name":[38],"type":["dbl"],"align":["right"]},{"label":["yardsPerPenalty"],"name":[39],"type":["dbl"],"align":["right"]},{"label":["passEfficiency"],"name":[40],"type":["dbl"],"align":["right"]},{"label":["yardsPerPlay"],"name":[41],"type":["dbl"],"align":["right"]},{"label":["offensePoints"],"name":[42],"type":["dbl"],"align":["right"]},{"label":["offenseYards"],"name":[43],"type":["dbl"],"align":["right"]},{"label":["defensePointsAllowed"],"name":[44],"type":["dbl"],"align":["right"]},{"label":["defenseYPPAAllowed"],"name":[45],"type":["dbl"],"align":["right"]},{"label":["defenseYPRAAllowed"],"name":[46],"type":["dbl"],"align":["right"]},{"label":["defensePassYardsAllowed"],"name":[47],"type":["dbl"],"align":["right"]},{"label":["defenseRushYardsAllowed"],"name":[48],"type":["dbl"],"align":["right"]},{"label":["defenseYardsPerPlayAllowed"],"name":[49],"type":["dbl"],"align":["right"]},{"label":["forcedPenaltyYards"],"name":[50],"type":["dbl"],"align":["right"]},{"label":["forcedTO"],"name":[51],"type":["dbl"],"align":["right"]},{"label":["MOV"],"name":[52],"type":["dbl"],"align":["right"]}],"data":[{"1":"Air Force","2":"2017","3":"13.00000","4":"3.0","5":"0.000000","6":"0.00000","7":"0","8":"0.000000","9":"1.000000","10":"45.00000","11":"0","12":"3.000000","13":"7.000000","14":"0","15":"0","16":"0.0000000","17":"1.0000000","18":"1.000000","19":"8.000000","20":"0","21":"43.00000","22":"2.0000000","23":"1.0000000","24":"1.0","25":"15.00000","26":"64.0000","27":"1.0","28":"9.00000","29":"7.100000","30":"168.0000","31":"49.00000","32":"3.400000","33":"3.000000","34":"29.00000","35":"1.000000","36":"0.0000000","37":"1.0000000","38":"1825.000","39":"9.666667","40":"0.1111111","41":"5.250000","42":"14.00000","43":"232.0000","44":"24.0","45":"7.300000","46":"4.500000","47":"169.00","48":"190.0000","49":"5.900000","50":"72.00000","51":"1.0000000","52":"-16.000000"},{"1":"Air Force","2":"2017","3":"18.50000","4":"3.5","5":"1.500000","6":"18.00000","7":"0","8":"2.000000","9":"0.500000","10":"47.00000","11":"0","12":"3.000000","13":"5.500000","14":"0","15":"0","16":"0.0000000","17":"1.0000000","18":"2.500000","19":"5.500000","20":"0","21":"36.00000","22":"1.5000000","23":"0.5000000","24":"2.5","25":"14.50000","26":"48.5000","27":"1.5","28":"7.50000","29":"6.300000","30":"194.0000","31":"54.50000","32":"3.550000","33":"4.000000","34":"40.50000","35":"1.000000","36":"0.0000000","37":"1.0000000","38":"1872.000","39":"10.033333","40":"0.2222222","41":"4.925000","42":"19.50000","43":"242.5000","44":"28.0","45":"9.300000","46":"4.550000","47":"174.50","48":"188.5000","49":"6.925000","50":"36.00000","51":"1.0000000","52":"-10.000000"},{"1":"Air Force","2":"2017","3":"25.00000","4":"4.0","5":"1.666667","6":"12.00000","7":"0","8":"1.333333","9":"1.333333","10":"34.66667","11":"0","12":"2.333333","13":"6.333333","14":"0","15":"0","16":"0.0000000","17":"0.6666667","18":"2.666667","19":"4.333333","20":"0","21":"34.33333","22":"1.0000000","23":"0.3333333","24":"2.0","25":"18.33333","26":"85.0000","27":"4.0","28":"11.00000","29":"7.133333","30":"208.6667","31":"57.33333","32":"3.633333","33":"3.333333","34":"32.00000","35":"1.333333","36":"0.6666667","37":"0.6666667","38":"1953.667","39":"9.188889","40":"0.3148148","41":"5.383333","42":"27.33333","43":"293.6667","44":"40.0","45":"11.600000","46":"6.000000","47":"165.00","48":"246.6667","49":"8.800000","50":"45.66667","51":"0.6666667","52":"-12.666667"},{"1":"Air Force","2":"2017","3":"30.00000","4":"4.5","5":"2.250000","6":"12.50000","7":"0","8":"1.500000","9":"1.500000","10":"48.25000","11":"0","12":"3.000000","13":"7.000000","14":"0","15":"0","16":"0.0000000","17":"0.5000000","18":"2.750000","19":"3.500000","20":"0","21":"32.50000","22":"0.7500000","23":"0.7500000","24":"2.0","25":"20.50000","26":"134.0000","27":"5.5","28":"12.50000","29":"9.475000","30":"241.5000","31":"56.75000","32":"4.275000","33":"3.250000","34":"30.25000","35":"1.500000","36":"1.0000000","37":"0.5000000","38":"1878.250","39":"8.975000","40":"0.3831699","41":"6.875000","42":"33.25000","43":"375.5000","44":"43.5","45":"10.500000","46":"6.575000","47":"145.25","48":"302.7500","49":"8.537500","50":"43.00000","51":"0.5000000","52":"-10.250000"},{"1":"Air Force","2":"2017","3":"30.80000","4":"5.0","5":"2.800000","6":"14.00000","7":"0","8":"1.400000","9":"1.200000","10":"55.20000","11":"0","12":"3.000000","13":"6.400000","14":"0","15":"0","16":"0.2000000","17":"0.4000000","18":"3.400000","19":"3.200000","20":"0","21":"33.60000","22":"0.8000000","23":"0.6000000","24":"2.4","25":"22.40000","26":"121.6000","27":"5.2","28":"11.60000","29":"9.380000","30":"273.4000","31":"61.00000","32":"4.440000","33":"3.600000","34":"35.40000","35":"2.000000","36":"1.6000000","37":"0.4000000","38":"1901.200","39":"9.420000","40":"0.4065359","41":"6.910000","42":"34.40000","43":"395.0000","44":"41.4","45":"9.480000","46":"6.620000","47":"145.20","48":"295.4000","49":"8.050000","50":"38.40000","51":"0.8000000","52":"-7.400000"},{"1":"Air Force","2":"2017","3":"33.16667","4":"5.5","5":"3.333333","6":"13.66667","7":"0","8":"1.333333","9":"1.000000","10":"54.33333","11":"0","12":"3.000000","13":"6.833333","14":"0","15":"0","16":"0.1666667","17":"0.3333333","18":"3.500000","19":"2.666667","20":"0","21":"32.50000","22":"0.6666667","23":"0.5000000","24":"2.5","25":"24.66667","26":"108.1667","27":"5.0","28":"10.83333","29":"8.800000","30":"319.5000","31":"66.00000","32":"4.700000","33":"3.833333","34":"39.16667","35":"2.000000","36":"1.5000000","37":"0.5000000","38":"1997.667","39":"9.783333","40":"0.4340181","41":"6.750000","42":"37.16667","43":"427.6667","44":"42.0","45":"9.166667","46":"6.816667","47":"165.50","48":"272.3333","49":"7.991667","50":"36.16667","51":"0.6666667","52":"-5.666667"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>There are a few columns from the <code>ha</code> dataframe, like the game ID, schools names, the week, the year, etc. that I don’t want to have a cumulative mean - I want the original columns. So I’ll select those columns and combine them with the cumulative means. Then I’ll add the actual MOV results for use as the predictor variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>ha <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(ha[, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">55</span>, <span class="dv">56</span>)], cmeans[, <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span><span class="sc">:</span><span class="dv">52</span>)])</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>ha<span class="sc">$</span>MOV_actual <span class="ot">&lt;-</span> mov_actual</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ha)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["id"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["school"],"name":[2],"type":["chr"],"align":["left"]},{"label":["homeAway"],"name":[3],"type":["chr"],"align":["left"]},{"label":["week"],"name":[4],"type":["int"],"align":["right"]},{"label":["year"],"name":[5],"type":["int"],"align":["right"]},{"label":["elo"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["neutral_site"],"name":[7],"type":["lgl"],"align":["right"]},{"label":["points"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["rushingTDs"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["puntReturnYards"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["puntReturnTDs"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["puntReturns"],"name":[12],"type":["dbl"],"align":["right"]},{"label":["passingTDs"],"name":[13],"type":["dbl"],"align":["right"]},{"label":["kickReturnYards"],"name":[14],"type":["dbl"],"align":["right"]},{"label":["kickReturnTDs"],"name":[15],"type":["dbl"],"align":["right"]},{"label":["kickReturns"],"name":[16],"type":["dbl"],"align":["right"]},{"label":["kickingPoints"],"name":[17],"type":["dbl"],"align":["right"]},{"label":["interceptionYards"],"name":[18],"type":["dbl"],"align":["right"]},{"label":["interceptionTDs"],"name":[19],"type":["dbl"],"align":["right"]},{"label":["passesIntercepted"],"name":[20],"type":["dbl"],"align":["right"]},{"label":["fumblesRecovered"],"name":[21],"type":["dbl"],"align":["right"]},{"label":["totalFumbles"],"name":[22],"type":["dbl"],"align":["right"]},{"label":["tacklesForLoss"],"name":[23],"type":["dbl"],"align":["right"]},{"label":["defensiveTDs"],"name":[24],"type":["dbl"],"align":["right"]},{"label":["tackles"],"name":[25],"type":["dbl"],"align":["right"]},{"label":["sacks"],"name":[26],"type":["dbl"],"align":["right"]},{"label":["qbHurries"],"name":[27],"type":["dbl"],"align":["right"]},{"label":["passesDeflected"],"name":[28],"type":["dbl"],"align":["right"]},{"label":["firstDowns"],"name":[29],"type":["dbl"],"align":["right"]},{"label":["netPassingYards"],"name":[30],"type":["dbl"],"align":["right"]},{"label":["passCompletions"],"name":[31],"type":["dbl"],"align":["right"]},{"label":["passAttempts"],"name":[32],"type":["dbl"],"align":["right"]},{"label":["yardsPerPass"],"name":[33],"type":["dbl"],"align":["right"]},{"label":["rushingYards"],"name":[34],"type":["dbl"],"align":["right"]},{"label":["rushingAttempts"],"name":[35],"type":["dbl"],"align":["right"]},{"label":["yardsPerRushAttempt"],"name":[36],"type":["dbl"],"align":["right"]},{"label":["penalties"],"name":[37],"type":["dbl"],"align":["right"]},{"label":["penaltiesYards"],"name":[38],"type":["dbl"],"align":["right"]},{"label":["turnovers"],"name":[39],"type":["dbl"],"align":["right"]},{"label":["fumblesLost"],"name":[40],"type":["dbl"],"align":["right"]},{"label":["interceptions"],"name":[41],"type":["dbl"],"align":["right"]},{"label":["posTime"],"name":[42],"type":["dbl"],"align":["right"]},{"label":["yardsPerPenalty"],"name":[43],"type":["dbl"],"align":["right"]},{"label":["passEfficiency"],"name":[44],"type":["dbl"],"align":["right"]},{"label":["yardsPerPlay"],"name":[45],"type":["dbl"],"align":["right"]},{"label":["offensePoints"],"name":[46],"type":["dbl"],"align":["right"]},{"label":["offenseYards"],"name":[47],"type":["dbl"],"align":["right"]},{"label":["defensePointsAllowed"],"name":[48],"type":["dbl"],"align":["right"]},{"label":["defenseYPPAAllowed"],"name":[49],"type":["dbl"],"align":["right"]},{"label":["defenseYPRAAllowed"],"name":[50],"type":["dbl"],"align":["right"]},{"label":["defensePassYardsAllowed"],"name":[51],"type":["dbl"],"align":["right"]},{"label":["defenseRushYardsAllowed"],"name":[52],"type":["dbl"],"align":["right"]},{"label":["defenseYardsPerPlayAllowed"],"name":[53],"type":["dbl"],"align":["right"]},{"label":["forcedPenaltyYards"],"name":[54],"type":["dbl"],"align":["right"]},{"label":["forcedTO"],"name":[55],"type":["dbl"],"align":["right"]},{"label":["MOV"],"name":[56],"type":["dbl"],"align":["right"]},{"label":["MOV_actual"],"name":[57],"type":["int"],"align":["right"]}],"data":[{"1":"400935352","2":"Air Force","3":"away","4":"3","5":"2017","6":"1562","7":"FALSE","8":"13.00000","9":"0.000000","10":"0.00000","11":"0","12":"0.000000","13":"1.000000","14":"45.00000","15":"0","16":"3.000000","17":"7.000000","18":"0","19":"0","20":"0.0000000","21":"1.0000000","22":"1.000000","23":"8.000000","24":"0","25":"43.00000","26":"2.0000000","27":"1.0000000","28":"1.0","29":"15.00000","30":"64.0000","31":"1.0","32":"9.00000","33":"7.100000","34":"168.0000","35":"49.00000","36":"3.400000","37":"3.000000","38":"29.00000","39":"1.000000","40":"0.0000000","41":"1.0000000","42":"1825.000","43":"9.666667","44":"0.1111111","45":"5.250000","46":"14.00000","47":"232.0000","48":"24.0","49":"7.300000","50":"4.500000","51":"169.00","52":"190.0000","53":"5.900000","54":"72.00000","55":"1.0000000","56":"-16.000000","57":"-16"},{"1":"400945259","2":"Air Force","3":"home","4":"4","5":"2017","6":"1559","7":"FALSE","8":"18.50000","9":"1.500000","10":"18.00000","11":"0","12":"2.000000","13":"0.500000","14":"47.00000","15":"0","16":"3.000000","17":"5.500000","18":"0","19":"0","20":"0.0000000","21":"1.0000000","22":"2.500000","23":"5.500000","24":"0","25":"36.00000","26":"1.5000000","27":"0.5000000","28":"2.5","29":"14.50000","30":"48.5000","31":"1.5","32":"7.50000","33":"6.300000","34":"194.0000","35":"54.50000","36":"3.550000","37":"4.000000","38":"40.50000","39":"1.000000","40":"0.0000000","41":"1.0000000","42":"1872.000","43":"10.033333","44":"0.2222222","45":"4.925000","46":"19.50000","47":"242.5000","48":"28.0","49":"9.300000","50":"4.550000","51":"174.50","52":"188.5000","53":"6.925000","54":"36.00000","55":"1.0000000","56":"-10.000000","57":"-4"},{"1":"400945263","2":"Air Force","3":"away","4":"5","5":"2017","6":"1560","7":"FALSE","8":"25.00000","9":"1.666667","10":"12.00000","11":"0","12":"1.333333","13":"1.333333","14":"34.66667","15":"0","16":"2.333333","17":"6.333333","18":"0","19":"0","20":"0.0000000","21":"0.6666667","22":"2.666667","23":"4.333333","24":"0","25":"34.33333","26":"1.0000000","27":"0.3333333","28":"2.0","29":"18.33333","30":"85.0000","31":"4.0","32":"11.00000","33":"7.133333","34":"208.6667","35":"57.33333","36":"3.633333","37":"3.333333","38":"32.00000","39":"1.333333","40":"0.6666667","41":"0.6666667","42":"1953.667","43":"9.188889","44":"0.3148148","45":"5.383333","46":"27.33333","47":"293.6667","48":"40.0","49":"11.600000","50":"6.000000","51":"165.00","52":"246.6667","53":"8.800000","54":"45.66667","55":"0.6666667","56":"-12.666667","57":"-18"},{"1":"400941815","2":"Air Force","3":"away","4":"6","5":"2017","6":"1508","7":"FALSE","8":"30.00000","9":"2.250000","10":"12.50000","11":"0","12":"1.500000","13":"1.500000","14":"48.25000","15":"0","16":"3.000000","17":"7.000000","18":"0","19":"0","20":"0.0000000","21":"0.5000000","22":"2.750000","23":"3.500000","24":"0","25":"32.50000","26":"0.7500000","27":"0.7500000","28":"2.0","29":"20.50000","30":"134.0000","31":"5.5","32":"12.50000","33":"9.475000","34":"241.5000","35":"56.75000","36":"4.275000","37":"3.250000","38":"30.25000","39":"1.500000","40":"1.0000000","41":"0.5000000","42":"1878.250","43":"8.975000","44":"0.3831699","45":"6.875000","46":"33.25000","47":"375.5000","48":"43.5","49":"10.500000","50":"6.575000","51":"145.25","52":"302.7500","53":"8.537500","54":"43.00000","55":"0.5000000","56":"-10.250000","57":"-3"},{"1":"400945272","2":"Air Force","3":"home","4":"7","5":"2017","6":"1509","7":"FALSE","8":"30.80000","9":"2.800000","10":"14.00000","11":"0","12":"1.400000","13":"1.200000","14":"55.20000","15":"0","16":"3.000000","17":"6.400000","18":"0","19":"0","20":"0.2000000","21":"0.4000000","22":"3.400000","23":"3.200000","24":"0","25":"33.60000","26":"0.8000000","27":"0.6000000","28":"2.4","29":"22.40000","30":"121.6000","31":"5.2","32":"11.60000","33":"9.380000","34":"273.4000","35":"61.00000","36":"4.440000","37":"3.600000","38":"35.40000","39":"2.000000","40":"1.6000000","41":"0.4000000","42":"1901.200","43":"9.420000","44":"0.4065359","45":"6.910000","46":"34.40000","47":"395.0000","48":"41.4","49":"9.480000","50":"6.620000","51":"145.20","52":"295.4000","53":"8.050000","54":"38.40000","55":"0.8000000","56":"-7.400000","57":"4"},{"1":"400945278","2":"Air Force","3":"away","4":"8","5":"2017","6":"1506","7":"FALSE","8":"33.16667","9":"3.333333","10":"13.66667","11":"0","12":"1.333333","13":"1.000000","14":"54.33333","15":"0","16":"3.000000","17":"6.833333","18":"0","19":"0","20":"0.1666667","21":"0.3333333","22":"3.500000","23":"2.666667","24":"0","25":"32.50000","26":"0.6666667","27":"0.5000000","28":"2.5","29":"24.66667","30":"108.1667","31":"5.0","32":"10.83333","33":"8.800000","34":"319.5000","35":"66.00000","36":"4.700000","37":"3.833333","38":"39.16667","39":"2.000000","40":"1.5000000","41":"0.5000000","42":"1997.667","43":"9.783333","44":"0.4340181","45":"6.750000","46":"37.16667","47":"427.6667","48":"42.0","49":"9.166667","50":"6.816667","51":"165.50","52":"272.3333","53":"7.991667","54":"36.16667","55":"0.6666667","56":"-5.666667","57":"3"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>I also want to include the spread as a predictor variable, which I can get via the API from <code>/lines</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>spread <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"spread.RData"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(spread)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["id"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["home_spread"],"name":[2],"type":["dbl"],"align":["right"]}],"data":[{"1":"400944997","2":"9.500000"},{"1":"400944998","2":"9.333333"},{"1":"400934536","2":"24.166667"},{"1":"400945016","2":"-20.333333"},{"1":"400934493","2":"-18.666667"},{"1":"400938591","2":"-17.333333"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Now I’ll deal with the neutral site column since the dataframe is merged back together. I’m going to make a HFA column that’s a 1 for the home team at their home field, a -1 for the away team, and a 0 for both teams at a neutral site. Then I’ll add the pre-game spread for the home and away teams.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>ha <span class="ot">&lt;-</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  ha <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">HFA =</span> <span class="fu">case_when</span>(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    homeAway <span class="sc">==</span> <span class="st">"home"</span> <span class="sc">&amp;</span> <span class="sc">!</span>neutral_site <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    homeAway <span class="sc">==</span> <span class="st">"away"</span> <span class="sc">&amp;</span> <span class="sc">!</span>neutral_site <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    neutral_site <span class="sc">~</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(spread, <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">spread =</span> <span class="fu">ifelse</span>(homeAway <span class="sc">==</span> <span class="st">"home"</span>, home_spread, <span class="sc">-</span>home_spread))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Something else I want to add is each team’s seasonal win/loss record in the for of the percent of games they’ve won. I keep adding more and more predictors. We’ll find out later if any of it will even be useful.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>ha <span class="ot">&lt;-</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  ha <span class="sc">%&gt;%</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">wins =</span> <span class="fu">ifelse</span>(MOV_actual <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(school, year) <span class="sc">%&gt;%</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">games =</span> <span class="fu">row_number</span>(),</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">cumwins =</span> <span class="fu">cumsum</span>(wins),</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">winPct =</span> cumwins <span class="sc">/</span> games) <span class="sc">%&gt;%</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>wins, <span class="sc">-</span>games, <span class="sc">-</span>cumwins)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ok, this is where things get a little complicated. But first, a sidebar. I wrote this code over the course of a few weekends. Until this particular project, I’d never dealt with data where there are “sides” to think about. It took me a while to wrap my mind around it, and this is code from my first efforts where I was just trying to find “a way” to get things done. Pure brute force. Later you’ll see that I came up with a much better (and faster) way to do what I about to demonstrate. All part of the sausage-making the way I look at it.</p>
<p>The idea here is that I wanted to account for home field advantage. It’s a definite thing with a measurable effect. I’ll demonstrate using the <code>home</code> dataframe from earlier. I’ll remove games played at a neutral site, and get the mean margin of victory.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>home <span class="sc">%&gt;%</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>neutral_site) <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">meanMOV =</span> <span class="fu">mean</span>(MOV))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["meanMOV"],"name":[1],"type":["dbl"],"align":["right"]}],"data":[{"1":"3.967238"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Home teams win by almost 4 points on average. We can also check to see if the mean MOV is statistically significant. I’ll use the Wilcoxon signed rank test because <em>I’m certain</em> the data are not normally distributed - they’re football scores, after all. I’ll do a one-sided test where the null hypothesis is that the mean MOV is 0.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wilcox.test</span>(home <span class="sc">%&gt;%</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(<span class="sc">!</span>neutral_site) <span class="sc">%&gt;%</span> .<span class="sc">$</span>MOV, </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">alternative =</span> <span class="st">"greater"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Wilcoxon signed rank test with continuity correction

data:  home %&gt;% filter(!neutral_site) %&gt;% .$MOV
V = 3355196, p-value &lt; 2.2e-16
alternative hypothesis: true location is greater than 0</code></pre>
</div>
</div>
<p>Based on that p-value, we reject the null hypothesis at the 95% confidence level. Right, so home field advantage is a real thing, and I need to account for it.</p>
<p>To do that, I wanted to get away from the idea of home team and away team and instead think of them more generically by randomly picking one team as “the team” and the other as “the opponent”. My <code>ha</code> dataframe is still grouped by <code>school</code> and <code>year</code>, so I’ll ungroup it and call it my end-of-week results data - it’s a mental trick so I think about things differently. Then I’ll get all of the unique game IDs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>eowResults <span class="ot">&lt;-</span> ha <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>()</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(eowResults <span class="sc">%&gt;%</span> .<span class="sc">$</span>id))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, I’ll loop over the ID. For each ID, I’ll start by picking out the common columns (id, week, and year), and then identify one team as team1 and the other as team2. For the first game, and for column-naming consistency as I build this new dataframe <code>df</code>, team 1 will be “the team”, and team2 will be “the opponent”. For all other games, I pick a random number between 0 and 1. If it’s greater than or equal to 0.5, team1 is “the team” and team2 is “the opponent”. Otherwise, it’s the reverse.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> ids){</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  common <span class="ot">&lt;-</span> eowResults <span class="sc">%&gt;%</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(id <span class="sc">==</span> i) <span class="sc">%&gt;%</span> </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, week, year)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  team1 <span class="ot">&lt;-</span> eowResults <span class="sc">%&gt;%</span> </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(id <span class="sc">==</span> i) <span class="sc">%&gt;%</span> </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>id, <span class="sc">-</span>week, <span class="sc">-</span>year)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(team1) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">colnames</span>(team1), <span class="st">"team"</span>, <span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  team2 <span class="ot">&lt;-</span> eowResults <span class="sc">%&gt;%</span> </span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(id <span class="sc">==</span> i) <span class="sc">%&gt;%</span> </span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>id, <span class="sc">-</span>week, <span class="sc">-</span>year)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(team2) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">colnames</span>(team2), <span class="st">"opponent"</span>, <span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (i <span class="sc">==</span> <span class="fu">min</span>(ids)){df <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(common, team1, team2)}</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&gt;=</span> <span class="fl">0.5</span>, </span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>           newRow <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(common, team1, team2), </span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>           newRow <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(common, team2, team1))</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>(newRow)}</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Like I said, brute force. Now I have some redundant columns, so I’ll drop drop them before going further.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>homeAway_team, <span class="sc">-</span>homeAway_opponent, <span class="sc">-</span>neutral_site_team,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>neutral_site_opponent, <span class="sc">-</span>MOV_actual_opponent, <span class="sc">-</span>HFA_opponent,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>home_spread_opponent, <span class="sc">-</span>spread_opponent, <span class="sc">-</span>home_spread_team)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The final big step is to add a bunch of new columns to represent the difference in one team’s average performance versus the average performance of the other team. Think of it this way. If a team scores on average 30 points a game, you might think that’s pretty good. However, if the teams they’ve played have on average given up 40 points, then that 30 points doesn’t look as impressive. I want to account for that for a number of statistics, so that’s what I do here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffPointsScored =</span> offensePoints_team <span class="sc">-</span> defensePointsAllowed_opponent,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffPointsAllowed =</span> defensePointsAllowed_team <span class="sc">-</span> offensePoints_opponent,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffYPPAOff =</span> yardsPerPass_team <span class="sc">-</span> defenseYPPAAllowed_opponent,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffYPPADef =</span> defenseYPPAAllowed_team <span class="sc">-</span> yardsPerPass_opponent,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffYPRAOff =</span> yardsPerRushAttempt_team <span class="sc">-</span> defenseYPRAAllowed_opponent,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffYPRADef =</span> defenseYPRAAllowed_team <span class="sc">-</span> yardsPerRushAttempt_opponent,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffPassYardsOff =</span> netPassingYards_team <span class="sc">-</span> defensePassYardsAllowed_opponent,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffPassYardsDef =</span> defensePassYardsAllowed_team <span class="sc">-</span> netPassingYards_opponent,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffRushYardsOff =</span> rushingYards_team <span class="sc">-</span> defenseRushYardsAllowed_opponent,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffRushYardsDef =</span> defenseRushYardsAllowed_team <span class="sc">-</span> rushingYards_opponent,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffYPPOff =</span> yardsPerPlay_team <span class="sc">-</span> defenseYardsPerPlayAllowed_opponent,</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffYPPDef =</span> defenseYardsPerPlayAllowed_team <span class="sc">-</span> yardsPerPlay_opponent,</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffELO =</span> elo_team <span class="sc">-</span> elo_opponent,</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffWinPct =</span> winPct_team <span class="sc">-</span> winPct_opponent</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>elo_team, <span class="sc">-</span>elo_opponent, <span class="sc">-</span>winPct_team, <span class="sc">-</span>winPct_opponent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>At this point, I noticed that there are a number of NAs in the <code>spread_team</code> column, and they’re all from the 2020 season. I guess that might have to do with it being the first COVID season. I’ll replace those NAs with 0s - again, maybe not the best idea if I was doing this for real.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">spread_team =</span> <span class="fu">replace_na</span>(spread_team, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>One last thing. This is going to seem out of place here, but since I cranked away at this data set a bunch of times as I was working through this, I developed some insights and some practices. First, I’ll explicitly set the teams as factors instead of strings. I’ll also generate a new column, <code>diffMOV</code> as the difference in the mean margin of victory - that turned out to be useful. I’ll also get rid of any column with “TD” in it’s name because I found them to be unhelpful. Same thing with pass completions, pass attempts (I essentially have those already in <code>passEfficiency</code>), and rushing attempts. Finally, I reorder columns to make looking at the dataset a little easier.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>lvls <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">c</span>(df <span class="sc">%&gt;%</span> .<span class="sc">$</span>school_team, df <span class="sc">%&gt;%</span> .<span class="sc">$</span>school_opponent)))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">school_team =</span> <span class="fu">factor</span>(school_team, <span class="at">levels =</span> lvls),</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">school_opponent =</span> <span class="fu">factor</span>(school_opponent, <span class="at">levels =</span> lvls),</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">diffMOV  =</span> MOV_team <span class="sc">-</span> MOV_opponent) <span class="sc">%&gt;%</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>MOV_team, <span class="sc">-</span>MOV_opponent,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>rushingTDs_team, <span class="sc">-</span>rushingTDs_opponent,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>puntReturnTDs_team, <span class="sc">-</span>puntReturnTDs_opponent,</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>passingTDs_team, <span class="sc">-</span>passingTDs_opponent,</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>kickReturnTDs_team, <span class="sc">-</span>kickReturnTDs_opponent,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>interceptionTDs_team, <span class="sc">-</span>interceptionTDs_opponent,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>passCompletions_team, <span class="sc">-</span>passCompletions_opponent,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>passAttempts_team, <span class="sc">-</span>passAttempts_opponent,</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>rushingAttempts_team, <span class="sc">-</span>rushingAttempts_opponent</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, week, year, school_team, MOV_actual_team, HFA_team, spread_team, </span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>         school_opponent, diffELO, <span class="fu">everything</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Data wrangling is finally complete, and the data are now ready to be split into training and test data sets. The training data will be the 2017-2020 seasons (<code>df20</code>), and I’ll train some models on that to predict the 2021 season (<code>df21</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>df20 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">&lt;</span> <span class="dv">2021</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>year)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>df21 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2021</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Pause one more time and think about the data at this point. Recall that the df20 and df21 data are game <strong>results</strong>. I can’t use game results in the test data set - I won’t have results prior to each game being played! I will however have week 1 results available at the start of week 2, and both of those will be available at the start of week 3, and so on. If I group the test data by team and week, I can just shift all of the results data down one row. That will produce NAs for the first game each team plays, so I’ll drop those. This means I won’t have a prediction for the first game each team plays, either. I’ll need to find another way of doing things if I want to do this for real. Forging ahead anyway for now…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>df21 <span class="ot">&lt;-</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  df21 <span class="sc">%&gt;%</span>  </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(school_team, week) <span class="sc">%&gt;%</span> </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(school_team) <span class="sc">%&gt;%</span> </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="dv">9</span><span class="sc">:</span><span class="dv">102</span>, lag)) <span class="sc">%&gt;%</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>year)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["id"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["week"],"name":[2],"type":["int"],"align":["right"]},{"label":["school_team"],"name":[3],"type":["fct"],"align":["left"]},{"label":["MOV_actual_team"],"name":[4],"type":["int"],"align":["right"]},{"label":["HFA_team"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["spread_team"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["school_opponent"],"name":[7],"type":["fct"],"align":["left"]},{"label":["diffELO"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["points_team"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["puntReturnYards_team"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["puntReturns_team"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["kickReturnYards_team"],"name":[12],"type":["dbl"],"align":["right"]},{"label":["kickReturns_team"],"name":[13],"type":["dbl"],"align":["right"]},{"label":["kickingPoints_team"],"name":[14],"type":["dbl"],"align":["right"]},{"label":["interceptionYards_team"],"name":[15],"type":["dbl"],"align":["right"]},{"label":["passesIntercepted_team"],"name":[16],"type":["dbl"],"align":["right"]},{"label":["fumblesRecovered_team"],"name":[17],"type":["dbl"],"align":["right"]},{"label":["totalFumbles_team"],"name":[18],"type":["dbl"],"align":["right"]},{"label":["tacklesForLoss_team"],"name":[19],"type":["dbl"],"align":["right"]},{"label":["defensiveTDs_team"],"name":[20],"type":["dbl"],"align":["right"]},{"label":["tackles_team"],"name":[21],"type":["dbl"],"align":["right"]},{"label":["sacks_team"],"name":[22],"type":["dbl"],"align":["right"]},{"label":["qbHurries_team"],"name":[23],"type":["dbl"],"align":["right"]},{"label":["passesDeflected_team"],"name":[24],"type":["dbl"],"align":["right"]},{"label":["firstDowns_team"],"name":[25],"type":["dbl"],"align":["right"]},{"label":["netPassingYards_team"],"name":[26],"type":["dbl"],"align":["right"]},{"label":["yardsPerPass_team"],"name":[27],"type":["dbl"],"align":["right"]},{"label":["rushingYards_team"],"name":[28],"type":["dbl"],"align":["right"]},{"label":["yardsPerRushAttempt_team"],"name":[29],"type":["dbl"],"align":["right"]},{"label":["penalties_team"],"name":[30],"type":["dbl"],"align":["right"]},{"label":["penaltiesYards_team"],"name":[31],"type":["dbl"],"align":["right"]},{"label":["turnovers_team"],"name":[32],"type":["dbl"],"align":["right"]},{"label":["fumblesLost_team"],"name":[33],"type":["dbl"],"align":["right"]},{"label":["interceptions_team"],"name":[34],"type":["dbl"],"align":["right"]},{"label":["posTime_team"],"name":[35],"type":["dbl"],"align":["right"]},{"label":["yardsPerPenalty_team"],"name":[36],"type":["dbl"],"align":["right"]},{"label":["passEfficiency_team"],"name":[37],"type":["dbl"],"align":["right"]},{"label":["yardsPerPlay_team"],"name":[38],"type":["dbl"],"align":["right"]},{"label":["offensePoints_team"],"name":[39],"type":["dbl"],"align":["right"]},{"label":["offenseYards_team"],"name":[40],"type":["dbl"],"align":["right"]},{"label":["defensePointsAllowed_team"],"name":[41],"type":["dbl"],"align":["right"]},{"label":["defenseYPPAAllowed_team"],"name":[42],"type":["dbl"],"align":["right"]},{"label":["defenseYPRAAllowed_team"],"name":[43],"type":["dbl"],"align":["right"]},{"label":["defensePassYardsAllowed_team"],"name":[44],"type":["dbl"],"align":["right"]},{"label":["defenseRushYardsAllowed_team"],"name":[45],"type":["dbl"],"align":["right"]},{"label":["defenseYardsPerPlayAllowed_team"],"name":[46],"type":["dbl"],"align":["right"]},{"label":["forcedPenaltyYards_team"],"name":[47],"type":["dbl"],"align":["right"]},{"label":["forcedTO_team"],"name":[48],"type":["dbl"],"align":["right"]},{"label":["points_opponent"],"name":[49],"type":["dbl"],"align":["right"]},{"label":["puntReturnYards_opponent"],"name":[50],"type":["dbl"],"align":["right"]},{"label":["puntReturns_opponent"],"name":[51],"type":["dbl"],"align":["right"]},{"label":["kickReturnYards_opponent"],"name":[52],"type":["dbl"],"align":["right"]},{"label":["kickReturns_opponent"],"name":[53],"type":["dbl"],"align":["right"]},{"label":["kickingPoints_opponent"],"name":[54],"type":["dbl"],"align":["right"]},{"label":["interceptionYards_opponent"],"name":[55],"type":["dbl"],"align":["right"]},{"label":["passesIntercepted_opponent"],"name":[56],"type":["dbl"],"align":["right"]},{"label":["fumblesRecovered_opponent"],"name":[57],"type":["dbl"],"align":["right"]},{"label":["totalFumbles_opponent"],"name":[58],"type":["dbl"],"align":["right"]},{"label":["tacklesForLoss_opponent"],"name":[59],"type":["dbl"],"align":["right"]},{"label":["defensiveTDs_opponent"],"name":[60],"type":["dbl"],"align":["right"]},{"label":["tackles_opponent"],"name":[61],"type":["dbl"],"align":["right"]},{"label":["sacks_opponent"],"name":[62],"type":["dbl"],"align":["right"]},{"label":["qbHurries_opponent"],"name":[63],"type":["dbl"],"align":["right"]},{"label":["passesDeflected_opponent"],"name":[64],"type":["dbl"],"align":["right"]},{"label":["firstDowns_opponent"],"name":[65],"type":["dbl"],"align":["right"]},{"label":["netPassingYards_opponent"],"name":[66],"type":["dbl"],"align":["right"]},{"label":["yardsPerPass_opponent"],"name":[67],"type":["dbl"],"align":["right"]},{"label":["rushingYards_opponent"],"name":[68],"type":["dbl"],"align":["right"]},{"label":["yardsPerRushAttempt_opponent"],"name":[69],"type":["dbl"],"align":["right"]},{"label":["penalties_opponent"],"name":[70],"type":["dbl"],"align":["right"]},{"label":["penaltiesYards_opponent"],"name":[71],"type":["dbl"],"align":["right"]},{"label":["turnovers_opponent"],"name":[72],"type":["dbl"],"align":["right"]},{"label":["fumblesLost_opponent"],"name":[73],"type":["dbl"],"align":["right"]},{"label":["interceptions_opponent"],"name":[74],"type":["dbl"],"align":["right"]},{"label":["posTime_opponent"],"name":[75],"type":["dbl"],"align":["right"]},{"label":["yardsPerPenalty_opponent"],"name":[76],"type":["dbl"],"align":["right"]},{"label":["passEfficiency_opponent"],"name":[77],"type":["dbl"],"align":["right"]},{"label":["yardsPerPlay_opponent"],"name":[78],"type":["dbl"],"align":["right"]},{"label":["offensePoints_opponent"],"name":[79],"type":["dbl"],"align":["right"]},{"label":["offenseYards_opponent"],"name":[80],"type":["dbl"],"align":["right"]},{"label":["defensePointsAllowed_opponent"],"name":[81],"type":["dbl"],"align":["right"]},{"label":["defenseYPPAAllowed_opponent"],"name":[82],"type":["dbl"],"align":["right"]},{"label":["defenseYPRAAllowed_opponent"],"name":[83],"type":["dbl"],"align":["right"]},{"label":["defensePassYardsAllowed_opponent"],"name":[84],"type":["dbl"],"align":["right"]},{"label":["defenseRushYardsAllowed_opponent"],"name":[85],"type":["dbl"],"align":["right"]},{"label":["defenseYardsPerPlayAllowed_opponent"],"name":[86],"type":["dbl"],"align":["right"]},{"label":["forcedPenaltyYards_opponent"],"name":[87],"type":["dbl"],"align":["right"]},{"label":["forcedTO_opponent"],"name":[88],"type":["dbl"],"align":["right"]},{"label":["diffPointsScored"],"name":[89],"type":["dbl"],"align":["right"]},{"label":["diffPointsAllowed"],"name":[90],"type":["dbl"],"align":["right"]},{"label":["diffYPPAOff"],"name":[91],"type":["dbl"],"align":["right"]},{"label":["diffYPPADef"],"name":[92],"type":["dbl"],"align":["right"]},{"label":["diffYPRAOff"],"name":[93],"type":["dbl"],"align":["right"]},{"label":["diffYPRADef"],"name":[94],"type":["dbl"],"align":["right"]},{"label":["diffPassYardsOff"],"name":[95],"type":["dbl"],"align":["right"]},{"label":["diffPassYardsDef"],"name":[96],"type":["dbl"],"align":["right"]},{"label":["diffRushYardsOff"],"name":[97],"type":["dbl"],"align":["right"]},{"label":["diffRushYardsDef"],"name":[98],"type":["dbl"],"align":["right"]},{"label":["diffYPPOff"],"name":[99],"type":["dbl"],"align":["right"]},{"label":["diffYPPDef"],"name":[100],"type":["dbl"],"align":["right"]},{"label":["diffWinPct"],"name":[101],"type":["dbl"],"align":["right"]},{"label":["diffMOV"],"name":[102],"type":["dbl"],"align":["right"]}],"data":[{"1":"401310704","2":"3","3":"Air Force","4":"-4","5":"1","6":"-8.900","7":"Utah State","8":"296","9":"23.00000","10":"0","11":"1.0000000","12":"47.000000","13":"2.000000","14":"3.000000","15":"0.000000","16":"0.0000000","17":"0.000000","18":"1.000000","19":"10.000000","20":"0","21":"22.00000","22":"5.000000","23":"6.000000","24":"1.000000","25":"14.00000","26":"49.00000","27":"4.90000","28":"176.0000","29":"3.000000","30":"5.000000","31":"38.00000","32":"0.0000000","33":"0.0000000","34":"0.0000000","35":"2208.000","36":"7.600000","37":"0.3000000","38":"3.950","39":"24.00000","40":"225.0000","41":"3.00000","42":"3.200000","43":"1.100000","44":"32.0000","45":"36.00000","46":"2.150000","47":"27.00000","48":"1.000000","49":"5.00000","50":"6.00000","51":"1.000000","52":"71.00000","53":"4.500000","54":"2.000000","55":"11.00000","56":"1.000000","57":"0.5000000","58":"1.000000","59":"4.000000","60":"0.0000000","61":"31.50000","62":"1.0000000","63":"4.000000","64":"3.000000","65":"15.00000","66":"46.5000","67":"3.500000","68":"186.50000","69":"2.750","70":"3.000000","71":"24.50000","72":"1.500000","73":"0.5000000","74":"1.0000000","75":"1935.500","76":"9.500000","77":"0.3062500","78":"3.125000","79":"5.50000","80":"233.0000","81":"40.00000","82":"7.950000","83":"3.200000","84":"206.0000","85":"138.5000","86":"5.575000","87":"42.50000","88":"1.500000","89":"-16.000000","90":"-2.5000000","91":"-3.050000","92":"-0.300000","93":"-0.2000000","94":"-1.6500000","95":"-157.00000","96":"-14.50000","97":"37.50000","98":"-150.50000","99":"-1.625000","100":"-0.9750000","101":"1.0000000","102":"51.000000"},{"1":"401282207","2":"4","3":"Air Force","4":"24","5":"1","6":"-3.625","7":"Florida Atlantic","8":"29","9":"34.00000","10":"0","11":"0.5000000","12":"25.500000","13":"3.000000","14":"6.000000","15":"4.000000","16":"0.5000000","17":"0.000000","18":"1.000000","19":"5.000000","20":"0","21":"33.50000","22":"3.500000","23":"4.500000","24":"2.500000","25":"18.50000","26":"115.50000","27":"10.05000","28":"306.5000","29":"4.950000","30":"5.000000","31":"34.00000","32":"1.0000000","33":"0.5000000","34":"0.5000000","35":"2123.500","36":"6.800000","37":"0.4000000","38":"7.500","39":"37.50000","40":"422.0000","41":"28.50000","42":"6.100000","43":"2.850000","44":"240.0000","45":"108.00000","46":"4.475000","47":"36.00000","48":"1.000000","49":"37.50000","50":"0.00000","51":"0.000000","52":"82.00000","53":"4.500000","54":"7.500000","55":"4.00000","56":"0.500000","57":"1.5000000","58":"0.500000","59":"4.000000","60":"0.0000000","61":"36.00000","62":"1.5000000","63":"1.500000","64":"2.500000","65":"25.50000","66":"333.5000","67":"7.550000","68":"201.00000","69":"4.700","70":"7.500000","71":"61.50000","72":"1.500000","73":"0.5000000","74":"1.0000000","75":"1690.000","76":"8.089286","77":"0.6294444","78":"6.125000","79":"39.00000","80":"534.5000","81":"38.00000","82":"10.600000","83":"6.300000","84":"196.5000","85":"293.0000","86":"8.450000","87":"40.00000","88":"1.500000","89":"-0.500000","90":"-10.5000000","91":"-0.550000","92":"-1.450000","93":"-1.3500000","94":"-1.8500000","95":"-81.00000","96":"-93.50000","97":"13.50000","98":"-93.00000","99":"-0.950000","100":"-1.6500000","101":"-0.5000000","102":"4.500000"},{"1":"401310710","2":"5","3":"Air Force","4":"28","5":"-1","6":"-11.500","7":"New Mexico","8":"397","9":"33.00000","10":"0","11":"0.3333333","12":"17.000000","13":"2.000000","14":"6.333333","15":"2.666667","16":"0.6666667","17":"0.000000","18":"1.000000","19":"4.333333","20":"0","21":"30.33333","22":"2.666667","23":"4.000000","24":"4.000000","25":"20.33333","26":"100.33333","27":"11.36667","28":"353.0000","29":"5.333333","30":"4.333333","31":"27.66667","32":"0.6666667","33":"0.3333333","34":"0.3333333","35":"2234.667","36":"6.200000","37":"0.4000000","38":"8.350","39":"36.66667","40":"453.3333","41":"21.66667","42":"4.866667","43":"4.266667","44":"186.0000","45":"119.00000","46":"4.566667","47":"37.33333","48":"1.000000","49":"19.66667","50":"5.00000","51":"1.333333","52":"48.33333","53":"2.333333","54":"3.666667","55":"0.00000","56":"1.000000","57":"0.3333333","58":"2.333333","59":"3.333333","60":"0.0000000","61":"35.66667","62":"0.3333333","63":"1.000000","64":"2.666667","65":"20.00000","66":"223.6667","67":"7.233333","68":"143.00000","69":"4.700","70":"6.000000","71":"49.33333","72":"1.000000","73":"0.6666667","74":"0.3333333","75":"1651.667","76":"8.222222","77":"0.5214211","78":"5.966667","79":"22.33333","80":"366.6667","81":"27.33333","82":"7.766667","83":"6.166667","84":"113.6667","85":"328.6667","86":"6.966667","87":"37.00000","88":"1.333333","89":"9.333333","90":"-0.6666667","91":"3.600000","92":"-2.366667","93":"-0.8333333","94":"-0.4333333","95":"-13.33333","96":"-37.66667","97":"24.33333","98":"-24.00000","99":"1.383333","100":"-1.4000000","101":"0.3333333","102":"17.666667"},{"1":"401310714","2":"6","3":"Air Force","4":"10","5":"1","6":"-5.500","7":"Wyoming","8":"148","9":"34.25000","10":"0","11":"0.2500000","12":"12.750000","13":"1.500000","14":"6.750000","15":"6.500000","16":"0.7500000","17":"1.000000","18":"1.250000","19":"4.250000","20":"0","21":"28.75000","22":"3.000000","23":"3.750000","24":"3.000000","25":"21.25000","26":"83.50000","27":"12.65000","28":"366.7500","29":"5.400000","30":"4.750000","31":"34.50000","32":"0.5000000","33":"0.2500000","34":"0.2500000","35":"2304.250","36":"6.941667","37":"0.4250000","38":"9.025","39":"38.25000","40":"450.2500","41":"19.00000","42":"5.600000","43":"3.800000","44":"184.2500","45":"101.00000","46":"4.700000","47":"47.75000","48":"1.500000","49":"14.25000","50":"17.75000","51":"0.750000","52":"74.75000","53":"3.000000","54":"5.250000","55":"0.00000","56":"1.000000","57":"0.0000000","58":"1.250000","59":"3.750000","60":"0.0000000","61":"28.25000","62":"1.5000000","63":"1.500000","64":"2.500000","65":"17.25000","66":"189.5000","67":"5.850000","68":"109.25000","69":"3.075","70":"8.250000","71":"68.25000","72":"1.500000","73":"0.7500000","74":"0.7500000","75":"1702.000","76":"7.652778","77":"0.5408966","78":"4.462500","79":"15.75000","80":"298.7500","81":"32.00000","82":"10.025000","83":"4.075000","84":"209.2500","85":"180.5000","86":"7.050000","87":"54.75000","88":"1.000000","89":"6.250000","90":"3.2500000","91":"2.625000","92":"-0.250000","93":"1.3250000","94":"0.7250000","95":"-125.75000","96":"-5.25000","97":"186.25000","98":"-8.25000","99":"1.975000","100":"0.2375000","101":"0.5000000","102":"32.000000"},{"1":"401310718","2":"7","3":"Air Force","4":"7","5":"-1","6":"3.125","7":"Boise State","8":"1","9":"32.20000","10":"0","11":"0.2000000","12":"10.200000","13":"1.400000","14":"6.600000","15":"5.200000","16":"0.6000000","17":"1.200000","18":"2.000000","19":"4.400000","20":"0","21":"27.80000","22":"3.000000","23":"3.000000","24":"3.800000","25":"21.00000","26":"88.80000","27":"12.32000","28":"335.6000","29":"4.980000","30":"4.000000","31":"28.60000","32":"0.6000000","33":"0.4000000","34":"0.2000000","35":"2309.000","36":"6.553333","37":"0.4800000","38":"8.650","39":"36.00000","40":"424.4000","41":"18.40000","42":"5.500000","43":"3.880000","44":"176.0000","45":"103.60000","46":"4.690000","47":"46.20000","48":"1.600000","49":"33.25000","50":"6.25000","51":"1.250000","52":"23.50000","53":"1.250000","54":"5.750000","55":"33.75000","56":"1.500000","57":"0.7500000","58":"2.000000","59":"6.250000","60":"1.0000000","61":"53.00000","62":"3.5000000","63":"3.750000","64":"3.750000","65":"20.00000","66":"174.2500","67":"7.100000","68":"171.25000","69":"4.350","70":"6.000000","71":"52.25000","72":"1.250000","73":"0.7500000","74":"0.5000000","75":"1754.500","76":"8.516667","77":"0.5359233","78":"5.725000","79":"32.00000","80":"345.5000","81":"28.50000","82":"6.525000","83":"4.125000","84":"164.0000","85":"170.7500","86":"5.325000","87":"31.25000","88":"2.000000","89":"7.500000","90":"-13.6000000","91":"5.795000","92":"-1.600000","93":"0.8550000","94":"-0.4700000","95":"-75.20000","96":"1.75000","97":"164.85000","98":"-67.65000","99":"3.325000","100":"-1.0350000","101":"0.0500000","102":"7.600000"},{"1":"401310724","2":"8","3":"Air Force","4":"-6","5":"1","6":"-2.875","7":"San Diego State","8":"101","9":"30.83333","10":"0","11":"0.1666667","12":"8.166667","13":"1.666667","14":"6.500000","15":"5.666667","16":"0.6666667","17":"1.166667","18":"1.833333","19":"4.000000","20":"0","21":"29.00000","22":"2.833333","23":"3.166667","24":"3.333333","25":"20.66667","26":"83.83333","27":"12.23333","28":"330.8333","29":"4.966667","30":"4.000000","31":"31.00000","32":"0.6666667","33":"0.5000000","34":"0.1666667","35":"2294.000","36":"7.252778","37":"0.4333333","38":"8.600","39":"34.50000","40":"414.6667","41":"18.50000","42":"5.783333","43":"3.750000","44":"189.8333","45":"99.33333","46":"4.766667","47":"51.00000","48":"1.666667","49":"29.42857","50":"19.71429","51":"1.000000","52":"54.14286","53":"2.571429","54":"9.714286","55":"33.14286","56":"1.142857","57":"1.2857143","58":"2.142857","59":"5.000000","60":"0.2857143","61":"42.00000","62":"2.2857143","63":"1.428571","64":"2.857143","65":"21.14286","66":"278.5714","67":"7.957143","68":"87.42857","69":"2.400","70":"5.428571","71":"51.71429","72":"1.428571","73":"0.7142857","74":"0.7142857","75":"1722.000","76":"9.215136","77":"0.6402302","78":"5.178571","79":"30.71429","80":"366.0000","81":"24.14286","82":"8.171429","83":"4.442857","84":"209.1429","85":"198.2857","86":"6.307143","87":"66.42857","88":"2.428571","89":"10.357143","90":"-12.2142857","91":"4.061905","92":"-2.173810","93":"0.5238095","94":"1.3500000","95":"-125.30952","96":"-88.73810","97":"132.54762","98":"11.90476","99":"2.292857","100":"-0.4119048","101":"0.4047619","102":"6.880952"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="feature-selection-with-lasso-regression" class="level2">
<h2 class="anchored" data-anchor-id="feature-selection-with-lasso-regression">Feature Selection With Lasso Regression</h2>
<p>That was a fair amount of work! We now have data sets with 102 columns, and I know that a decent amount of those columns are just noise. My go-to method for feature selection is lasso regression, and it happens to be the same techniques used by the authors. But wait! I’ve been a fan of the <code>caret</code> package to do modeling, but now there’s <a href="https://www.tidymodels.org/start/">tidymodels</a> - written with tidy concepts in mind. And written by Max Kuhn - the author of <code>caret</code>. I’ve been wanting to try this out, so here goes.</p>
<p>After importing the library, I need to get my training and test sets back into one dataset so tidymodels can do its thing in its tidy way. I join them and the re-split them with <code>initial_time_split()</code> because my observations are by week and year. The proportion is 2682/3298 because the first 2682 observations are the games in the 2017-2020 seasons. I’ll also create a validation data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>df_joined <span class="ot">&lt;-</span> df20 <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>(df21)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>data_split <span class="ot">&lt;-</span> <span class="fu">initial_time_split</span>(df_joined, <span class="at">prop =</span> <span class="dv">2682</span><span class="sc">/</span><span class="dv">3298</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(data_split)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>test_data  <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’m not going to go into detail here about what each of these steps are doing because I can’t to it any better than <a href="https://www.tidymodels.org/start/">the docs</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create the recipe</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># note I omit the categorical school variables</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>lm_rec <span class="ot">&lt;-</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(MOV_actual_team <span class="sc">~</span> ., <span class="at">data =</span> train_data <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>id, <span class="sc">-</span>week, <span class="sc">-</span>school_team, <span class="sc">-</span>school_opponent)) <span class="sc">%&gt;%</span> </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span>        <span class="co"># one-hot encoding</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>()) <span class="sc">%&gt;%</span>                   <span class="co"># eliminate zero variance columns</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric</span>(), <span class="sc">-</span><span class="fu">all_outcomes</span>())  <span class="co"># normalize numeric variables</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co"># define the model and hyperparameters to tune</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>lm_mod <span class="ot">&lt;-</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fu">tune</span>(), <span class="at">mixture =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co"># values to select when tuning</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>lambda_grid <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">penalty =</span> <span class="dv">10</span><span class="sc">^</span><span class="fu">seq</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">50</span>))</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="co"># cross validation folds</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">345</span>)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(train_data, <span class="at">v =</span> <span class="dv">10</span>)</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="co"># create the workflow</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>lm_wflow <span class="ot">&lt;-</span> </span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_mod) <span class="sc">%&gt;%</span> </span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(lm_rec)</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a><span class="co"># tune the model</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>lm_res <span class="ot">&lt;-</span> </span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>  lm_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> lambda_grid,</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> folds,</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">control_grid</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s take a look at the mean error and R-squared for the different penalty values (thanks to <a href="https://juliasilge.com/blog/lasso-the-office/">this post</a> for the nice plot idea).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>lm_res <span class="sc">%&gt;%</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(penalty, mean, <span class="at">color =</span> .metric)) <span class="sc">+</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">ymin =</span> mean <span class="sc">-</span> std_err,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">ymax =</span> mean <span class="sc">+</span> std_err</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.metric, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>() <span class="sc">+</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>I have some choices of what do to next. Normally, what I’d do is select the simplest model within one standard error of the model with the lowest RMSE. I can do that with the <code>select_by_one_std_err()</code> function as shown below. Note the penalty value for that model and hold that thought.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>lm_res <span class="sc">%&gt;%</span> <span class="fu">select_by_one_std_err</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>, <span class="fu">desc</span>(penalty))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["penalty"],"name":[1],"type":["dbl"],"align":["right"]},{"label":[".metric"],"name":[2],"type":["chr"],"align":["left"]},{"label":[".estimator"],"name":[3],"type":["chr"],"align":["left"]},{"label":["mean"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["n"],"name":[5],"type":["int"],"align":["right"]},{"label":["std_err"],"name":[6],"type":["dbl"],"align":["right"]},{"label":[".config"],"name":[7],"type":["chr"],"align":["left"]},{"label":[".best"],"name":[8],"type":["dbl"],"align":["right"]},{"label":[".bound"],"name":[9],"type":["dbl"],"align":["right"]}],"data":[{"1":"1.599859","2":"rmse","3":"standard","4":"12.78504","5":"10","6":"0.2438228","7":"Preprocessor1_Model37","8":"12.57348","9":"12.80983"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>I could also forget the “within one standard error” aspect and just select the model with the lowest RMSE (or I could select the least complex model that has no more than a certain percentage loss of RMSE). Select the model with the lowest error gives the folloing penalty value. Which one shoud I choose?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>lowest_rmse <span class="ot">&lt;-</span> lm_res <span class="sc">%&gt;%</span> <span class="fu">select_best</span>(<span class="st">"rmse"</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>lowest_rmse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["penalty"],"name":[1],"type":["dbl"],"align":["right"]},{"label":[".config"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"0.2559548","2":"Preprocessor1_Model24"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Take a look at the model object below. If I go with the 1SE lambda of 1.6, based on the degrees of freedom (Df) I’ll have only 2 or 3 predictors in the model (1.64 just happens to fall between the two penalty values below, so I’m not sure how many predictor will actually be selected). So out of about 100 predictors, only 2 or three will be selected. To me, that means a few variables dominate and the rest are just noise. With the lowest RMSE lambda value of 0.256, there will be 21-22 predictors selected. For the purpose of this post, I’m going to choose the lowest RMSE.</p>
<p>For the final fit, I finalize the work flow based on the lowest RMSE. Notice I also use <code>data_split</code>, which contains both the training and test data. From that fit, I get the RMSE and R-squared for the test data set. The RMSE is about 3 touchdowns, and the R-squared is alarmingly low.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>lm_final_wf <span class="ot">&lt;-</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  lm_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(lowest_rmse)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>lm_final_fit <span class="ot">&lt;-</span> </span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  lm_final_wf <span class="sc">%&gt;%</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(data_split) </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>lm_final_fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[".metric"],"name":[1],"type":["chr"],"align":["left"]},{"label":[".estimator"],"name":[2],"type":["chr"],"align":["left"]},{"label":[".estimate"],"name":[3],"type":["dbl"],"align":["right"]},{"label":[".config"],"name":[4],"type":["chr"],"align":["left"]}],"data":[{"1":"rmse","2":"standard","3":"21.1776241","4":"Preprocessor1_Model1"},{"1":"rsq","2":"standard","3":"0.1532188","4":"Preprocessor1_Model1"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>lm_final_fit <span class="sc">%&gt;%</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>parsnip model object


Call:  glmnet::glmnet(x = maybe_matrix(x), y = y, family = "gaussian",      alpha = ~1) 

   Df  %Dev  Lambda
1   0  0.00 17.7300
2   1 11.16 16.1500
3   1 20.42 14.7200
4   1 28.11 13.4100
5   1 34.50 12.2200
6   1 39.80 11.1300
7   1 44.20 10.1500
8   1 47.85  9.2440
9   1 50.88  8.4230
10  1 53.40  7.6750
11  1 55.49  6.9930
12  1 57.23  6.3720
13  1 58.67  5.8060
14  2 59.87  5.2900
15  2 60.98  4.8200
16  2 61.90  4.3920
17  2 62.66  4.0020
18  2 63.29  3.6460
19  2 63.82  3.3220
20  2 64.25  3.0270
21  2 64.62  2.7580
22  2 64.92  2.5130
23  2 65.17  2.2900
24  2 65.37  2.0860
25  2 65.54  1.9010
26  2 65.69  1.7320
27  3 65.84  1.5780
28  3 66.00  1.4380
29  3 66.13  1.3100
30  4 66.24  1.1940
31  5 66.35  1.0880
32  6 66.45  0.9913
33  6 66.55  0.9032
34  6 66.63  0.8230
35  7 66.72  0.7498
36  7 66.80  0.6832
37 10 66.87  0.6225
38 13 66.95  0.5672
39 14 67.03  0.5168
40 15 67.10  0.4709
41 15 67.16  0.4291
42 17 67.21  0.3910
43 18 67.26  0.3562
44 20 67.30  0.3246
45 21 67.35  0.2958
46 21 67.38  0.2695
47 22 67.42  0.2455
48 22 67.45  0.2237
49 22 67.47  0.2039
50 24 67.50  0.1857
51 28 67.52  0.1692
52 32 67.55  0.1542
53 35 67.58  0.1405
54 39 67.64  0.1280
55 42 67.69  0.1167
56 43 67.74  0.1063
57 45 67.79  0.0969
58 46 67.83  0.0882
59 47 67.86  0.0804
60 51 67.90  0.0733
61 54 67.93  0.0668
62 54 67.96  0.0608
63 55 67.98  0.0554
64 56 68.00  0.0505
65 57 68.02  0.0460
66 59 68.05  0.0419
67 59 68.06  0.0382
68 59 68.07  0.0348
69 59 68.08  0.0317
70 61 68.09  0.0289
71 62 68.10  0.0263
72 64 68.10  0.0240
73 65 68.11  0.0219
74 68 68.11  0.0199
75 69 68.13  0.0181
76 70 68.13  0.0165
77 72 68.14  0.0151
78 72 68.15  0.0137
79 73 68.15  0.0125
80 74 68.16  0.0114
81 74 68.16  0.0104
82 74 68.17  0.0095
83 74 68.17  0.0086
84 75 68.17  0.0079
85 75 68.19  0.0072
86 76 68.19  0.0065</code></pre>
</div>
</div>
<p>Here I plot the selected predictors color coded by whether the coefficient is positive or negative. Clearly, <code>diffMOV</code> dominates all other variables. Other important variables include the spread and home field advantage. Everything after that is probably just noise.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>lm_final_fit <span class="sc">%&gt;%</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  vip<span class="sc">::</span><span class="fu">vi</span>(<span class="at">lambda =</span> lowest_rmse<span class="sc">$</span>penalty) <span class="sc">%&gt;%</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">Importance =</span> <span class="fu">abs</span>(Importance),</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Variable =</span> forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(Variable, Importance)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Importance <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Importance, <span class="at">y =</span> Variable, <span class="at">fill =</span> Sign)) <span class="sc">+</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Well, what if we were to make predictions based off of this model? First I’ll make a scatter plot of predictions versus actual MOV.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>lm_final_fit <span class="sc">%&gt;%</span> </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span><span class="st">`</span><span class="at">.pred</span><span class="st">`</span>, <span class="at">y=</span>MOV_actual_team)) <span class="sc">+</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Linear Model Prediction Results"</span>,</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Predicted MOV"</span>,</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Actual MOV"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>NThere’s a little bit of a trend there, but it looks more like a shotgun blast. Not surprising, though, given the RMSE and R-squared we saw earlier. Let’s see what percent of predictions were correct in a head-to-head sense - in other words, what percent predicted just the correct winner.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>lm_final_fit <span class="sc">%&gt;%</span> </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">both_positive =</span> <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">both_negative =</span> <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&lt;</span> <span class="dv">0</span>,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">correct =</span> both_positive <span class="sc">+</span> both_negative) <span class="sc">%&gt;%</span> </span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">sumCorrect =</span> <span class="fu">sum</span>(correct)) <span class="sc">/</span> <span class="fu">nrow</span>(df21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["sumCorrect"],"name":[1],"type":["dbl"],"align":["right"]}],"data":[{"1":"0.6396104"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Hmm… 64% Better than half, anyway, but not very impressive. Before I move on to another model type, I’ll grab the 22 predictors so I can remove everything else from the training and test data sets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>keep_vars <span class="ot">&lt;-</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  lm_final_fit <span class="sc">%&gt;%</span> </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  vip<span class="sc">::</span><span class="fu">vi</span>(<span class="at">lambda =</span> lowest_rmse<span class="sc">$</span>penalty) <span class="sc">%&gt;%</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Importance <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  .<span class="sc">$</span> Variable</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="random-forest-model" class="level2">
<h2 class="anchored" data-anchor-id="random-forest-model">Random Forest Model</h2>
<p>I’ll try a few different models with the same data and see how they compare. I’ll start with a random forest model using the <code>ranger package</code>. I’ll use the same tidymodels procedure as above: create a recipe, model, and workflow, tune hyperparameters, and show the errors for the best model. This takes a while to execute on my laptop even when using all available cores.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>cores <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>()</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co"># the recipe</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>rf_rec <span class="ot">&lt;-</span> </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(MOV_actual_team <span class="sc">~</span> ., <span class="at">data =</span> train_data <span class="sc">%&gt;%</span> <span class="fu">select</span>(keep_vars, MOV_actual_team)) <span class="sc">%&gt;%</span> </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>())</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="co"># the model to tune</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>rf_mod <span class="ot">&lt;-</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rand_forest</span>(<span class="at">mtry =</span> <span class="fu">tune</span>(), <span class="at">min_n =</span> <span class="fu">tune</span>(), <span class="at">trees =</span> <span class="dv">1000</span>) <span class="sc">%&gt;%</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>, <span class="at">importance =</span> <span class="st">"impurity"</span>, <span class="at">num.threads =</span> cores) <span class="sc">%&gt;%</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a><span class="co"># the workflow</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>rf_wflow <span class="ot">&lt;-</span> </span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(rf_mod) <span class="sc">%&gt;%</span> </span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rf_rec)</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a><span class="co"># now set the seed for reproducability and tune the hyperparameters</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>rf_fit <span class="ot">&lt;-</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>  rf_wflow <span class="sc">%&gt;%</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(<span class="at">grid =</span> <span class="dv">25</span>,</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>            <span class="at">control =</span> <span class="fu">control_grid</span>(),</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>            <span class="at">resamples =</span> folds)</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a><span class="co"># take a look at the best models</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>rf_fit <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["mtry"],"name":[1],"type":["int"],"align":["right"]},{"label":["min_n"],"name":[2],"type":["int"],"align":["right"]},{"label":[".metric"],"name":[3],"type":["chr"],"align":["left"]},{"label":[".estimator"],"name":[4],"type":["chr"],"align":["left"]},{"label":["mean"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["n"],"name":[6],"type":["int"],"align":["right"]},{"label":["std_err"],"name":[7],"type":["dbl"],"align":["right"]},{"label":[".config"],"name":[8],"type":["chr"],"align":["left"]}],"data":[{"1":"19","2":"37","3":"rmse","4":"standard","5":"11.82908","6":"10","7":"0.2678413","8":"Preprocessor1_Model17"},{"1":"21","2":"31","3":"rmse","4":"standard","5":"11.83112","6":"10","7":"0.2642429","8":"Preprocessor1_Model03"},{"1":"20","2":"19","3":"rmse","4":"standard","5":"11.83795","6":"10","7":"0.2652306","8":"Preprocessor1_Model07"},{"1":"19","2":"30","3":"rmse","4":"standard","5":"11.84434","6":"10","7":"0.2644563","8":"Preprocessor1_Model21"},{"1":"17","2":"29","3":"rmse","4":"standard","5":"11.85543","6":"10","7":"0.2602131","8":"Preprocessor1_Model06"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>There’s a nice <code>autoplot()</code> function that comes with <code>tune</code> (one of the tidymodels dependencies) that can be used with various tidymodels objects. Let’s check it out with <code>rf_fit</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(rf_fit) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Looks like large numbers of <code>mtry</code> are good, but the error flattens out after 50 or so.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># final fit</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>last_rf_mod <span class="ot">&lt;-</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rand_forest</span>(<span class="at">mtry =</span> <span class="dv">17</span>, <span class="at">min_n =</span> <span class="dv">22</span>, <span class="at">trees =</span> <span class="dv">1000</span>) <span class="sc">%&gt;%</span> <span class="co"># original </span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>, <span class="at">importance =</span> <span class="st">"impurity"</span>, <span class="at">num.threads =</span> cores) <span class="sc">%&gt;%</span> </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co"># the last workflow</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>last_rf_workflow <span class="ot">&lt;-</span> </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  rf_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_model</span>(last_rf_mod)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="co"># the last fit</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">345</span>)</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>last_rf_fit <span class="ot">&lt;-</span> </span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  last_rf_workflow <span class="sc">%&gt;%</span> </span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(data_split)</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>last_rf_fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[".metric"],"name":[1],"type":["chr"],"align":["left"]},{"label":[".estimator"],"name":[2],"type":["chr"],"align":["left"]},{"label":[".estimate"],"name":[3],"type":["dbl"],"align":["right"]},{"label":[".config"],"name":[4],"type":["chr"],"align":["left"]}],"data":[{"1":"rmse","2":"standard","3":"22.2265451","4":"Preprocessor1_Model1"},{"1":"rsq","2":"standard","3":"0.1230733","4":"Preprocessor1_Model1"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Still pretty bad. Let’s take a look at variable importance for this model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>last_rf_fit <span class="sc">%&gt;%</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">".workflow"</span>, <span class="dv">1</span>) <span class="sc">%&gt;%</span>   </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  vip<span class="sc">::</span><span class="fu">vip</span>(<span class="at">num_features =</span> <span class="dv">22</span>) <span class="sc">+</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Really only three variables that are contributing much to the model. I’ll do predicted versus actual again and hope for less of a shotgun blast.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>last_rf_fit <span class="sc">%&gt;%</span> </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span><span class="st">`</span><span class="at">.pred</span><span class="st">`</span>, <span class="at">y=</span>MOV_actual_team)) <span class="sc">+</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Ranger Prediction Results"</span>,</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Predicted MOV"</span>,</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Actual MOV"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Maybe looks a little more elongated but that could be wishful thinking. How about the percent correct head to head?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>last_rf_fit <span class="sc">%&gt;%</span> </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">both_positive =</span> <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">both_negative =</span> <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&lt;</span> <span class="dv">0</span>,</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">correct =</span> both_positive <span class="sc">+</span> both_negative) <span class="sc">%&gt;%</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">sumCorrect =</span> <span class="fu">sum</span>(correct)) <span class="sc">/</span> <span class="fu">nrow</span>(df21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["sumCorrect"],"name":[1],"type":["dbl"],"align":["right"]}],"data":[{"1":"0.6087662"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Slightly worse, but basically the same. Well, while I’m at it, I’ll look at predictions, actual MOV, and the spread.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>last_rf_fit <span class="sc">%&gt;%</span> </span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">spread_team =</span> test_data<span class="sc">$</span>spread_team) <span class="sc">%&gt;%</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">`</span><span class="at">.pred</span><span class="st">`</span>, MOV_actual_team, spread_team) <span class="sc">%&gt;%</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[".pred"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["MOV_actual_team"],"name":[2],"type":["int"],"align":["right"]},{"label":["spread_team"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"27.1360248","2":"-4","3":"-8.900"},{"1":"-0.9265833","2":"24","3":"-3.625"},{"1":"15.0652501","2":"28","3":"-11.500"},{"1":"25.0059872","2":"10","3":"-5.500"},{"1":"-2.4032607","2":"7","3":"3.125"},{"1":"9.3461843","2":"-6","3":"-2.875"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>The predictions don’t compare well, that’s for sure. Well, this may partially be the result of replacing NAs with 0s earlier, and I suspect I just have too many garbage predictors in the model. The authors were getting a head to head accuracy in the low 70’s, so there’s definite room for improvement. I’ll drive on anyway and look at teams that did a lot better or worse than predicted. Here I show only the extreme two ends. I plot (predicted - actual), so positive values are for teams that I predicted would win by a much larger margin than they actually did.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>last_rf_fit <span class="sc">%&gt;%</span> </span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">team =</span> df21<span class="sc">$</span>school_team,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">opp =</span> df21<span class="sc">$</span>school_opponent,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">spread_team =</span> df21<span class="sc">$</span>spread_team) <span class="sc">%&gt;%</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(team) <span class="sc">%&gt;%</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">meanDiff =</span> <span class="fu">mean</span>(<span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">-</span> MOV_actual_team)) <span class="sc">%&gt;%</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(meanDiff) <span class="sc">%&gt;%</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">team =</span> forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(team, meanDiff)) <span class="sc">%&gt;%</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">abs</span>(meanDiff) <span class="sc">&gt;</span> <span class="dv">7</span>) <span class="sc">%&gt;%</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">x=</span>team, <span class="at">y=</span>meanDiff)) <span class="sc">+</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Finally, I’ll look at the proportion of games I correctly predicted over time. I’m curious if I do poorly early in the season and then improve, or if it’s relatively consistent. Quick note: the first time I made this plot, I was getting 100% accuracy in the early weeks, and then it got steadily worse over time. That was a giant red flag, and after thoroughly scrubbing my code, I found an error where some actual results had snuck into the test data. I’m glad I caught that!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>last_rf_fit <span class="sc">%&gt;%</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(test_data <span class="sc">%&gt;%</span> </span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(id, week, school_team, school_opponent) <span class="sc">%&gt;%</span> </span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>              <span class="fu">rename</span>(<span class="st">"ID"</span> <span class="ot">=</span> <span class="st">"id"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">incorrect =</span> <span class="fu">case_when</span>(</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">0</span>), </span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">correct=</span> <span class="fu">case_when</span>(</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(week) <span class="sc">%&gt;%</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">sumIncorrect =</span> <span class="fu">sum</span>(incorrect),</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">sumCorrect =</span> <span class="fu">sum</span>(correct),</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">proportionCorrect =</span> sumCorrect <span class="sc">/</span> n) <span class="sc">%&gt;%</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">x=</span>week, <span class="at">y=</span>proportionCorrect)) <span class="sc">+</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Looks reasonably consistent, so at least I know I fixed that error.</p>
</section>
<section id="gradient-boost-machine-model" class="level2">
<h2 class="anchored" data-anchor-id="gradient-boost-machine-model">Gradient Boost Machine Model</h2>
<p>I don’t have much hope that this will be any better than the last two models, but it’ll give me another rep with the tidymodels workflow. Note that I’m using the random forest recipe (<code>rf_rec</code>). In hindsight, the recipe is model agnostic, so I should have just called it something generic to avoid confusion.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">345</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>gbm_mod <span class="ot">&lt;-</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="dv">1000</span>, </span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">tree_depth =</span> <span class="fu">tune</span>(), </span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">min_n =</span> <span class="fu">tune</span>(), </span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">loss_reduction =</span> <span class="fu">tune</span>(),</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">sample_size =</span> <span class="fu">tune</span>(), </span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">mtry =</span> <span class="fu">tune</span>(),</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">learn_rate =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>, <span class="at">num.threads =</span> cores) <span class="sc">%&gt;%</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>gbm_wflow <span class="ot">&lt;-</span> </span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(gbm_mod) <span class="sc">%&gt;%</span> </span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rf_rec)</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>gbm_fit <span class="ot">&lt;-</span> </span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>  gbm_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(<span class="at">grid =</span> <span class="dv">25</span>,</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>            <span class="at">control =</span> <span class="fu">control_grid</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>),</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>            <span class="at">resamples =</span> folds)</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>gbm_fit <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["mtry"],"name":[1],"type":["int"],"align":["right"]},{"label":["min_n"],"name":[2],"type":["int"],"align":["right"]},{"label":["tree_depth"],"name":[3],"type":["int"],"align":["right"]},{"label":["learn_rate"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["loss_reduction"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["sample_size"],"name":[6],"type":["dbl"],"align":["right"]},{"label":[".metric"],"name":[7],"type":["chr"],"align":["left"]},{"label":[".estimator"],"name":[8],"type":["chr"],"align":["left"]},{"label":["mean"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["n"],"name":[10],"type":["int"],"align":["right"]},{"label":["std_err"],"name":[11],"type":["dbl"],"align":["right"]},{"label":[".config"],"name":[12],"type":["chr"],"align":["left"]}],"data":[{"1":"18","2":"26","3":"15","4":"0.005212500","5":"1.434754e-05","6":"0.5969096","7":"rmse","8":"standard","9":"11.80719","10":"10","11":"0.2404661","12":"Preprocessor1_Model12"},{"1":"13","2":"20","3":"12","4":"0.007181982","5":"1.970398e-06","6":"0.7279449","7":"rmse","8":"standard","9":"11.85740","10":"10","11":"0.2474927","12":"Preprocessor1_Model24"},{"1":"14","2":"11","3":"6","4":"0.002386377","5":"8.075017e-05","6":"0.9132322","7":"rmse","8":"standard","9":"11.97554","10":"10","11":"0.2725003","12":"Preprocessor1_Model07"},{"1":"21","2":"19","3":"1","4":"0.036538848","5":"3.622162e-04","6":"0.4023778","7":"rmse","8":"standard","9":"11.97958","10":"10","11":"0.2532841","12":"Preprocessor1_Model08"},{"1":"8","2":"27","3":"3","4":"0.009669570","5":"4.392162e-06","6":"0.4973411","7":"rmse","8":"standard","9":"11.98145","10":"10","11":"0.2365237","12":"Preprocessor1_Model19"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Then the final fit.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>gbm_best <span class="ot">&lt;-</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  gbm_fit <span class="sc">%&gt;%</span> </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select_best</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co"># final fit</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>last_gbm_mod <span class="ot">&lt;-</span> </span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="dv">1000</span>, </span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">tree_depth =</span> gbm_best <span class="sc">%&gt;%</span> .<span class="sc">$</span>tree_depth, </span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">min_n =</span> gbm_best <span class="sc">%&gt;%</span> .<span class="sc">$</span>min_n, </span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">loss_reduction =</span> gbm_best <span class="sc">%&gt;%</span> .<span class="sc">$</span>loss_reduction,</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">sample_size =</span> gbm_best <span class="sc">%&gt;%</span> .<span class="sc">$</span>sample_size, </span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">mtry =</span> gbm_best <span class="sc">%&gt;%</span> .<span class="sc">$</span>mtry,</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">learn_rate =</span> gbm_best <span class="sc">%&gt;%</span> .<span class="sc">$</span>learn_rate) <span class="sc">%&gt;%</span> </span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>, <span class="at">num.threads =</span> cores) <span class="sc">%&gt;%</span> </span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="co"># the last workflow</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>last_gbm_workflow <span class="ot">&lt;-</span> </span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>  gbm_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_model</span>(last_gbm_mod)</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a><span class="co"># the last fit</span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">345</span>)</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>last_gbm_fit <span class="ot">&lt;-</span> </span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>  last_gbm_workflow <span class="sc">%&gt;%</span> </span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(data_split)</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a><span class="co"># since I used data_split above, this includes the test data set</span></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>last_gbm_fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[".metric"],"name":[1],"type":["chr"],"align":["left"]},{"label":[".estimator"],"name":[2],"type":["chr"],"align":["left"]},{"label":[".estimate"],"name":[3],"type":["dbl"],"align":["right"]},{"label":[".config"],"name":[4],"type":["chr"],"align":["left"]}],"data":[{"1":"rmse","2":"standard","3":"22.6052034","4":"Preprocessor1_Model1"},{"1":"rsq","2":"standard","3":"0.1136797","4":"Preprocessor1_Model1"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>More of the same, of course, and now variable importance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>last_gbm_fit <span class="sc">%&gt;%</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">".workflow"</span>, <span class="dv">1</span>) <span class="sc">%&gt;%</span>   </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  vip<span class="sc">::</span><span class="fu">vip</span>(<span class="at">num_features =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Yep, and now accuracy.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>last_gbm_fit <span class="sc">%&gt;%</span> </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">both_positive =</span> <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">both_negative =</span> <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&lt;</span> <span class="dv">0</span>,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">correct =</span> both_positive <span class="sc">+</span> both_negative) <span class="sc">%&gt;%</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">sumCorrect =</span> <span class="fu">sum</span>(correct)) <span class="sc">/</span> <span class="fu">nrow</span>(df21)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["sumCorrect"],"name":[1],"type":["dbl"],"align":["right"]}],"data":[{"1":"0.6152597"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>About the same as the others, so no surprise. Well, aside from demonstrating the garbage-in garbage-out principle, it was interesting to dip my toe in the waters of predictive modeling of sports events. As a bonus, I got some practice with tidymodels, which was great.</p>
<p>At this point in my weekend modeling, I paused and thought about what might have gone wrong and what might have gone right in the methodology I used. I also read <a href="https://blog.collegefootballdata.com/talking-tech-building-an-artifical-neural-network-to/">this post</a> about using a neural net to predict college football games. I tend to shy away from neural nets for regression problems. In my experience, they’re a pain to set up, take a long time to train, and I really haven’t seen them outperform the simpler, faster, and interpretable tree-based models.</p>
<p>Then I stumbled across <a href="https://blogs.rstudio.com/ai/posts/2021-02-11-tabnet/">this blog post from RStudio</a> that demonstrated the use of <code>tabnet</code>, a neural net model developed by Google specifically for tabular data that incorporates some of the processes in tree-based models to improve interpretability. In the <a href="https://arxiv.org/abs/1908.07442">original paper</a>, the authors also demonstrated that <code>tabnet</code> was on par, and often better, than the current go-to models like <code>xgboost</code>. So, time to give it a whack.</p>
</section>
<section id="neural-net-model" class="level2">
<h2 class="anchored" data-anchor-id="neural-net-model">Neural Net Model</h2>
<p>As I mentioned, I’m not too happy with the mess of predictors I’ve been using so far. Time for a fresh start using just a few predictors similar to the CollegeFootballData.com blog I just mentioned. I have lots of variables in my environment right now, so first I’m going to purge.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’ll load some of the same data sets from disk that I used earlier and filter non-FBS games as before. However, this time, I’m only going to keep a few columns: id, school, conference, homeAway, points, week, and year.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>gs <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"gameStats_full.RData"</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>gs <span class="ot">&lt;-</span> <span class="fu">type.convert</span>(gs, <span class="at">as.is =</span> <span class="cn">TRUE</span>)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co"># get the ID of non-FBS games</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>fbs <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"fbs_teams.RData"</span>)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>fcsIDs <span class="ot">&lt;-</span> gs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>school <span class="sc">%in%</span> (fbs <span class="sc">%&gt;%</span> .<span class="sc">$</span>school)) <span class="sc">%&gt;%</span> .<span class="sc">$</span>id</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="co"># filter</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>gs <span class="ot">&lt;-</span> </span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  gs <span class="sc">%&gt;%</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>id <span class="sc">%in%</span> fcsIDs) <span class="sc">%&gt;%</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, school, conference, homeAway, points, week, year)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’ll create home and away dataframes again as earlier and add the Elo and neutral site data, and then recombine it all into a dataframe called <code>pregame</code>. I’ll calculate the margin of victory (mov) here, too. I noticed one of the away conference names was missing but was able to track down that it was a FBS independent team.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>home <span class="ot">&lt;-</span> gs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(homeAway <span class="sc">==</span> <span class="st">"home"</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>away <span class="ot">&lt;-</span> gs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(homeAway <span class="sc">==</span> <span class="st">"away"</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="co"># get pre-game Elo and neutral vield data</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>eloSite <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"eloSite.RData"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>id <span class="sc">%in%</span> (fcsIDs)) <span class="sc">%&gt;%</span> </span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  tidyjson<span class="sc">::</span><span class="fu">as_tibble</span>(eloSite)</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="co"># get pre-game spread</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>spread <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"spread.RData"</span>)</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>spread <span class="ot">&lt;-</span> spread <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>id <span class="sc">%in%</span> (fcsIDs))</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>spread <span class="ot">&lt;-</span> spread <span class="sc">%&gt;%</span> <span class="fu">drop_na</span>()</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>pregame <span class="ot">&lt;-</span> spread <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(eloSite, <span class="at">by =</span> <span class="st">"id"</span>)</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>pregame <span class="ot">&lt;-</span> </span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>  pregame <span class="sc">%&gt;%</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(home <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>school, <span class="sc">-</span>homeAway), <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="st">"home_conference"</span> <span class="ot">=</span> <span class="st">"conference"</span>, <span class="st">"home_points"</span> <span class="ot">=</span> <span class="st">"points"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(away <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>school, <span class="sc">-</span>year, <span class="sc">-</span>homeAway, <span class="sc">-</span>week), <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="st">"away_conference"</span> <span class="ot">=</span> <span class="st">"conference"</span>, <span class="st">"away_points"</span> <span class="ot">=</span> <span class="st">"points"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mov =</span> home_points <span class="sc">-</span> away_points) <span class="sc">%&gt;%</span></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>home_points, <span class="sc">-</span>away_points) <span class="sc">%&gt;%</span> </span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">away_conference =</span> <span class="fu">replace_na</span>(away_conference, <span class="st">"FBS Independents"</span>))</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pregame)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["id"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["home_spread"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["home_team"],"name":[3],"type":["chr"],"align":["left"]},{"label":["home_pregame_elo"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["away_team"],"name":[5],"type":["chr"],"align":["left"]},{"label":["away_pregame_elo"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["neutral_site"],"name":[7],"type":["lgl"],"align":["right"]},{"label":["home_conference"],"name":[8],"type":["chr"],"align":["left"]},{"label":["week"],"name":[9],"type":["int"],"align":["right"]},{"label":["year"],"name":[10],"type":["int"],"align":["right"]},{"label":["away_conference"],"name":[11],"type":["chr"],"align":["left"]},{"label":["mov"],"name":[12],"type":["int"],"align":["right"]}],"data":[{"1":"400944997","2":"9.500000","3":"Bowling Green","4":"1204","5":"Ohio","6":"1376","7":"FALSE","8":"Mid-American","9":"7","10":"2017","11":"Mid-American","12":"-18"},{"1":"400944998","2":"9.333333","3":"Central Michigan","4":"1233","5":"Toledo","6":"1568","7":"FALSE","8":"Mid-American","9":"7","10":"2017","11":"Mid-American","12":"-20"},{"1":"400934536","2":"24.166667","3":"Kansas","4":"972","5":"Kansas State","6":"1681","7":"FALSE","8":"Big 12","9":"9","10":"2017","11":"Big 12","12":"-10"},{"1":"400945016","2":"-20.333333","3":"Western Michigan","4":"1662","5":"Kent State","6":"935","7":"FALSE","8":"Mid-American","9":"11","10":"2017","11":"Mid-American","12":"28"},{"1":"400934493","2":"-18.666667","3":"Oklahoma State","4":"1727","5":"Tulsa","6":"1665","7":"FALSE","8":"Big 12","9":"1","10":"2017","11":"American Athletic","12":"35"},{"1":"400938591","2":"-17.333333","3":"UCF","4":"1446","5":"Florida International","6":"1272","7":"FALSE","8":"American Athletic","9":"1","10":"2017","11":"Conference USA","12":"44"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>I’m only working with 12 columns this time - well, 9 if you don’t count id, week, and year. I won’t use those for training or testing. They’re just to keep track of things. So it’s down to team, conference, spread, Elo, and the home field advantage thing, which I’ll address next.</p>
<p>Recall my first attempt was complicated and involved looping over game IDs. I came up with a much better way this time. I randomly select game IDs, then apply the HFA indicator in place. Way faster and a lot clearer what I’m doing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(pregame), <span class="fu">trunc</span>(<span class="fu">nrow</span>(pregame) <span class="sc">/</span> <span class="dv">2</span>))</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>pregame<span class="sc">$</span>HFA <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>pregame[idx, <span class="st">"HFA"</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>pregame[<span class="sc">-</span>idx, <span class="st">"HFA"</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>pregame[<span class="sc">-</span>idx, <span class="st">"mov"</span>] <span class="ot">&lt;-</span> pregame[<span class="sc">-</span>idx, <span class="st">"mov"</span>]</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>pregame <span class="ot">&lt;-</span> pregame <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">HFA =</span> <span class="fu">ifelse</span>(neutral_site, <span class="dv">0</span>, HFA))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The last thing to do is turn the team names into factors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>pregame <span class="ot">&lt;-</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  pregame <span class="sc">%&gt;%</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">home_team =</span> <span class="fu">factor</span>(home_team),</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">away_team =</span> <span class="fu">factor</span>(away_team))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That’s it! I’m ready to split the data in the training, test, and validation sets and get to model building.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>data_split <span class="ot">&lt;-</span> </span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">initial_time_split</span>(</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    pregame <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>id, <span class="sc">-</span>year, <span class="sc">-</span>neutral_site, <span class="sc">-</span>week),</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">prop =</span> <span class="dv">2656</span><span class="sc">/</span><span class="dv">3391</span>)</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(data_split)</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>test_data  <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_split)</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">234</span>)</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>val_set <span class="ot">&lt;-</span> <span class="fu">validation_split</span>(train_data, <span class="at">prop =</span> <span class="fl">0.80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are many hyperparameters to tune, and I’ll exclude epochs, batch_size, and virtual_batch_size just to speed this part up.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tabnet)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>nn_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(mov <span class="sc">~</span> ., train_data) <span class="sc">%&gt;%</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric</span>(), <span class="sc">-</span><span class="fu">all_outcomes</span>())</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>nn_mod <span class="ot">&lt;-</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabnet</span>(<span class="at">epochs =</span> <span class="dv">5</span>, </span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">batch_size =</span> <span class="dv">256</span>, </span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">decision_width =</span> <span class="fu">tune</span>(), </span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">attention_width =</span> <span class="fu">tune</span>(),</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">num_steps =</span> <span class="fu">tune</span>(), </span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">penalty =</span> <span class="fu">tune</span>(), </span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">virtual_batch_size =</span> <span class="dv">64</span>, </span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">momentum =</span> <span class="fu">tune</span>(),</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">feature_reusage =</span> <span class="fu">tune</span>(), </span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">learn_rate =</span> <span class="fu">tune</span>()</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"torch"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>nn_wf <span class="ot">&lt;-</span> </span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(nn_mod) <span class="sc">%&gt;%</span></span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(nn_rec)</span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>nn_fit <span class="ot">&lt;-</span></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>  nn_wf <span class="sc">%&gt;%</span></span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(val_set,</span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>            <span class="at">grid =</span> <span class="dv">50</span>,</span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>            <span class="at">control =</span> <span class="fu">control_grid</span>())</span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>nn_fit<span class="sc">$</span>.notes[[<span class="dv">1</span>]]<span class="sc">$</span>note</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>character(0)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>nn_fit <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["penalty"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["learn_rate"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["decision_width"],"name":[3],"type":["int"],"align":["right"]},{"label":["attention_width"],"name":[4],"type":["int"],"align":["right"]},{"label":["num_steps"],"name":[5],"type":["int"],"align":["right"]},{"label":["feature_reusage"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["momentum"],"name":[7],"type":["dbl"],"align":["right"]},{"label":[".metric"],"name":[8],"type":["chr"],"align":["left"]},{"label":[".estimator"],"name":[9],"type":["chr"],"align":["left"]},{"label":["mean"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["n"],"name":[11],"type":["int"],"align":["right"]},{"label":["std_err"],"name":[12],"type":["dbl"],"align":["right"]},{"label":[".config"],"name":[13],"type":["chr"],"align":["left"]}],"data":[{"1":"1.430669e-01","2":"0.023946918","3":"15","4":"62","5":"8","6":"1.148702","7":"0.1944556","8":"rmse","9":"standard","10":"15.71699","11":"1","12":"NA","13":"Preprocessor1_Model20"},{"1":"7.926339e-04","2":"0.090298939","3":"31","4":"17","5":"5","6":"1.223266","7":"0.3849162","8":"rmse","9":"standard","10":"15.73111","11":"1","12":"NA","13":"Preprocessor1_Model19"},{"1":"1.866379e-08","2":"0.039492908","3":"54","4":"20","5":"4","6":"1.606832","7":"0.3777322","8":"rmse","9":"standard","10":"15.83893","11":"1","12":"NA","13":"Preprocessor1_Model43"},{"1":"8.360702e-08","2":"0.012958859","3":"61","4":"26","5":"10","6":"1.465862","7":"0.2632811","8":"rmse","9":"standard","10":"15.90070","11":"1","12":"NA","13":"Preprocessor1_Model26"},{"1":"2.007269e-03","2":"0.003636129","3":"46","4":"49","5":"9","6":"1.191325","7":"0.2790510","8":"rmse","9":"standard","10":"16.02400","11":"1","12":"NA","13":"Preprocessor1_Model36"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>The final fit.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with tuned parameters</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>last_nn_mod <span class="ot">&lt;-</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabnet</span>(<span class="at">epochs =</span> <span class="dv">15</span>, </span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">batch_size =</span> <span class="dv">256</span>, </span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">decision_width =</span> <span class="dv">15</span>, </span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">attention_width =</span> <span class="dv">62</span>,</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">num_steps =</span> <span class="dv">8</span>, </span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">penalty =</span> <span class="fl">0.1430669</span>, </span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">virtual_batch_size =</span> <span class="dv">64</span>, </span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">momentum =</span> <span class="fl">0.194</span>,</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">feature_reusage =</span> <span class="fl">1.148</span>, </span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">learn_rate =</span> <span class="fl">0.02395</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"torch"</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a><span class="co"># the last workflow</span></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>last_nn_workflow <span class="ot">&lt;-</span> </span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>  nn_wf <span class="sc">%&gt;%</span> </span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_model</span>(last_nn_mod)</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a><span class="co"># the last fit</span></span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>last_nn_fit <span class="ot">&lt;-</span> </span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>  last_nn_workflow <span class="sc">%&gt;%</span> </span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(data_split)</span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a><span class="co"># since I used data_split above, this includes the test data set</span></span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a>last_nn_fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[".metric"],"name":[1],"type":["chr"],"align":["left"]},{"label":[".estimator"],"name":[2],"type":["chr"],"align":["left"]},{"label":[".estimate"],"name":[3],"type":["dbl"],"align":["right"]},{"label":[".config"],"name":[4],"type":["chr"],"align":["left"]}],"data":[{"1":"rmse","2":"standard","3":"15.6451600","4":"Preprocessor1_Model1"},{"1":"rsq","2":"standard","3":"0.4447101","4":"Preprocessor1_Model1"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Both metrics are quite a bit higher than what we’ve seen up to this point, so I’m optimistic this model will perform better.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>last_nn_fit <span class="sc">%&gt;%</span> </span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">".workflow"</span>, <span class="dv">1</span>) <span class="sc">%&gt;%</span>   </span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  vip<span class="sc">::</span><span class="fu">vip</span>() <span class="sc">+</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The model relies heavily on the spread, which makes sense since given that it’s hard to beat the spread, and I’m considering only a few other predictors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># find percent I predicted the correct winner</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>last_nn_fit <span class="sc">%&gt;%</span> </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">both_positive =</span> <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> mov <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">both_negative =</span> <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> mov <span class="sc">&lt;</span> <span class="dv">0</span>,</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">correct =</span> both_positive <span class="sc">+</span> both_negative) <span class="sc">%&gt;%</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">Correct =</span> <span class="fu">sum</span>(correct)) <span class="sc">/</span> <span class="fu">nrow</span>(test_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["Correct"],"name":[1],"type":["dbl"],"align":["right"]}],"data":[{"1":"0.7238095"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>This model correctly predicts 72.3% of the game winners, compared to the ~ 60% for the earlier models. How does that compare to the spread?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># how does the spread do?</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>last_nn_fit <span class="sc">%&gt;%</span> </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">spread =</span> <span class="sc">-</span>test_data<span class="sc">$</span>home_spread,</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">both_positive =</span> spread <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> mov <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">both_negative =</span> spread <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> mov <span class="sc">&lt;</span> <span class="dv">0</span>,</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">correct =</span> both_positive <span class="sc">+</span> both_negative) <span class="sc">%&gt;%</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">Correct =</span> <span class="fu">sum</span>(correct)) <span class="sc">/</span> <span class="fu">nrow</span>(test_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["Correct"],"name":[1],"type":["dbl"],"align":["right"]}],"data":[{"1":"0.7292517"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Not surprising that it’s almost the same. Really at this point, this model basically <em>is</em> the spread. Obviously, if we want to beat the spread, we need to improve on this. Let’s check the predicted vs.&nbsp;actual raw values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>last_nn_fit <span class="sc">%&gt;%</span> </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["id"],"name":[1],"type":["chr"],"align":["left"]},{"label":[".pred"],"name":[2],"type":["dbl"],"align":["right"]},{"label":[".row"],"name":[3],"type":["int"],"align":["right"]},{"label":["mov"],"name":[4],"type":["int"],"align":["right"]},{"label":[".config"],"name":[5],"type":["chr"],"align":["left"]}],"data":[{"1":"train/test split","2":"4.9447575","3":"2657","4":"33","5":"Preprocessor1_Model1"},{"1":"train/test split","2":"22.9584503","3":"2658","4":"8","5":"Preprocessor1_Model1"},{"1":"train/test split","2":"-0.3658603","3":"2659","4":"14","5":"Preprocessor1_Model1"},{"1":"train/test split","2":"-6.1112452","3":"2660","4":"3","5":"Preprocessor1_Model1"},{"1":"train/test split","2":"2.7838397","3":"2661","4":"-7","5":"Preprocessor1_Model1"},{"1":"train/test split","2":"17.8494225","3":"2662","4":"4","5":"Preprocessor1_Model1"},{"1":"train/test split","2":"3.3607163","3":"2663","4":"10","5":"Preprocessor1_Model1"},{"1":"train/test split","2":"-8.9240465","3":"2664","4":"-4","5":"Preprocessor1_Model1"},{"1":"train/test split","2":"11.9484339","3":"2665","4":"4","5":"Preprocessor1_Model1"},{"1":"train/test split","2":"-13.1121655","3":"2666","4":"-18","5":"Preprocessor1_Model1"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>And now let’s plot them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>last_nn_fit <span class="sc">%&gt;%</span> </span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span><span class="st">`</span><span class="at">.pred</span><span class="st">`</span>, <span class="at">y=</span>mov)) <span class="sc">+</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"NN Prediction Results"</span>,</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Predicted MOV"</span>,</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Actual MOV"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="interpretability-plots" class="level3">
<h3 class="anchored" data-anchor-id="interpretability-plots">Interpretability Plots</h3>
<p>Earlier I mentioned that <code>tabnet</code> models were developed to be interpretable. The following plot shows the first 50 games in the test set with games on the x axis. For these games, it seems the Elo scores were the biggest contributors. Interesting. I wonder why we don’t see more of an impact from the spread.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>exp_fit <span class="ot">&lt;-</span> </span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  last_nn_fit <span class="sc">%&gt;%</span> </span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">".workflow"</span>, <span class="dv">1</span>) <span class="sc">%&gt;%</span>   </span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>()</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>ex_fit <span class="ot">&lt;-</span> <span class="fu">tabnet_explain</span>(exp_fit<span class="sc">$</span>fit, test_data[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, ])</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(ex_fit) <span class="sc">+</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Game"</span>, <span class="at">y =</span> <span class="st">"Predictor"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-64-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Next, for the same 50 games, we see that different predictors are important in different steps. Here we see that spread comes into play mostly in the 7th and 8th step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># PER-STEP, OBSERVATION-LEVEL FEATURE IMPORTANCES</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(ex_fit, <span class="at">type=</span><span class="st">"steps"</span>) <span class="sc">+</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Game"</span>, <span class="at">y =</span> <span class="st">"Predictor"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-65-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="next-steps" class="level2">
<h2 class="anchored" data-anchor-id="next-steps">Next Steps</h2>
<p>While <code>tabnet</code> looks promising, I can’t directly compare its performance with the other models in this post because I used a different data set for it. I saw in the tidymodels docs that there’s a way to do model comparison using work flow sets, so I’ll check that out in another post.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'alternate';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb72" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Predictive Modeling"</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "A variety of machine learning models to predict beating the spread."</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "John King"</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "3/12/2022"</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-copy: true</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="co">    df-print: paged</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a><span class="co">  - R</span></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a><span class="co">  - ggplot2</span></span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a><span class="co">  - college football</span></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a><span class="co">  - sports analytics</span></span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a><span class="co">  - machine learning</span></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> "teaser.png"</span></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>Continuing with the streak of posts about college football posts, here I finally get into developing some models to predict the winning team and margin of victory of college football games. For this analysis, I was inspired by <span class="co">[</span><span class="ot">this post</span><span class="co">](https://blog.collegefootballdata.com/lessons-from-picking-the-2022-cfb-season/)</span> that mentioned a leader board for people who picked winners from the 2021-2022 season. Reminds me of Kaggle competitions, which I did once for fun and <span class="co">[</span><span class="ot">wrote about it</span><span class="co">](https://jfking.netlify.app/blog/ames/)</span>.</span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>I also found <span class="co">[</span><span class="ot">this published paper</span><span class="co">](https://content.iospress.com/articles/journal-of-sports-analytics/jsa190314)</span> both extremely interesting and helpful because it lays out in detail the author's analytic methodology for building their predictive model. The first part of this post is my attempt at replicating their technique using a different data source (collegefootball.com's <span class="co">[</span><span class="ot">API</span><span class="co">](https://api.collegefootballdata.com/api/docs/?url=/api-docs.json)</span>) and using data from the 2017-2020 seasons to predict games of the 2021 season. Spoiler, my initial tree-based models don't perform nearly as well as theirs, and I eventually try a neural network with much better success.</span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a><span class="fu">## Get the Data</span></span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a>First, I'll load data I previously obtained via the API I mentioned above. If you want to see how to make those API calls, I explain it in <span class="co">[</span><span class="ot">this post</span><span class="co">](https://jfking.netlify.app/blog/oregon-football/)</span>. The data in <span class="in">`/games/teams`</span> has a bunch of game result data that are similar to the data used in the article above.</span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a>gs <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"gameStats.RData"</span>)</span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true" tabindex="-1"></a>gs <span class="ot">&lt;-</span> <span class="fu">type.convert</span>(gs, <span class="at">as.is =</span> <span class="cn">TRUE</span>)</span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gs)</span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-42"><a href="#cb72-42" aria-hidden="true" tabindex="-1"></a>I also want to get the list of all of the FBS teams because I want to filter out the games played against non-FBS teams. There's a bunch of data in that table, but I'm really only interested in the <span class="in">`school`</span> column.</span>
<span id="cb72-43"><a href="#cb72-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-46"><a href="#cb72-46" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-47"><a href="#cb72-47" aria-hidden="true" tabindex="-1"></a>fbs <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"fbs_teams.RData"</span>)</span>
<span id="cb72-48"><a href="#cb72-48" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(fbs)</span>
<span id="cb72-49"><a href="#cb72-49" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-50"><a href="#cb72-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-51"><a href="#cb72-51" aria-hidden="true" tabindex="-1"></a>Now I'll get a vector of all of the game IDs from the first table in which a non-FBS team played. Here are the first three.</span>
<span id="cb72-52"><a href="#cb72-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-55"><a href="#cb72-55" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-56"><a href="#cb72-56" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr) <span class="co"># I'm going to need to do some data wrangling</span></span>
<span id="cb72-57"><a href="#cb72-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-58"><a href="#cb72-58" aria-hidden="true" tabindex="-1"></a>fcsIDs <span class="ot">&lt;-</span> gs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>school <span class="sc">%in%</span> (fbs <span class="sc">%&gt;%</span> .<span class="sc">$</span>school)) <span class="sc">%&gt;%</span> .<span class="sc">$</span>id</span>
<span id="cb72-59"><a href="#cb72-59" aria-hidden="true" tabindex="-1"></a>fcsIDs[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb72-60"><a href="#cb72-60" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-61"><a href="#cb72-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-62"><a href="#cb72-62" aria-hidden="true" tabindex="-1"></a>Now I apply the filter and separate out some of the columns. For example, the <span class="in">`totalPenaltiesYards`</span> column is formatted as penalties-yards, so for example 3-25. I'll then create a new column that divides one of those values by the other so that I get a single <span class="in">`yardsPerPenalty`</span> value. I'll also convert the time of possession into minutes and get rid of columns I no longer need.</span>
<span id="cb72-63"><a href="#cb72-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-66"><a href="#cb72-66" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-67"><a href="#cb72-67" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr) <span class="co"># needed for the separate function below</span></span>
<span id="cb72-68"><a href="#cb72-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-69"><a href="#cb72-69" aria-hidden="true" tabindex="-1"></a>gs <span class="ot">&lt;-</span> </span>
<span id="cb72-70"><a href="#cb72-70" aria-hidden="true" tabindex="-1"></a>  gs <span class="sc">%&gt;%</span></span>
<span id="cb72-71"><a href="#cb72-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>id <span class="sc">%in%</span> fcsIDs) <span class="sc">%&gt;%</span></span>
<span id="cb72-72"><a href="#cb72-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(totalPenaltiesYards, </span>
<span id="cb72-73"><a href="#cb72-73" aria-hidden="true" tabindex="-1"></a>           <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"penalties"</span>, <span class="st">"penaltiesYards"</span>), <span class="at">convert =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb72-74"><a href="#cb72-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(completionAttempts, </span>
<span id="cb72-75"><a href="#cb72-75" aria-hidden="true" tabindex="-1"></a>           <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"passCompletions"</span>, <span class="st">"passAttempts"</span>), <span class="at">convert =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb72-76"><a href="#cb72-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(possessionTime, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"posMM"</span>, <span class="st">"posSS"</span>), <span class="at">convert =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb72-77"><a href="#cb72-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">posTime =</span> posMM <span class="sc">*</span> <span class="dv">60</span> <span class="sc">+</span> posSS,</span>
<span id="cb72-78"><a href="#cb72-78" aria-hidden="true" tabindex="-1"></a>         <span class="at">yardsPerPenalty =</span> penaltiesYards <span class="sc">/</span> penalties,</span>
<span id="cb72-79"><a href="#cb72-79" aria-hidden="true" tabindex="-1"></a>         <span class="at">passEfficiency =</span> passCompletions <span class="sc">/</span> passAttempts,</span>
<span id="cb72-80"><a href="#cb72-80" aria-hidden="true" tabindex="-1"></a>         <span class="at">yardsPerPlay =</span> (yardsPerPass <span class="sc">+</span> yardsPerRushAttempt) <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb72-81"><a href="#cb72-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>totalYards, <span class="sc">-</span>posMM, <span class="sc">-</span>posSS, <span class="sc">-</span>fourthDownEff, <span class="sc">-</span>thirdDownEff)</span>
<span id="cb72-82"><a href="#cb72-82" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-83"><a href="#cb72-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-84"><a href="#cb72-84" aria-hidden="true" tabindex="-1"></a>I found that there are a number of NAs in the data. For this demonstration, I'll just convert them all to 0. If I was cleaning this data for an actual competition or to try to beat Vegas, I'd take a much harder look at those NAs and treat them carefully.</span>
<span id="cb72-85"><a href="#cb72-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-88"><a href="#cb72-88" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-89"><a href="#cb72-89" aria-hidden="true" tabindex="-1"></a>gs[<span class="fu">is.na</span>(gs)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb72-90"><a href="#cb72-90" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-91"><a href="#cb72-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-92"><a href="#cb72-92" aria-hidden="true" tabindex="-1"></a>I also found that there's a game ID that's repeated, so I'll filter out the repeat.</span>
<span id="cb72-93"><a href="#cb72-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-96"><a href="#cb72-96" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-97"><a href="#cb72-97" aria-hidden="true" tabindex="-1"></a><span class="co"># there's an id that's repeated - there should be two games for each ID</span></span>
<span id="cb72-98"><a href="#cb72-98" aria-hidden="true" tabindex="-1"></a>gs <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> <span class="fu">count</span>() <span class="sc">%&gt;%</span> <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">2</span>)</span>
<span id="cb72-99"><a href="#cb72-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-100"><a href="#cb72-100" aria-hidden="true" tabindex="-1"></a><span class="co"># take a look at that ID</span></span>
<span id="cb72-101"><a href="#cb72-101" aria-hidden="true" tabindex="-1"></a>gs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(id <span class="sc">==</span> <span class="dv">401309547</span>)</span>
<span id="cb72-102"><a href="#cb72-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-103"><a href="#cb72-103" aria-hidden="true" tabindex="-1"></a><span class="co"># filter out the ID with zeros in the rushingTDs column</span></span>
<span id="cb72-104"><a href="#cb72-104" aria-hidden="true" tabindex="-1"></a>gs <span class="ot">&lt;-</span> gs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>(id <span class="sc">==</span> <span class="dv">401309547</span> <span class="sc">&amp;</span> rushingTDs <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb72-105"><a href="#cb72-105" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-106"><a href="#cb72-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-107"><a href="#cb72-107" aria-hidden="true" tabindex="-1"></a>In the article, they did some feature engineering that I'll replicate here.</span>
<span id="cb72-108"><a href="#cb72-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-111"><a href="#cb72-111" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-112"><a href="#cb72-112" aria-hidden="true" tabindex="-1"></a>gs <span class="ot">&lt;-</span> </span>
<span id="cb72-113"><a href="#cb72-113" aria-hidden="true" tabindex="-1"></a>  gs <span class="sc">%&gt;%</span> </span>
<span id="cb72-114"><a href="#cb72-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">offensePoints =</span> (rushingTDs <span class="sc">+</span> passingTDs) <span class="sc">*</span> <span class="dv">7</span> <span class="sc">+</span> kickingPoints,</span>
<span id="cb72-115"><a href="#cb72-115" aria-hidden="true" tabindex="-1"></a>         <span class="at">offenseYards =</span> netPassingYards <span class="sc">+</span> rushingYards) <span class="sc">%&gt;%</span> </span>
<span id="cb72-116"><a href="#cb72-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id)</span>
<span id="cb72-117"><a href="#cb72-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-118"><a href="#cb72-118" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-119"><a href="#cb72-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-120"><a href="#cb72-120" aria-hidden="true" tabindex="-1"></a>They also created some features for one team based on how the other team performed. Doing this in the original <span class="in">`gs`</span> dataframe made my head hurt, so I split it into separate dataframes for the home and away teams. While I'm at it, I'll also calculate <span class="in">`MOV`</span>, the margin of victory.</span>
<span id="cb72-121"><a href="#cb72-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-124"><a href="#cb72-124" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-125"><a href="#cb72-125" aria-hidden="true" tabindex="-1"></a>home <span class="ot">&lt;-</span> gs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(homeAway <span class="sc">==</span> <span class="st">"home"</span>)</span>
<span id="cb72-126"><a href="#cb72-126" aria-hidden="true" tabindex="-1"></a>away <span class="ot">&lt;-</span> gs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(homeAway <span class="sc">==</span> <span class="st">"away"</span>)</span>
<span id="cb72-127"><a href="#cb72-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-128"><a href="#cb72-128" aria-hidden="true" tabindex="-1"></a>home <span class="ot">&lt;-</span> </span>
<span id="cb72-129"><a href="#cb72-129" aria-hidden="true" tabindex="-1"></a>  home <span class="sc">%&gt;%</span> </span>
<span id="cb72-130"><a href="#cb72-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb72-131"><a href="#cb72-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">defensePointsAllowed =</span> away<span class="sc">$</span>offensePoints,</span>
<span id="cb72-132"><a href="#cb72-132" aria-hidden="true" tabindex="-1"></a>    <span class="at">defenseYPPAAllowed =</span> away<span class="sc">$</span>yardsPerPass,</span>
<span id="cb72-133"><a href="#cb72-133" aria-hidden="true" tabindex="-1"></a>    <span class="at">defenseYPRAAllowed =</span> away<span class="sc">$</span>yardsPerRushAttempt,</span>
<span id="cb72-134"><a href="#cb72-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">defensePassYardsAllowed =</span> away<span class="sc">$</span>netPassingYards,</span>
<span id="cb72-135"><a href="#cb72-135" aria-hidden="true" tabindex="-1"></a>    <span class="at">defenseRushYardsAllowed =</span> away<span class="sc">$</span>rushingYards,</span>
<span id="cb72-136"><a href="#cb72-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">defenseYardsPerPlayAllowed =</span> away<span class="sc">$</span>yardsPerPlay,</span>
<span id="cb72-137"><a href="#cb72-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">forcedPenaltyYards =</span> away<span class="sc">$</span>penaltiesYards,</span>
<span id="cb72-138"><a href="#cb72-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">forcedTO =</span> away<span class="sc">$</span>turnovers,</span>
<span id="cb72-139"><a href="#cb72-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">MOV =</span> points <span class="sc">-</span> away<span class="sc">$</span>points</span>
<span id="cb72-140"><a href="#cb72-140" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-141"><a href="#cb72-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-142"><a href="#cb72-142" aria-hidden="true" tabindex="-1"></a>away <span class="ot">&lt;-</span> </span>
<span id="cb72-143"><a href="#cb72-143" aria-hidden="true" tabindex="-1"></a>  away <span class="sc">%&gt;%</span></span>
<span id="cb72-144"><a href="#cb72-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb72-145"><a href="#cb72-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">defensePointsAllowed =</span> home<span class="sc">$</span>offensePoints,</span>
<span id="cb72-146"><a href="#cb72-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">defenseYPPAAllowed =</span> home<span class="sc">$</span>yardsPerPass,</span>
<span id="cb72-147"><a href="#cb72-147" aria-hidden="true" tabindex="-1"></a>    <span class="at">defenseYPRAAllowed =</span> home<span class="sc">$</span>yardsPerRushAttempt,</span>
<span id="cb72-148"><a href="#cb72-148" aria-hidden="true" tabindex="-1"></a>    <span class="at">defensePassYardsAllowed =</span> home<span class="sc">$</span>netPassingYards,</span>
<span id="cb72-149"><a href="#cb72-149" aria-hidden="true" tabindex="-1"></a>    <span class="at">defenseRushYardsAllowed =</span> home<span class="sc">$</span>rushingYards,</span>
<span id="cb72-150"><a href="#cb72-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">defenseYardsPerPlayAllowed =</span> home<span class="sc">$</span>yardsPerPlay,</span>
<span id="cb72-151"><a href="#cb72-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">forcedPenaltyYards =</span> home<span class="sc">$</span>penaltiesYards,</span>
<span id="cb72-152"><a href="#cb72-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">forcedTO =</span> home<span class="sc">$</span>turnovers,</span>
<span id="cb72-153"><a href="#cb72-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">MOV =</span> points <span class="sc">-</span> home<span class="sc">$</span>points</span>
<span id="cb72-154"><a href="#cb72-154" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-155"><a href="#cb72-155" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-156"><a href="#cb72-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-157"><a href="#cb72-157" aria-hidden="true" tabindex="-1"></a>I also wanted to get each team's Elo score,which I found in the <span class="in">`/games`</span> data via the API. For some reason, I grabbed the pregame Elo score instead of the post-game Elo, but that's fine. I'll account for that later. I'll also filter out those games using the game IDs in the <span class="in">`home`</span> dataframe. The <span class="in">`/games`</span> data also contains a boolean <span class="in">`neutral_site`</span>, which will be useful. There's always a home and away team in every game (as indicated in the <span class="in">`homeAway`</span> column) even if the game is played on a neutral site. If I want to correctly factor in whether a team has a home field advantage, I'll need to account for those games played at a neutral site.</span>
<span id="cb72-158"><a href="#cb72-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-161"><a href="#cb72-161" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-162"><a href="#cb72-162" aria-hidden="true" tabindex="-1"></a>eloSite <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"eloSite.RData"</span>) <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>()</span>
<span id="cb72-163"><a href="#cb72-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-164"><a href="#cb72-164" aria-hidden="true" tabindex="-1"></a>eloSite <span class="ot">&lt;-</span> eloSite <span class="sc">%&gt;%</span> <span class="fu">filter</span>(id <span class="sc">%in%</span> (home <span class="sc">%&gt;%</span> .<span class="sc">$</span>id))</span>
<span id="cb72-165"><a href="#cb72-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-166"><a href="#cb72-166" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(eloSite)</span>
<span id="cb72-167"><a href="#cb72-167" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-168"><a href="#cb72-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-169"><a href="#cb72-169" aria-hidden="true" tabindex="-1"></a>Now I'll combine that data with the <span class="in">`home`</span> and <span class="in">`away`</span> dataframes.</span>
<span id="cb72-170"><a href="#cb72-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-173"><a href="#cb72-173" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-174"><a href="#cb72-174" aria-hidden="true" tabindex="-1"></a>home <span class="ot">&lt;-</span></span>
<span id="cb72-175"><a href="#cb72-175" aria-hidden="true" tabindex="-1"></a>  home <span class="sc">%&gt;%</span> </span>
<span id="cb72-176"><a href="#cb72-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(eloSite <span class="sc">%&gt;%</span> </span>
<span id="cb72-177"><a href="#cb72-177" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(id, home_team, home_pregame_elo, neutral_site),</span>
<span id="cb72-178"><a href="#cb72-178" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"id"</span> <span class="ot">=</span> <span class="st">"id"</span>, <span class="st">"school"</span> <span class="ot">=</span> <span class="st">"home_team"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb72-179"><a href="#cb72-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="st">"elo"</span> <span class="ot">=</span> <span class="st">"home_pregame_elo"</span>)</span>
<span id="cb72-180"><a href="#cb72-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-181"><a href="#cb72-181" aria-hidden="true" tabindex="-1"></a>away <span class="ot">&lt;-</span></span>
<span id="cb72-182"><a href="#cb72-182" aria-hidden="true" tabindex="-1"></a>  away <span class="sc">%&gt;%</span> </span>
<span id="cb72-183"><a href="#cb72-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(eloSite <span class="sc">%&gt;%</span> </span>
<span id="cb72-184"><a href="#cb72-184" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(id, away_team, away_pregame_elo, neutral_site),</span>
<span id="cb72-185"><a href="#cb72-185" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"id"</span> <span class="ot">=</span> <span class="st">"id"</span>, <span class="st">"school"</span> <span class="ot">=</span> <span class="st">"away_team"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb72-186"><a href="#cb72-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="st">"elo"</span> <span class="ot">=</span> <span class="st">"away_pregame_elo"</span>)</span>
<span id="cb72-187"><a href="#cb72-187" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-188"><a href="#cb72-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-189"><a href="#cb72-189" aria-hidden="true" tabindex="-1"></a>The authors explained that their methodology didn't use raw game results. Instead, they used seasonal cumulative means. Let's take <span class="in">`rushingTDs`</span> for an example. Say a given team in week 1 had 1 rushing TD. Week 1 results are unchanged. If they scored 2 rushing TDs in week 2, then the cumulative mean becomes 1.5 and so on through the weeks. At the beginning of the next season, reset and start over. Hopefully, that makes sense.</span>
<span id="cb72-190"><a href="#cb72-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-193"><a href="#cb72-193" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-194"><a href="#cb72-194" aria-hidden="true" tabindex="-1"></a><span class="co"># re-combine the home and away dataframes into one long dataframe</span></span>
<span id="cb72-195"><a href="#cb72-195" aria-hidden="true" tabindex="-1"></a>ha <span class="ot">&lt;-</span> </span>
<span id="cb72-196"><a href="#cb72-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(home, away) <span class="sc">%&gt;%</span> </span>
<span id="cb72-197"><a href="#cb72-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(school, year, week)</span>
<span id="cb72-198"><a href="#cb72-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-199"><a href="#cb72-199" aria-hidden="true" tabindex="-1"></a><span class="co"># I want to calculate the cumulative MOV mean, but I also need to preserve the</span></span>
<span id="cb72-200"><a href="#cb72-200" aria-hidden="true" tabindex="-1"></a><span class="co"># actual MOV as the response variable.</span></span>
<span id="cb72-201"><a href="#cb72-201" aria-hidden="true" tabindex="-1"></a>mov_actual <span class="ot">&lt;-</span> ha <span class="sc">%&gt;%</span> .<span class="sc">$</span>MOV </span>
<span id="cb72-202"><a href="#cb72-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-203"><a href="#cb72-203" aria-hidden="true" tabindex="-1"></a><span class="co"># now calculate the cumulative means</span></span>
<span id="cb72-204"><a href="#cb72-204" aria-hidden="true" tabindex="-1"></a>cmeans<span class="ot">&lt;-</span></span>
<span id="cb72-205"><a href="#cb72-205" aria-hidden="true" tabindex="-1"></a>  ha <span class="sc">%&gt;%</span></span>
<span id="cb72-206"><a href="#cb72-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(school, year) <span class="sc">%&gt;%</span></span>
<span id="cb72-207"><a href="#cb72-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize_at</span>(<span class="fu">vars</span>(<span class="fu">c</span>(<span class="dv">3</span><span class="sc">:</span><span class="dv">52</span>)), cummean) <span class="sc">%&gt;%</span></span>
<span id="cb72-208"><a href="#cb72-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb72-209"><a href="#cb72-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-210"><a href="#cb72-210" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cmeans)</span>
<span id="cb72-211"><a href="#cb72-211" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-212"><a href="#cb72-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-213"><a href="#cb72-213" aria-hidden="true" tabindex="-1"></a>There are a few columns from the <span class="in">`ha`</span> dataframe, like the game ID, schools names, the week, the year, etc. that I don't want to have a cumulative mean - I want the original columns. So I'll select those columns and combine them with the cumulative means. Then I'll add the actual MOV results for use as the predictor variable.</span>
<span id="cb72-214"><a href="#cb72-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-217"><a href="#cb72-217" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-218"><a href="#cb72-218" aria-hidden="true" tabindex="-1"></a>ha <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(ha[, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">55</span>, <span class="dv">56</span>)], cmeans[, <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span><span class="sc">:</span><span class="dv">52</span>)])</span>
<span id="cb72-219"><a href="#cb72-219" aria-hidden="true" tabindex="-1"></a>ha<span class="sc">$</span>MOV_actual <span class="ot">&lt;-</span> mov_actual</span>
<span id="cb72-220"><a href="#cb72-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-221"><a href="#cb72-221" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ha)</span>
<span id="cb72-222"><a href="#cb72-222" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-223"><a href="#cb72-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-224"><a href="#cb72-224" aria-hidden="true" tabindex="-1"></a>I also want to include the spread as a predictor variable, which I can get via the API from <span class="in">`/lines`</span>.</span>
<span id="cb72-225"><a href="#cb72-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-228"><a href="#cb72-228" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-229"><a href="#cb72-229" aria-hidden="true" tabindex="-1"></a>spread <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"spread.RData"</span>)</span>
<span id="cb72-230"><a href="#cb72-230" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(spread)</span>
<span id="cb72-231"><a href="#cb72-231" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-232"><a href="#cb72-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-233"><a href="#cb72-233" aria-hidden="true" tabindex="-1"></a>Now I'll deal with the neutral site column since the dataframe is merged back together. I'm going to make a HFA column that's a 1 for the home team at their home field, a -1 for the away team, and a 0 for both teams at a neutral site. Then I'll add the pre-game spread for the home and away teams.</span>
<span id="cb72-234"><a href="#cb72-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-237"><a href="#cb72-237" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-238"><a href="#cb72-238" aria-hidden="true" tabindex="-1"></a>ha <span class="ot">&lt;-</span></span>
<span id="cb72-239"><a href="#cb72-239" aria-hidden="true" tabindex="-1"></a>  ha <span class="sc">%&gt;%</span></span>
<span id="cb72-240"><a href="#cb72-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">HFA =</span> <span class="fu">case_when</span>(</span>
<span id="cb72-241"><a href="#cb72-241" aria-hidden="true" tabindex="-1"></a>    homeAway <span class="sc">==</span> <span class="st">"home"</span> <span class="sc">&amp;</span> <span class="sc">!</span>neutral_site <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb72-242"><a href="#cb72-242" aria-hidden="true" tabindex="-1"></a>    homeAway <span class="sc">==</span> <span class="st">"away"</span> <span class="sc">&amp;</span> <span class="sc">!</span>neutral_site <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb72-243"><a href="#cb72-243" aria-hidden="true" tabindex="-1"></a>    neutral_site <span class="sc">~</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb72-244"><a href="#cb72-244" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(spread, <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb72-245"><a href="#cb72-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">spread =</span> <span class="fu">ifelse</span>(homeAway <span class="sc">==</span> <span class="st">"home"</span>, home_spread, <span class="sc">-</span>home_spread))</span>
<span id="cb72-246"><a href="#cb72-246" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-247"><a href="#cb72-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-248"><a href="#cb72-248" aria-hidden="true" tabindex="-1"></a>Something else I want to add is each team's seasonal win/loss record in the for of the percent of games they've won. I keep adding more and more predictors. We'll find out later if any of it will even be useful.</span>
<span id="cb72-249"><a href="#cb72-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-252"><a href="#cb72-252" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-253"><a href="#cb72-253" aria-hidden="true" tabindex="-1"></a>ha <span class="ot">&lt;-</span> </span>
<span id="cb72-254"><a href="#cb72-254" aria-hidden="true" tabindex="-1"></a>  ha <span class="sc">%&gt;%</span></span>
<span id="cb72-255"><a href="#cb72-255" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">wins =</span> <span class="fu">ifelse</span>(MOV_actual <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb72-256"><a href="#cb72-256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(school, year) <span class="sc">%&gt;%</span></span>
<span id="cb72-257"><a href="#cb72-257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">games =</span> <span class="fu">row_number</span>(),</span>
<span id="cb72-258"><a href="#cb72-258" aria-hidden="true" tabindex="-1"></a>         <span class="at">cumwins =</span> <span class="fu">cumsum</span>(wins),</span>
<span id="cb72-259"><a href="#cb72-259" aria-hidden="true" tabindex="-1"></a>         <span class="at">winPct =</span> cumwins <span class="sc">/</span> games) <span class="sc">%&gt;%</span></span>
<span id="cb72-260"><a href="#cb72-260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>wins, <span class="sc">-</span>games, <span class="sc">-</span>cumwins)</span>
<span id="cb72-261"><a href="#cb72-261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-262"><a href="#cb72-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-263"><a href="#cb72-263" aria-hidden="true" tabindex="-1"></a>Ok, this is where things get a little complicated. But first, a sidebar. I wrote this code over the course of a few weekends. Until this particular project, I'd never dealt with data where there are "sides" to think about. It took me a while to wrap my mind around it, and this is code from my first efforts where I was just trying to find "a way" to get things done. Pure brute force. Later you'll see that I came up with a much better (and faster) way to do what I about to demonstrate. All part of the sausage-making the way I look at it.</span>
<span id="cb72-264"><a href="#cb72-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-265"><a href="#cb72-265" aria-hidden="true" tabindex="-1"></a>The idea here is that I wanted to account for home field advantage. It's a definite thing with a measurable effect. I'll demonstrate using the <span class="in">`home`</span> dataframe from earlier. I'll remove games played at a neutral site, and get the mean margin of victory.</span>
<span id="cb72-266"><a href="#cb72-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-269"><a href="#cb72-269" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-270"><a href="#cb72-270" aria-hidden="true" tabindex="-1"></a>home <span class="sc">%&gt;%</span> </span>
<span id="cb72-271"><a href="#cb72-271" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>neutral_site) <span class="sc">%&gt;%</span></span>
<span id="cb72-272"><a href="#cb72-272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">meanMOV =</span> <span class="fu">mean</span>(MOV))</span>
<span id="cb72-273"><a href="#cb72-273" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-274"><a href="#cb72-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-275"><a href="#cb72-275" aria-hidden="true" tabindex="-1"></a>Home teams win by almost 4 points on average. We can also check to see if the mean MOV is statistically significant. I'll use the Wilcoxon signed rank test because *I'm certain* the data are not normally distributed - they're football scores, after all. I'll do a one-sided test where the null hypothesis is that the mean MOV is 0.</span>
<span id="cb72-276"><a href="#cb72-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-279"><a href="#cb72-279" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-280"><a href="#cb72-280" aria-hidden="true" tabindex="-1"></a><span class="fu">wilcox.test</span>(home <span class="sc">%&gt;%</span> </span>
<span id="cb72-281"><a href="#cb72-281" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(<span class="sc">!</span>neutral_site) <span class="sc">%&gt;%</span> .<span class="sc">$</span>MOV, </span>
<span id="cb72-282"><a href="#cb72-282" aria-hidden="true" tabindex="-1"></a>            <span class="at">alternative =</span> <span class="st">"greater"</span>)</span>
<span id="cb72-283"><a href="#cb72-283" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-284"><a href="#cb72-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-285"><a href="#cb72-285" aria-hidden="true" tabindex="-1"></a>Based on that p-value, we reject the null hypothesis at the 95% confidence level. Right, so home field advantage is a real thing, and I need to account for it.</span>
<span id="cb72-286"><a href="#cb72-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-287"><a href="#cb72-287" aria-hidden="true" tabindex="-1"></a>To do that, I wanted to get away from the idea of home team and away team and instead think of them more generically by randomly picking one team as "the team" and the other as "the opponent". My <span class="in">`ha`</span> dataframe is still grouped by <span class="in">`school`</span> and <span class="in">`year`</span>, so I'll ungroup it and call it my end-of-week results data - it's a mental trick so I think about things differently. Then I'll get all of the unique game IDs.</span>
<span id="cb72-288"><a href="#cb72-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-291"><a href="#cb72-291" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-292"><a href="#cb72-292" aria-hidden="true" tabindex="-1"></a>eowResults <span class="ot">&lt;-</span> ha <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>()</span>
<span id="cb72-293"><a href="#cb72-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-294"><a href="#cb72-294" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(eowResults <span class="sc">%&gt;%</span> .<span class="sc">$</span>id))</span>
<span id="cb72-295"><a href="#cb72-295" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-296"><a href="#cb72-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-297"><a href="#cb72-297" aria-hidden="true" tabindex="-1"></a>Next, I'll loop over the ID. For each ID, I'll start by picking out the common columns (id, week, and year), and then identify one team as team1 and the other as team2. For the first game, and for column-naming consistency as I build this new dataframe <span class="in">`df`</span>, team 1 will be "the team", and team2 will be "the opponent". For all other games, I pick a random number between 0 and 1. If it's greater than or equal to 0.5, team1 is "the team" and team2 is "the opponent". Otherwise, it's the reverse.</span>
<span id="cb72-298"><a href="#cb72-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-301"><a href="#cb72-301" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-302"><a href="#cb72-302" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> ids){</span>
<span id="cb72-303"><a href="#cb72-303" aria-hidden="true" tabindex="-1"></a>  common <span class="ot">&lt;-</span> eowResults <span class="sc">%&gt;%</span> </span>
<span id="cb72-304"><a href="#cb72-304" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(id <span class="sc">==</span> i) <span class="sc">%&gt;%</span> </span>
<span id="cb72-305"><a href="#cb72-305" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb72-306"><a href="#cb72-306" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, week, year)</span>
<span id="cb72-307"><a href="#cb72-307" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-308"><a href="#cb72-308" aria-hidden="true" tabindex="-1"></a>  team1 <span class="ot">&lt;-</span> eowResults <span class="sc">%&gt;%</span> </span>
<span id="cb72-309"><a href="#cb72-309" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(id <span class="sc">==</span> i) <span class="sc">%&gt;%</span> </span>
<span id="cb72-310"><a href="#cb72-310" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb72-311"><a href="#cb72-311" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>id, <span class="sc">-</span>week, <span class="sc">-</span>year)</span>
<span id="cb72-312"><a href="#cb72-312" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-313"><a href="#cb72-313" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(team1) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">colnames</span>(team1), <span class="st">"team"</span>, <span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb72-314"><a href="#cb72-314" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-315"><a href="#cb72-315" aria-hidden="true" tabindex="-1"></a>  team2 <span class="ot">&lt;-</span> eowResults <span class="sc">%&gt;%</span> </span>
<span id="cb72-316"><a href="#cb72-316" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(id <span class="sc">==</span> i) <span class="sc">%&gt;%</span> </span>
<span id="cb72-317"><a href="#cb72-317" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb72-318"><a href="#cb72-318" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>id, <span class="sc">-</span>week, <span class="sc">-</span>year)</span>
<span id="cb72-319"><a href="#cb72-319" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-320"><a href="#cb72-320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(team2) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">colnames</span>(team2), <span class="st">"opponent"</span>, <span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb72-321"><a href="#cb72-321" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-322"><a href="#cb72-322" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (i <span class="sc">==</span> <span class="fu">min</span>(ids)){df <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(common, team1, team2)}</span>
<span id="cb72-323"><a href="#cb72-323" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb72-324"><a href="#cb72-324" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&gt;=</span> <span class="fl">0.5</span>, </span>
<span id="cb72-325"><a href="#cb72-325" aria-hidden="true" tabindex="-1"></a>           newRow <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(common, team1, team2), </span>
<span id="cb72-326"><a href="#cb72-326" aria-hidden="true" tabindex="-1"></a>           newRow <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(common, team2, team1))</span>
<span id="cb72-327"><a href="#cb72-327" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>(newRow)}</span>
<span id="cb72-328"><a href="#cb72-328" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-329"><a href="#cb72-329" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb72-330"><a href="#cb72-330" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-331"><a href="#cb72-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-332"><a href="#cb72-332" aria-hidden="true" tabindex="-1"></a><span class="in">```{r include=FALSE}</span></span>
<span id="cb72-333"><a href="#cb72-333" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(cmeans, i, common, team1, team2)</span>
<span id="cb72-334"><a href="#cb72-334" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-335"><a href="#cb72-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-336"><a href="#cb72-336" aria-hidden="true" tabindex="-1"></a>Like I said, brute force. Now I have some redundant columns, so I'll drop drop them before going further.</span>
<span id="cb72-337"><a href="#cb72-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-340"><a href="#cb72-340" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-341"><a href="#cb72-341" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> </span>
<span id="cb72-342"><a href="#cb72-342" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span> </span>
<span id="cb72-343"><a href="#cb72-343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>homeAway_team, <span class="sc">-</span>homeAway_opponent, <span class="sc">-</span>neutral_site_team,</span>
<span id="cb72-344"><a href="#cb72-344" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>neutral_site_opponent, <span class="sc">-</span>MOV_actual_opponent, <span class="sc">-</span>HFA_opponent,</span>
<span id="cb72-345"><a href="#cb72-345" aria-hidden="true" tabindex="-1"></a>         <span class="sc">-</span>home_spread_opponent, <span class="sc">-</span>spread_opponent, <span class="sc">-</span>home_spread_team)</span>
<span id="cb72-346"><a href="#cb72-346" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-347"><a href="#cb72-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-348"><a href="#cb72-348" aria-hidden="true" tabindex="-1"></a>The final big step is to add a bunch of new columns to represent the difference in one team's average performance versus the average performance of the other team. Think of it this way. If a team scores on average 30 points a game, you might think that's pretty good. However, if the teams they've played have on average given up 40 points, then that 30 points doesn't look as impressive. I want to account for that for a number of statistics, so that's what I do here.</span>
<span id="cb72-349"><a href="#cb72-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-352"><a href="#cb72-352" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-353"><a href="#cb72-353" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> </span>
<span id="cb72-354"><a href="#cb72-354" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span></span>
<span id="cb72-355"><a href="#cb72-355" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb72-356"><a href="#cb72-356" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffPointsScored =</span> offensePoints_team <span class="sc">-</span> defensePointsAllowed_opponent,</span>
<span id="cb72-357"><a href="#cb72-357" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffPointsAllowed =</span> defensePointsAllowed_team <span class="sc">-</span> offensePoints_opponent,</span>
<span id="cb72-358"><a href="#cb72-358" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffYPPAOff =</span> yardsPerPass_team <span class="sc">-</span> defenseYPPAAllowed_opponent,</span>
<span id="cb72-359"><a href="#cb72-359" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffYPPADef =</span> defenseYPPAAllowed_team <span class="sc">-</span> yardsPerPass_opponent,</span>
<span id="cb72-360"><a href="#cb72-360" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffYPRAOff =</span> yardsPerRushAttempt_team <span class="sc">-</span> defenseYPRAAllowed_opponent,</span>
<span id="cb72-361"><a href="#cb72-361" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffYPRADef =</span> defenseYPRAAllowed_team <span class="sc">-</span> yardsPerRushAttempt_opponent,</span>
<span id="cb72-362"><a href="#cb72-362" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffPassYardsOff =</span> netPassingYards_team <span class="sc">-</span> defensePassYardsAllowed_opponent,</span>
<span id="cb72-363"><a href="#cb72-363" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffPassYardsDef =</span> defensePassYardsAllowed_team <span class="sc">-</span> netPassingYards_opponent,</span>
<span id="cb72-364"><a href="#cb72-364" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffRushYardsOff =</span> rushingYards_team <span class="sc">-</span> defenseRushYardsAllowed_opponent,</span>
<span id="cb72-365"><a href="#cb72-365" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffRushYardsDef =</span> defenseRushYardsAllowed_team <span class="sc">-</span> rushingYards_opponent,</span>
<span id="cb72-366"><a href="#cb72-366" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffYPPOff =</span> yardsPerPlay_team <span class="sc">-</span> defenseYardsPerPlayAllowed_opponent,</span>
<span id="cb72-367"><a href="#cb72-367" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffYPPDef =</span> defenseYardsPerPlayAllowed_team <span class="sc">-</span> yardsPerPlay_opponent,</span>
<span id="cb72-368"><a href="#cb72-368" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffELO =</span> elo_team <span class="sc">-</span> elo_opponent,</span>
<span id="cb72-369"><a href="#cb72-369" aria-hidden="true" tabindex="-1"></a>    <span class="at">diffWinPct =</span> winPct_team <span class="sc">-</span> winPct_opponent</span>
<span id="cb72-370"><a href="#cb72-370" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb72-371"><a href="#cb72-371" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>elo_team, <span class="sc">-</span>elo_opponent, <span class="sc">-</span>winPct_team, <span class="sc">-</span>winPct_opponent)</span>
<span id="cb72-372"><a href="#cb72-372" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-373"><a href="#cb72-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-374"><a href="#cb72-374" aria-hidden="true" tabindex="-1"></a>At this point, I noticed that there are a number of NAs in the <span class="in">`spread_team`</span> column, and they're all from the 2020 season. I guess that might have to do with it being the first COVID season. I'll replace those NAs with 0s - again, maybe not the best idea if I was doing this for real.</span>
<span id="cb72-375"><a href="#cb72-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-378"><a href="#cb72-378" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-379"><a href="#cb72-379" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">spread_team =</span> <span class="fu">replace_na</span>(spread_team, <span class="dv">0</span>))</span>
<span id="cb72-380"><a href="#cb72-380" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-381"><a href="#cb72-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-382"><a href="#cb72-382" aria-hidden="true" tabindex="-1"></a>One last thing. This is going to seem out of place here, but since I cranked away at this data set a bunch of times as I was working through this, I developed some insights and some practices. First, I'll explicitly set the teams as factors instead of strings. I'll also generate a new column, <span class="in">`diffMOV`</span> as the difference in the mean margin of victory - that turned out to be useful. I'll also get rid of any column with "TD" in it's name because I found them to be unhelpful. Same thing with pass completions, pass attempts (I essentially have those already in <span class="in">`passEfficiency`</span>), and rushing attempts. Finally, I reorder columns to make looking at the dataset a little easier.</span>
<span id="cb72-383"><a href="#cb72-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-386"><a href="#cb72-386" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-387"><a href="#cb72-387" aria-hidden="true" tabindex="-1"></a>lvls <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">c</span>(df <span class="sc">%&gt;%</span> .<span class="sc">$</span>school_team, df <span class="sc">%&gt;%</span> .<span class="sc">$</span>school_opponent)))</span>
<span id="cb72-388"><a href="#cb72-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-389"><a href="#cb72-389" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb72-390"><a href="#cb72-390" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">school_team =</span> <span class="fu">factor</span>(school_team, <span class="at">levels =</span> lvls),</span>
<span id="cb72-391"><a href="#cb72-391" aria-hidden="true" tabindex="-1"></a>         <span class="at">school_opponent =</span> <span class="fu">factor</span>(school_opponent, <span class="at">levels =</span> lvls),</span>
<span id="cb72-392"><a href="#cb72-392" aria-hidden="true" tabindex="-1"></a>         <span class="at">diffMOV  =</span> MOV_team <span class="sc">-</span> MOV_opponent) <span class="sc">%&gt;%</span></span>
<span id="cb72-393"><a href="#cb72-393" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb72-394"><a href="#cb72-394" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>MOV_team, <span class="sc">-</span>MOV_opponent,</span>
<span id="cb72-395"><a href="#cb72-395" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>rushingTDs_team, <span class="sc">-</span>rushingTDs_opponent,</span>
<span id="cb72-396"><a href="#cb72-396" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>puntReturnTDs_team, <span class="sc">-</span>puntReturnTDs_opponent,</span>
<span id="cb72-397"><a href="#cb72-397" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>passingTDs_team, <span class="sc">-</span>passingTDs_opponent,</span>
<span id="cb72-398"><a href="#cb72-398" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>kickReturnTDs_team, <span class="sc">-</span>kickReturnTDs_opponent,</span>
<span id="cb72-399"><a href="#cb72-399" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>interceptionTDs_team, <span class="sc">-</span>interceptionTDs_opponent,</span>
<span id="cb72-400"><a href="#cb72-400" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>passCompletions_team, <span class="sc">-</span>passCompletions_opponent,</span>
<span id="cb72-401"><a href="#cb72-401" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>passAttempts_team, <span class="sc">-</span>passAttempts_opponent,</span>
<span id="cb72-402"><a href="#cb72-402" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>rushingAttempts_team, <span class="sc">-</span>rushingAttempts_opponent</span>
<span id="cb72-403"><a href="#cb72-403" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb72-404"><a href="#cb72-404" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, week, year, school_team, MOV_actual_team, HFA_team, spread_team, </span>
<span id="cb72-405"><a href="#cb72-405" aria-hidden="true" tabindex="-1"></a>         school_opponent, diffELO, <span class="fu">everything</span>())</span>
<span id="cb72-406"><a href="#cb72-406" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-407"><a href="#cb72-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-408"><a href="#cb72-408" aria-hidden="true" tabindex="-1"></a>Data wrangling is finally complete, and the data are now ready to be split into training and test data sets. The training data will be the 2017-2020 seasons (<span class="in">`df20`</span>), and I'll train some models on that to predict the 2021 season (<span class="in">`df21`</span>).</span>
<span id="cb72-409"><a href="#cb72-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-412"><a href="#cb72-412" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-413"><a href="#cb72-413" aria-hidden="true" tabindex="-1"></a>df20 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">&lt;</span> <span class="dv">2021</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>year)</span>
<span id="cb72-414"><a href="#cb72-414" aria-hidden="true" tabindex="-1"></a>df21 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2021</span>)</span>
<span id="cb72-415"><a href="#cb72-415" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-416"><a href="#cb72-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-417"><a href="#cb72-417" aria-hidden="true" tabindex="-1"></a>Pause one more time and think about the data at this point. Recall that the df20 and df21 data are game **results**. I can't use game results in the test data set - I won't have results prior to each game being played! I will however have week 1 results available at the start of week 2, and both of those will be available at the start of week 3, and so on. If I group the test data by team and week, I can just shift all of the results data down one row. That will produce NAs for the first game each team plays, so I'll drop those. This means I won't have a prediction for the first game each team plays, either. I'll need to find another way of doing things if I want to do this for real. Forging ahead anyway for now...</span>
<span id="cb72-418"><a href="#cb72-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-421"><a href="#cb72-421" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-422"><a href="#cb72-422" aria-hidden="true" tabindex="-1"></a>df21 <span class="ot">&lt;-</span></span>
<span id="cb72-423"><a href="#cb72-423" aria-hidden="true" tabindex="-1"></a>  df21 <span class="sc">%&gt;%</span>  </span>
<span id="cb72-424"><a href="#cb72-424" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(school_team, week) <span class="sc">%&gt;%</span> </span>
<span id="cb72-425"><a href="#cb72-425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(school_team) <span class="sc">%&gt;%</span> </span>
<span id="cb72-426"><a href="#cb72-426" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="dv">9</span><span class="sc">:</span><span class="dv">102</span>, lag)) <span class="sc">%&gt;%</span></span>
<span id="cb72-427"><a href="#cb72-427" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-428"><a href="#cb72-428" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb72-429"><a href="#cb72-429" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>year)</span>
<span id="cb72-430"><a href="#cb72-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-431"><a href="#cb72-431" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df21)</span>
<span id="cb72-432"><a href="#cb72-432" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-433"><a href="#cb72-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-434"><a href="#cb72-434" aria-hidden="true" tabindex="-1"></a><span class="fu">## Feature Selection With Lasso Regression</span></span>
<span id="cb72-435"><a href="#cb72-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-436"><a href="#cb72-436" aria-hidden="true" tabindex="-1"></a>That was a fair amount of work! We now have data sets with 102 columns, and I know that a decent amount of those columns are just noise. My go-to method for feature selection is lasso regression, and it happens to be the same techniques used by the authors. But wait! I've been a fan of the <span class="in">`caret`</span> package to do modeling, but now there's <span class="co">[</span><span class="ot">tidymodels</span><span class="co">](https://www.tidymodels.org/start/)</span> - written with tidy concepts in mind. And written by Max Kuhn - the author of <span class="in">`caret`</span>. I've been wanting to try this out, so here goes.</span>
<span id="cb72-437"><a href="#cb72-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-438"><a href="#cb72-438" aria-hidden="true" tabindex="-1"></a>After importing the library, I need to get my training and test sets back into one dataset so tidymodels can do its thing in its tidy way. I join them and the re-split them with <span class="in">`initial_time_split()`</span> because my observations are by week and year. The proportion is 2682/3298 because the first 2682 observations are the games in the 2017-2020 seasons. I'll also create a validation data set.</span>
<span id="cb72-439"><a href="#cb72-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-442"><a href="#cb72-442" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-443"><a href="#cb72-443" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb72-444"><a href="#cb72-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-445"><a href="#cb72-445" aria-hidden="true" tabindex="-1"></a>df_joined <span class="ot">&lt;-</span> df20 <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>(df21)</span>
<span id="cb72-446"><a href="#cb72-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-447"><a href="#cb72-447" aria-hidden="true" tabindex="-1"></a>data_split <span class="ot">&lt;-</span> <span class="fu">initial_time_split</span>(df_joined, <span class="at">prop =</span> <span class="dv">2682</span><span class="sc">/</span><span class="dv">3298</span>)</span>
<span id="cb72-448"><a href="#cb72-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-449"><a href="#cb72-449" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(data_split)</span>
<span id="cb72-450"><a href="#cb72-450" aria-hidden="true" tabindex="-1"></a>test_data  <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_split)</span>
<span id="cb72-451"><a href="#cb72-451" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-452"><a href="#cb72-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-453"><a href="#cb72-453" aria-hidden="true" tabindex="-1"></a>I'm not going to go into detail here about what each of these steps are doing because I can't to it any better than <span class="co">[</span><span class="ot">the docs</span><span class="co">](https://www.tidymodels.org/start/)</span>.</span>
<span id="cb72-454"><a href="#cb72-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-457"><a href="#cb72-457" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-458"><a href="#cb72-458" aria-hidden="true" tabindex="-1"></a><span class="co"># create the recipe</span></span>
<span id="cb72-459"><a href="#cb72-459" aria-hidden="true" tabindex="-1"></a><span class="co"># note I omit the categorical school variables</span></span>
<span id="cb72-460"><a href="#cb72-460" aria-hidden="true" tabindex="-1"></a>lm_rec <span class="ot">&lt;-</span></span>
<span id="cb72-461"><a href="#cb72-461" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(MOV_actual_team <span class="sc">~</span> ., <span class="at">data =</span> train_data <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>id, <span class="sc">-</span>week, <span class="sc">-</span>school_team, <span class="sc">-</span>school_opponent)) <span class="sc">%&gt;%</span> </span>
<span id="cb72-462"><a href="#cb72-462" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span>        <span class="co"># one-hot encoding</span></span>
<span id="cb72-463"><a href="#cb72-463" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>()) <span class="sc">%&gt;%</span>                   <span class="co"># eliminate zero variance columns</span></span>
<span id="cb72-464"><a href="#cb72-464" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric</span>(), <span class="sc">-</span><span class="fu">all_outcomes</span>())  <span class="co"># normalize numeric variables</span></span>
<span id="cb72-465"><a href="#cb72-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-466"><a href="#cb72-466" aria-hidden="true" tabindex="-1"></a><span class="co"># define the model and hyperparameters to tune</span></span>
<span id="cb72-467"><a href="#cb72-467" aria-hidden="true" tabindex="-1"></a>lm_mod <span class="ot">&lt;-</span></span>
<span id="cb72-468"><a href="#cb72-468" aria-hidden="true" tabindex="-1"></a>  <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fu">tune</span>(), <span class="at">mixture =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb72-469"><a href="#cb72-469" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb72-470"><a href="#cb72-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-471"><a href="#cb72-471" aria-hidden="true" tabindex="-1"></a><span class="co"># values to select when tuning</span></span>
<span id="cb72-472"><a href="#cb72-472" aria-hidden="true" tabindex="-1"></a>lambda_grid <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">penalty =</span> <span class="dv">10</span><span class="sc">^</span><span class="fu">seq</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">50</span>))</span>
<span id="cb72-473"><a href="#cb72-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-474"><a href="#cb72-474" aria-hidden="true" tabindex="-1"></a><span class="co"># cross validation folds</span></span>
<span id="cb72-475"><a href="#cb72-475" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">345</span>)</span>
<span id="cb72-476"><a href="#cb72-476" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(train_data, <span class="at">v =</span> <span class="dv">10</span>)</span>
<span id="cb72-477"><a href="#cb72-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-478"><a href="#cb72-478" aria-hidden="true" tabindex="-1"></a><span class="co"># create the workflow</span></span>
<span id="cb72-479"><a href="#cb72-479" aria-hidden="true" tabindex="-1"></a>lm_wflow <span class="ot">&lt;-</span> </span>
<span id="cb72-480"><a href="#cb72-480" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb72-481"><a href="#cb72-481" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_mod) <span class="sc">%&gt;%</span> </span>
<span id="cb72-482"><a href="#cb72-482" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(lm_rec)</span>
<span id="cb72-483"><a href="#cb72-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-484"><a href="#cb72-484" aria-hidden="true" tabindex="-1"></a><span class="co"># tune the model</span></span>
<span id="cb72-485"><a href="#cb72-485" aria-hidden="true" tabindex="-1"></a>lm_res <span class="ot">&lt;-</span> </span>
<span id="cb72-486"><a href="#cb72-486" aria-hidden="true" tabindex="-1"></a>  lm_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb72-487"><a href="#cb72-487" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(</span>
<span id="cb72-488"><a href="#cb72-488" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> lambda_grid,</span>
<span id="cb72-489"><a href="#cb72-489" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> folds,</span>
<span id="cb72-490"><a href="#cb72-490" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">control_grid</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>)</span>
<span id="cb72-491"><a href="#cb72-491" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-492"><a href="#cb72-492" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-493"><a href="#cb72-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-494"><a href="#cb72-494" aria-hidden="true" tabindex="-1"></a>Let's take a look at the mean error and R-squared for the different penalty values (thanks to <span class="co">[</span><span class="ot">this post</span><span class="co">](https://juliasilge.com/blog/lasso-the-office/)</span> for the nice plot idea).</span>
<span id="cb72-495"><a href="#cb72-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-498"><a href="#cb72-498" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-499"><a href="#cb72-499" aria-hidden="true" tabindex="-1"></a>lm_res <span class="sc">%&gt;%</span></span>
<span id="cb72-500"><a href="#cb72-500" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-501"><a href="#cb72-501" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(penalty, mean, <span class="at">color =</span> .metric)) <span class="sc">+</span></span>
<span id="cb72-502"><a href="#cb72-502" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(</span>
<span id="cb72-503"><a href="#cb72-503" aria-hidden="true" tabindex="-1"></a>    <span class="at">ymin =</span> mean <span class="sc">-</span> std_err,</span>
<span id="cb72-504"><a href="#cb72-504" aria-hidden="true" tabindex="-1"></a>    <span class="at">ymax =</span> mean <span class="sc">+</span> std_err</span>
<span id="cb72-505"><a href="#cb72-505" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb72-506"><a href="#cb72-506" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb72-507"><a href="#cb72-507" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb72-508"><a href="#cb72-508" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb72-509"><a href="#cb72-509" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.metric, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb72-510"><a href="#cb72-510" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>() <span class="sc">+</span></span>
<span id="cb72-511"><a href="#cb72-511" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb72-512"><a href="#cb72-512" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb72-513"><a href="#cb72-513" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-514"><a href="#cb72-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-515"><a href="#cb72-515" aria-hidden="true" tabindex="-1"></a>I have some choices of what do to next. Normally, what I'd do is select the simplest model within one standard error of the model with the lowest RMSE. I can do that with the <span class="in">`select_by_one_std_err()`</span> function as shown below. Note the penalty value for that model and hold that thought.</span>
<span id="cb72-516"><a href="#cb72-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-519"><a href="#cb72-519" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-520"><a href="#cb72-520" aria-hidden="true" tabindex="-1"></a>lm_res <span class="sc">%&gt;%</span> <span class="fu">select_by_one_std_err</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>, <span class="fu">desc</span>(penalty))</span>
<span id="cb72-521"><a href="#cb72-521" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-522"><a href="#cb72-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-523"><a href="#cb72-523" aria-hidden="true" tabindex="-1"></a>I could also forget the "within one standard error" aspect and just select the model with the lowest RMSE (or I could select the least complex model that has no more than a certain percentage loss of RMSE). Select the model with the lowest error gives the folloing penalty value. Which one shoud I choose?</span>
<span id="cb72-524"><a href="#cb72-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-527"><a href="#cb72-527" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-528"><a href="#cb72-528" aria-hidden="true" tabindex="-1"></a>lowest_rmse <span class="ot">&lt;-</span> lm_res <span class="sc">%&gt;%</span> <span class="fu">select_best</span>(<span class="st">"rmse"</span>)</span>
<span id="cb72-529"><a href="#cb72-529" aria-hidden="true" tabindex="-1"></a>lowest_rmse</span>
<span id="cb72-530"><a href="#cb72-530" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-531"><a href="#cb72-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-532"><a href="#cb72-532" aria-hidden="true" tabindex="-1"></a>Take a look at the model object below. If I go with the 1SE lambda of 1.6, based on the degrees of freedom (Df) I'll have only 2 or 3 predictors in the model (1.64 just happens to fall between the two penalty values below, so I'm not sure how many predictor will actually be selected). So out of about 100 predictors, only 2 or three will be selected. To me, that means a few variables dominate and the rest are just noise. With the lowest RMSE lambda value of 0.256, there will be 21-22 predictors selected. For the purpose of this post, I'm going to choose the lowest RMSE.</span>
<span id="cb72-533"><a href="#cb72-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-534"><a href="#cb72-534" aria-hidden="true" tabindex="-1"></a>For the final fit, I finalize the work flow based on the lowest RMSE. Notice I also use <span class="in">`data_split`</span>, which contains both the training and test data. From that fit, I get the RMSE and R-squared for the test data set. The RMSE is about 3 touchdowns, and the R-squared is alarmingly low.</span>
<span id="cb72-535"><a href="#cb72-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-538"><a href="#cb72-538" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-539"><a href="#cb72-539" aria-hidden="true" tabindex="-1"></a>lm_final_wf <span class="ot">&lt;-</span> </span>
<span id="cb72-540"><a href="#cb72-540" aria-hidden="true" tabindex="-1"></a>  lm_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb72-541"><a href="#cb72-541" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(lowest_rmse)</span>
<span id="cb72-542"><a href="#cb72-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-543"><a href="#cb72-543" aria-hidden="true" tabindex="-1"></a>lm_final_fit <span class="ot">&lt;-</span> </span>
<span id="cb72-544"><a href="#cb72-544" aria-hidden="true" tabindex="-1"></a>  lm_final_wf <span class="sc">%&gt;%</span></span>
<span id="cb72-545"><a href="#cb72-545" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(data_split) </span>
<span id="cb72-546"><a href="#cb72-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-547"><a href="#cb72-547" aria-hidden="true" tabindex="-1"></a>lm_final_fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span>
<span id="cb72-548"><a href="#cb72-548" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-549"><a href="#cb72-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-552"><a href="#cb72-552" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-553"><a href="#cb72-553" aria-hidden="true" tabindex="-1"></a>lm_final_fit <span class="sc">%&gt;%</span> </span>
<span id="cb72-554"><a href="#cb72-554" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>()</span>
<span id="cb72-555"><a href="#cb72-555" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-556"><a href="#cb72-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-557"><a href="#cb72-557" aria-hidden="true" tabindex="-1"></a>Here I plot the selected predictors color coded by whether the coefficient is positive or negative. Clearly, <span class="in">`diffMOV`</span> dominates all other variables. Other important variables include the spread and home field advantage. Everything after that is probably just noise.</span>
<span id="cb72-558"><a href="#cb72-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-561"><a href="#cb72-561" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-562"><a href="#cb72-562" aria-hidden="true" tabindex="-1"></a>lm_final_fit <span class="sc">%&gt;%</span> </span>
<span id="cb72-563"><a href="#cb72-563" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-564"><a href="#cb72-564" aria-hidden="true" tabindex="-1"></a>  vip<span class="sc">::</span><span class="fu">vi</span>(<span class="at">lambda =</span> lowest_rmse<span class="sc">$</span>penalty) <span class="sc">%&gt;%</span></span>
<span id="cb72-565"><a href="#cb72-565" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb72-566"><a href="#cb72-566" aria-hidden="true" tabindex="-1"></a>    <span class="at">Importance =</span> <span class="fu">abs</span>(Importance),</span>
<span id="cb72-567"><a href="#cb72-567" aria-hidden="true" tabindex="-1"></a>    <span class="at">Variable =</span> forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(Variable, Importance)</span>
<span id="cb72-568"><a href="#cb72-568" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb72-569"><a href="#cb72-569" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Importance <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb72-570"><a href="#cb72-570" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Importance, <span class="at">y =</span> Variable, <span class="at">fill =</span> Sign)) <span class="sc">+</span></span>
<span id="cb72-571"><a href="#cb72-571" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb72-572"><a href="#cb72-572" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb72-573"><a href="#cb72-573" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb72-574"><a href="#cb72-574" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb72-575"><a href="#cb72-575" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-576"><a href="#cb72-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-577"><a href="#cb72-577" aria-hidden="true" tabindex="-1"></a>Well, what if we were to make predictions based off of this model? First I'll make a scatter plot of predictions versus actual MOV.</span>
<span id="cb72-578"><a href="#cb72-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-581"><a href="#cb72-581" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-582"><a href="#cb72-582" aria-hidden="true" tabindex="-1"></a>lm_final_fit <span class="sc">%&gt;%</span> </span>
<span id="cb72-583"><a href="#cb72-583" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-584"><a href="#cb72-584" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb72-585"><a href="#cb72-585" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb72-586"><a href="#cb72-586" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span><span class="st">`</span><span class="at">.pred</span><span class="st">`</span>, <span class="at">y=</span>MOV_actual_team)) <span class="sc">+</span></span>
<span id="cb72-587"><a href="#cb72-587" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb72-588"><a href="#cb72-588" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Linear Model Prediction Results"</span>,</span>
<span id="cb72-589"><a href="#cb72-589" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Predicted MOV"</span>,</span>
<span id="cb72-590"><a href="#cb72-590" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Actual MOV"</span>)</span>
<span id="cb72-591"><a href="#cb72-591" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-592"><a href="#cb72-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-593"><a href="#cb72-593" aria-hidden="true" tabindex="-1"></a>NThere's a little bit of a trend there, but it looks more like a shotgun blast. Not surprising, though, given the RMSE and R-squared we saw earlier. Let's see what percent of predictions were correct in a head-to-head sense - in other words, what percent predicted just the correct winner.</span>
<span id="cb72-594"><a href="#cb72-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-597"><a href="#cb72-597" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-598"><a href="#cb72-598" aria-hidden="true" tabindex="-1"></a>lm_final_fit <span class="sc">%&gt;%</span> </span>
<span id="cb72-599"><a href="#cb72-599" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-600"><a href="#cb72-600" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">both_positive =</span> <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb72-601"><a href="#cb72-601" aria-hidden="true" tabindex="-1"></a>         <span class="at">both_negative =</span> <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&lt;</span> <span class="dv">0</span>,</span>
<span id="cb72-602"><a href="#cb72-602" aria-hidden="true" tabindex="-1"></a>         <span class="at">correct =</span> both_positive <span class="sc">+</span> both_negative) <span class="sc">%&gt;%</span> </span>
<span id="cb72-603"><a href="#cb72-603" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">sumCorrect =</span> <span class="fu">sum</span>(correct)) <span class="sc">/</span> <span class="fu">nrow</span>(df21)</span>
<span id="cb72-604"><a href="#cb72-604" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-605"><a href="#cb72-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-606"><a href="#cb72-606" aria-hidden="true" tabindex="-1"></a>Hmm... 64% Better than half, anyway, but not very impressive. Before I move on to another model type, I'll grab the 22 predictors so I can remove everything else from the training and test data sets.</span>
<span id="cb72-607"><a href="#cb72-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-610"><a href="#cb72-610" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-611"><a href="#cb72-611" aria-hidden="true" tabindex="-1"></a>keep_vars <span class="ot">&lt;-</span> </span>
<span id="cb72-612"><a href="#cb72-612" aria-hidden="true" tabindex="-1"></a>  lm_final_fit <span class="sc">%&gt;%</span> </span>
<span id="cb72-613"><a href="#cb72-613" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-614"><a href="#cb72-614" aria-hidden="true" tabindex="-1"></a>  vip<span class="sc">::</span><span class="fu">vi</span>(<span class="at">lambda =</span> lowest_rmse<span class="sc">$</span>penalty) <span class="sc">%&gt;%</span></span>
<span id="cb72-615"><a href="#cb72-615" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Importance <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb72-616"><a href="#cb72-616" aria-hidden="true" tabindex="-1"></a>  .<span class="sc">$</span> Variable</span>
<span id="cb72-617"><a href="#cb72-617" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-618"><a href="#cb72-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-619"><a href="#cb72-619" aria-hidden="true" tabindex="-1"></a><span class="fu">## Random Forest Model</span></span>
<span id="cb72-620"><a href="#cb72-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-621"><a href="#cb72-621" aria-hidden="true" tabindex="-1"></a>I'll try a few different models with the same data and see how they compare. I'll start with a random forest model using the <span class="in">`ranger package`</span>. I'll use the same tidymodels procedure as above: create a recipe, model, and workflow, tune hyperparameters, and show the errors for the best model. This takes a while to execute on my laptop even when using all available cores.</span>
<span id="cb72-622"><a href="#cb72-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-625"><a href="#cb72-625" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-626"><a href="#cb72-626" aria-hidden="true" tabindex="-1"></a>cores <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>()</span>
<span id="cb72-627"><a href="#cb72-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-628"><a href="#cb72-628" aria-hidden="true" tabindex="-1"></a><span class="co"># the recipe</span></span>
<span id="cb72-629"><a href="#cb72-629" aria-hidden="true" tabindex="-1"></a>rf_rec <span class="ot">&lt;-</span> </span>
<span id="cb72-630"><a href="#cb72-630" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(MOV_actual_team <span class="sc">~</span> ., <span class="at">data =</span> train_data <span class="sc">%&gt;%</span> <span class="fu">select</span>(keep_vars, MOV_actual_team)) <span class="sc">%&gt;%</span> </span>
<span id="cb72-631"><a href="#cb72-631" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb72-632"><a href="#cb72-632" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>())</span>
<span id="cb72-633"><a href="#cb72-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-634"><a href="#cb72-634" aria-hidden="true" tabindex="-1"></a><span class="co"># the model to tune</span></span>
<span id="cb72-635"><a href="#cb72-635" aria-hidden="true" tabindex="-1"></a>rf_mod <span class="ot">&lt;-</span></span>
<span id="cb72-636"><a href="#cb72-636" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rand_forest</span>(<span class="at">mtry =</span> <span class="fu">tune</span>(), <span class="at">min_n =</span> <span class="fu">tune</span>(), <span class="at">trees =</span> <span class="dv">1000</span>) <span class="sc">%&gt;%</span></span>
<span id="cb72-637"><a href="#cb72-637" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>, <span class="at">importance =</span> <span class="st">"impurity"</span>, <span class="at">num.threads =</span> cores) <span class="sc">%&gt;%</span></span>
<span id="cb72-638"><a href="#cb72-638" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb72-639"><a href="#cb72-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-640"><a href="#cb72-640" aria-hidden="true" tabindex="-1"></a><span class="co"># the workflow</span></span>
<span id="cb72-641"><a href="#cb72-641" aria-hidden="true" tabindex="-1"></a>rf_wflow <span class="ot">&lt;-</span> </span>
<span id="cb72-642"><a href="#cb72-642" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb72-643"><a href="#cb72-643" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(rf_mod) <span class="sc">%&gt;%</span> </span>
<span id="cb72-644"><a href="#cb72-644" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rf_rec)</span>
<span id="cb72-645"><a href="#cb72-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-646"><a href="#cb72-646" aria-hidden="true" tabindex="-1"></a><span class="co"># now set the seed for reproducability and tune the hyperparameters</span></span>
<span id="cb72-647"><a href="#cb72-647" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb72-648"><a href="#cb72-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-649"><a href="#cb72-649" aria-hidden="true" tabindex="-1"></a>rf_fit <span class="ot">&lt;-</span></span>
<span id="cb72-650"><a href="#cb72-650" aria-hidden="true" tabindex="-1"></a>  rf_wflow <span class="sc">%&gt;%</span></span>
<span id="cb72-651"><a href="#cb72-651" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(<span class="at">grid =</span> <span class="dv">25</span>,</span>
<span id="cb72-652"><a href="#cb72-652" aria-hidden="true" tabindex="-1"></a>            <span class="at">control =</span> <span class="fu">control_grid</span>(),</span>
<span id="cb72-653"><a href="#cb72-653" aria-hidden="true" tabindex="-1"></a>            <span class="at">resamples =</span> folds)</span>
<span id="cb72-654"><a href="#cb72-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-655"><a href="#cb72-655" aria-hidden="true" tabindex="-1"></a><span class="co"># take a look at the best models</span></span>
<span id="cb72-656"><a href="#cb72-656" aria-hidden="true" tabindex="-1"></a>rf_fit <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>)</span>
<span id="cb72-657"><a href="#cb72-657" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-658"><a href="#cb72-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-659"><a href="#cb72-659" aria-hidden="true" tabindex="-1"></a>There's a nice <span class="in">`autoplot()`</span> function that comes with <span class="in">`tune`</span> (one of the tidymodels dependencies) that can be used with various tidymodels objects. Let's check it out with <span class="in">`rf_fit`</span>.</span>
<span id="cb72-660"><a href="#cb72-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-663"><a href="#cb72-663" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-664"><a href="#cb72-664" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(rf_fit) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span>
<span id="cb72-665"><a href="#cb72-665" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-666"><a href="#cb72-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-667"><a href="#cb72-667" aria-hidden="true" tabindex="-1"></a>Looks like large numbers of <span class="in">`mtry`</span> are good, but the error flattens out after 50 or so.</span>
<span id="cb72-668"><a href="#cb72-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-671"><a href="#cb72-671" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-672"><a href="#cb72-672" aria-hidden="true" tabindex="-1"></a><span class="co"># final fit</span></span>
<span id="cb72-673"><a href="#cb72-673" aria-hidden="true" tabindex="-1"></a>last_rf_mod <span class="ot">&lt;-</span> </span>
<span id="cb72-674"><a href="#cb72-674" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rand_forest</span>(<span class="at">mtry =</span> <span class="dv">17</span>, <span class="at">min_n =</span> <span class="dv">22</span>, <span class="at">trees =</span> <span class="dv">1000</span>) <span class="sc">%&gt;%</span> <span class="co"># original </span></span>
<span id="cb72-675"><a href="#cb72-675" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>, <span class="at">importance =</span> <span class="st">"impurity"</span>, <span class="at">num.threads =</span> cores) <span class="sc">%&gt;%</span> </span>
<span id="cb72-676"><a href="#cb72-676" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb72-677"><a href="#cb72-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-678"><a href="#cb72-678" aria-hidden="true" tabindex="-1"></a><span class="co"># the last workflow</span></span>
<span id="cb72-679"><a href="#cb72-679" aria-hidden="true" tabindex="-1"></a>last_rf_workflow <span class="ot">&lt;-</span> </span>
<span id="cb72-680"><a href="#cb72-680" aria-hidden="true" tabindex="-1"></a>  rf_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb72-681"><a href="#cb72-681" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_model</span>(last_rf_mod)</span>
<span id="cb72-682"><a href="#cb72-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-683"><a href="#cb72-683" aria-hidden="true" tabindex="-1"></a><span class="co"># the last fit</span></span>
<span id="cb72-684"><a href="#cb72-684" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">345</span>)</span>
<span id="cb72-685"><a href="#cb72-685" aria-hidden="true" tabindex="-1"></a>last_rf_fit <span class="ot">&lt;-</span> </span>
<span id="cb72-686"><a href="#cb72-686" aria-hidden="true" tabindex="-1"></a>  last_rf_workflow <span class="sc">%&gt;%</span> </span>
<span id="cb72-687"><a href="#cb72-687" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(data_split)</span>
<span id="cb72-688"><a href="#cb72-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-689"><a href="#cb72-689" aria-hidden="true" tabindex="-1"></a>last_rf_fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span>
<span id="cb72-690"><a href="#cb72-690" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-691"><a href="#cb72-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-692"><a href="#cb72-692" aria-hidden="true" tabindex="-1"></a>Still pretty bad. Let's take a look at variable importance for this model.</span>
<span id="cb72-693"><a href="#cb72-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-696"><a href="#cb72-696" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-697"><a href="#cb72-697" aria-hidden="true" tabindex="-1"></a>last_rf_fit <span class="sc">%&gt;%</span> </span>
<span id="cb72-698"><a href="#cb72-698" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">".workflow"</span>, <span class="dv">1</span>) <span class="sc">%&gt;%</span>   </span>
<span id="cb72-699"><a href="#cb72-699" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb72-700"><a href="#cb72-700" aria-hidden="true" tabindex="-1"></a>  vip<span class="sc">::</span><span class="fu">vip</span>(<span class="at">num_features =</span> <span class="dv">22</span>) <span class="sc">+</span></span>
<span id="cb72-701"><a href="#cb72-701" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb72-702"><a href="#cb72-702" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-703"><a href="#cb72-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-704"><a href="#cb72-704" aria-hidden="true" tabindex="-1"></a>Really only three variables that are contributing much to the model. I'll do predicted versus actual again and hope for less of a shotgun blast.</span>
<span id="cb72-705"><a href="#cb72-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-708"><a href="#cb72-708" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-709"><a href="#cb72-709" aria-hidden="true" tabindex="-1"></a>last_rf_fit <span class="sc">%&gt;%</span> </span>
<span id="cb72-710"><a href="#cb72-710" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-711"><a href="#cb72-711" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb72-712"><a href="#cb72-712" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb72-713"><a href="#cb72-713" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span><span class="st">`</span><span class="at">.pred</span><span class="st">`</span>, <span class="at">y=</span>MOV_actual_team)) <span class="sc">+</span></span>
<span id="cb72-714"><a href="#cb72-714" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb72-715"><a href="#cb72-715" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Ranger Prediction Results"</span>,</span>
<span id="cb72-716"><a href="#cb72-716" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Predicted MOV"</span>,</span>
<span id="cb72-717"><a href="#cb72-717" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Actual MOV"</span>)</span>
<span id="cb72-718"><a href="#cb72-718" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-719"><a href="#cb72-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-720"><a href="#cb72-720" aria-hidden="true" tabindex="-1"></a>Maybe looks a little more elongated but that could be wishful thinking. How about the percent correct head to head?</span>
<span id="cb72-721"><a href="#cb72-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-724"><a href="#cb72-724" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-725"><a href="#cb72-725" aria-hidden="true" tabindex="-1"></a>last_rf_fit <span class="sc">%&gt;%</span> </span>
<span id="cb72-726"><a href="#cb72-726" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-727"><a href="#cb72-727" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">both_positive =</span> <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb72-728"><a href="#cb72-728" aria-hidden="true" tabindex="-1"></a>         <span class="at">both_negative =</span> <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&lt;</span> <span class="dv">0</span>,</span>
<span id="cb72-729"><a href="#cb72-729" aria-hidden="true" tabindex="-1"></a>         <span class="at">correct =</span> both_positive <span class="sc">+</span> both_negative) <span class="sc">%&gt;%</span></span>
<span id="cb72-730"><a href="#cb72-730" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">sumCorrect =</span> <span class="fu">sum</span>(correct)) <span class="sc">/</span> <span class="fu">nrow</span>(df21)</span>
<span id="cb72-731"><a href="#cb72-731" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-732"><a href="#cb72-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-733"><a href="#cb72-733" aria-hidden="true" tabindex="-1"></a>Slightly worse, but basically the same. Well, while I'm at it, I'll look at predictions, actual MOV, and the spread.</span>
<span id="cb72-734"><a href="#cb72-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-737"><a href="#cb72-737" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-738"><a href="#cb72-738" aria-hidden="true" tabindex="-1"></a>last_rf_fit <span class="sc">%&gt;%</span> </span>
<span id="cb72-739"><a href="#cb72-739" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-740"><a href="#cb72-740" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">spread_team =</span> test_data<span class="sc">$</span>spread_team) <span class="sc">%&gt;%</span></span>
<span id="cb72-741"><a href="#cb72-741" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">`</span><span class="at">.pred</span><span class="st">`</span>, MOV_actual_team, spread_team) <span class="sc">%&gt;%</span></span>
<span id="cb72-742"><a href="#cb72-742" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span>
<span id="cb72-743"><a href="#cb72-743" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-744"><a href="#cb72-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-745"><a href="#cb72-745" aria-hidden="true" tabindex="-1"></a>The predictions don't compare well, that's for sure. Well, this may partially be the result of replacing NAs with 0s earlier, and I suspect I just have too many garbage predictors in the model. The authors were getting a head to head accuracy in the low 70's, so there's definite room for improvement. I'll drive on anyway and look at teams that did a lot better or worse than predicted. Here I show only the extreme two ends. I plot (predicted - actual), so positive values are for teams that I predicted would win by a much larger margin than they actually did.</span>
<span id="cb72-746"><a href="#cb72-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-749"><a href="#cb72-749" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-750"><a href="#cb72-750" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig.height: 8</span></span>
<span id="cb72-751"><a href="#cb72-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-752"><a href="#cb72-752" aria-hidden="true" tabindex="-1"></a>last_rf_fit <span class="sc">%&gt;%</span> </span>
<span id="cb72-753"><a href="#cb72-753" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-754"><a href="#cb72-754" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">team =</span> df21<span class="sc">$</span>school_team,</span>
<span id="cb72-755"><a href="#cb72-755" aria-hidden="true" tabindex="-1"></a>         <span class="at">opp =</span> df21<span class="sc">$</span>school_opponent,</span>
<span id="cb72-756"><a href="#cb72-756" aria-hidden="true" tabindex="-1"></a>         <span class="at">spread_team =</span> df21<span class="sc">$</span>spread_team) <span class="sc">%&gt;%</span></span>
<span id="cb72-757"><a href="#cb72-757" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(team) <span class="sc">%&gt;%</span></span>
<span id="cb72-758"><a href="#cb72-758" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">meanDiff =</span> <span class="fu">mean</span>(<span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">-</span> MOV_actual_team)) <span class="sc">%&gt;%</span></span>
<span id="cb72-759"><a href="#cb72-759" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(meanDiff) <span class="sc">%&gt;%</span></span>
<span id="cb72-760"><a href="#cb72-760" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">team =</span> forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(team, meanDiff)) <span class="sc">%&gt;%</span></span>
<span id="cb72-761"><a href="#cb72-761" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">abs</span>(meanDiff) <span class="sc">&gt;</span> <span class="dv">7</span>) <span class="sc">%&gt;%</span></span>
<span id="cb72-762"><a href="#cb72-762" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb72-763"><a href="#cb72-763" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">x=</span>team, <span class="at">y=</span>meanDiff)) <span class="sc">+</span></span>
<span id="cb72-764"><a href="#cb72-764" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb72-765"><a href="#cb72-765" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb72-766"><a href="#cb72-766" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-767"><a href="#cb72-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-768"><a href="#cb72-768" aria-hidden="true" tabindex="-1"></a>Finally, I'll look at the proportion of games I correctly predicted over time. I'm curious if I do poorly early in the season and then improve, or if it's relatively consistent. Quick note: the first time I made this plot, I was getting 100% accuracy in the early weeks, and then it got steadily worse over time. That was a giant red flag, and after thoroughly scrubbing my code, I found an error where some actual results had snuck into the test data. I'm glad I caught that!</span>
<span id="cb72-769"><a href="#cb72-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-772"><a href="#cb72-772" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-773"><a href="#cb72-773" aria-hidden="true" tabindex="-1"></a>last_rf_fit <span class="sc">%&gt;%</span></span>
<span id="cb72-774"><a href="#cb72-774" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-775"><a href="#cb72-775" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(test_data <span class="sc">%&gt;%</span> </span>
<span id="cb72-776"><a href="#cb72-776" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(id, week, school_team, school_opponent) <span class="sc">%&gt;%</span> </span>
<span id="cb72-777"><a href="#cb72-777" aria-hidden="true" tabindex="-1"></a>              <span class="fu">rename</span>(<span class="st">"ID"</span> <span class="ot">=</span> <span class="st">"id"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb72-778"><a href="#cb72-778" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">incorrect =</span> <span class="fu">case_when</span>(</span>
<span id="cb72-779"><a href="#cb72-779" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb72-780"><a href="#cb72-780" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb72-781"><a href="#cb72-781" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">0</span>), </span>
<span id="cb72-782"><a href="#cb72-782" aria-hidden="true" tabindex="-1"></a>    <span class="at">correct=</span> <span class="fu">case_when</span>(</span>
<span id="cb72-783"><a href="#cb72-783" aria-hidden="true" tabindex="-1"></a>      <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb72-784"><a href="#cb72-784" aria-hidden="true" tabindex="-1"></a>      <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb72-785"><a href="#cb72-785" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb72-786"><a href="#cb72-786" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(week) <span class="sc">%&gt;%</span></span>
<span id="cb72-787"><a href="#cb72-787" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">sumIncorrect =</span> <span class="fu">sum</span>(incorrect),</span>
<span id="cb72-788"><a href="#cb72-788" aria-hidden="true" tabindex="-1"></a>            <span class="at">sumCorrect =</span> <span class="fu">sum</span>(correct),</span>
<span id="cb72-789"><a href="#cb72-789" aria-hidden="true" tabindex="-1"></a>            <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb72-790"><a href="#cb72-790" aria-hidden="true" tabindex="-1"></a>            <span class="at">proportionCorrect =</span> sumCorrect <span class="sc">/</span> n) <span class="sc">%&gt;%</span></span>
<span id="cb72-791"><a href="#cb72-791" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb72-792"><a href="#cb72-792" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">x=</span>week, <span class="at">y=</span>proportionCorrect)) <span class="sc">+</span></span>
<span id="cb72-793"><a href="#cb72-793" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb72-794"><a href="#cb72-794" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-795"><a href="#cb72-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-796"><a href="#cb72-796" aria-hidden="true" tabindex="-1"></a>Looks reasonably consistent, so at least I know I fixed that error.</span>
<span id="cb72-797"><a href="#cb72-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-798"><a href="#cb72-798" aria-hidden="true" tabindex="-1"></a><span class="fu">## Gradient Boost Machine Model</span></span>
<span id="cb72-799"><a href="#cb72-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-800"><a href="#cb72-800" aria-hidden="true" tabindex="-1"></a>I don't have much hope that this will be any better than the last two models, but it'll give me another rep with the tidymodels workflow. Note that I'm using the random forest recipe (<span class="in">`rf_rec`</span>). In hindsight, the recipe is model agnostic, so I should have just called it something generic to avoid confusion.</span>
<span id="cb72-801"><a href="#cb72-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-804"><a href="#cb72-804" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-805"><a href="#cb72-805" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">345</span>)</span>
<span id="cb72-806"><a href="#cb72-806" aria-hidden="true" tabindex="-1"></a>gbm_mod <span class="ot">&lt;-</span></span>
<span id="cb72-807"><a href="#cb72-807" aria-hidden="true" tabindex="-1"></a>  <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="dv">1000</span>, </span>
<span id="cb72-808"><a href="#cb72-808" aria-hidden="true" tabindex="-1"></a>             <span class="at">tree_depth =</span> <span class="fu">tune</span>(), </span>
<span id="cb72-809"><a href="#cb72-809" aria-hidden="true" tabindex="-1"></a>             <span class="at">min_n =</span> <span class="fu">tune</span>(), </span>
<span id="cb72-810"><a href="#cb72-810" aria-hidden="true" tabindex="-1"></a>             <span class="at">loss_reduction =</span> <span class="fu">tune</span>(),</span>
<span id="cb72-811"><a href="#cb72-811" aria-hidden="true" tabindex="-1"></a>             <span class="at">sample_size =</span> <span class="fu">tune</span>(), </span>
<span id="cb72-812"><a href="#cb72-812" aria-hidden="true" tabindex="-1"></a>             <span class="at">mtry =</span> <span class="fu">tune</span>(),</span>
<span id="cb72-813"><a href="#cb72-813" aria-hidden="true" tabindex="-1"></a>             <span class="at">learn_rate =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb72-814"><a href="#cb72-814" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>, <span class="at">num.threads =</span> cores) <span class="sc">%&gt;%</span></span>
<span id="cb72-815"><a href="#cb72-815" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb72-816"><a href="#cb72-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-817"><a href="#cb72-817" aria-hidden="true" tabindex="-1"></a>gbm_wflow <span class="ot">&lt;-</span> </span>
<span id="cb72-818"><a href="#cb72-818" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb72-819"><a href="#cb72-819" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(gbm_mod) <span class="sc">%&gt;%</span> </span>
<span id="cb72-820"><a href="#cb72-820" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(rf_rec)</span>
<span id="cb72-821"><a href="#cb72-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-822"><a href="#cb72-822" aria-hidden="true" tabindex="-1"></a>gbm_fit <span class="ot">&lt;-</span> </span>
<span id="cb72-823"><a href="#cb72-823" aria-hidden="true" tabindex="-1"></a>  gbm_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb72-824"><a href="#cb72-824" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(<span class="at">grid =</span> <span class="dv">25</span>,</span>
<span id="cb72-825"><a href="#cb72-825" aria-hidden="true" tabindex="-1"></a>            <span class="at">control =</span> <span class="fu">control_grid</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>),</span>
<span id="cb72-826"><a href="#cb72-826" aria-hidden="true" tabindex="-1"></a>            <span class="at">resamples =</span> folds)</span>
<span id="cb72-827"><a href="#cb72-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-828"><a href="#cb72-828" aria-hidden="true" tabindex="-1"></a>gbm_fit <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>)</span>
<span id="cb72-829"><a href="#cb72-829" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-830"><a href="#cb72-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-831"><a href="#cb72-831" aria-hidden="true" tabindex="-1"></a>Then the final fit.</span>
<span id="cb72-832"><a href="#cb72-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-835"><a href="#cb72-835" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-836"><a href="#cb72-836" aria-hidden="true" tabindex="-1"></a>gbm_best <span class="ot">&lt;-</span> </span>
<span id="cb72-837"><a href="#cb72-837" aria-hidden="true" tabindex="-1"></a>  gbm_fit <span class="sc">%&gt;%</span> </span>
<span id="cb72-838"><a href="#cb72-838" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select_best</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>)</span>
<span id="cb72-839"><a href="#cb72-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-840"><a href="#cb72-840" aria-hidden="true" tabindex="-1"></a><span class="co"># final fit</span></span>
<span id="cb72-841"><a href="#cb72-841" aria-hidden="true" tabindex="-1"></a>last_gbm_mod <span class="ot">&lt;-</span> </span>
<span id="cb72-842"><a href="#cb72-842" aria-hidden="true" tabindex="-1"></a>  <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="dv">1000</span>, </span>
<span id="cb72-843"><a href="#cb72-843" aria-hidden="true" tabindex="-1"></a>              <span class="at">tree_depth =</span> gbm_best <span class="sc">%&gt;%</span> .<span class="sc">$</span>tree_depth, </span>
<span id="cb72-844"><a href="#cb72-844" aria-hidden="true" tabindex="-1"></a>              <span class="at">min_n =</span> gbm_best <span class="sc">%&gt;%</span> .<span class="sc">$</span>min_n, </span>
<span id="cb72-845"><a href="#cb72-845" aria-hidden="true" tabindex="-1"></a>              <span class="at">loss_reduction =</span> gbm_best <span class="sc">%&gt;%</span> .<span class="sc">$</span>loss_reduction,</span>
<span id="cb72-846"><a href="#cb72-846" aria-hidden="true" tabindex="-1"></a>              <span class="at">sample_size =</span> gbm_best <span class="sc">%&gt;%</span> .<span class="sc">$</span>sample_size, </span>
<span id="cb72-847"><a href="#cb72-847" aria-hidden="true" tabindex="-1"></a>              <span class="at">mtry =</span> gbm_best <span class="sc">%&gt;%</span> .<span class="sc">$</span>mtry,</span>
<span id="cb72-848"><a href="#cb72-848" aria-hidden="true" tabindex="-1"></a>              <span class="at">learn_rate =</span> gbm_best <span class="sc">%&gt;%</span> .<span class="sc">$</span>learn_rate) <span class="sc">%&gt;%</span> </span>
<span id="cb72-849"><a href="#cb72-849" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>, <span class="at">num.threads =</span> cores) <span class="sc">%&gt;%</span> </span>
<span id="cb72-850"><a href="#cb72-850" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb72-851"><a href="#cb72-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-852"><a href="#cb72-852" aria-hidden="true" tabindex="-1"></a><span class="co"># the last workflow</span></span>
<span id="cb72-853"><a href="#cb72-853" aria-hidden="true" tabindex="-1"></a>last_gbm_workflow <span class="ot">&lt;-</span> </span>
<span id="cb72-854"><a href="#cb72-854" aria-hidden="true" tabindex="-1"></a>  gbm_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb72-855"><a href="#cb72-855" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_model</span>(last_gbm_mod)</span>
<span id="cb72-856"><a href="#cb72-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-857"><a href="#cb72-857" aria-hidden="true" tabindex="-1"></a><span class="co"># the last fit</span></span>
<span id="cb72-858"><a href="#cb72-858" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">345</span>)</span>
<span id="cb72-859"><a href="#cb72-859" aria-hidden="true" tabindex="-1"></a>last_gbm_fit <span class="ot">&lt;-</span> </span>
<span id="cb72-860"><a href="#cb72-860" aria-hidden="true" tabindex="-1"></a>  last_gbm_workflow <span class="sc">%&gt;%</span> </span>
<span id="cb72-861"><a href="#cb72-861" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(data_split)</span>
<span id="cb72-862"><a href="#cb72-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-863"><a href="#cb72-863" aria-hidden="true" tabindex="-1"></a><span class="co"># since I used data_split above, this includes the test data set</span></span>
<span id="cb72-864"><a href="#cb72-864" aria-hidden="true" tabindex="-1"></a>last_gbm_fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span>
<span id="cb72-865"><a href="#cb72-865" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-866"><a href="#cb72-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-867"><a href="#cb72-867" aria-hidden="true" tabindex="-1"></a>More of the same, of course, and now variable importance.</span>
<span id="cb72-868"><a href="#cb72-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-871"><a href="#cb72-871" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-872"><a href="#cb72-872" aria-hidden="true" tabindex="-1"></a>last_gbm_fit <span class="sc">%&gt;%</span> </span>
<span id="cb72-873"><a href="#cb72-873" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">".workflow"</span>, <span class="dv">1</span>) <span class="sc">%&gt;%</span>   </span>
<span id="cb72-874"><a href="#cb72-874" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb72-875"><a href="#cb72-875" aria-hidden="true" tabindex="-1"></a>  vip<span class="sc">::</span><span class="fu">vip</span>(<span class="at">num_features =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb72-876"><a href="#cb72-876" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb72-877"><a href="#cb72-877" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-878"><a href="#cb72-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-879"><a href="#cb72-879" aria-hidden="true" tabindex="-1"></a>Yep, and now accuracy.</span>
<span id="cb72-880"><a href="#cb72-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-883"><a href="#cb72-883" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-884"><a href="#cb72-884" aria-hidden="true" tabindex="-1"></a>last_gbm_fit <span class="sc">%&gt;%</span> </span>
<span id="cb72-885"><a href="#cb72-885" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-886"><a href="#cb72-886" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">both_positive =</span> <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb72-887"><a href="#cb72-887" aria-hidden="true" tabindex="-1"></a>         <span class="at">both_negative =</span> <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> MOV_actual_team <span class="sc">&lt;</span> <span class="dv">0</span>,</span>
<span id="cb72-888"><a href="#cb72-888" aria-hidden="true" tabindex="-1"></a>         <span class="at">correct =</span> both_positive <span class="sc">+</span> both_negative) <span class="sc">%&gt;%</span></span>
<span id="cb72-889"><a href="#cb72-889" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">sumCorrect =</span> <span class="fu">sum</span>(correct)) <span class="sc">/</span> <span class="fu">nrow</span>(df21)</span>
<span id="cb72-890"><a href="#cb72-890" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-891"><a href="#cb72-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-892"><a href="#cb72-892" aria-hidden="true" tabindex="-1"></a>About the same as the others, so no surprise. Well, aside from demonstrating the garbage-in garbage-out principle, it was interesting to dip my toe in the waters of predictive modeling of sports events. As a bonus, I got some practice with tidymodels, which was great.</span>
<span id="cb72-893"><a href="#cb72-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-894"><a href="#cb72-894" aria-hidden="true" tabindex="-1"></a>At this point in my weekend modeling, I paused and thought about what might have gone wrong and what might have gone right in the methodology I used. I also read <span class="co">[</span><span class="ot">this post</span><span class="co">](https://blog.collegefootballdata.com/talking-tech-building-an-artifical-neural-network-to/)</span> about using a neural net to predict college football games. I tend to shy away from neural nets for regression problems. In my experience, they're a pain to set up, take a long time to train, and I really haven't seen them outperform the simpler, faster, and interpretable tree-based models.</span>
<span id="cb72-895"><a href="#cb72-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-896"><a href="#cb72-896" aria-hidden="true" tabindex="-1"></a>Then I stumbled across <span class="co">[</span><span class="ot">this blog post from RStudio</span><span class="co">](https://blogs.rstudio.com/ai/posts/2021-02-11-tabnet/)</span> that demonstrated the use of <span class="in">`tabnet`</span>, a neural net model developed by Google specifically for tabular data that incorporates some of the processes in tree-based models to improve interpretability. In the <span class="co">[</span><span class="ot">original paper</span><span class="co">](https://arxiv.org/abs/1908.07442)</span>, the authors also demonstrated that <span class="in">`tabnet`</span> was on par, and often better, than the current go-to models like <span class="in">`xgboost`</span>. So, time to give it a whack.</span>
<span id="cb72-897"><a href="#cb72-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-898"><a href="#cb72-898" aria-hidden="true" tabindex="-1"></a><span class="fu">## Neural Net Model</span></span>
<span id="cb72-899"><a href="#cb72-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-900"><a href="#cb72-900" aria-hidden="true" tabindex="-1"></a>As I mentioned, I'm not too happy with the mess of predictors I've been using so far. Time for a fresh start using just a few predictors similar to the CollegeFootballData.com blog I just mentioned. I have lots of variables in my environment right now, so first I'm going to purge.</span>
<span id="cb72-901"><a href="#cb72-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-904"><a href="#cb72-904" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-905"><a href="#cb72-905" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb72-906"><a href="#cb72-906" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-907"><a href="#cb72-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-908"><a href="#cb72-908" aria-hidden="true" tabindex="-1"></a>I'll load some of the same data sets from disk that I used earlier and filter non-FBS games as before. However, this time, I'm only going to keep a few columns: id, school, conference, homeAway, points, week, and year.</span>
<span id="cb72-909"><a href="#cb72-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-912"><a href="#cb72-912" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-913"><a href="#cb72-913" aria-hidden="true" tabindex="-1"></a>gs <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"gameStats_full.RData"</span>)</span>
<span id="cb72-914"><a href="#cb72-914" aria-hidden="true" tabindex="-1"></a>gs <span class="ot">&lt;-</span> <span class="fu">type.convert</span>(gs, <span class="at">as.is =</span> <span class="cn">TRUE</span>)</span>
<span id="cb72-915"><a href="#cb72-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-916"><a href="#cb72-916" aria-hidden="true" tabindex="-1"></a><span class="co"># get the ID of non-FBS games</span></span>
<span id="cb72-917"><a href="#cb72-917" aria-hidden="true" tabindex="-1"></a>fbs <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"fbs_teams.RData"</span>)</span>
<span id="cb72-918"><a href="#cb72-918" aria-hidden="true" tabindex="-1"></a>fcsIDs <span class="ot">&lt;-</span> gs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>school <span class="sc">%in%</span> (fbs <span class="sc">%&gt;%</span> .<span class="sc">$</span>school)) <span class="sc">%&gt;%</span> .<span class="sc">$</span>id</span>
<span id="cb72-919"><a href="#cb72-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-920"><a href="#cb72-920" aria-hidden="true" tabindex="-1"></a><span class="co"># filter</span></span>
<span id="cb72-921"><a href="#cb72-921" aria-hidden="true" tabindex="-1"></a>gs <span class="ot">&lt;-</span> </span>
<span id="cb72-922"><a href="#cb72-922" aria-hidden="true" tabindex="-1"></a>  gs <span class="sc">%&gt;%</span></span>
<span id="cb72-923"><a href="#cb72-923" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>id <span class="sc">%in%</span> fcsIDs) <span class="sc">%&gt;%</span></span>
<span id="cb72-924"><a href="#cb72-924" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, school, conference, homeAway, points, week, year)</span>
<span id="cb72-925"><a href="#cb72-925" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-926"><a href="#cb72-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-927"><a href="#cb72-927" aria-hidden="true" tabindex="-1"></a>I'll create home and away dataframes again as earlier and add the Elo and neutral site data, and then recombine it all into a dataframe called <span class="in">`pregame`</span>. I'll calculate the margin of victory (mov) here, too. I noticed one of the away conference names was missing but was able to track down that it was a FBS independent team.</span>
<span id="cb72-928"><a href="#cb72-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-931"><a href="#cb72-931" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-932"><a href="#cb72-932" aria-hidden="true" tabindex="-1"></a>home <span class="ot">&lt;-</span> gs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(homeAway <span class="sc">==</span> <span class="st">"home"</span>)</span>
<span id="cb72-933"><a href="#cb72-933" aria-hidden="true" tabindex="-1"></a>away <span class="ot">&lt;-</span> gs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(homeAway <span class="sc">==</span> <span class="st">"away"</span>)</span>
<span id="cb72-934"><a href="#cb72-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-935"><a href="#cb72-935" aria-hidden="true" tabindex="-1"></a><span class="co"># get pre-game Elo and neutral vield data</span></span>
<span id="cb72-936"><a href="#cb72-936" aria-hidden="true" tabindex="-1"></a>eloSite <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"eloSite.RData"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb72-937"><a href="#cb72-937" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>id <span class="sc">%in%</span> (fcsIDs)) <span class="sc">%&gt;%</span> </span>
<span id="cb72-938"><a href="#cb72-938" aria-hidden="true" tabindex="-1"></a>  tidyjson<span class="sc">::</span><span class="fu">as_tibble</span>(eloSite)</span>
<span id="cb72-939"><a href="#cb72-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-940"><a href="#cb72-940" aria-hidden="true" tabindex="-1"></a><span class="co"># get pre-game spread</span></span>
<span id="cb72-941"><a href="#cb72-941" aria-hidden="true" tabindex="-1"></a>spread <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"spread.RData"</span>)</span>
<span id="cb72-942"><a href="#cb72-942" aria-hidden="true" tabindex="-1"></a>spread <span class="ot">&lt;-</span> spread <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>id <span class="sc">%in%</span> (fcsIDs))</span>
<span id="cb72-943"><a href="#cb72-943" aria-hidden="true" tabindex="-1"></a>spread <span class="ot">&lt;-</span> spread <span class="sc">%&gt;%</span> <span class="fu">drop_na</span>()</span>
<span id="cb72-944"><a href="#cb72-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-945"><a href="#cb72-945" aria-hidden="true" tabindex="-1"></a>pregame <span class="ot">&lt;-</span> spread <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(eloSite, <span class="at">by =</span> <span class="st">"id"</span>)</span>
<span id="cb72-946"><a href="#cb72-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-947"><a href="#cb72-947" aria-hidden="true" tabindex="-1"></a>pregame <span class="ot">&lt;-</span> </span>
<span id="cb72-948"><a href="#cb72-948" aria-hidden="true" tabindex="-1"></a>  pregame <span class="sc">%&gt;%</span></span>
<span id="cb72-949"><a href="#cb72-949" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(home <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>school, <span class="sc">-</span>homeAway), <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb72-950"><a href="#cb72-950" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="st">"home_conference"</span> <span class="ot">=</span> <span class="st">"conference"</span>, <span class="st">"home_points"</span> <span class="ot">=</span> <span class="st">"points"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb72-951"><a href="#cb72-951" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(away <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>school, <span class="sc">-</span>year, <span class="sc">-</span>homeAway, <span class="sc">-</span>week), <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb72-952"><a href="#cb72-952" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="st">"away_conference"</span> <span class="ot">=</span> <span class="st">"conference"</span>, <span class="st">"away_points"</span> <span class="ot">=</span> <span class="st">"points"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb72-953"><a href="#cb72-953" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mov =</span> home_points <span class="sc">-</span> away_points) <span class="sc">%&gt;%</span></span>
<span id="cb72-954"><a href="#cb72-954" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>home_points, <span class="sc">-</span>away_points) <span class="sc">%&gt;%</span> </span>
<span id="cb72-955"><a href="#cb72-955" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb72-956"><a href="#cb72-956" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">away_conference =</span> <span class="fu">replace_na</span>(away_conference, <span class="st">"FBS Independents"</span>))</span>
<span id="cb72-957"><a href="#cb72-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-958"><a href="#cb72-958" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pregame)</span>
<span id="cb72-959"><a href="#cb72-959" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-960"><a href="#cb72-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-961"><a href="#cb72-961" aria-hidden="true" tabindex="-1"></a>I'm only working with 12 columns this time - well, 9 if you don't count id, week, and year. I won't use those for training or testing. They're just to keep track of things. So it's down to team, conference, spread, Elo, and the home field advantage thing, which I'll address next.</span>
<span id="cb72-962"><a href="#cb72-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-963"><a href="#cb72-963" aria-hidden="true" tabindex="-1"></a>Recall my first attempt was complicated and involved looping over game IDs. I came up with a much better way this time. I randomly select game IDs, then apply the HFA indicator in place. Way faster and a lot clearer what I'm doing.</span>
<span id="cb72-964"><a href="#cb72-964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-967"><a href="#cb72-967" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-968"><a href="#cb72-968" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb72-969"><a href="#cb72-969" aria-hidden="true" tabindex="-1"></a>idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(pregame), <span class="fu">trunc</span>(<span class="fu">nrow</span>(pregame) <span class="sc">/</span> <span class="dv">2</span>))</span>
<span id="cb72-970"><a href="#cb72-970" aria-hidden="true" tabindex="-1"></a>pregame<span class="sc">$</span>HFA <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb72-971"><a href="#cb72-971" aria-hidden="true" tabindex="-1"></a>pregame[idx, <span class="st">"HFA"</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb72-972"><a href="#cb72-972" aria-hidden="true" tabindex="-1"></a>pregame[<span class="sc">-</span>idx, <span class="st">"HFA"</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb72-973"><a href="#cb72-973" aria-hidden="true" tabindex="-1"></a>pregame[<span class="sc">-</span>idx, <span class="st">"mov"</span>] <span class="ot">&lt;-</span> pregame[<span class="sc">-</span>idx, <span class="st">"mov"</span>]</span>
<span id="cb72-974"><a href="#cb72-974" aria-hidden="true" tabindex="-1"></a>pregame <span class="ot">&lt;-</span> pregame <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">HFA =</span> <span class="fu">ifelse</span>(neutral_site, <span class="dv">0</span>, HFA))</span>
<span id="cb72-975"><a href="#cb72-975" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-976"><a href="#cb72-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-977"><a href="#cb72-977" aria-hidden="true" tabindex="-1"></a>The last thing to do is turn the team names into factors.</span>
<span id="cb72-978"><a href="#cb72-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-981"><a href="#cb72-981" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-982"><a href="#cb72-982" aria-hidden="true" tabindex="-1"></a>pregame <span class="ot">&lt;-</span></span>
<span id="cb72-983"><a href="#cb72-983" aria-hidden="true" tabindex="-1"></a>  pregame <span class="sc">%&gt;%</span></span>
<span id="cb72-984"><a href="#cb72-984" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">home_team =</span> <span class="fu">factor</span>(home_team),</span>
<span id="cb72-985"><a href="#cb72-985" aria-hidden="true" tabindex="-1"></a>         <span class="at">away_team =</span> <span class="fu">factor</span>(away_team))</span>
<span id="cb72-986"><a href="#cb72-986" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-987"><a href="#cb72-987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-988"><a href="#cb72-988" aria-hidden="true" tabindex="-1"></a>That's it! I'm ready to split the data in the training, test, and validation sets and get to model building.</span>
<span id="cb72-989"><a href="#cb72-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-992"><a href="#cb72-992" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-993"><a href="#cb72-993" aria-hidden="true" tabindex="-1"></a>data_split <span class="ot">&lt;-</span> </span>
<span id="cb72-994"><a href="#cb72-994" aria-hidden="true" tabindex="-1"></a>  <span class="fu">initial_time_split</span>(</span>
<span id="cb72-995"><a href="#cb72-995" aria-hidden="true" tabindex="-1"></a>    pregame <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>id, <span class="sc">-</span>year, <span class="sc">-</span>neutral_site, <span class="sc">-</span>week),</span>
<span id="cb72-996"><a href="#cb72-996" aria-hidden="true" tabindex="-1"></a>    <span class="at">prop =</span> <span class="dv">2656</span><span class="sc">/</span><span class="dv">3391</span>)</span>
<span id="cb72-997"><a href="#cb72-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-998"><a href="#cb72-998" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(data_split)</span>
<span id="cb72-999"><a href="#cb72-999" aria-hidden="true" tabindex="-1"></a>test_data  <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_split)</span>
<span id="cb72-1000"><a href="#cb72-1000" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">234</span>)</span>
<span id="cb72-1001"><a href="#cb72-1001" aria-hidden="true" tabindex="-1"></a>val_set <span class="ot">&lt;-</span> <span class="fu">validation_split</span>(train_data, <span class="at">prop =</span> <span class="fl">0.80</span>)</span>
<span id="cb72-1002"><a href="#cb72-1002" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1003"><a href="#cb72-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1004"><a href="#cb72-1004" aria-hidden="true" tabindex="-1"></a>There are many hyperparameters to tune, and I'll exclude epochs, batch_size, and virtual_batch_size just to speed this part up.</span>
<span id="cb72-1005"><a href="#cb72-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1006"><a href="#cb72-1006" aria-hidden="true" tabindex="-1"></a><span class="in">```{r message=FALSE, warning=FALSE}</span></span>
<span id="cb72-1007"><a href="#cb72-1007" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tabnet)</span>
<span id="cb72-1008"><a href="#cb72-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1009"><a href="#cb72-1009" aria-hidden="true" tabindex="-1"></a>nn_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(mov <span class="sc">~</span> ., train_data) <span class="sc">%&gt;%</span></span>
<span id="cb72-1010"><a href="#cb72-1010" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric</span>(), <span class="sc">-</span><span class="fu">all_outcomes</span>())</span>
<span id="cb72-1011"><a href="#cb72-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1012"><a href="#cb72-1012" aria-hidden="true" tabindex="-1"></a>nn_mod <span class="ot">&lt;-</span></span>
<span id="cb72-1013"><a href="#cb72-1013" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabnet</span>(<span class="at">epochs =</span> <span class="dv">5</span>, </span>
<span id="cb72-1014"><a href="#cb72-1014" aria-hidden="true" tabindex="-1"></a>         <span class="at">batch_size =</span> <span class="dv">256</span>, </span>
<span id="cb72-1015"><a href="#cb72-1015" aria-hidden="true" tabindex="-1"></a>         <span class="at">decision_width =</span> <span class="fu">tune</span>(), </span>
<span id="cb72-1016"><a href="#cb72-1016" aria-hidden="true" tabindex="-1"></a>         <span class="at">attention_width =</span> <span class="fu">tune</span>(),</span>
<span id="cb72-1017"><a href="#cb72-1017" aria-hidden="true" tabindex="-1"></a>         <span class="at">num_steps =</span> <span class="fu">tune</span>(), </span>
<span id="cb72-1018"><a href="#cb72-1018" aria-hidden="true" tabindex="-1"></a>         <span class="at">penalty =</span> <span class="fu">tune</span>(), </span>
<span id="cb72-1019"><a href="#cb72-1019" aria-hidden="true" tabindex="-1"></a>         <span class="at">virtual_batch_size =</span> <span class="dv">64</span>, </span>
<span id="cb72-1020"><a href="#cb72-1020" aria-hidden="true" tabindex="-1"></a>         <span class="at">momentum =</span> <span class="fu">tune</span>(),</span>
<span id="cb72-1021"><a href="#cb72-1021" aria-hidden="true" tabindex="-1"></a>         <span class="at">feature_reusage =</span> <span class="fu">tune</span>(), </span>
<span id="cb72-1022"><a href="#cb72-1022" aria-hidden="true" tabindex="-1"></a>         <span class="at">learn_rate =</span> <span class="fu">tune</span>()</span>
<span id="cb72-1023"><a href="#cb72-1023" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb72-1024"><a href="#cb72-1024" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"torch"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb72-1025"><a href="#cb72-1025" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb72-1026"><a href="#cb72-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1027"><a href="#cb72-1027" aria-hidden="true" tabindex="-1"></a>nn_wf <span class="ot">&lt;-</span> </span>
<span id="cb72-1028"><a href="#cb72-1028" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-1029"><a href="#cb72-1029" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(nn_mod) <span class="sc">%&gt;%</span></span>
<span id="cb72-1030"><a href="#cb72-1030" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(nn_rec)</span>
<span id="cb72-1031"><a href="#cb72-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1032"><a href="#cb72-1032" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb72-1033"><a href="#cb72-1033" aria-hidden="true" tabindex="-1"></a>nn_fit <span class="ot">&lt;-</span></span>
<span id="cb72-1034"><a href="#cb72-1034" aria-hidden="true" tabindex="-1"></a>  nn_wf <span class="sc">%&gt;%</span></span>
<span id="cb72-1035"><a href="#cb72-1035" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(val_set,</span>
<span id="cb72-1036"><a href="#cb72-1036" aria-hidden="true" tabindex="-1"></a>            <span class="at">grid =</span> <span class="dv">50</span>,</span>
<span id="cb72-1037"><a href="#cb72-1037" aria-hidden="true" tabindex="-1"></a>            <span class="at">control =</span> <span class="fu">control_grid</span>())</span>
<span id="cb72-1038"><a href="#cb72-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1039"><a href="#cb72-1039" aria-hidden="true" tabindex="-1"></a>nn_fit<span class="sc">$</span>.notes[[<span class="dv">1</span>]]<span class="sc">$</span>note</span>
<span id="cb72-1040"><a href="#cb72-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1041"><a href="#cb72-1041" aria-hidden="true" tabindex="-1"></a>nn_fit <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>)</span>
<span id="cb72-1042"><a href="#cb72-1042" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1043"><a href="#cb72-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1044"><a href="#cb72-1044" aria-hidden="true" tabindex="-1"></a>The final fit.</span>
<span id="cb72-1045"><a href="#cb72-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1048"><a href="#cb72-1048" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1049"><a href="#cb72-1049" aria-hidden="true" tabindex="-1"></a><span class="co"># with tuned parameters</span></span>
<span id="cb72-1050"><a href="#cb72-1050" aria-hidden="true" tabindex="-1"></a>last_nn_mod <span class="ot">&lt;-</span></span>
<span id="cb72-1051"><a href="#cb72-1051" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabnet</span>(<span class="at">epochs =</span> <span class="dv">15</span>, </span>
<span id="cb72-1052"><a href="#cb72-1052" aria-hidden="true" tabindex="-1"></a>         <span class="at">batch_size =</span> <span class="dv">256</span>, </span>
<span id="cb72-1053"><a href="#cb72-1053" aria-hidden="true" tabindex="-1"></a>         <span class="at">decision_width =</span> <span class="dv">15</span>, </span>
<span id="cb72-1054"><a href="#cb72-1054" aria-hidden="true" tabindex="-1"></a>         <span class="at">attention_width =</span> <span class="dv">62</span>,</span>
<span id="cb72-1055"><a href="#cb72-1055" aria-hidden="true" tabindex="-1"></a>         <span class="at">num_steps =</span> <span class="dv">8</span>, </span>
<span id="cb72-1056"><a href="#cb72-1056" aria-hidden="true" tabindex="-1"></a>         <span class="at">penalty =</span> <span class="fl">0.1430669</span>, </span>
<span id="cb72-1057"><a href="#cb72-1057" aria-hidden="true" tabindex="-1"></a>         <span class="at">virtual_batch_size =</span> <span class="dv">64</span>, </span>
<span id="cb72-1058"><a href="#cb72-1058" aria-hidden="true" tabindex="-1"></a>         <span class="at">momentum =</span> <span class="fl">0.194</span>,</span>
<span id="cb72-1059"><a href="#cb72-1059" aria-hidden="true" tabindex="-1"></a>         <span class="at">feature_reusage =</span> <span class="fl">1.148</span>, </span>
<span id="cb72-1060"><a href="#cb72-1060" aria-hidden="true" tabindex="-1"></a>         <span class="at">learn_rate =</span> <span class="fl">0.02395</span></span>
<span id="cb72-1061"><a href="#cb72-1061" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb72-1062"><a href="#cb72-1062" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"torch"</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb72-1063"><a href="#cb72-1063" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb72-1064"><a href="#cb72-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1065"><a href="#cb72-1065" aria-hidden="true" tabindex="-1"></a><span class="co"># the last workflow</span></span>
<span id="cb72-1066"><a href="#cb72-1066" aria-hidden="true" tabindex="-1"></a>last_nn_workflow <span class="ot">&lt;-</span> </span>
<span id="cb72-1067"><a href="#cb72-1067" aria-hidden="true" tabindex="-1"></a>  nn_wf <span class="sc">%&gt;%</span> </span>
<span id="cb72-1068"><a href="#cb72-1068" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_model</span>(last_nn_mod)</span>
<span id="cb72-1069"><a href="#cb72-1069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1070"><a href="#cb72-1070" aria-hidden="true" tabindex="-1"></a><span class="co"># the last fit</span></span>
<span id="cb72-1071"><a href="#cb72-1071" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb72-1072"><a href="#cb72-1072" aria-hidden="true" tabindex="-1"></a>last_nn_fit <span class="ot">&lt;-</span> </span>
<span id="cb72-1073"><a href="#cb72-1073" aria-hidden="true" tabindex="-1"></a>  last_nn_workflow <span class="sc">%&gt;%</span> </span>
<span id="cb72-1074"><a href="#cb72-1074" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(data_split)</span>
<span id="cb72-1075"><a href="#cb72-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1076"><a href="#cb72-1076" aria-hidden="true" tabindex="-1"></a><span class="co"># since I used data_split above, this includes the test data set</span></span>
<span id="cb72-1077"><a href="#cb72-1077" aria-hidden="true" tabindex="-1"></a>last_nn_fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span>
<span id="cb72-1078"><a href="#cb72-1078" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1079"><a href="#cb72-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1080"><a href="#cb72-1080" aria-hidden="true" tabindex="-1"></a>Both metrics are quite a bit higher than what we've seen up to this point, so I'm optimistic this model will perform better.</span>
<span id="cb72-1081"><a href="#cb72-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1084"><a href="#cb72-1084" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1085"><a href="#cb72-1085" aria-hidden="true" tabindex="-1"></a>last_nn_fit <span class="sc">%&gt;%</span> </span>
<span id="cb72-1086"><a href="#cb72-1086" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">".workflow"</span>, <span class="dv">1</span>) <span class="sc">%&gt;%</span>   </span>
<span id="cb72-1087"><a href="#cb72-1087" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb72-1088"><a href="#cb72-1088" aria-hidden="true" tabindex="-1"></a>  vip<span class="sc">::</span><span class="fu">vip</span>() <span class="sc">+</span></span>
<span id="cb72-1089"><a href="#cb72-1089" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb72-1090"><a href="#cb72-1090" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1091"><a href="#cb72-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1092"><a href="#cb72-1092" aria-hidden="true" tabindex="-1"></a>The model relies heavily on the spread, which makes sense since given that it's hard to beat the spread, and I'm considering only a few other predictors.</span>
<span id="cb72-1093"><a href="#cb72-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1096"><a href="#cb72-1096" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1097"><a href="#cb72-1097" aria-hidden="true" tabindex="-1"></a><span class="co"># find percent I predicted the correct winner</span></span>
<span id="cb72-1098"><a href="#cb72-1098" aria-hidden="true" tabindex="-1"></a>last_nn_fit <span class="sc">%&gt;%</span> </span>
<span id="cb72-1099"><a href="#cb72-1099" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-1100"><a href="#cb72-1100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">both_positive =</span> <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> mov <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb72-1101"><a href="#cb72-1101" aria-hidden="true" tabindex="-1"></a>         <span class="at">both_negative =</span> <span class="st">`</span><span class="at">.pred</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> mov <span class="sc">&lt;</span> <span class="dv">0</span>,</span>
<span id="cb72-1102"><a href="#cb72-1102" aria-hidden="true" tabindex="-1"></a>         <span class="at">correct =</span> both_positive <span class="sc">+</span> both_negative) <span class="sc">%&gt;%</span></span>
<span id="cb72-1103"><a href="#cb72-1103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">Correct =</span> <span class="fu">sum</span>(correct)) <span class="sc">/</span> <span class="fu">nrow</span>(test_data)</span>
<span id="cb72-1104"><a href="#cb72-1104" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1105"><a href="#cb72-1105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1106"><a href="#cb72-1106" aria-hidden="true" tabindex="-1"></a>This model correctly predicts 72.3% of the game winners, compared to the \~ 60% for the earlier models. How does that compare to the spread?</span>
<span id="cb72-1107"><a href="#cb72-1107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1110"><a href="#cb72-1110" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1111"><a href="#cb72-1111" aria-hidden="true" tabindex="-1"></a><span class="co"># how does the spread do?</span></span>
<span id="cb72-1112"><a href="#cb72-1112" aria-hidden="true" tabindex="-1"></a>last_nn_fit <span class="sc">%&gt;%</span> </span>
<span id="cb72-1113"><a href="#cb72-1113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-1114"><a href="#cb72-1114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">spread =</span> <span class="sc">-</span>test_data<span class="sc">$</span>home_spread,</span>
<span id="cb72-1115"><a href="#cb72-1115" aria-hidden="true" tabindex="-1"></a>         <span class="at">both_positive =</span> spread <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> mov <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb72-1116"><a href="#cb72-1116" aria-hidden="true" tabindex="-1"></a>         <span class="at">both_negative =</span> spread <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> mov <span class="sc">&lt;</span> <span class="dv">0</span>,</span>
<span id="cb72-1117"><a href="#cb72-1117" aria-hidden="true" tabindex="-1"></a>         <span class="at">correct =</span> both_positive <span class="sc">+</span> both_negative) <span class="sc">%&gt;%</span></span>
<span id="cb72-1118"><a href="#cb72-1118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">Correct =</span> <span class="fu">sum</span>(correct)) <span class="sc">/</span> <span class="fu">nrow</span>(test_data)</span>
<span id="cb72-1119"><a href="#cb72-1119" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1120"><a href="#cb72-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1121"><a href="#cb72-1121" aria-hidden="true" tabindex="-1"></a>Not surprising that it's almost the same. Really at this point, this model basically *is* the spread. Obviously, if we want to beat the spread, we need to improve on this. Let's check the predicted vs. actual raw values.</span>
<span id="cb72-1122"><a href="#cb72-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1125"><a href="#cb72-1125" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1126"><a href="#cb72-1126" aria-hidden="true" tabindex="-1"></a>last_nn_fit <span class="sc">%&gt;%</span> </span>
<span id="cb72-1127"><a href="#cb72-1127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-1128"><a href="#cb72-1128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>)</span>
<span id="cb72-1129"><a href="#cb72-1129" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1130"><a href="#cb72-1130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1131"><a href="#cb72-1131" aria-hidden="true" tabindex="-1"></a>And now let's plot them.</span>
<span id="cb72-1132"><a href="#cb72-1132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1135"><a href="#cb72-1135" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1136"><a href="#cb72-1136" aria-hidden="true" tabindex="-1"></a>last_nn_fit <span class="sc">%&gt;%</span> </span>
<span id="cb72-1137"><a href="#cb72-1137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-1138"><a href="#cb72-1138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb72-1139"><a href="#cb72-1139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb72-1140"><a href="#cb72-1140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span><span class="st">`</span><span class="at">.pred</span><span class="st">`</span>, <span class="at">y=</span>mov)) <span class="sc">+</span></span>
<span id="cb72-1141"><a href="#cb72-1141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb72-1142"><a href="#cb72-1142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"NN Prediction Results"</span>,</span>
<span id="cb72-1143"><a href="#cb72-1143" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Predicted MOV"</span>,</span>
<span id="cb72-1144"><a href="#cb72-1144" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Actual MOV"</span>)</span>
<span id="cb72-1145"><a href="#cb72-1145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1146"><a href="#cb72-1146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1147"><a href="#cb72-1147" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interpretability Plots</span></span>
<span id="cb72-1148"><a href="#cb72-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1149"><a href="#cb72-1149" aria-hidden="true" tabindex="-1"></a>Earlier I mentioned that <span class="in">`tabnet`</span> models were developed to be interpretable. The following plot shows the first 50 games in the test set with games on the x axis. For these games, it seems the Elo scores were the biggest contributors. Interesting. I wonder why we don't see more of an impact from the spread.</span>
<span id="cb72-1150"><a href="#cb72-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1153"><a href="#cb72-1153" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1154"><a href="#cb72-1154" aria-hidden="true" tabindex="-1"></a>exp_fit <span class="ot">&lt;-</span> </span>
<span id="cb72-1155"><a href="#cb72-1155" aria-hidden="true" tabindex="-1"></a>  last_nn_fit <span class="sc">%&gt;%</span> </span>
<span id="cb72-1156"><a href="#cb72-1156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">".workflow"</span>, <span class="dv">1</span>) <span class="sc">%&gt;%</span>   </span>
<span id="cb72-1157"><a href="#cb72-1157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>()</span>
<span id="cb72-1158"><a href="#cb72-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1159"><a href="#cb72-1159" aria-hidden="true" tabindex="-1"></a>ex_fit <span class="ot">&lt;-</span> <span class="fu">tabnet_explain</span>(exp_fit<span class="sc">$</span>fit, test_data[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, ])</span>
<span id="cb72-1160"><a href="#cb72-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1161"><a href="#cb72-1161" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(ex_fit) <span class="sc">+</span></span>
<span id="cb72-1162"><a href="#cb72-1162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Game"</span>, <span class="at">y =</span> <span class="st">"Predictor"</span>)</span>
<span id="cb72-1163"><a href="#cb72-1163" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1164"><a href="#cb72-1164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1165"><a href="#cb72-1165" aria-hidden="true" tabindex="-1"></a>Next, for the same 50 games, we see that different predictors are important in different steps. Here we see that spread comes into play mostly in the 7th and 8th step.</span>
<span id="cb72-1166"><a href="#cb72-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1169"><a href="#cb72-1169" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb72-1170"><a href="#cb72-1170" aria-hidden="true" tabindex="-1"></a><span class="co"># PER-STEP, OBSERVATION-LEVEL FEATURE IMPORTANCES</span></span>
<span id="cb72-1171"><a href="#cb72-1171" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(ex_fit, <span class="at">type=</span><span class="st">"steps"</span>) <span class="sc">+</span></span>
<span id="cb72-1172"><a href="#cb72-1172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Game"</span>, <span class="at">y =</span> <span class="st">"Predictor"</span>)</span>
<span id="cb72-1173"><a href="#cb72-1173" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb72-1174"><a href="#cb72-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1175"><a href="#cb72-1175" aria-hidden="true" tabindex="-1"></a><span class="fu">## Next Steps</span></span>
<span id="cb72-1176"><a href="#cb72-1176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-1177"><a href="#cb72-1177" aria-hidden="true" tabindex="-1"></a>While <span class="in">`tabnet`</span> looks promising, I can't directly compare its performance with the other models in this post because I used a different data set for it. I saw in the tidymodels docs that there's a way to do model comparison using work flow sets, so I'll check that out in another post.</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2022, John King</div>   
  </div>
</footer>



</body></html>