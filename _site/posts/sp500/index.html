<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="John King">
<meta name="dcterms.date" content="2023-01-16">
<meta name="description" content="Train a model to predict future stock prices.">

<title>A Random Walk - Stock Picker</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<link href="../../site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="../../site_libs/pagedtable-1.1/js/pagedtable.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">A Random Walk</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorials" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Tutorials</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tutorials">    
        <li>
    <a class="dropdown-item" href="../../tutorial/slr.html">
 <span class="dropdown-text">Simple Linear Regression</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/lm_assumptions.html">
 <span class="dropdown-text">Linear Model Assumptions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/mlr.html">
 <span class="dropdown-text">Multiple Linear Regression</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/model_selection.html">
 <span class="dropdown-text">Model Selection</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/transform.html">
 <span class="dropdown-text">Variable Transformation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/logistic.html">
 <span class="dropdown-text">Logistic Regression</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/advanced.html">
 <span class="dropdown-text">Advanced Designs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/np_anova.html">
 <span class="dropdown-text">Nonparametric ANOVA</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/gam.html">
 <span class="dropdown-text">Generalized Additive Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/svm.html">
 <span class="dropdown-text">Support Vector Machines</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/random_forest.html">
 <span class="dropdown-text">Random Forests</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorial/nn_regression.html">
 <span class="dropdown-text">Neural Network Regression</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-presentations" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Presentations</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-presentations">    
        <li>
    <a class="dropdown-item" href="../../presentations/doe.html">
 <span class="dropdown-text">Design of Experiments</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jfking50"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#sp-500-historical-stock-prices" id="toc-sp-500-historical-stock-prices" class="nav-link active" data-scroll-target="#sp-500-historical-stock-prices">S&amp;P 500 Historical Stock Prices</a></li>
  <li><a href="#add-predictor-variables" id="toc-add-predictor-variables" class="nav-link" data-scroll-target="#add-predictor-variables">Add Predictor Variables</a></li>
  <li><a href="#hyperparameter-tuning" id="toc-hyperparameter-tuning" class="nav-link" data-scroll-target="#hyperparameter-tuning">Hyperparameter Tuning</a></li>
  <li><a href="#the-final-fit" id="toc-the-final-fit" class="nav-link" data-scroll-target="#the-final-fit">The Final Fit</a></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a>
  <ul class="collapse">
  <li><a href="#simulate-buys-and-sells" id="toc-simulate-buys-and-sells" class="nav-link" data-scroll-target="#simulate-buys-and-sells">Simulate Buys And Sells</a></li>
  <li><a href="#some-plots" id="toc-some-plots" class="nav-link" data-scroll-target="#some-plots">Some Plots</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Stock Picker</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">R</div>
    <div class="quarto-category">predictive modeling</div>
    <div class="quarto-category">machine learning</div>
    <div class="quarto-category">stocks</div>
  </div>
  </div>

<div>
  <div class="description">
    Train a model to predict future stock prices.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>John King </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 16, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>In the Summer of 2022, a colleague shared some scripts he had written to identify stocks that had a high probability of increasing their value 20 days in the future. I don’t want to give away his methodology, so I’ll just say that the scripts fit two models for each individual stock, and there were more than 7,000 stocks. It was an interesting approach, and I worked on just getting the scripts to be more efficient. Eventually, I was able to get the whole process to run about 2.5x faster, which translated into several hours.</p>
<p>He said that he had very good success with the model results, but occasionally would make a bad pick that would tank. Another downside was that each time he was ready to buy a new stock, he’d have to re-run the script to get the most up to date predictions. His approach got me interested in trying a completely different method. It seemed to me that there ought to be some fundamental similarities about stock market behavior that all stocks share, so instead of fitting one model for every stock, how about fitting one model for any stock. To reduce the risk of buying something that would completely tank, I decided to just limit the data to just S&amp;P 500 stocks.</p>
<p>To test that idea out, this script downloads market indices (<code>idx</code>) and S&amp;P 500 stock histories (<code>sp500</code>) since 2007. Stock and index data are joined into one large dataframe <code>df_joined</code>. The data is then ordered and split into training and test sets. A <code>tabnet</code> model is tuned on the training set, and the hyperparameters from the best fit model are used to train the final model. Although the model is trained on S&amp;P 500 stocks only, the stock symbol was not included as a predictor variable, and so the model may be used to predict any stock’s future close price . There is only one predictive model, and it’s a regression model that predicts a stock’s closing price 3 days in the future.</p>
<p>So here we go. First, load some packages.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(quantmod)   <span class="co"># quantitative financial modeling</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)      <span class="co"># for map and reduce functions</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels) <span class="co"># for model fitting</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tabnet)     <span class="co"># the predictive model</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Other packages used but not loaded into the namespace are:</p>
<ul>
<li><code>yfR</code>: a yahoo finance for R package.</li>
<li><code>future</code>: for parallel processing.</li>
<li><code>zoo</code>: for rolling functions.</li>
<li><code>TTR</code>: Technical Trading Rules for stock market indicator functions.</li>
<li><code>vip</code>: for variable importance plots.</li>
<li><code>cvms</code>: for a nice looking confusion matrix.</li>
<li><code>torch</code>: for the <code>tabnet</code> neural network engine.</li>
</ul>
<section id="sp-500-historical-stock-prices" class="level2">
<h2 class="anchored" data-anchor-id="sp-500-historical-stock-prices">S&amp;P 500 Historical Stock Prices</h2>
<p>Since this takes a while, you might want to save it to disk so you can re-use the data without having to re-download everything.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"future::multisession"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>sp500 <span class="ot">&lt;-</span> yfR<span class="sc">::</span><span class="fu">yf_collection_get</span>(<span class="st">"SP500"</span>, </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">do_parallel =</span> <span class="cn">TRUE</span>, </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>                                <span class="at">first_date =</span> <span class="st">"2007-01-01"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"sequential"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">

</div>
<p>Clean up the dataframe and rename columns.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>sp500 <span class="ot">&lt;-</span> sp500 <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>ret_adjusted_prices, <span class="sc">-</span>ret_closing_prices) <span class="sc">%&gt;%</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(<span class="sc">~</span><span class="fu">c</span>(<span class="st">"Symbol"</span>, <span class="st">"Date"</span>, <span class="st">"Open"</span>, <span class="st">"High"</span>, <span class="st">"Low"</span>, <span class="st">"Close"</span>, <span class="st">"Volume"</span>, <span class="st">"Adj_Close"</span> ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="add-predictor-variables" class="level2">
<h2 class="anchored" data-anchor-id="add-predictor-variables">Add Predictor Variables</h2>
<p>Group by stock symbol and do some feature engineering to add predictor variables.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>sp500 <span class="ot">&lt;-</span> sp500 <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Symbol) <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">Date =</span> <span class="fu">as.Date</span>(Date,<span class="at">format=</span><span class="st">"%Y-%m-%d"</span>),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">Day_of_week =</span> <span class="fu">as.factor</span>(<span class="fu">weekdays</span>(Date)),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Month =</span> <span class="fu">as.factor</span>(<span class="fu">month</span>(Date)),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Volatility =</span> (High <span class="sc">-</span> Low) <span class="sc">/</span> Close,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">seven_day_volume_avg =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(Volume, <span class="at">k=</span><span class="dv">7</span>, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">seven_day_volatility_avg =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(Volatility, <span class="at">k=</span><span class="dv">7</span>, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">seven_day_trend =</span> (Close<span class="sc">-</span>(dplyr<span class="sc">::</span><span class="fu">lag</span>(Close,<span class="at">n=</span><span class="dv">7</span>,<span class="at">default =</span> <span class="cn">NA</span>))) <span class="sc">/</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(Close,<span class="at">n=</span><span class="dv">7</span>,<span class="at">default =</span> <span class="cn">NA</span>),</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">seven_day_volume_trend =</span> (seven_day_volume_avg<span class="sc">-</span>(dplyr<span class="sc">::</span><span class="fu">lag</span>(seven_day_volume_avg, <span class="at">n=</span><span class="dv">7</span>, <span class="at">default =</span> <span class="cn">NA</span>))) <span class="sc">/</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>      (dplyr<span class="sc">::</span><span class="fu">lag</span>(seven_day_volume_avg, <span class="at">n=</span><span class="dv">7</span>, <span class="at">default =</span> <span class="cn">NA</span>)),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">local_20_max =</span> zoo<span class="sc">::</span><span class="fu">rollapplyr</span>(Close, <span class="dv">20</span>, max, <span class="at">partial=</span><span class="cn">TRUE</span>),</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">local_20_min =</span> zoo<span class="sc">::</span><span class="fu">rollapplyr</span>(Close, <span class="dv">20</span>, min, <span class="at">partial=</span><span class="cn">TRUE</span>),</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff_from_local_max =</span> Close <span class="sc">-</span> local_20_max,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff_from_local_min =</span> Close <span class="sc">-</span> local_20_min,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">local_range =</span> (local_20_max <span class="sc">-</span> local_20_min) <span class="sc">/</span> Close,</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">trade_vol_5mov_avg =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(Volume, <span class="at">k =</span> <span class="dv">5</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff_ma_20 =</span> Close <span class="sc">-</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(Close, <span class="at">k =</span> <span class="dv">20</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>I iterated on this a while to assess model performance using different additional predictor variables. This is what I eventually settled on.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>sp500 <span class="ot">&lt;-</span> sp500 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">three_day_change =</span> Close <span class="sc">-</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(Close, <span class="at">n=</span><span class="dv">3</span>),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">rel_strength_index =</span> TTR<span class="sc">::</span><span class="fu">RSI</span>(Close, <span class="at">n=</span><span class="dv">14</span>),</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">MACD =</span> TTR<span class="sc">::</span><span class="fu">MACD</span>(Close, <span class="at">nFast=</span><span class="dv">12</span>, <span class="at">nSlow=</span><span class="dv">26</span>, <span class="at">nSig=</span><span class="dv">9</span>, <span class="at">maType=</span><span class="st">"EMA"</span>),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">macd =</span> <span class="fu">unlist</span>(MACD)[, <span class="dv">1</span>],</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">macd_signal =</span> <span class="fu">unlist</span>(MACD)[, <span class="dv">2</span>],</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">macd_above_signal =</span> macd <span class="sc">-</span> macd_signal,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">SO =</span> TTR<span class="sc">::</span><span class="fu">stoch</span>(Close),</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">fastK =</span> <span class="fu">unlist</span>(SO)[, <span class="dv">1</span>],</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">fastD =</span> <span class="fu">unlist</span>(SO)[, <span class="dv">2</span>],</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">slowD =</span> <span class="fu">unlist</span>(SO)[, <span class="dv">3</span>],</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">BB =</span> TTR<span class="sc">::</span><span class="fu">BBands</span>(Close),</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">bb_dn =</span> <span class="fu">unlist</span>(BB)[, <span class="dv">1</span>],</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">bb_mavg =</span> <span class="fu">unlist</span>(BB)[, <span class="dv">2</span>],</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">bb_up =</span> <span class="fu">unlist</span>(BB)[, <span class="dv">3</span>],</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">bb_pctB =</span> <span class="fu">unlist</span>(BB)[, <span class="dv">4</span>],</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> dplyr<span class="sc">::</span><span class="fu">lead</span>(Close, <span class="at">n=</span><span class="dv">3</span>, <span class="at">default =</span> <span class="cn">NA</span>) <span class="co"># the response (or outcome) variable</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>MACD, <span class="sc">-</span>SO, <span class="sc">-</span>BB)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sp500)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["Symbol"],"name":[1],"type":["chr"],"align":["left"]},{"label":["Date"],"name":[2],"type":["date"],"align":["right"]},{"label":["Open"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["High"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["Low"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["Close"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["Volume"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["Adj_Close"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["Day_of_week"],"name":[9],"type":["fct"],"align":["left"]},{"label":["Month"],"name":[10],"type":["fct"],"align":["left"]},{"label":["Volatility"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["seven_day_volume_avg"],"name":[12],"type":["dbl"],"align":["right"]},{"label":["seven_day_volatility_avg"],"name":[13],"type":["dbl"],"align":["right"]},{"label":["seven_day_trend"],"name":[14],"type":["dbl"],"align":["right"]},{"label":["seven_day_volume_trend"],"name":[15],"type":["dbl"],"align":["right"]},{"label":["local_20_max"],"name":[16],"type":["dbl"],"align":["right"]},{"label":["local_20_min"],"name":[17],"type":["dbl"],"align":["right"]},{"label":["diff_from_local_max"],"name":[18],"type":["dbl"],"align":["right"]},{"label":["diff_from_local_min"],"name":[19],"type":["dbl"],"align":["right"]},{"label":["local_range"],"name":[20],"type":["dbl"],"align":["right"]},{"label":["trade_vol_5mov_avg"],"name":[21],"type":["dbl"],"align":["right"]},{"label":["diff_ma_20"],"name":[22],"type":["dbl"],"align":["right"]},{"label":["three_day_change"],"name":[23],"type":["dbl"],"align":["right"]},{"label":["rel_strength_index"],"name":[24],"type":["dbl"],"align":["right"]},{"label":["macd"],"name":[25],"type":["dbl"],"align":["right"]},{"label":["macd_signal"],"name":[26],"type":["dbl"],"align":["right"]},{"label":["macd_above_signal"],"name":[27],"type":["dbl"],"align":["right"]},{"label":["fastK"],"name":[28],"type":["dbl"],"align":["right"]},{"label":["fastD"],"name":[29],"type":["dbl"],"align":["right"]},{"label":["slowD"],"name":[30],"type":["dbl"],"align":["right"]},{"label":["bb_dn"],"name":[31],"type":["dbl"],"align":["right"]},{"label":["bb_mavg"],"name":[32],"type":["dbl"],"align":["right"]},{"label":["bb_up"],"name":[33],"type":["dbl"],"align":["right"]},{"label":["bb_pctB"],"name":[34],"type":["dbl"],"align":["right"]},{"label":["y"],"name":[35],"type":["dbl"],"align":["right"]}],"data":[{"1":"MMM","2":"2007-01-03","3":"77.53","4":"78.85","5":"77.38","6":"78.26","7":"3781500","8":"50.88114","9":"Wednesday","10":"1","11":"0.01878355","12":"NA","13":"NA","14":"NA","15":"NA","16":"78.26","17":"78.26","18":"0.000000","19":"0.000000","20":"0.000000000","21":"NA","22":"NA","23":"NA","24":"NA","25":"NA","26":"NA","27":"NA","28":"NA","29":"NA","30":"NA","31":"NA","32":"NA","33":"NA","34":"NA","35":"77.59"},{"1":"MMM","2":"2007-01-04","3":"78.40","4":"78.41","5":"77.45","6":"77.95","7":"2968400","8":"50.67959","9":"Thursday","10":"1","11":"0.01231568","12":"NA","13":"NA","14":"NA","15":"NA","16":"78.26","17":"77.95","18":"-0.310005","19":"0.000000","20":"0.003976973","21":"NA","22":"NA","23":"NA","24":"NA","25":"NA","26":"NA","27":"NA","28":"NA","29":"NA","30":"NA","31":"NA","32":"NA","33":"NA","34":"NA","35":"77.68"},{"1":"MMM","2":"2007-01-05","3":"77.89","4":"77.90","5":"77.01","6":"77.42","7":"2765200","8":"50.33502","9":"Friday","10":"1","11":"0.01149574","12":"NA","13":"NA","14":"NA","15":"NA","16":"78.26","17":"77.42","18":"-0.840004","19":"0.000000","20":"0.010849962","21":"NA","22":"NA","23":"NA","24":"NA","25":"NA","26":"NA","27":"NA","28":"NA","29":"NA","30":"NA","31":"NA","32":"NA","33":"NA","34":"NA","35":"77.85"},{"1":"MMM","2":"2007-01-08","3":"77.42","4":"78.04","5":"76.97","6":"77.59","7":"2434500","8":"50.44556","9":"Monday","10":"1","11":"0.01379044","12":"NA","13":"NA","14":"NA","15":"NA","16":"78.26","17":"77.42","18":"-0.670006","19":"0.169998","20":"0.010826189","21":"NA","22":"NA","23":"-0.670006","24":"NA","25":"NA","26":"NA","27":"NA","28":"NA","29":"NA","30":"NA","31":"NA","32":"NA","33":"NA","34":"NA","35":"78.65"},{"1":"MMM","2":"2007-01-09","3":"78.00","4":"78.23","5":"77.44","6":"77.68","7":"1896800","8":"50.50405","9":"Tuesday","10":"1","11":"0.01016994","12":"NA","13":"NA","14":"NA","15":"NA","16":"78.26","17":"77.42","18":"-0.580002","19":"0.260002","20":"0.010813646","21":"2769280","22":"NA","23":"-0.269997","24":"NA","25":"NA","26":"NA","27":"NA","28":"NA","29":"NA","30":"NA","31":"NA","32":"NA","33":"NA","34":"NA","35":"79.36"},{"1":"MMM","2":"2007-01-10","3":"77.31","4":"77.96","5":"77.04","6":"77.85","7":"1787500","8":"50.61459","9":"Wednesday","10":"1","11":"0.01181757","12":"NA","13":"NA","14":"NA","15":"NA","16":"78.26","17":"77.42","18":"-0.410004","19":"0.430000","20":"0.010790032","21":"2370480","22":"NA","23":"0.430000","24":"NA","25":"NA","26":"NA","27":"NA","28":"NA","29":"NA","30":"NA","31":"NA","32":"NA","33":"NA","34":"NA","35":"79.56"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Now that I have the S&amp;P 500 stocks, I’m going to get the historical data for five major stock indexes, <code>IV_vars</code>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>IV_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"NDAQ"</span>,<span class="st">"SPY"</span>,<span class="st">"CBOE"</span>,<span class="st">"GS"</span>,<span class="st">"^VIX"</span>) </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>idx <span class="ot">&lt;-</span> IV_vars <span class="sc">%&gt;%</span> <span class="fu">map</span>(<span class="cf">function</span>(symbol){</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">getSymbols</span>(<span class="at">Symbols =</span> symbol, </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">reload.Symbols =</span> <span class="cn">FALSE</span>, </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">warnings =</span> <span class="cn">FALSE</span>, </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">auto.assign =</span> <span class="cn">FALSE</span>),</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="st">"Date"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename_with</span>(<span class="sc">~</span><span class="fu">c</span>(<span class="st">"Date"</span>,<span class="st">"Open"</span>,<span class="st">"High"</span>,<span class="st">"Low"</span>,<span class="st">"Close"</span>,<span class="st">"Volume"</span>,<span class="st">"Adj_Close"</span> ))</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (symbol <span class="sc">==</span> <span class="st">"^VIX"</span>){symbol <span class="ot">&lt;-</span> <span class="st">"VIX"</span>}</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">Date =</span> <span class="fu">as.Date</span>(Date, <span class="at">format=</span><span class="st">"%Y-%m-%d"</span>),</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">Volatility =</span> (High <span class="sc">-</span> Low) <span class="sc">/</span> Close,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">seven_day_volume_avg =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(Volume, <span class="at">k=</span><span class="dv">7</span>, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">seven_day_volatility_avg =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(Volatility, <span class="at">k=</span><span class="dv">7</span>, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">seven_day_trend =</span> (Close<span class="sc">-</span>(dplyr<span class="sc">::</span><span class="fu">lag</span>(Close,<span class="at">n=</span><span class="dv">7</span>,<span class="at">default =</span> <span class="cn">NA</span>))) <span class="sc">/</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(Close,<span class="at">n=</span><span class="dv">7</span>,<span class="at">default =</span> <span class="cn">NA</span>),</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">local_20_max =</span> zoo<span class="sc">::</span><span class="fu">rollapplyr</span>(Close, <span class="dv">20</span>, max, <span class="at">partial=</span><span class="cn">TRUE</span>),</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">local_20_min =</span> zoo<span class="sc">::</span><span class="fu">rollapplyr</span>(Close, <span class="dv">20</span>, min, <span class="at">partial=</span><span class="cn">TRUE</span>),</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">diff_from_local_max =</span> Close <span class="sc">-</span> local_20_max,</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">diff_from_local_min =</span> Close <span class="sc">-</span> local_20_min,</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">local_range =</span> (local_20_max <span class="sc">-</span> local_20_min) <span class="sc">/</span> Close</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>Open, <span class="sc">-</span>High, <span class="sc">-</span>Low, <span class="sc">-</span>Adj_Close, <span class="sc">-</span>local_20_min, <span class="sc">-</span>local_20_max)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Date"</span>, <span class="fu">paste</span>(symbol, <span class="fu">colnames</span>(df)[<span class="dv">2</span><span class="sc">:</span><span class="dv">10</span>], <span class="at">sep=</span><span class="st">"_"</span>))</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>  df</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">reduce</span>(left_join, <span class="at">by=</span><span class="st">"Date"</span>)</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(idx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["Date"],"name":[1],"type":["date"],"align":["right"]},{"label":["NDAQ_Close"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["NDAQ_Volume"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["NDAQ_Volatility"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["NDAQ_seven_day_volume_avg"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["NDAQ_seven_day_volatility_avg"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["NDAQ_seven_day_trend"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["NDAQ_diff_from_local_max"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["NDAQ_diff_from_local_min"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["NDAQ_local_range"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["SPY_Close"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["SPY_Volume"],"name":[12],"type":["dbl"],"align":["right"]},{"label":["SPY_Volatility"],"name":[13],"type":["dbl"],"align":["right"]},{"label":["SPY_seven_day_volume_avg"],"name":[14],"type":["dbl"],"align":["right"]},{"label":["SPY_seven_day_volatility_avg"],"name":[15],"type":["dbl"],"align":["right"]},{"label":["SPY_seven_day_trend"],"name":[16],"type":["dbl"],"align":["right"]},{"label":["SPY_diff_from_local_max"],"name":[17],"type":["dbl"],"align":["right"]},{"label":["SPY_diff_from_local_min"],"name":[18],"type":["dbl"],"align":["right"]},{"label":["SPY_local_range"],"name":[19],"type":["dbl"],"align":["right"]},{"label":["CBOE_Close"],"name":[20],"type":["dbl"],"align":["right"]},{"label":["CBOE_Volume"],"name":[21],"type":["dbl"],"align":["right"]},{"label":["CBOE_Volatility"],"name":[22],"type":["dbl"],"align":["right"]},{"label":["CBOE_seven_day_volume_avg"],"name":[23],"type":["dbl"],"align":["right"]},{"label":["CBOE_seven_day_volatility_avg"],"name":[24],"type":["dbl"],"align":["right"]},{"label":["CBOE_seven_day_trend"],"name":[25],"type":["dbl"],"align":["right"]},{"label":["CBOE_diff_from_local_max"],"name":[26],"type":["dbl"],"align":["right"]},{"label":["CBOE_diff_from_local_min"],"name":[27],"type":["dbl"],"align":["right"]},{"label":["CBOE_local_range"],"name":[28],"type":["dbl"],"align":["right"]},{"label":["GS_Close"],"name":[29],"type":["dbl"],"align":["right"]},{"label":["GS_Volume"],"name":[30],"type":["dbl"],"align":["right"]},{"label":["GS_Volatility"],"name":[31],"type":["dbl"],"align":["right"]},{"label":["GS_seven_day_volume_avg"],"name":[32],"type":["dbl"],"align":["right"]},{"label":["GS_seven_day_volatility_avg"],"name":[33],"type":["dbl"],"align":["right"]},{"label":["GS_seven_day_trend"],"name":[34],"type":["dbl"],"align":["right"]},{"label":["GS_diff_from_local_max"],"name":[35],"type":["dbl"],"align":["right"]},{"label":["GS_diff_from_local_min"],"name":[36],"type":["dbl"],"align":["right"]},{"label":["GS_local_range"],"name":[37],"type":["dbl"],"align":["right"]},{"label":["VIX_Close"],"name":[38],"type":["dbl"],"align":["right"]},{"label":["VIX_Volume"],"name":[39],"type":["dbl"],"align":["right"]},{"label":["VIX_Volatility"],"name":[40],"type":["dbl"],"align":["right"]},{"label":["VIX_seven_day_volume_avg"],"name":[41],"type":["dbl"],"align":["right"]},{"label":["VIX_seven_day_volatility_avg"],"name":[42],"type":["dbl"],"align":["right"]},{"label":["VIX_seven_day_trend"],"name":[43],"type":["dbl"],"align":["right"]},{"label":["VIX_diff_from_local_max"],"name":[44],"type":["dbl"],"align":["right"]},{"label":["VIX_diff_from_local_min"],"name":[45],"type":["dbl"],"align":["right"]},{"label":["VIX_local_range"],"name":[46],"type":["dbl"],"align":["right"]}],"data":[{"1":"2007-01-03","2":"10.33667","3":"16054800","4":"0.02386330","5":"NA","6":"NA","7":"NA","8":"0.00","9":"0.000000","10":"0.00000000","11":"141.37","12":"94807600","13":"0.016198586","14":"NA","15":"NA","16":"NA","17":"0.000000","18":"0.000000","19":"0.000000000","20":"NA","21":"NA","22":"NA","23":"NA","24":"NA","25":"NA","26":"NA","27":"NA","28":"NA","29":"200.72","30":"6494900","31":"0.02740135","32":"NA","33":"NA","34":"NA","35":"0.000000","36":"0.000000","37":"0.000000000","38":"12.04","39":"0","40":"0.10132890","41":"NA","42":"NA","43":"NA","44":"0.00","45":"0.00","46":"0.00000000"},{"1":"2007-01-04","2":"10.63000","3":"9840900","4":"0.04703669","5":"NA","6":"NA","7":"NA","8":"0.00","9":"0.293333","10":"0.02759483","11":"141.67","12":"69620600","13":"0.010164481","14":"NA","15":"NA","16":"NA","17":"0.000000","18":"0.300003","19":"0.002117618","20":"NA","21":"NA","22":"NA","23":"NA","24":"NA","25":"NA","26":"NA","27":"NA","28":"NA","29":"198.85","30":"6460200","31":"0.01307514","32":"NA","33":"NA","34":"NA","35":"-1.869995","36":"0.000000","37":"0.009404048","38":"11.51","39":"0","40":"0.09904431","41":"NA","42":"NA","43":"NA","44":"-0.53","45":"0.00","46":"0.04604692"},{"1":"2007-01-05","2":"11.03333","3":"11149200","4":"0.04561931","5":"NA","6":"NA","7":"NA","8":"0.00","9":"0.696666","10":"0.06314194","11":"140.54","12":"76645300","13":"0.007257642","14":"NA","15":"NA","16":"NA","17":"-1.130005","18":"0.000000","19":"0.008040452","20":"NA","21":"NA","22":"NA","23":"NA","24":"NA","25":"NA","26":"NA","27":"NA","28":"NA","29":"199.05","30":"5892900","31":"0.01055014","32":"NA","33":"NA","34":"NA","35":"-1.669998","36":"0.199997","37":"0.009394599","38":"12.14","39":"0","40":"0.04695222","41":"NA","42":"NA","43":"NA","44":"0.00","45":"0.63","46":"0.05189456"},{"1":"2007-01-08","2":"11.34667","3":"10998300","4":"0.04289074","5":"NA","6":"NA","7":"NA","8":"0.00","9":"1.010000","10":"0.08901292","11":"141.19","12":"71655000","13":"0.008215908","14":"NA","15":"NA","16":"NA","17":"-0.479996","18":"0.650009","19":"0.008003435","20":"NA","21":"NA","22":"NA","23":"NA","24":"NA","25":"NA","26":"NA","27":"NA","28":"NA","29":"203.73","30":"7851000","31":"0.02871443","32":"NA","33":"NA","34":"NA","35":"0.000000","36":"4.879990","37":"0.023953223","38":"12.00","39":"0","40":"0.08750000","41":"NA","42":"NA","43":"NA","44":"-0.14","45":"0.49","46":"0.05250000"},{"1":"2007-01-09","2":"11.27667","3":"9531600","4":"0.03133319","5":"NA","6":"NA","7":"NA","8":"-0.07","9":"0.940000","10":"0.08956547","11":"141.07","12":"75680100","13":"0.008506500","14":"NA","15":"NA","16":"NA","17":"-0.599991","18":"0.530014","19":"0.008010243","20":"NA","21":"NA","22":"NA","23":"NA","24":"NA","25":"NA","26":"NA","27":"NA","28":"NA","29":"204.08","30":"7147100","31":"0.01421008","32":"NA","33":"NA","34":"NA","35":"0.000000","36":"5.229996","37":"0.025627185","38":"11.91","39":"0","40":"0.06549118","41":"NA","42":"NA","43":"NA","44":"-0.23","45":"0.40","46":"0.05289673"},{"1":"2007-01-10","2":"11.76000","3":"11197200","4":"0.06632653","5":"NA","6":"NA","7":"NA","8":"0.00","9":"1.423333","10":"0.12103172","11":"141.54","12":"72428000","13":"0.008972757","14":"NA","15":"NA","16":"NA","17":"-0.130005","18":"1.000000","19":"0.007983645","20":"NA","21":"NA","22":"NA","23":"NA","24":"NA","25":"NA","26":"NA","27":"NA","28":"NA","29":"208.11","30":"8025700","31":"0.03334776","32":"NA","33":"NA","34":"NA","35":"0.000000","36":"9.259995","37":"0.044495675","38":"11.47","39":"0","40":"0.09328684","41":"NA","42":"NA","43":"NA","44":"-0.67","45":"0.00","46":"0.05841325"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Now I join the stock dataframe to the index dataframe, eliminate some columns, and drop <code>NA</code>s.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df_joined <span class="ot">&lt;-</span> sp500 <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(idx, <span class="at">by =</span> <span class="st">"Date"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    y,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    Symbol,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    Close, </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    Date,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    diff_ma_20,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    macd,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    macd_signal,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    macd_above_signal,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    three_day_change,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    rel_strength_index,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    fastK,</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    fastD,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    slowD,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    bb_dn,</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    bb_mavg,</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    bb_up,</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    bb_pctB,</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    Volume, </span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    Volatility, </span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    seven_day_volume_avg, </span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    seven_day_volatility_avg, </span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    seven_day_trend, </span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    seven_day_volume_trend, </span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    local_20_max, </span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    local_20_min, </span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    diff_from_local_max, </span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    diff_from_local_min, </span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    local_range, </span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    NDAQ_Close, </span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    NDAQ_Volatility, </span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    NDAQ_Volume, </span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    NDAQ_Volume, </span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    NDAQ_seven_day_volume_avg, </span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    NDAQ_seven_day_volatility_avg, </span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    NDAQ_seven_day_trend, </span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    NDAQ_diff_from_local_max, </span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    NDAQ_diff_from_local_min, </span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    NDAQ_local_range, </span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>    SPY_Close, </span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    SPY_Volatility, </span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    SPY_Volume, </span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>    SPY_seven_day_volume_avg, </span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    SPY_seven_day_volatility_avg, </span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    SPY_seven_day_trend, </span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    SPY_diff_from_local_max, </span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>    SPY_diff_from_local_min, </span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>    SPY_local_range, </span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>    GS_Close, </span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>    GS_Volatility, </span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>    GS_Volume, </span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>    GS_seven_day_volume_avg, </span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>    GS_seven_day_volatility_avg, </span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>    GS_seven_day_trend, </span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>    GS_diff_from_local_max, </span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>    GS_diff_from_local_min, </span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>    GS_local_range, </span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>    CBOE_Close, </span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>    CBOE_Volatility, </span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>    CBOE_Volume, </span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>    CBOE_seven_day_volume_avg, </span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>    CBOE_seven_day_volatility_avg, </span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>    CBOE_seven_day_trend, </span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>    CBOE_diff_from_local_max, </span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>    CBOE_diff_from_local_min, </span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>    CBOE_local_range, </span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>    VIX_Close, </span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>    VIX_Volatility, </span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>    VIX_seven_day_volatility_avg, </span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>    VIX_seven_day_trend</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_joined)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["y"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["Symbol"],"name":[2],"type":["chr"],"align":["left"]},{"label":["Close"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["Date"],"name":[4],"type":["date"],"align":["right"]},{"label":["diff_ma_20"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["macd"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["macd_signal"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["macd_above_signal"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["three_day_change"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["rel_strength_index"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["fastK"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["fastD"],"name":[12],"type":["dbl"],"align":["right"]},{"label":["slowD"],"name":[13],"type":["dbl"],"align":["right"]},{"label":["bb_dn"],"name":[14],"type":["dbl"],"align":["right"]},{"label":["bb_mavg"],"name":[15],"type":["dbl"],"align":["right"]},{"label":["bb_up"],"name":[16],"type":["dbl"],"align":["right"]},{"label":["bb_pctB"],"name":[17],"type":["dbl"],"align":["right"]},{"label":["Volume"],"name":[18],"type":["dbl"],"align":["right"]},{"label":["Volatility"],"name":[19],"type":["dbl"],"align":["right"]},{"label":["seven_day_volume_avg"],"name":[20],"type":["dbl"],"align":["right"]},{"label":["seven_day_volatility_avg"],"name":[21],"type":["dbl"],"align":["right"]},{"label":["seven_day_trend"],"name":[22],"type":["dbl"],"align":["right"]},{"label":["seven_day_volume_trend"],"name":[23],"type":["dbl"],"align":["right"]},{"label":["local_20_max"],"name":[24],"type":["dbl"],"align":["right"]},{"label":["local_20_min"],"name":[25],"type":["dbl"],"align":["right"]},{"label":["diff_from_local_max"],"name":[26],"type":["dbl"],"align":["right"]},{"label":["diff_from_local_min"],"name":[27],"type":["dbl"],"align":["right"]},{"label":["local_range"],"name":[28],"type":["dbl"],"align":["right"]},{"label":["NDAQ_Close"],"name":[29],"type":["dbl"],"align":["right"]},{"label":["NDAQ_Volatility"],"name":[30],"type":["dbl"],"align":["right"]},{"label":["NDAQ_Volume"],"name":[31],"type":["dbl"],"align":["right"]},{"label":["NDAQ_seven_day_volume_avg"],"name":[32],"type":["dbl"],"align":["right"]},{"label":["NDAQ_seven_day_volatility_avg"],"name":[33],"type":["dbl"],"align":["right"]},{"label":["NDAQ_seven_day_trend"],"name":[34],"type":["dbl"],"align":["right"]},{"label":["NDAQ_diff_from_local_max"],"name":[35],"type":["dbl"],"align":["right"]},{"label":["NDAQ_diff_from_local_min"],"name":[36],"type":["dbl"],"align":["right"]},{"label":["NDAQ_local_range"],"name":[37],"type":["dbl"],"align":["right"]},{"label":["SPY_Close"],"name":[38],"type":["dbl"],"align":["right"]},{"label":["SPY_Volatility"],"name":[39],"type":["dbl"],"align":["right"]},{"label":["SPY_Volume"],"name":[40],"type":["dbl"],"align":["right"]},{"label":["SPY_seven_day_volume_avg"],"name":[41],"type":["dbl"],"align":["right"]},{"label":["SPY_seven_day_volatility_avg"],"name":[42],"type":["dbl"],"align":["right"]},{"label":["SPY_seven_day_trend"],"name":[43],"type":["dbl"],"align":["right"]},{"label":["SPY_diff_from_local_max"],"name":[44],"type":["dbl"],"align":["right"]},{"label":["SPY_diff_from_local_min"],"name":[45],"type":["dbl"],"align":["right"]},{"label":["SPY_local_range"],"name":[46],"type":["dbl"],"align":["right"]},{"label":["GS_Close"],"name":[47],"type":["dbl"],"align":["right"]},{"label":["GS_Volatility"],"name":[48],"type":["dbl"],"align":["right"]},{"label":["GS_Volume"],"name":[49],"type":["dbl"],"align":["right"]},{"label":["GS_seven_day_volume_avg"],"name":[50],"type":["dbl"],"align":["right"]},{"label":["GS_seven_day_volatility_avg"],"name":[51],"type":["dbl"],"align":["right"]},{"label":["GS_seven_day_trend"],"name":[52],"type":["dbl"],"align":["right"]},{"label":["GS_diff_from_local_max"],"name":[53],"type":["dbl"],"align":["right"]},{"label":["GS_diff_from_local_min"],"name":[54],"type":["dbl"],"align":["right"]},{"label":["GS_local_range"],"name":[55],"type":["dbl"],"align":["right"]},{"label":["CBOE_Close"],"name":[56],"type":["dbl"],"align":["right"]},{"label":["CBOE_Volatility"],"name":[57],"type":["dbl"],"align":["right"]},{"label":["CBOE_Volume"],"name":[58],"type":["dbl"],"align":["right"]},{"label":["CBOE_seven_day_volume_avg"],"name":[59],"type":["dbl"],"align":["right"]},{"label":["CBOE_seven_day_volatility_avg"],"name":[60],"type":["dbl"],"align":["right"]},{"label":["CBOE_seven_day_trend"],"name":[61],"type":["dbl"],"align":["right"]},{"label":["CBOE_diff_from_local_max"],"name":[62],"type":["dbl"],"align":["right"]},{"label":["CBOE_diff_from_local_min"],"name":[63],"type":["dbl"],"align":["right"]},{"label":["CBOE_local_range"],"name":[64],"type":["dbl"],"align":["right"]},{"label":["VIX_Close"],"name":[65],"type":["dbl"],"align":["right"]},{"label":["VIX_Volatility"],"name":[66],"type":["dbl"],"align":["right"]},{"label":["VIX_seven_day_volatility_avg"],"name":[67],"type":["dbl"],"align":["right"]},{"label":["VIX_seven_day_trend"],"name":[68],"type":["dbl"],"align":["right"]}],"data":[{"1":"78.49","2":"MMM","3":"78.18","4":"2010-06-24","5":"-0.46849925","6":"-0.5667265","7":"-1.0445828","8":"0.4778563","9":"-3.290001","10":"42.80790","11":"0.5111442","12":"0.6988609","13":"0.8297837","14":"74.36808","15":"78.6485","16":"82.92892","17":"0.4452741","18":"4340100","19":"0.02519817","20":"4240000","21":"0.02055968","22":"-0.01993227","23":"-0.16764355","24":"81.47","25":"74.74","26":"-3.290001","27":"3.440002","28":"0.08608344","29":"6.113333","30":"0.02071979","31":"6785400","32":"6003514","33":"0.02189276","34":"-0.06856273","35":"-0.450000","36":"0.040000","37":"0.08015268","38":"107.42","39":"0.01573267","40":"268523600","41":"232746571","42":"0.01477042","43":"-0.04089287","44":"-4.720001","45":"1.930000","46":"0.06190655","47":"134.98","48":"0.02126237","49":"9967900","50":"8747171","51":"0.02141229","52":"-0.014024822","53":"-9.970001","54":"1.539994","55":"0.08527186","56":"33.29","57":"0.04265551","58":"1600800","59":"1352085.7","60":"0.04055380","61":"0.02462293","62":"-0.189999","63":"2.280001","64":"0.07419645","65":"29.74","66":"0.09213178","67":"0.07977728","68":"0.1495941"},{"1":"78.99","2":"MMM","3":"78.90","4":"2010-06-25","5":"0.37800265","6":"-0.5858054","7":"-0.9528273","8":"0.3670219","9":"-1.129997","10":"45.86789","11":"0.6152696","12":"0.6419399","13":"0.7342046","14":"74.43259","15":"78.5220","16":"82.61141","17":"0.5462173","18":"4339900","19":"0.01533586","20":"4094300","21":"0.01920028","22":"-0.02448065","23":"-0.18276979","24":"81.47","25":"74.74","26":"-2.569999","27":"4.160004","28":"0.08529788","29":"6.296667","30":"0.03282165","31":"9883800","32":"6705129","33":"0.02431513","34":"-0.03326500","35":"-0.266666","36":"0.223334","37":"0.07781895","38":"107.87","39":"0.01529620","40":"238726500","41":"235939786","42":"0.01539891","43":"-0.03653087","44":"-4.269996","45":"2.380005","46":"0.06164829","47":"139.66","48":"0.03916655","49":"14332300","50":"9783543","51":"0.02434967","52":"0.018969838","53":"-5.169998","54":"6.220002","55":"0.08155520","56":"32.07","57":"0.03991263","58":"640100","59":"1135128.6","60":"0.04260288","61":"0.00000000","62":"-1.410000","63":"1.060000","64":"0.07701902","65":"28.53","66":"0.08201892","67":"0.08388846","68":"0.1006945"},{"1":"78.55","2":"MMM","3":"78.98","4":"2010-06-28","5":"0.47450340","6":"-0.5861417","7":"-0.8794902","8":"0.2933485","9":"-1.140000","10":"46.21225","11":"0.6272458","12":"0.5845532","13":"0.6417847","14":"74.42629","15":"78.5055","16":"82.58471","17":"0.5581612","18":"3094000","19":"0.01823249","20":"3968243","21":"0.01921329","22":"-0.02529922","23":"-0.12694591","24":"81.47","25":"74.74","26":"-2.489998","27":"4.240005","28":"0.08521148","29":"6.286667","30":"0.01378584","31":"6531600","32":"6933643","33":"0.02273713","34":"-0.02431443","35":"-0.276666","36":"0.213334","37":"0.07794273","38":"107.53","39":"0.01097369","40":"169218600","41":"222515900","42":"0.01533597","43":"-0.04110933","44":"-4.610000","45":"2.040001","46":"0.06184322","47":"136.66","48":"0.02817215","49":"9908100","50":"10041229","51":"0.02508683","52":"-0.004806313","53":"-8.169998","54":"3.220002","55":"0.08334553","56":"32.78","57":"0.03935323","58":"718200","59":"1028057.1","60":"0.04264653","61":"0.04063489","62":"-0.700001","63":"1.769999","64":"0.07535083","65":"29.00","66":"0.04931038","67":"0.08186522","68":"0.1576847"},{"1":"77.67","2":"MMM","3":"78.49","4":"2010-06-29","5":"-0.03650150","6":"-0.6290896","7":"-0.8294101","8":"0.2003205","9":"0.309998","10":"44.35121","11":"0.2623757","12":"0.5016304","13":"0.5760412","14":"74.45215","15":"78.5265","16":"82.60085","17":"0.4955206","18":"8545400","19":"0.02790168","20":"4438186","21":"0.02143948","22":"-0.03313627","23":"-0.03725201","24":"81.47","25":"74.74","26":"-2.980003","27":"3.750000","28":"0.08574345","29":"6.016667","30":"0.03213291","31":"7984200","32":"7044814","33":"0.02494286","34":"-0.05842457","35":"-0.546666","36":"0.000000","37":"0.09085861","38":"104.21","39":"0.03800018","40":"373649500","41":"251036314","42":"0.01979284","43":"-0.06730514","44":"-7.930000","45":"0.000000","46":"0.07609634","47":"133.76","48":"0.02003595","49":"10338100","50":"10067400","51":"0.02567465","52":"-0.031987250","53":"-11.070007","54":"0.319993","55":"0.08515252","56":"31.76","57":"0.03243070","58":"622300","59":"955214.3","60":"0.04317943","61":"0.02418575","62":"-1.720000","63":"0.750000","64":"0.07777078","65":"34.13","66":"0.12217990","67":"0.08989509","68":"0.4250522"},{"1":"78.14","2":"MMM","3":"78.99","4":"2010-06-30","5":"0.45099850","6":"-0.6053773","7":"-0.7846035","8":"0.1792262","9":"0.089996","10":"46.70953","11":"0.2552548","12":"0.3816254","13":"0.4892697","14":"74.46058","15":"78.5390","16":"82.61742","17":"0.5552908","18":"6942900","19":"0.02544628","20":"4849457","21":"0.02169043","22":"-0.03044069","23":"0.12669895","24":"81.47","25":"74.74","26":"-2.480003","27":"4.250000","28":"0.08520070","29":"5.926667","30":"0.02587188","31":"8521800","32":"7312243","33":"0.02472905","34":"-0.06421042","35":"-0.636666","36":"0.000000","37":"0.10742395","38":"103.22","39":"0.01937609","40":"284101700","41":"261173600","42":"0.01947060","43":"-0.07351228","44":"-8.919998","45":"0.000000","46":"0.08641734","47":"131.27","48":"0.02498666","49":"9139800","50":"10131514","51":"0.02629867","52":"-0.046972563","53":"-12.769989","54":"0.000000","55":"0.09728033","56":"32.55","57":"0.03072203","58":"402400","59":"860285.7","60":"0.03869546","61":"0.01591754","62":"-0.930001","63":"1.539999","64":"0.07588326","65":"34.54","66":"0.08367113","67":"0.08594321","68":"0.3882638"},{"1":"80.52","2":"MMM","3":"78.55","4":"2010-07-01","5":"0.00050315","6":"-0.6242735","7":"-0.7525375","8":"0.1282640","9":"-0.430000","10":"44.90604","11":"0.1231243","12":"0.2135849","13":"0.3656136","14":"74.47210","15":"78.5495","16":"82.62690","17":"0.5000617","18":"6811700","19":"0.01973259","20":"5377300","21":"0.02095712","22":"-0.01849302","23":"0.31529457","24":"81.47","25":"74.74","26":"-2.919998","27":"3.810005","28":"0.08567795","29":"5.900000","30":"0.04067797","31":"9065100","32":"7716643","33":"0.02671434","34":"-0.05195496","35":"-0.663333","36":"0.000000","37":"0.11242932","38":"102.76","39":"0.02296614","40":"382924800","41":"281683514","42":"0.01950503","43":"-0.06215203","44":"-9.379997","45":"0.000000","46":"0.09128062","47":"131.14","48":"0.03240811","49":"11645300","50":"10509100","51":"0.02757927","52":"-0.027079117","53":"-11.110001","54":"0.000000","55":"0.08471863","56":"30.31","57":"0.08248103","58":"1023200","59":"862342.9","60":"0.04462257","61":"-0.07280514","62":"-3.170001","63":"0.000000","64":"0.10458598","65":"32.86","66":"0.14790021","67":"0.09312938","68":"0.2147875"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Again, you might want to save this to disk so you don’t have to keep repeating the above steps.</p>
<p>One stock (NVR) trades at over $4,000/share. It’s so much higher than all of the others, I decided to eliminate it from training and testing.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df_joined <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Close <span class="sc">&gt;</span> <span class="dv">4000</span>) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(Symbol)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["Symbol"],"name":[1],"type":["chr"],"align":["left"]}],"data":[{"1":"NVR"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>For speed purposes, I’m going to train on just the data since 2017.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>df_joined5 <span class="ot">&lt;-</span> df_joined <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Date <span class="sc">&gt;=</span> <span class="st">"2017-01-01"</span> <span class="sc">&amp;</span> Symbol <span class="sc">!=</span> <span class="st">"NVR"</span>) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(Date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This demonstrates how a naive stock picker would have fared in 2022 (as of Summer 2022). I’ll need to at least beat this benchmark.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df_joined <span class="sc">%&gt;%</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Date <span class="sc">&gt;=</span> <span class="st">"2022-01-01"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">inc =</span> y <span class="sc">&gt;</span> Close) <span class="sc">%&gt;%</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">year_2022 =</span> <span class="fu">sum</span>(inc)) <span class="sc">/</span> <span class="dv">58033</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["year_2022"],"name":[1],"type":["dbl"],"align":["right"]}],"data":[{"1":"0.4676822"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="hyperparameter-tuning" class="level2">
<h2 class="anchored" data-anchor-id="hyperparameter-tuning">Hyperparameter Tuning</h2>
<p>Now I create train and test data sets. I’ll train on data up to 2022-01-01, and the test data will be from that day forward. Functions below are from <code>tidymodels</code>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>data_split <span class="ot">&lt;-</span> <span class="fu">initial_time_split</span>(df_joined5, </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">prop =</span> df_joined5 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Date <span class="sc">&lt;</span> <span class="st">"2022-01-01"</span>) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>() <span class="sc">/</span> <span class="fu">nrow</span>(df_joined5))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(data_split) </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>test_data  <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_split)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>val_set <span class="ot">&lt;-</span> <span class="fu">validation_split</span>(train_data, <span class="at">prop =</span> <span class="fl">0.80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Create the neural net recipe.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>nn_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(y <span class="sc">~</span> ., <span class="at">data =</span> train_data <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>Symbol, <span class="sc">-</span>Date)) <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Define the model and parameters for tuning. Use large values for batch size. Batch size should be 2 to the order of something. Virtual batch size should be 1/8 of the batch size. Use trial and error to see how large you can go based on your GPU’s dedicated memory. Mine’s old and wimpy, so with validation, I have to keep it to <span class="math inline">\(2^{13}\)</span>. Without validation, I can go up to <span class="math inline">\(2^{15}\)</span>. This took many hours on my machine to complete, and some models failed.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>nn_mod <span class="ot">&lt;-</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabnet</span>(<span class="at">epochs =</span> <span class="dv">10</span>, </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">batch_size =</span> <span class="dv">2</span><span class="sc">^</span><span class="dv">13</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">virtual_batch_size =</span> <span class="dv">2</span><span class="sc">^</span><span class="dv">10</span>,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">decision_width =</span> <span class="fu">tune</span>(), </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">attention_width =</span> <span class="fu">tune</span>(),</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">num_steps =</span> <span class="fu">tune</span>(), </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">penalty =</span> <span class="fu">tune</span>(), </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">momentum =</span> <span class="fu">tune</span>(),</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">feature_reusage =</span> <span class="fu">tune</span>(), </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">learn_rate =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"torch"</span>, <span class="at">device=</span><span class="st">"cuda"</span>, <span class="at">verbose=</span><span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Define the workflow.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>nn_wf <span class="ot">&lt;-</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(nn_mod) <span class="sc">%&gt;%</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(nn_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Fit 25 models for tuning.</p>
<div class="cell">

</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>nn_fit <span class="ot">&lt;-</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  nn_wf <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(val_set,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">grid =</span> <span class="dv">25</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">control =</span> <span class="fu">control_grid</span>())</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># see how the models performed</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>nn_fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Show the top 5 models based on root mean squared error (RMSE) and R-squared.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>nn_fit <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["penalty"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["learn_rate"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["decision_width"],"name":[3],"type":["int"],"align":["right"]},{"label":["attention_width"],"name":[4],"type":["int"],"align":["right"]},{"label":["num_steps"],"name":[5],"type":["int"],"align":["right"]},{"label":["feature_reusage"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["momentum"],"name":[7],"type":["dbl"],"align":["right"]},{"label":[".metric"],"name":[8],"type":["chr"],"align":["left"]},{"label":[".estimator"],"name":[9],"type":["chr"],"align":["left"]},{"label":["mean"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["n"],"name":[11],"type":["int"],"align":["right"]},{"label":["std_err"],"name":[12],"type":["dbl"],"align":["right"]},{"label":[".config"],"name":[13],"type":["chr"],"align":["left"]}],"data":[{"1":"1.887354e-06","2":"0.023897007","3":"20","4":"56","5":"6","6":"1.777806","7":"0.1526991","8":"rmse","9":"standard","10":"12.15408","11":"1","12":"NA","13":"Preprocessor1_Model05"},{"1":"4.889441e-09","2":"0.009163333","3":"23","4":"28","5":"4","6":"1.669124","7":"0.3590279","8":"rmse","9":"standard","10":"13.17872","11":"1","12":"NA","13":"Preprocessor1_Model15"},{"1":"1.615767e-04","2":"0.099516739","3":"19","4":"16","5":"7","6":"1.130779","7":"0.3935718","8":"rmse","9":"standard","10":"13.41399","11":"1","12":"NA","13":"Preprocessor1_Model25"},{"1":"1.553904e-03","2":"0.001215648","3":"26","4":"40","5":"7","6":"1.351638","7":"0.2830284","8":"rmse","9":"standard","10":"81.56733","11":"1","12":"NA","13":"Preprocessor1_Model08"},{"1":"6.741420e-08","2":"0.000202984","3":"44","4":"32","5":"5","6":"1.729842","7":"0.3120057","8":"rmse","9":"standard","10":"199.09685","11":"1","12":"NA","13":"Preprocessor1_Model04"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>nn_fit <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"rsq"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["penalty"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["learn_rate"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["decision_width"],"name":[3],"type":["int"],"align":["right"]},{"label":["attention_width"],"name":[4],"type":["int"],"align":["right"]},{"label":["num_steps"],"name":[5],"type":["int"],"align":["right"]},{"label":["feature_reusage"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["momentum"],"name":[7],"type":["dbl"],"align":["right"]},{"label":[".metric"],"name":[8],"type":["chr"],"align":["left"]},{"label":[".estimator"],"name":[9],"type":["chr"],"align":["left"]},{"label":["mean"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["n"],"name":[11],"type":["int"],"align":["right"]},{"label":["std_err"],"name":[12],"type":["dbl"],"align":["right"]},{"label":[".config"],"name":[13],"type":["chr"],"align":["left"]}],"data":[{"1":"1.615767e-04","2":"0.0995167386","3":"19","4":"16","5":"7","6":"1.130779","7":"0.39357185","8":"rsq","9":"standard","10":"0.9966011","11":"1","12":"NA","13":"Preprocessor1_Model25"},{"1":"1.887354e-06","2":"0.0238970068","3":"20","4":"56","5":"6","6":"1.777806","7":"0.15269911","8":"rsq","9":"standard","10":"0.9949211","11":"1","12":"NA","13":"Preprocessor1_Model05"},{"1":"4.889441e-09","2":"0.0091633335","3":"23","4":"28","5":"4","6":"1.669124","7":"0.35902790","8":"rsq","9":"standard","10":"0.9944811","11":"1","12":"NA","13":"Preprocessor1_Model15"},{"1":"1.553904e-03","2":"0.0012156482","3":"26","4":"40","5":"7","6":"1.351638","7":"0.28302841","8":"rsq","9":"standard","10":"0.8530734","11":"1","12":"NA","13":"Preprocessor1_Model08"},{"1":"6.915258e-01","2":"0.0001043431","3":"48","4":"54","5":"3","6":"1.823148","7":"0.09684035","8":"rsq","9":"standard","10":"0.5257241","11":"1","12":"NA","13":"Preprocessor1_Model01"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>You can save and reload the model results for another day.</p>
</section>
<section id="the-final-fit" class="level2">
<h2 class="anchored" data-anchor-id="the-final-fit">The Final Fit</h2>
<p>For the final fit, I went back to 2012. I tried 2007, but I kept running out of GPU memory when using the best hyperparameters ID’ed above. Side note - if I use default hyperparameter values, I can train on data back to 2007, so one or more of the hyperparameters is memory intensive.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>data_split <span class="ot">&lt;-</span> <span class="fu">initial_time_split</span>(df_joined5, </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">prop =</span> df_joined5 <span class="sc">%&gt;%</span> </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">filter</span>(Date <span class="sc">&lt;</span> <span class="st">"2022-01-01"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">nrow</span>() <span class="sc">/</span> <span class="fu">nrow</span>(df_joined5))</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(data_split) </span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>test_data  <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_split)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>nn_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(y <span class="sc">~</span> ., <span class="at">data =</span> train_data <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>Symbol, <span class="sc">-</span>Date)) <span class="sc">%&gt;%</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Final model. I did this in 5-epoch increments just in case there were any errors.I stopped after 15 epochs since the loss had stabilized. Better to use a validation set here and stop when the validation loss bottoms out, but I had memory limitations.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>model_fit <span class="ot">&lt;-</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabnet_fit</span>(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    nn_rec,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> train_data <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>Symbol, <span class="sc">-</span>Date),</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">tabnet_model =</span> model_fit,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">from_epoch =</span> <span class="dv">10</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">epochs =</span> <span class="dv">5</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">checkpoint_epochs =</span> <span class="dv">5</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">batch_size =</span> <span class="dv">2</span><span class="sc">^</span><span class="dv">13</span>,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">virtual_batch_size =</span> <span class="dv">2</span><span class="sc">^</span><span class="dv">10</span>,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">decision_width =</span> <span class="dv">23</span>, </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">attention_width =</span> <span class="dv">28</span>,</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">num_steps =</span> <span class="dv">4</span>, </span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">penalty =</span> <span class="fl">4.89e-9</span>, </span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">momentum =</span> <span class="fl">0.359</span>,</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">feature_reusage =</span> <span class="fl">1.67</span>, </span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">learn_rate =</span> <span class="fl">0.00916</span>,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">device =</span> <span class="st">"cuda"</span>,</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Save the final model! I highly recommend it because this model can be used for months without re-training.</p>
<div class="cell">

</div>
<p>Check variable importance. Pretty heavily dominated by a small number of predictors, which isn’t great.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>vip<span class="sc">::</span><span class="fu">vip</span>(model_fit, <span class="at">num_features =</span> <span class="dv">20</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>For convenience, I make a dataframe <code>res</code> (short for results) with actual and predicted close prices and use it for checking performance.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> test_data<span class="sc">$</span>Date,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">symbol =</span> test_data<span class="sc">$</span>Symbol,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">close =</span> test_data<span class="sc">$</span>Close,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">new_close =</span> test_data<span class="sc">$</span>y,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred =</span> <span class="fu">predict</span>(model_fit, test_data) <span class="sc">%&gt;%</span> .<span class="sc">$</span><span class="st">`</span><span class="at">.pred</span><span class="st">`</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Calculate the RMSE for the final model. Shouldn’t be too different from the RMSE for the training data,</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>res <span class="sc">%&gt;%</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">er =</span> (pred <span class="sc">-</span> new_close)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">rmse =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>(er)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["rmse"],"name":[1],"type":["dbl"],"align":["right"]}],"data":[{"1":"22.58211"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Even though this is a regression problem, we can also look at it as if it was a classification problem and get the confusion matrix. We want lots of true-positives, of course. I’m not that concerned if the model predicts a stock will go down and it actually goes up because with a downward prediction, I wouldn’t have looked at it further or risked any money on it. What I don’t want are many upward predictions that actually go down.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> res <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_diff =</span> pred <span class="sc">-</span> close,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">act_diff =</span> new_close <span class="sc">-</span> close,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">correct =</span> <span class="fu">ifelse</span>((pred_diff <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> act_diff <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|</span> (pred_diff <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> act_diff <span class="sc">&lt;</span> <span class="dv">0</span>) , <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">target =</span> <span class="fu">ifelse</span>(new_close <span class="sc">&gt;</span> close, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">predict =</span> <span class="fu">ifelse</span>(pred <span class="sc">&gt;</span> close, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>conf_mat <span class="ot">&lt;-</span> cvms<span class="sc">::</span><span class="fu">confusion_matrix</span>(</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">targets =</span> res <span class="sc">%&gt;%</span> .<span class="sc">$</span>target,</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">predictions =</span> res <span class="sc">%&gt;%</span> .<span class="sc">$</span>predict)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>cvms<span class="sc">::</span><span class="fu">plot_confusion_matrix</span>(conf_mat<span class="sc">$</span><span class="st">`</span><span class="at">Confusion Matrix</span><span class="st">`</span>[[<span class="dv">1</span>]]) <span class="sc">+</span> </span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Tabnet Regression Accuracy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>My results were true positives around 50% - right around the benchmark. But that got me thinking. What I’m showing is how good the model is at predicting the stock price in exactly three days. What if I buy a stock, and after three days it hasn’t gone up? I’d probably hang on to it a little longer in case it goes up after 4 or 5 or __ days. Plus, if I stick to S&amp;P 500 stocks,I’m not too concerned about losing everything, so might as well hold on. Furthermore, if a stock did go up, I might also want to hang on longer to see if it keeps going up. Basically, I need a sell strategy. This might be a place for a new model, but for now I’ll just hard code an approximate strategy.</p>
<p>For each stock and each date, get the maximum close price over the next 10 days. Here, I’m not concerned about the amount a stock goes up or down, just that it did or did not increase in value at some point in the next 10 days. If I do this, I get a much higher true positive rate.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> res <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(symbol) <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">windowmax =</span> zoo<span class="sc">::</span><span class="fu">rollmax</span>(close, <span class="at">k=</span><span class="dv">10</span>, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"left"</span>),</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> <span class="fu">ifelse</span>(predict <span class="sc">&gt;</span> target <span class="sc">&amp;</span> windowmax <span class="sc">&gt;</span> close, <span class="dv">1</span>, target)) <span class="sc">%&gt;%</span> </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>conf_mat <span class="ot">&lt;-</span> cvms<span class="sc">::</span><span class="fu">confusion_matrix</span>(</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">targets =</span> res <span class="sc">%&gt;%</span> .<span class="sc">$</span>target,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">predictions =</span> res <span class="sc">%&gt;%</span> .<span class="sc">$</span>predict)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>cvms<span class="sc">::</span><span class="fu">plot_confusion_matrix</span>(conf_mat<span class="sc">$</span><span class="st">`</span><span class="at">Confusion Matrix</span><span class="st">`</span>[[<span class="dv">1</span>]]) <span class="sc">+</span> </span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Tabnet Regression Accuracy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here, I’m getting the average return using the above sell strategy.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>res <span class="sc">%&gt;%</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(symbol) <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">windowmax =</span> <span class="fu">rollmax</span>(close, <span class="at">k=</span><span class="dv">10</span>, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"left"</span>),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred_new =</span> <span class="fu">ifelse</span>(predict <span class="sc">&gt;</span> target <span class="sc">&amp;</span> windowmax <span class="sc">&gt;</span> close, windowmax, pred)) <span class="sc">%&gt;%</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(predict <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gain =</span> pred_new <span class="sc">/</span> close) <span class="sc">%&gt;%</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mean_gain =</span> <span class="fu">mean</span>(gain, <span class="at">na.rm=</span>T))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["mean_gain"],"name":[1],"type":["dbl"],"align":["right"]}],"data":[{"1":"1.077511"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<section id="simulate-buys-and-sells" class="level3">
<h3 class="anchored" data-anchor-id="simulate-buys-and-sells">Simulate Buys And Sells</h3>
<p>Given the above sell strategy and the regression model, I now conduct 30 simulations of buying and selling stocks in 2021. I’ll assume I start with $50,000 to invest, and I’ll buy stocks $5,000 at a time. I’ll sell when a stock has gained at least 6%. Below is a summary of the distribution of the profits from all simulations. At least there <strong>is</strong> profit for 2022, which actually pretty good.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(furrr)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"future::multisession"</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> res <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>()</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span> <span class="sc">%&gt;%</span> <span class="fu">future_map</span>(<span class="cf">function</span>(x){</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  bank <span class="ot">&lt;-</span> <span class="dv">50000</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  buy_amt <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  thresh <span class="ot">&lt;-</span> <span class="fl">1.06</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (d <span class="cf">in</span> <span class="fu">unique</span>(res<span class="sc">$</span>date)){</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(d)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (d <span class="sc">==</span> <span class="st">"2022-01-03"</span>){</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>      buy <span class="ot">&lt;-</span> res <span class="sc">%&gt;%</span> <span class="fu">filter</span>(date <span class="sc">==</span> d <span class="sc">&amp;</span> pred <span class="sc">&gt;</span> close)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>      id <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(buy), bank<span class="sc">/</span>buy_amt, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>      cur_stocks <span class="ot">&lt;-</span> buy <span class="sc">%&gt;%</span> <span class="fu">slice</span>(id) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>new_close, <span class="sc">-</span>pred)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>      bank <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    today <span class="ot">&lt;-</span> res <span class="sc">%&gt;%</span> <span class="fu">filter</span>(date <span class="sc">==</span> d <span class="sc">&amp;</span> symbol <span class="sc">%in%</span> (cur_stocks <span class="sc">%&gt;%</span> .<span class="sc">$</span>symbol)) <span class="sc">%&gt;%</span> </span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>new_close, <span class="sc">-</span>pred) <span class="sc">%&gt;%</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="st">"new_close"</span> <span class="ot">=</span> <span class="st">"close"</span>, <span class="st">"new_date"</span> <span class="ot">=</span> <span class="st">"date"</span>)</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    sell <span class="ot">&lt;-</span> cur_stocks <span class="sc">%&gt;%</span> </span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(today, <span class="at">by =</span> <span class="st">"symbol"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">gain =</span> new_close <span class="sc">/</span> close) <span class="sc">%&gt;%</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(gain <span class="sc">&gt;=</span> thresh)</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(sell) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>      bank <span class="ot">&lt;-</span> bank <span class="sc">+</span> sell <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">dollars =</span> gain <span class="sc">*</span> buy_amt) <span class="sc">%&gt;%</span> <span class="fu">select</span>(dollars) <span class="sc">%&gt;%</span> <span class="fu">sum</span>()</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">exists</span>(<span class="st">"actions"</span>)){actions <span class="ot">&lt;-</span> actions <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>(sell)}<span class="cf">else</span>{actions <span class="ot">&lt;-</span> sell}</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>      cur_stocks <span class="ot">&lt;-</span> cur_stocks <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>symbol <span class="sc">%in%</span> (sell <span class="sc">%&gt;%</span> .<span class="sc">$</span>symbol))</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>      buy <span class="ot">&lt;-</span> res <span class="sc">%&gt;%</span> <span class="fu">filter</span>(date <span class="sc">==</span> d <span class="sc">&amp;</span> pred <span class="sc">&gt;</span> close)</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>      id <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(buy), <span class="fu">floor</span>(bank <span class="sc">/</span> buy_amt), <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>      bank <span class="ot">&lt;-</span> bank <span class="sc">-</span> <span class="fu">floor</span>(bank <span class="sc">/</span> buy_amt) <span class="sc">*</span> buy_amt</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>      cur_stocks <span class="ot">&lt;-</span> cur_stocks <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>(buy <span class="sc">%&gt;%</span> <span class="fu">slice</span>(id) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>new_close, <span class="sc">-</span>pred))</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>  actions <span class="sc">%&gt;%</span> </span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dollars =</span> gain <span class="sc">*</span> buy_amt) <span class="sc">%&gt;%</span> </span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(dollars) <span class="sc">%&gt;%</span> </span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>() <span class="sc">-</span> buy_amt <span class="sc">*</span> <span class="fu">nrow</span>(actions)</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>}, <span class="at">.options =</span> <span class="fu">furrr_options</span>(<span class="at">seed =</span> T)) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>()</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(temp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   2567    3950    4786    5054    5907    8634 </code></pre>
</div>
</div>
</section>
<section id="some-plots" class="level3">
<h3 class="anchored" data-anchor-id="some-plots">Some Plots</h3>
<p>Predicted versus actual close price. There’s a noticeable error or predicting slightly higher than the actual close price.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>res <span class="sc">%&gt;%</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope=</span><span class="dv">1</span>, <span class="at">color=</span><span class="st">'red'</span>, <span class="at">linewidth=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>new_close, <span class="at">y=</span>pred), <span class="at">alpha=</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Actual Close Price"</span>) <span class="sc">+</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Predicted Close Price"</span>) <span class="sc">+</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>These were nine of the top performing stocks in 2021, if I remember right. Just seeing how they look in 2022 and how closely the model predictions match actual close prices for various individual stocks.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>top9 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"DXCM"</span>, <span class="st">"AMD"</span>, <span class="st">"URI"</span>, <span class="st">"NFLX"</span>, <span class="st">"NVDA"</span>, <span class="st">"MU"</span>, <span class="st">"FCX"</span>, <span class="st">"ABMD"</span>, <span class="st">"FTNT"</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(res <span class="sc">%&gt;%</span> <span class="fu">filter</span>(date <span class="sc">&gt;=</span> <span class="st">"2022-01-01"</span> <span class="sc">&amp;</span> symbol <span class="sc">%in%</span> top9)) <span class="sc">+</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>date, <span class="at">y=</span>new_close, <span class="at">group=</span>symbol), <span class="at">size=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>date<span class="dv">-3</span>, <span class="at">y=</span>pred), <span class="at">color=</span><span class="st">"red"</span>, <span class="at">size=</span><span class="dv">2</span>, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_trans</span>(<span class="at">y=</span><span class="st">"log10"</span>) <span class="sc">+</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>symbol) <span class="sc">+</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Close"</span>) <span class="sc">+</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"2022 Closing Prices</span><span class="sc">\n</span><span class="st">Actual: Black, Predicted: Red"</span>) <span class="sc">+</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid" width="672"></p>
</div>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'alternate';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb30" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Stock Picker"</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Train a model to predict future stock prices."</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "John King"</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "1/16/2023"</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-copy: true</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co">    df-print: paged</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="co">  - R</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="co">  - predictive modeling</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="co">  - machine learning</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="co">  - stocks</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> "teaser.jpg"</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>In the Summer of 2022, a colleague shared some scripts he had written to identify stocks that had a high probability of increasing their value 20 days in the future. I don't want to give away his methodology, so I'll just say that the scripts fit two models for each individual stock, and there were more than 7,000 stocks. It was an interesting approach, and I worked on just getting the scripts to be more efficient. Eventually, I was able to get the whole process to run about 2.5x faster, which translated into several hours.</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>He said that he had very good success with the model results, but occasionally would make a bad pick that would tank. Another downside was that each time he was ready to buy a new stock, he'd have to re-run the script to get the most up to date predictions. His approach got me interested in trying a completely different method. It seemed to me that there ought to be some fundamental similarities about stock market behavior that all stocks share, so instead of fitting one model for every stock, how about fitting one model for any stock. To reduce the risk of buying something that would completely tank, I decided to just limit the data to just S&amp;P 500 stocks.</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>To test that idea out, this script downloads market indices (<span class="in">`idx`</span>) and S&amp;P 500 stock histories (<span class="in">`sp500`</span>) since 2007. Stock and index data are joined into one large dataframe <span class="in">`df_joined`</span>. The data is then ordered and split into training and test sets. A <span class="in">`tabnet`</span> model is tuned on the training set, and the hyperparameters from the best fit model are used to train the final model. Although the model is trained on S&amp;P 500 stocks only, the stock symbol was not included as a predictor variable, and so the model may be used to predict any stock's future close price . There is only one predictive model, and it's a regression model that predicts a stock's closing price 3 days in the future.</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>So here we go. First, load some packages.</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(quantmod)   <span class="co"># quantitative financial modeling</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)      <span class="co"># for map and reduce functions</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels) <span class="co"># for model fitting</span></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tabnet)     <span class="co"># the predictive model</span></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly)</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>Other packages used but not loaded into the namespace are:</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`yfR`</span>: a yahoo finance for R package.</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`future`</span>: for parallel processing.</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`zoo`</span>: for rolling functions.</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`TTR`</span>: Technical Trading Rules for stock market indicator functions.</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`vip`</span>: for variable importance plots.</span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`cvms`</span>: for a nice looking confusion matrix.</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`torch`</span>: for the <span class="in">`tabnet`</span> neural network engine.</span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a><span class="fu">## S&amp;P 500 Historical Stock Prices</span></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>Since this takes a while, you might want to save it to disk so you can re-use the data without having to re-download everything.</span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"future::multisession"</span>)</span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>sp500 <span class="ot">&lt;-</span> yfR<span class="sc">::</span><span class="fu">yf_collection_get</span>(<span class="st">"SP500"</span>, </span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>                                <span class="at">do_parallel =</span> <span class="cn">TRUE</span>, </span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>                                <span class="at">first_date =</span> <span class="st">"2007-01-01"</span>)</span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"sequential"</span>)</span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a>sp500 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"sp500_history.Rdata"</span>)</span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a>Clean up the dataframe and rename columns.</span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a>sp500 <span class="ot">&lt;-</span> sp500 <span class="sc">%&gt;%</span></span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>ret_adjusted_prices, <span class="sc">-</span>ret_closing_prices) <span class="sc">%&gt;%</span></span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(<span class="sc">~</span><span class="fu">c</span>(<span class="st">"Symbol"</span>, <span class="st">"Date"</span>, <span class="st">"Open"</span>, <span class="st">"High"</span>, <span class="st">"Low"</span>, <span class="st">"Close"</span>, <span class="st">"Volume"</span>, <span class="st">"Adj_Close"</span> ))</span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a><span class="fu">## Add Predictor Variables</span></span>
<span id="cb30-89"><a href="#cb30-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-90"><a href="#cb30-90" aria-hidden="true" tabindex="-1"></a>Group by stock symbol and do some feature engineering to add predictor variables.</span>
<span id="cb30-91"><a href="#cb30-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-94"><a href="#cb30-94" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-95"><a href="#cb30-95" aria-hidden="true" tabindex="-1"></a>sp500 <span class="ot">&lt;-</span> sp500 <span class="sc">%&gt;%</span></span>
<span id="cb30-96"><a href="#cb30-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Symbol) <span class="sc">%&gt;%</span></span>
<span id="cb30-97"><a href="#cb30-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-98"><a href="#cb30-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">Date =</span> <span class="fu">as.Date</span>(Date,<span class="at">format=</span><span class="st">"%Y-%m-%d"</span>),</span>
<span id="cb30-99"><a href="#cb30-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">Day_of_week =</span> <span class="fu">as.factor</span>(<span class="fu">weekdays</span>(Date)),</span>
<span id="cb30-100"><a href="#cb30-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">Month =</span> <span class="fu">as.factor</span>(<span class="fu">month</span>(Date)),</span>
<span id="cb30-101"><a href="#cb30-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">Volatility =</span> (High <span class="sc">-</span> Low) <span class="sc">/</span> Close,</span>
<span id="cb30-102"><a href="#cb30-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">seven_day_volume_avg =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(Volume, <span class="at">k=</span><span class="dv">7</span>, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb30-103"><a href="#cb30-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">seven_day_volatility_avg =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(Volatility, <span class="at">k=</span><span class="dv">7</span>, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb30-104"><a href="#cb30-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">seven_day_trend =</span> (Close<span class="sc">-</span>(dplyr<span class="sc">::</span><span class="fu">lag</span>(Close,<span class="at">n=</span><span class="dv">7</span>,<span class="at">default =</span> <span class="cn">NA</span>))) <span class="sc">/</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(Close,<span class="at">n=</span><span class="dv">7</span>,<span class="at">default =</span> <span class="cn">NA</span>),</span>
<span id="cb30-105"><a href="#cb30-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">seven_day_volume_trend =</span> (seven_day_volume_avg<span class="sc">-</span>(dplyr<span class="sc">::</span><span class="fu">lag</span>(seven_day_volume_avg, <span class="at">n=</span><span class="dv">7</span>, <span class="at">default =</span> <span class="cn">NA</span>))) <span class="sc">/</span></span>
<span id="cb30-106"><a href="#cb30-106" aria-hidden="true" tabindex="-1"></a>      (dplyr<span class="sc">::</span><span class="fu">lag</span>(seven_day_volume_avg, <span class="at">n=</span><span class="dv">7</span>, <span class="at">default =</span> <span class="cn">NA</span>)),</span>
<span id="cb30-107"><a href="#cb30-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">local_20_max =</span> zoo<span class="sc">::</span><span class="fu">rollapplyr</span>(Close, <span class="dv">20</span>, max, <span class="at">partial=</span><span class="cn">TRUE</span>),</span>
<span id="cb30-108"><a href="#cb30-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">local_20_min =</span> zoo<span class="sc">::</span><span class="fu">rollapplyr</span>(Close, <span class="dv">20</span>, min, <span class="at">partial=</span><span class="cn">TRUE</span>),</span>
<span id="cb30-109"><a href="#cb30-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff_from_local_max =</span> Close <span class="sc">-</span> local_20_max,</span>
<span id="cb30-110"><a href="#cb30-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff_from_local_min =</span> Close <span class="sc">-</span> local_20_min,</span>
<span id="cb30-111"><a href="#cb30-111" aria-hidden="true" tabindex="-1"></a>    <span class="at">local_range =</span> (local_20_max <span class="sc">-</span> local_20_min) <span class="sc">/</span> Close,</span>
<span id="cb30-112"><a href="#cb30-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">trade_vol_5mov_avg =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(Volume, <span class="at">k =</span> <span class="dv">5</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb30-113"><a href="#cb30-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff_ma_20 =</span> Close <span class="sc">-</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(Close, <span class="at">k =</span> <span class="dv">20</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>)</span>
<span id="cb30-114"><a href="#cb30-114" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-115"><a href="#cb30-115" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-116"><a href="#cb30-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-117"><a href="#cb30-117" aria-hidden="true" tabindex="-1"></a>I iterated on this a while to assess model performance using different additional predictor variables. This is what I eventually settled on.</span>
<span id="cb30-118"><a href="#cb30-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-121"><a href="#cb30-121" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-122"><a href="#cb30-122" aria-hidden="true" tabindex="-1"></a>sp500 <span class="ot">&lt;-</span> sp500 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb30-123"><a href="#cb30-123" aria-hidden="true" tabindex="-1"></a>  <span class="at">three_day_change =</span> Close <span class="sc">-</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(Close, <span class="at">n=</span><span class="dv">3</span>),</span>
<span id="cb30-124"><a href="#cb30-124" aria-hidden="true" tabindex="-1"></a>  <span class="at">rel_strength_index =</span> TTR<span class="sc">::</span><span class="fu">RSI</span>(Close, <span class="at">n=</span><span class="dv">14</span>),</span>
<span id="cb30-125"><a href="#cb30-125" aria-hidden="true" tabindex="-1"></a>  <span class="at">MACD =</span> TTR<span class="sc">::</span><span class="fu">MACD</span>(Close, <span class="at">nFast=</span><span class="dv">12</span>, <span class="at">nSlow=</span><span class="dv">26</span>, <span class="at">nSig=</span><span class="dv">9</span>, <span class="at">maType=</span><span class="st">"EMA"</span>),</span>
<span id="cb30-126"><a href="#cb30-126" aria-hidden="true" tabindex="-1"></a>  <span class="at">macd =</span> <span class="fu">unlist</span>(MACD)[, <span class="dv">1</span>],</span>
<span id="cb30-127"><a href="#cb30-127" aria-hidden="true" tabindex="-1"></a>  <span class="at">macd_signal =</span> <span class="fu">unlist</span>(MACD)[, <span class="dv">2</span>],</span>
<span id="cb30-128"><a href="#cb30-128" aria-hidden="true" tabindex="-1"></a>  <span class="at">macd_above_signal =</span> macd <span class="sc">-</span> macd_signal,</span>
<span id="cb30-129"><a href="#cb30-129" aria-hidden="true" tabindex="-1"></a>  <span class="at">SO =</span> TTR<span class="sc">::</span><span class="fu">stoch</span>(Close),</span>
<span id="cb30-130"><a href="#cb30-130" aria-hidden="true" tabindex="-1"></a>  <span class="at">fastK =</span> <span class="fu">unlist</span>(SO)[, <span class="dv">1</span>],</span>
<span id="cb30-131"><a href="#cb30-131" aria-hidden="true" tabindex="-1"></a>  <span class="at">fastD =</span> <span class="fu">unlist</span>(SO)[, <span class="dv">2</span>],</span>
<span id="cb30-132"><a href="#cb30-132" aria-hidden="true" tabindex="-1"></a>  <span class="at">slowD =</span> <span class="fu">unlist</span>(SO)[, <span class="dv">3</span>],</span>
<span id="cb30-133"><a href="#cb30-133" aria-hidden="true" tabindex="-1"></a>  <span class="at">BB =</span> TTR<span class="sc">::</span><span class="fu">BBands</span>(Close),</span>
<span id="cb30-134"><a href="#cb30-134" aria-hidden="true" tabindex="-1"></a>  <span class="at">bb_dn =</span> <span class="fu">unlist</span>(BB)[, <span class="dv">1</span>],</span>
<span id="cb30-135"><a href="#cb30-135" aria-hidden="true" tabindex="-1"></a>  <span class="at">bb_mavg =</span> <span class="fu">unlist</span>(BB)[, <span class="dv">2</span>],</span>
<span id="cb30-136"><a href="#cb30-136" aria-hidden="true" tabindex="-1"></a>  <span class="at">bb_up =</span> <span class="fu">unlist</span>(BB)[, <span class="dv">3</span>],</span>
<span id="cb30-137"><a href="#cb30-137" aria-hidden="true" tabindex="-1"></a>  <span class="at">bb_pctB =</span> <span class="fu">unlist</span>(BB)[, <span class="dv">4</span>],</span>
<span id="cb30-138"><a href="#cb30-138" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> dplyr<span class="sc">::</span><span class="fu">lead</span>(Close, <span class="at">n=</span><span class="dv">3</span>, <span class="at">default =</span> <span class="cn">NA</span>) <span class="co"># the response (or outcome) variable</span></span>
<span id="cb30-139"><a href="#cb30-139" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>MACD, <span class="sc">-</span>SO, <span class="sc">-</span>BB)</span>
<span id="cb30-140"><a href="#cb30-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-141"><a href="#cb30-141" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sp500)</span>
<span id="cb30-142"><a href="#cb30-142" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-143"><a href="#cb30-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-144"><a href="#cb30-144" aria-hidden="true" tabindex="-1"></a>Now that I have the S&amp;P 500 stocks, I'm going to get the historical data for five major stock indexes, <span class="in">`IV_vars`</span>.</span>
<span id="cb30-145"><a href="#cb30-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-148"><a href="#cb30-148" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-149"><a href="#cb30-149" aria-hidden="true" tabindex="-1"></a>IV_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"NDAQ"</span>,<span class="st">"SPY"</span>,<span class="st">"CBOE"</span>,<span class="st">"GS"</span>,<span class="st">"^VIX"</span>) </span>
<span id="cb30-150"><a href="#cb30-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-151"><a href="#cb30-151" aria-hidden="true" tabindex="-1"></a>idx <span class="ot">&lt;-</span> IV_vars <span class="sc">%&gt;%</span> <span class="fu">map</span>(<span class="cf">function</span>(symbol){</span>
<span id="cb30-152"><a href="#cb30-152" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-153"><a href="#cb30-153" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(</span>
<span id="cb30-154"><a href="#cb30-154" aria-hidden="true" tabindex="-1"></a>    <span class="fu">getSymbols</span>(<span class="at">Symbols =</span> symbol, </span>
<span id="cb30-155"><a href="#cb30-155" aria-hidden="true" tabindex="-1"></a>               <span class="at">reload.Symbols =</span> <span class="cn">FALSE</span>, </span>
<span id="cb30-156"><a href="#cb30-156" aria-hidden="true" tabindex="-1"></a>               <span class="at">warnings =</span> <span class="cn">FALSE</span>, </span>
<span id="cb30-157"><a href="#cb30-157" aria-hidden="true" tabindex="-1"></a>               <span class="at">auto.assign =</span> <span class="cn">FALSE</span>),</span>
<span id="cb30-158"><a href="#cb30-158" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> <span class="st">"Date"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-159"><a href="#cb30-159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename_with</span>(<span class="sc">~</span><span class="fu">c</span>(<span class="st">"Date"</span>,<span class="st">"Open"</span>,<span class="st">"High"</span>,<span class="st">"Low"</span>,<span class="st">"Close"</span>,<span class="st">"Volume"</span>,<span class="st">"Adj_Close"</span> ))</span>
<span id="cb30-160"><a href="#cb30-160" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-161"><a href="#cb30-161" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (symbol <span class="sc">==</span> <span class="st">"^VIX"</span>){symbol <span class="ot">&lt;-</span> <span class="st">"VIX"</span>}</span>
<span id="cb30-162"><a href="#cb30-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-163"><a href="#cb30-163" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb30-164"><a href="#cb30-164" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb30-165"><a href="#cb30-165" aria-hidden="true" tabindex="-1"></a>      <span class="at">Date =</span> <span class="fu">as.Date</span>(Date, <span class="at">format=</span><span class="st">"%Y-%m-%d"</span>),</span>
<span id="cb30-166"><a href="#cb30-166" aria-hidden="true" tabindex="-1"></a>      <span class="at">Volatility =</span> (High <span class="sc">-</span> Low) <span class="sc">/</span> Close,</span>
<span id="cb30-167"><a href="#cb30-167" aria-hidden="true" tabindex="-1"></a>      <span class="at">seven_day_volume_avg =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(Volume, <span class="at">k=</span><span class="dv">7</span>, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb30-168"><a href="#cb30-168" aria-hidden="true" tabindex="-1"></a>      <span class="at">seven_day_volatility_avg =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(Volatility, <span class="at">k=</span><span class="dv">7</span>, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb30-169"><a href="#cb30-169" aria-hidden="true" tabindex="-1"></a>      <span class="at">seven_day_trend =</span> (Close<span class="sc">-</span>(dplyr<span class="sc">::</span><span class="fu">lag</span>(Close,<span class="at">n=</span><span class="dv">7</span>,<span class="at">default =</span> <span class="cn">NA</span>))) <span class="sc">/</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(Close,<span class="at">n=</span><span class="dv">7</span>,<span class="at">default =</span> <span class="cn">NA</span>),</span>
<span id="cb30-170"><a href="#cb30-170" aria-hidden="true" tabindex="-1"></a>      <span class="at">local_20_max =</span> zoo<span class="sc">::</span><span class="fu">rollapplyr</span>(Close, <span class="dv">20</span>, max, <span class="at">partial=</span><span class="cn">TRUE</span>),</span>
<span id="cb30-171"><a href="#cb30-171" aria-hidden="true" tabindex="-1"></a>      <span class="at">local_20_min =</span> zoo<span class="sc">::</span><span class="fu">rollapplyr</span>(Close, <span class="dv">20</span>, min, <span class="at">partial=</span><span class="cn">TRUE</span>),</span>
<span id="cb30-172"><a href="#cb30-172" aria-hidden="true" tabindex="-1"></a>      <span class="at">diff_from_local_max =</span> Close <span class="sc">-</span> local_20_max,</span>
<span id="cb30-173"><a href="#cb30-173" aria-hidden="true" tabindex="-1"></a>      <span class="at">diff_from_local_min =</span> Close <span class="sc">-</span> local_20_min,</span>
<span id="cb30-174"><a href="#cb30-174" aria-hidden="true" tabindex="-1"></a>      <span class="at">local_range =</span> (local_20_max <span class="sc">-</span> local_20_min) <span class="sc">/</span> Close</span>
<span id="cb30-175"><a href="#cb30-175" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb30-176"><a href="#cb30-176" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>Open, <span class="sc">-</span>High, <span class="sc">-</span>Low, <span class="sc">-</span>Adj_Close, <span class="sc">-</span>local_20_min, <span class="sc">-</span>local_20_max)</span>
<span id="cb30-177"><a href="#cb30-177" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-178"><a href="#cb30-178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Date"</span>, <span class="fu">paste</span>(symbol, <span class="fu">colnames</span>(df)[<span class="dv">2</span><span class="sc">:</span><span class="dv">10</span>], <span class="at">sep=</span><span class="st">"_"</span>))</span>
<span id="cb30-179"><a href="#cb30-179" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-180"><a href="#cb30-180" aria-hidden="true" tabindex="-1"></a>  df</span>
<span id="cb30-181"><a href="#cb30-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-182"><a href="#cb30-182" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">reduce</span>(left_join, <span class="at">by=</span><span class="st">"Date"</span>)</span>
<span id="cb30-183"><a href="#cb30-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-184"><a href="#cb30-184" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(idx)</span>
<span id="cb30-185"><a href="#cb30-185" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-186"><a href="#cb30-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-187"><a href="#cb30-187" aria-hidden="true" tabindex="-1"></a>Now I join the stock dataframe to the index dataframe, eliminate some columns, and drop <span class="in">`NA`</span>s.</span>
<span id="cb30-188"><a href="#cb30-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-191"><a href="#cb30-191" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-192"><a href="#cb30-192" aria-hidden="true" tabindex="-1"></a>df_joined <span class="ot">&lt;-</span> sp500 <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-193"><a href="#cb30-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(idx, <span class="at">by =</span> <span class="st">"Date"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb30-194"><a href="#cb30-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb30-195"><a href="#cb30-195" aria-hidden="true" tabindex="-1"></a>    y,</span>
<span id="cb30-196"><a href="#cb30-196" aria-hidden="true" tabindex="-1"></a>    Symbol,</span>
<span id="cb30-197"><a href="#cb30-197" aria-hidden="true" tabindex="-1"></a>    Close, </span>
<span id="cb30-198"><a href="#cb30-198" aria-hidden="true" tabindex="-1"></a>    Date,</span>
<span id="cb30-199"><a href="#cb30-199" aria-hidden="true" tabindex="-1"></a>    diff_ma_20,</span>
<span id="cb30-200"><a href="#cb30-200" aria-hidden="true" tabindex="-1"></a>    macd,</span>
<span id="cb30-201"><a href="#cb30-201" aria-hidden="true" tabindex="-1"></a>    macd_signal,</span>
<span id="cb30-202"><a href="#cb30-202" aria-hidden="true" tabindex="-1"></a>    macd_above_signal,</span>
<span id="cb30-203"><a href="#cb30-203" aria-hidden="true" tabindex="-1"></a>    three_day_change,</span>
<span id="cb30-204"><a href="#cb30-204" aria-hidden="true" tabindex="-1"></a>    rel_strength_index,</span>
<span id="cb30-205"><a href="#cb30-205" aria-hidden="true" tabindex="-1"></a>    fastK,</span>
<span id="cb30-206"><a href="#cb30-206" aria-hidden="true" tabindex="-1"></a>    fastD,</span>
<span id="cb30-207"><a href="#cb30-207" aria-hidden="true" tabindex="-1"></a>    slowD,</span>
<span id="cb30-208"><a href="#cb30-208" aria-hidden="true" tabindex="-1"></a>    bb_dn,</span>
<span id="cb30-209"><a href="#cb30-209" aria-hidden="true" tabindex="-1"></a>    bb_mavg,</span>
<span id="cb30-210"><a href="#cb30-210" aria-hidden="true" tabindex="-1"></a>    bb_up,</span>
<span id="cb30-211"><a href="#cb30-211" aria-hidden="true" tabindex="-1"></a>    bb_pctB,</span>
<span id="cb30-212"><a href="#cb30-212" aria-hidden="true" tabindex="-1"></a>    Volume, </span>
<span id="cb30-213"><a href="#cb30-213" aria-hidden="true" tabindex="-1"></a>    Volatility, </span>
<span id="cb30-214"><a href="#cb30-214" aria-hidden="true" tabindex="-1"></a>    seven_day_volume_avg, </span>
<span id="cb30-215"><a href="#cb30-215" aria-hidden="true" tabindex="-1"></a>    seven_day_volatility_avg, </span>
<span id="cb30-216"><a href="#cb30-216" aria-hidden="true" tabindex="-1"></a>    seven_day_trend, </span>
<span id="cb30-217"><a href="#cb30-217" aria-hidden="true" tabindex="-1"></a>    seven_day_volume_trend, </span>
<span id="cb30-218"><a href="#cb30-218" aria-hidden="true" tabindex="-1"></a>    local_20_max, </span>
<span id="cb30-219"><a href="#cb30-219" aria-hidden="true" tabindex="-1"></a>    local_20_min, </span>
<span id="cb30-220"><a href="#cb30-220" aria-hidden="true" tabindex="-1"></a>    diff_from_local_max, </span>
<span id="cb30-221"><a href="#cb30-221" aria-hidden="true" tabindex="-1"></a>    diff_from_local_min, </span>
<span id="cb30-222"><a href="#cb30-222" aria-hidden="true" tabindex="-1"></a>    local_range, </span>
<span id="cb30-223"><a href="#cb30-223" aria-hidden="true" tabindex="-1"></a>    NDAQ_Close, </span>
<span id="cb30-224"><a href="#cb30-224" aria-hidden="true" tabindex="-1"></a>    NDAQ_Volatility, </span>
<span id="cb30-225"><a href="#cb30-225" aria-hidden="true" tabindex="-1"></a>    NDAQ_Volume, </span>
<span id="cb30-226"><a href="#cb30-226" aria-hidden="true" tabindex="-1"></a>    NDAQ_Volume, </span>
<span id="cb30-227"><a href="#cb30-227" aria-hidden="true" tabindex="-1"></a>    NDAQ_seven_day_volume_avg, </span>
<span id="cb30-228"><a href="#cb30-228" aria-hidden="true" tabindex="-1"></a>    NDAQ_seven_day_volatility_avg, </span>
<span id="cb30-229"><a href="#cb30-229" aria-hidden="true" tabindex="-1"></a>    NDAQ_seven_day_trend, </span>
<span id="cb30-230"><a href="#cb30-230" aria-hidden="true" tabindex="-1"></a>    NDAQ_diff_from_local_max, </span>
<span id="cb30-231"><a href="#cb30-231" aria-hidden="true" tabindex="-1"></a>    NDAQ_diff_from_local_min, </span>
<span id="cb30-232"><a href="#cb30-232" aria-hidden="true" tabindex="-1"></a>    NDAQ_local_range, </span>
<span id="cb30-233"><a href="#cb30-233" aria-hidden="true" tabindex="-1"></a>    SPY_Close, </span>
<span id="cb30-234"><a href="#cb30-234" aria-hidden="true" tabindex="-1"></a>    SPY_Volatility, </span>
<span id="cb30-235"><a href="#cb30-235" aria-hidden="true" tabindex="-1"></a>    SPY_Volume, </span>
<span id="cb30-236"><a href="#cb30-236" aria-hidden="true" tabindex="-1"></a>    SPY_seven_day_volume_avg, </span>
<span id="cb30-237"><a href="#cb30-237" aria-hidden="true" tabindex="-1"></a>    SPY_seven_day_volatility_avg, </span>
<span id="cb30-238"><a href="#cb30-238" aria-hidden="true" tabindex="-1"></a>    SPY_seven_day_trend, </span>
<span id="cb30-239"><a href="#cb30-239" aria-hidden="true" tabindex="-1"></a>    SPY_diff_from_local_max, </span>
<span id="cb30-240"><a href="#cb30-240" aria-hidden="true" tabindex="-1"></a>    SPY_diff_from_local_min, </span>
<span id="cb30-241"><a href="#cb30-241" aria-hidden="true" tabindex="-1"></a>    SPY_local_range, </span>
<span id="cb30-242"><a href="#cb30-242" aria-hidden="true" tabindex="-1"></a>    GS_Close, </span>
<span id="cb30-243"><a href="#cb30-243" aria-hidden="true" tabindex="-1"></a>    GS_Volatility, </span>
<span id="cb30-244"><a href="#cb30-244" aria-hidden="true" tabindex="-1"></a>    GS_Volume, </span>
<span id="cb30-245"><a href="#cb30-245" aria-hidden="true" tabindex="-1"></a>    GS_seven_day_volume_avg, </span>
<span id="cb30-246"><a href="#cb30-246" aria-hidden="true" tabindex="-1"></a>    GS_seven_day_volatility_avg, </span>
<span id="cb30-247"><a href="#cb30-247" aria-hidden="true" tabindex="-1"></a>    GS_seven_day_trend, </span>
<span id="cb30-248"><a href="#cb30-248" aria-hidden="true" tabindex="-1"></a>    GS_diff_from_local_max, </span>
<span id="cb30-249"><a href="#cb30-249" aria-hidden="true" tabindex="-1"></a>    GS_diff_from_local_min, </span>
<span id="cb30-250"><a href="#cb30-250" aria-hidden="true" tabindex="-1"></a>    GS_local_range, </span>
<span id="cb30-251"><a href="#cb30-251" aria-hidden="true" tabindex="-1"></a>    CBOE_Close, </span>
<span id="cb30-252"><a href="#cb30-252" aria-hidden="true" tabindex="-1"></a>    CBOE_Volatility, </span>
<span id="cb30-253"><a href="#cb30-253" aria-hidden="true" tabindex="-1"></a>    CBOE_Volume, </span>
<span id="cb30-254"><a href="#cb30-254" aria-hidden="true" tabindex="-1"></a>    CBOE_seven_day_volume_avg, </span>
<span id="cb30-255"><a href="#cb30-255" aria-hidden="true" tabindex="-1"></a>    CBOE_seven_day_volatility_avg, </span>
<span id="cb30-256"><a href="#cb30-256" aria-hidden="true" tabindex="-1"></a>    CBOE_seven_day_trend, </span>
<span id="cb30-257"><a href="#cb30-257" aria-hidden="true" tabindex="-1"></a>    CBOE_diff_from_local_max, </span>
<span id="cb30-258"><a href="#cb30-258" aria-hidden="true" tabindex="-1"></a>    CBOE_diff_from_local_min, </span>
<span id="cb30-259"><a href="#cb30-259" aria-hidden="true" tabindex="-1"></a>    CBOE_local_range, </span>
<span id="cb30-260"><a href="#cb30-260" aria-hidden="true" tabindex="-1"></a>    VIX_Close, </span>
<span id="cb30-261"><a href="#cb30-261" aria-hidden="true" tabindex="-1"></a>    VIX_Volatility, </span>
<span id="cb30-262"><a href="#cb30-262" aria-hidden="true" tabindex="-1"></a>    VIX_seven_day_volatility_avg, </span>
<span id="cb30-263"><a href="#cb30-263" aria-hidden="true" tabindex="-1"></a>    VIX_seven_day_trend</span>
<span id="cb30-264"><a href="#cb30-264" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-265"><a href="#cb30-265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb30-266"><a href="#cb30-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-267"><a href="#cb30-267" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_joined)</span>
<span id="cb30-268"><a href="#cb30-268" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-269"><a href="#cb30-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-270"><a href="#cb30-270" aria-hidden="true" tabindex="-1"></a>Again, you might want to save this to disk so you don't have to keep repeating the above steps.</span>
<span id="cb30-271"><a href="#cb30-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-272"><a href="#cb30-272" aria-hidden="true" tabindex="-1"></a>One stock (NVR) trades at over \$4,000/share. It's so much higher than all of the others, I decided to eliminate it from training and testing.</span>
<span id="cb30-273"><a href="#cb30-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-276"><a href="#cb30-276" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-277"><a href="#cb30-277" aria-hidden="true" tabindex="-1"></a>df_joined <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Close <span class="sc">&gt;</span> <span class="dv">4000</span>) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(Symbol)</span>
<span id="cb30-278"><a href="#cb30-278" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-279"><a href="#cb30-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-280"><a href="#cb30-280" aria-hidden="true" tabindex="-1"></a>For speed purposes, I'm going to train on just the data since 2017.</span>
<span id="cb30-281"><a href="#cb30-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-284"><a href="#cb30-284" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-285"><a href="#cb30-285" aria-hidden="true" tabindex="-1"></a>df_joined5 <span class="ot">&lt;-</span> df_joined <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Date <span class="sc">&gt;=</span> <span class="st">"2017-01-01"</span> <span class="sc">&amp;</span> Symbol <span class="sc">!=</span> <span class="st">"NVR"</span>) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(Date)</span>
<span id="cb30-286"><a href="#cb30-286" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-287"><a href="#cb30-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-288"><a href="#cb30-288" aria-hidden="true" tabindex="-1"></a>This demonstrates how a naive stock picker would have fared in 2022 (as of Summer 2022). I'll need to at least beat this benchmark.</span>
<span id="cb30-289"><a href="#cb30-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-292"><a href="#cb30-292" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-293"><a href="#cb30-293" aria-hidden="true" tabindex="-1"></a>df_joined <span class="sc">%&gt;%</span></span>
<span id="cb30-294"><a href="#cb30-294" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Date <span class="sc">&gt;=</span> <span class="st">"2022-01-01"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-295"><a href="#cb30-295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">inc =</span> y <span class="sc">&gt;</span> Close) <span class="sc">%&gt;%</span></span>
<span id="cb30-296"><a href="#cb30-296" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">year_2022 =</span> <span class="fu">sum</span>(inc)) <span class="sc">/</span> <span class="dv">58033</span></span>
<span id="cb30-297"><a href="#cb30-297" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-298"><a href="#cb30-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-299"><a href="#cb30-299" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hyperparameter Tuning</span></span>
<span id="cb30-300"><a href="#cb30-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-301"><a href="#cb30-301" aria-hidden="true" tabindex="-1"></a>Now I create train and test data sets. I'll train on data up to 2022-01-01, and the test data will be from that day forward. Functions below are from <span class="in">`tidymodels`</span>.</span>
<span id="cb30-302"><a href="#cb30-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-305"><a href="#cb30-305" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-306"><a href="#cb30-306" aria-hidden="true" tabindex="-1"></a>data_split <span class="ot">&lt;-</span> <span class="fu">initial_time_split</span>(df_joined5, </span>
<span id="cb30-307"><a href="#cb30-307" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">prop =</span> df_joined5 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Date <span class="sc">&lt;</span> <span class="st">"2022-01-01"</span>) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>() <span class="sc">/</span> <span class="fu">nrow</span>(df_joined5))</span>
<span id="cb30-308"><a href="#cb30-308" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(data_split) </span>
<span id="cb30-309"><a href="#cb30-309" aria-hidden="true" tabindex="-1"></a>test_data  <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_split)</span>
<span id="cb30-310"><a href="#cb30-310" aria-hidden="true" tabindex="-1"></a>val_set <span class="ot">&lt;-</span> <span class="fu">validation_split</span>(train_data, <span class="at">prop =</span> <span class="fl">0.80</span>)</span>
<span id="cb30-311"><a href="#cb30-311" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-312"><a href="#cb30-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-313"><a href="#cb30-313" aria-hidden="true" tabindex="-1"></a>Create the neural net recipe.</span>
<span id="cb30-314"><a href="#cb30-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-317"><a href="#cb30-317" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-318"><a href="#cb30-318" aria-hidden="true" tabindex="-1"></a>nn_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(y <span class="sc">~</span> ., <span class="at">data =</span> train_data <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>Symbol, <span class="sc">-</span>Date)) <span class="sc">%&gt;%</span></span>
<span id="cb30-319"><a href="#cb30-319" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb30-320"><a href="#cb30-320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-321"><a href="#cb30-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-322"><a href="#cb30-322" aria-hidden="true" tabindex="-1"></a>Define the model and parameters for tuning. Use large values for batch size. Batch size should be 2 to the order of something. Virtual batch size should be 1/8 of the batch size. Use trial and error to see how large you can go based on your GPU's dedicated memory. Mine's old and wimpy, so with validation, I have to keep it to $2^{13}$. Without validation, I can go up to $2^{15}$. This took many hours on my machine to complete, and some models failed.</span>
<span id="cb30-323"><a href="#cb30-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-326"><a href="#cb30-326" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-327"><a href="#cb30-327" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb30-328"><a href="#cb30-328" aria-hidden="true" tabindex="-1"></a>nn_mod <span class="ot">&lt;-</span></span>
<span id="cb30-329"><a href="#cb30-329" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabnet</span>(<span class="at">epochs =</span> <span class="dv">10</span>, </span>
<span id="cb30-330"><a href="#cb30-330" aria-hidden="true" tabindex="-1"></a>         <span class="at">batch_size =</span> <span class="dv">2</span><span class="sc">^</span><span class="dv">13</span>,</span>
<span id="cb30-331"><a href="#cb30-331" aria-hidden="true" tabindex="-1"></a>         <span class="at">virtual_batch_size =</span> <span class="dv">2</span><span class="sc">^</span><span class="dv">10</span>,</span>
<span id="cb30-332"><a href="#cb30-332" aria-hidden="true" tabindex="-1"></a>         <span class="at">decision_width =</span> <span class="fu">tune</span>(), </span>
<span id="cb30-333"><a href="#cb30-333" aria-hidden="true" tabindex="-1"></a>         <span class="at">attention_width =</span> <span class="fu">tune</span>(),</span>
<span id="cb30-334"><a href="#cb30-334" aria-hidden="true" tabindex="-1"></a>         <span class="at">num_steps =</span> <span class="fu">tune</span>(), </span>
<span id="cb30-335"><a href="#cb30-335" aria-hidden="true" tabindex="-1"></a>         <span class="at">penalty =</span> <span class="fu">tune</span>(), </span>
<span id="cb30-336"><a href="#cb30-336" aria-hidden="true" tabindex="-1"></a>         <span class="at">momentum =</span> <span class="fu">tune</span>(),</span>
<span id="cb30-337"><a href="#cb30-337" aria-hidden="true" tabindex="-1"></a>         <span class="at">feature_reusage =</span> <span class="fu">tune</span>(), </span>
<span id="cb30-338"><a href="#cb30-338" aria-hidden="true" tabindex="-1"></a>         <span class="at">learn_rate =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb30-339"><a href="#cb30-339" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"torch"</span>, <span class="at">device=</span><span class="st">"cuda"</span>, <span class="at">verbose=</span><span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-340"><a href="#cb30-340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb30-341"><a href="#cb30-341" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-342"><a href="#cb30-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-343"><a href="#cb30-343" aria-hidden="true" tabindex="-1"></a>Define the workflow.</span>
<span id="cb30-344"><a href="#cb30-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-347"><a href="#cb30-347" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-348"><a href="#cb30-348" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb30-349"><a href="#cb30-349" aria-hidden="true" tabindex="-1"></a>nn_wf <span class="ot">&lt;-</span> </span>
<span id="cb30-350"><a href="#cb30-350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-351"><a href="#cb30-351" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(nn_mod) <span class="sc">%&gt;%</span></span>
<span id="cb30-352"><a href="#cb30-352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(nn_rec)</span>
<span id="cb30-353"><a href="#cb30-353" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-354"><a href="#cb30-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-355"><a href="#cb30-355" aria-hidden="true" tabindex="-1"></a>Fit 25 models for tuning.</span>
<span id="cb30-356"><a href="#cb30-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-359"><a href="#cb30-359" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-360"><a href="#cb30-360" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb30-361"><a href="#cb30-361" aria-hidden="true" tabindex="-1"></a>nn_fit <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"nn_fit.Rdata"</span>)</span>
<span id="cb30-362"><a href="#cb30-362" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-363"><a href="#cb30-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-366"><a href="#cb30-366" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-367"><a href="#cb30-367" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb30-368"><a href="#cb30-368" aria-hidden="true" tabindex="-1"></a>nn_fit <span class="ot">&lt;-</span></span>
<span id="cb30-369"><a href="#cb30-369" aria-hidden="true" tabindex="-1"></a>  nn_wf <span class="sc">%&gt;%</span></span>
<span id="cb30-370"><a href="#cb30-370" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(val_set,</span>
<span id="cb30-371"><a href="#cb30-371" aria-hidden="true" tabindex="-1"></a>            <span class="at">grid =</span> <span class="dv">25</span>,</span>
<span id="cb30-372"><a href="#cb30-372" aria-hidden="true" tabindex="-1"></a>            <span class="at">control =</span> <span class="fu">control_grid</span>())</span>
<span id="cb30-373"><a href="#cb30-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-374"><a href="#cb30-374" aria-hidden="true" tabindex="-1"></a><span class="co"># see how the models performed</span></span>
<span id="cb30-375"><a href="#cb30-375" aria-hidden="true" tabindex="-1"></a>nn_fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span>
<span id="cb30-376"><a href="#cb30-376" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-377"><a href="#cb30-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-378"><a href="#cb30-378" aria-hidden="true" tabindex="-1"></a>Show the top 5 models based on root mean squared error (RMSE) and R-squared.</span>
<span id="cb30-379"><a href="#cb30-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-382"><a href="#cb30-382" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-383"><a href="#cb30-383" aria-hidden="true" tabindex="-1"></a>nn_fit <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"rmse"</span>)</span>
<span id="cb30-384"><a href="#cb30-384" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-385"><a href="#cb30-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-388"><a href="#cb30-388" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-389"><a href="#cb30-389" aria-hidden="true" tabindex="-1"></a>nn_fit <span class="sc">%&gt;%</span> <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"rsq"</span>)</span>
<span id="cb30-390"><a href="#cb30-390" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-391"><a href="#cb30-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-392"><a href="#cb30-392" aria-hidden="true" tabindex="-1"></a>You can save and reload the model results for another day.</span>
<span id="cb30-393"><a href="#cb30-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-394"><a href="#cb30-394" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Final Fit</span></span>
<span id="cb30-395"><a href="#cb30-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-396"><a href="#cb30-396" aria-hidden="true" tabindex="-1"></a>For the final fit, I went back to 2012. I tried 2007, but I kept running out of GPU memory when using the best hyperparameters ID'ed above. Side note - if I use default hyperparameter values, I can train on data back to 2007, so one or more of the hyperparameters is memory intensive.</span>
<span id="cb30-397"><a href="#cb30-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-400"><a href="#cb30-400" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-401"><a href="#cb30-401" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb30-402"><a href="#cb30-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-403"><a href="#cb30-403" aria-hidden="true" tabindex="-1"></a>data_split <span class="ot">&lt;-</span> <span class="fu">initial_time_split</span>(df_joined5, </span>
<span id="cb30-404"><a href="#cb30-404" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">prop =</span> df_joined5 <span class="sc">%&gt;%</span> </span>
<span id="cb30-405"><a href="#cb30-405" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">filter</span>(Date <span class="sc">&lt;</span> <span class="st">"2022-01-01"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb30-406"><a href="#cb30-406" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">nrow</span>() <span class="sc">/</span> <span class="fu">nrow</span>(df_joined5))</span>
<span id="cb30-407"><a href="#cb30-407" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(data_split) </span>
<span id="cb30-408"><a href="#cb30-408" aria-hidden="true" tabindex="-1"></a>test_data  <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_split)</span>
<span id="cb30-409"><a href="#cb30-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-410"><a href="#cb30-410" aria-hidden="true" tabindex="-1"></a>nn_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(y <span class="sc">~</span> ., <span class="at">data =</span> train_data <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>Symbol, <span class="sc">-</span>Date)) <span class="sc">%&gt;%</span></span>
<span id="cb30-411"><a href="#cb30-411" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb30-412"><a href="#cb30-412" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-413"><a href="#cb30-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-414"><a href="#cb30-414" aria-hidden="true" tabindex="-1"></a>Final model. I did this in 5-epoch increments just in case there were any errors.I stopped after 15 epochs since the loss had stabilized. Better to use a validation set here and stop when the validation loss bottoms out, but I had memory limitations.</span>
<span id="cb30-415"><a href="#cb30-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-418"><a href="#cb30-418" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-419"><a href="#cb30-419" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb30-420"><a href="#cb30-420" aria-hidden="true" tabindex="-1"></a>model_fit <span class="ot">&lt;-</span></span>
<span id="cb30-421"><a href="#cb30-421" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabnet_fit</span>(</span>
<span id="cb30-422"><a href="#cb30-422" aria-hidden="true" tabindex="-1"></a>    nn_rec,</span>
<span id="cb30-423"><a href="#cb30-423" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> train_data <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>Symbol, <span class="sc">-</span>Date),</span>
<span id="cb30-424"><a href="#cb30-424" aria-hidden="true" tabindex="-1"></a>    <span class="at">tabnet_model =</span> model_fit,</span>
<span id="cb30-425"><a href="#cb30-425" aria-hidden="true" tabindex="-1"></a>    <span class="at">from_epoch =</span> <span class="dv">10</span>,</span>
<span id="cb30-426"><a href="#cb30-426" aria-hidden="true" tabindex="-1"></a>    <span class="at">epochs =</span> <span class="dv">5</span>,</span>
<span id="cb30-427"><a href="#cb30-427" aria-hidden="true" tabindex="-1"></a>    <span class="at">checkpoint_epochs =</span> <span class="dv">5</span>,</span>
<span id="cb30-428"><a href="#cb30-428" aria-hidden="true" tabindex="-1"></a>    <span class="at">batch_size =</span> <span class="dv">2</span><span class="sc">^</span><span class="dv">13</span>,</span>
<span id="cb30-429"><a href="#cb30-429" aria-hidden="true" tabindex="-1"></a>    <span class="at">virtual_batch_size =</span> <span class="dv">2</span><span class="sc">^</span><span class="dv">10</span>,</span>
<span id="cb30-430"><a href="#cb30-430" aria-hidden="true" tabindex="-1"></a>    <span class="at">decision_width =</span> <span class="dv">23</span>, </span>
<span id="cb30-431"><a href="#cb30-431" aria-hidden="true" tabindex="-1"></a>    <span class="at">attention_width =</span> <span class="dv">28</span>,</span>
<span id="cb30-432"><a href="#cb30-432" aria-hidden="true" tabindex="-1"></a>    <span class="at">num_steps =</span> <span class="dv">4</span>, </span>
<span id="cb30-433"><a href="#cb30-433" aria-hidden="true" tabindex="-1"></a>    <span class="at">penalty =</span> <span class="fl">4.89e-9</span>, </span>
<span id="cb30-434"><a href="#cb30-434" aria-hidden="true" tabindex="-1"></a>    <span class="at">momentum =</span> <span class="fl">0.359</span>,</span>
<span id="cb30-435"><a href="#cb30-435" aria-hidden="true" tabindex="-1"></a>    <span class="at">feature_reusage =</span> <span class="fl">1.67</span>, </span>
<span id="cb30-436"><a href="#cb30-436" aria-hidden="true" tabindex="-1"></a>    <span class="at">learn_rate =</span> <span class="fl">0.00916</span>,</span>
<span id="cb30-437"><a href="#cb30-437" aria-hidden="true" tabindex="-1"></a>    <span class="at">device =</span> <span class="st">"cuda"</span>,</span>
<span id="cb30-438"><a href="#cb30-438" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb30-439"><a href="#cb30-439" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-440"><a href="#cb30-440" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-441"><a href="#cb30-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-442"><a href="#cb30-442" aria-hidden="true" tabindex="-1"></a>Save the final model! I highly recommend it because this model can be used for months without re-training.</span>
<span id="cb30-443"><a href="#cb30-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-446"><a href="#cb30-446" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-447"><a href="#cb30-447" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb30-448"><a href="#cb30-448" aria-hidden="true" tabindex="-1"></a>model_fit <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"tuned_model.Rdata"</span>)</span>
<span id="cb30-449"><a href="#cb30-449" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-450"><a href="#cb30-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-451"><a href="#cb30-451" aria-hidden="true" tabindex="-1"></a>Check variable importance. Pretty heavily dominated by a small number of predictors, which isn't great.</span>
<span id="cb30-452"><a href="#cb30-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-455"><a href="#cb30-455" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-456"><a href="#cb30-456" aria-hidden="true" tabindex="-1"></a>vip<span class="sc">::</span><span class="fu">vip</span>(model_fit, <span class="at">num_features =</span> <span class="dv">20</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>()</span>
<span id="cb30-457"><a href="#cb30-457" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-458"><a href="#cb30-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-459"><a href="#cb30-459" aria-hidden="true" tabindex="-1"></a>For convenience, I make a dataframe <span class="in">`res`</span> (short for results) with actual and predicted close prices and use it for checking performance.</span>
<span id="cb30-460"><a href="#cb30-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-463"><a href="#cb30-463" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-464"><a href="#cb30-464" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb30-465"><a href="#cb30-465" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> test_data<span class="sc">$</span>Date,</span>
<span id="cb30-466"><a href="#cb30-466" aria-hidden="true" tabindex="-1"></a>  <span class="at">symbol =</span> test_data<span class="sc">$</span>Symbol,</span>
<span id="cb30-467"><a href="#cb30-467" aria-hidden="true" tabindex="-1"></a>  <span class="at">close =</span> test_data<span class="sc">$</span>Close,</span>
<span id="cb30-468"><a href="#cb30-468" aria-hidden="true" tabindex="-1"></a>  <span class="at">new_close =</span> test_data<span class="sc">$</span>y,</span>
<span id="cb30-469"><a href="#cb30-469" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred =</span> <span class="fu">predict</span>(model_fit, test_data) <span class="sc">%&gt;%</span> .<span class="sc">$</span><span class="st">`</span><span class="at">.pred</span><span class="st">`</span></span>
<span id="cb30-470"><a href="#cb30-470" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-471"><a href="#cb30-471" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-472"><a href="#cb30-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-473"><a href="#cb30-473" aria-hidden="true" tabindex="-1"></a>Calculate the RMSE for the final model. Shouldn't be too different from the RMSE for the training data,</span>
<span id="cb30-474"><a href="#cb30-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-477"><a href="#cb30-477" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-478"><a href="#cb30-478" aria-hidden="true" tabindex="-1"></a>res <span class="sc">%&gt;%</span> </span>
<span id="cb30-479"><a href="#cb30-479" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">er =</span> (pred <span class="sc">-</span> new_close)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb30-480"><a href="#cb30-480" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">rmse =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>(er)))</span>
<span id="cb30-481"><a href="#cb30-481" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-482"><a href="#cb30-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-483"><a href="#cb30-483" aria-hidden="true" tabindex="-1"></a>Even though this is a regression problem, we can also look at it as if it was a classification problem and get the confusion matrix. We want lots of true-positives, of course. I'm not that concerned if the model predicts a stock will go down and it actually goes up because with a downward prediction, I wouldn't have looked at it further or risked any money on it. What I don't want are many upward predictions that actually go down.</span>
<span id="cb30-484"><a href="#cb30-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-487"><a href="#cb30-487" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-488"><a href="#cb30-488" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> res <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb30-489"><a href="#cb30-489" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_diff =</span> pred <span class="sc">-</span> close,</span>
<span id="cb30-490"><a href="#cb30-490" aria-hidden="true" tabindex="-1"></a>  <span class="at">act_diff =</span> new_close <span class="sc">-</span> close,</span>
<span id="cb30-491"><a href="#cb30-491" aria-hidden="true" tabindex="-1"></a>  <span class="at">correct =</span> <span class="fu">ifelse</span>((pred_diff <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> act_diff <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|</span> (pred_diff <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> act_diff <span class="sc">&lt;</span> <span class="dv">0</span>) , <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb30-492"><a href="#cb30-492" aria-hidden="true" tabindex="-1"></a>  <span class="at">target =</span> <span class="fu">ifelse</span>(new_close <span class="sc">&gt;</span> close, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb30-493"><a href="#cb30-493" aria-hidden="true" tabindex="-1"></a>  <span class="at">predict =</span> <span class="fu">ifelse</span>(pred <span class="sc">&gt;</span> close, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb30-494"><a href="#cb30-494" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-495"><a href="#cb30-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-496"><a href="#cb30-496" aria-hidden="true" tabindex="-1"></a>conf_mat <span class="ot">&lt;-</span> cvms<span class="sc">::</span><span class="fu">confusion_matrix</span>(</span>
<span id="cb30-497"><a href="#cb30-497" aria-hidden="true" tabindex="-1"></a>  <span class="at">targets =</span> res <span class="sc">%&gt;%</span> .<span class="sc">$</span>target,</span>
<span id="cb30-498"><a href="#cb30-498" aria-hidden="true" tabindex="-1"></a>  <span class="at">predictions =</span> res <span class="sc">%&gt;%</span> .<span class="sc">$</span>predict)</span>
<span id="cb30-499"><a href="#cb30-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-500"><a href="#cb30-500" aria-hidden="true" tabindex="-1"></a>cvms<span class="sc">::</span><span class="fu">plot_confusion_matrix</span>(conf_mat<span class="sc">$</span><span class="st">`</span><span class="at">Confusion Matrix</span><span class="st">`</span>[[<span class="dv">1</span>]]) <span class="sc">+</span> </span>
<span id="cb30-501"><a href="#cb30-501" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Tabnet Regression Accuracy"</span>)</span>
<span id="cb30-502"><a href="#cb30-502" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-503"><a href="#cb30-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-504"><a href="#cb30-504" aria-hidden="true" tabindex="-1"></a><span class="fu">## Results</span></span>
<span id="cb30-505"><a href="#cb30-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-506"><a href="#cb30-506" aria-hidden="true" tabindex="-1"></a>My results were true positives around 50% - right around the benchmark. But that got me thinking. What I'm showing is how good the model is at predicting the stock price in exactly three days. What if I buy a stock, and after three days it hasn't gone up? I'd probably hang on to it a little longer in case it goes up after 4 or 5 or <span class="sc">\_\_</span> days. Plus, if I stick to S&amp;P 500 stocks,I'm not too concerned about losing everything, so might as well hold on. Furthermore, if a stock did go up, I might also want to hang on longer to see if it keeps going up. Basically, I need a sell strategy. This might be a place for a new model, but for now I'll just hard code an approximate strategy.</span>
<span id="cb30-507"><a href="#cb30-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-508"><a href="#cb30-508" aria-hidden="true" tabindex="-1"></a>For each stock and each date, get the maximum close price over the next 10 days. Here, I'm not concerned about the amount a stock goes up or down, just that it did or did not increase in value at some point in the next 10 days. If I do this, I get a much higher true positive rate.</span>
<span id="cb30-509"><a href="#cb30-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-512"><a href="#cb30-512" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-513"><a href="#cb30-513" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> res <span class="sc">%&gt;%</span></span>
<span id="cb30-514"><a href="#cb30-514" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(symbol) <span class="sc">%&gt;%</span></span>
<span id="cb30-515"><a href="#cb30-515" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-516"><a href="#cb30-516" aria-hidden="true" tabindex="-1"></a>    <span class="at">windowmax =</span> zoo<span class="sc">::</span><span class="fu">rollmax</span>(close, <span class="at">k=</span><span class="dv">10</span>, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"left"</span>),</span>
<span id="cb30-517"><a href="#cb30-517" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> <span class="fu">ifelse</span>(predict <span class="sc">&gt;</span> target <span class="sc">&amp;</span> windowmax <span class="sc">&gt;</span> close, <span class="dv">1</span>, target)) <span class="sc">%&gt;%</span> </span>
<span id="cb30-518"><a href="#cb30-518" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb30-519"><a href="#cb30-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-520"><a href="#cb30-520" aria-hidden="true" tabindex="-1"></a>conf_mat <span class="ot">&lt;-</span> cvms<span class="sc">::</span><span class="fu">confusion_matrix</span>(</span>
<span id="cb30-521"><a href="#cb30-521" aria-hidden="true" tabindex="-1"></a>  <span class="at">targets =</span> res <span class="sc">%&gt;%</span> .<span class="sc">$</span>target,</span>
<span id="cb30-522"><a href="#cb30-522" aria-hidden="true" tabindex="-1"></a>  <span class="at">predictions =</span> res <span class="sc">%&gt;%</span> .<span class="sc">$</span>predict)</span>
<span id="cb30-523"><a href="#cb30-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-524"><a href="#cb30-524" aria-hidden="true" tabindex="-1"></a>cvms<span class="sc">::</span><span class="fu">plot_confusion_matrix</span>(conf_mat<span class="sc">$</span><span class="st">`</span><span class="at">Confusion Matrix</span><span class="st">`</span>[[<span class="dv">1</span>]]) <span class="sc">+</span> </span>
<span id="cb30-525"><a href="#cb30-525" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Tabnet Regression Accuracy"</span>)</span>
<span id="cb30-526"><a href="#cb30-526" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-527"><a href="#cb30-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-528"><a href="#cb30-528" aria-hidden="true" tabindex="-1"></a>Here, I'm getting the average return using the above sell strategy.</span>
<span id="cb30-529"><a href="#cb30-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-532"><a href="#cb30-532" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-533"><a href="#cb30-533" aria-hidden="true" tabindex="-1"></a>res <span class="sc">%&gt;%</span></span>
<span id="cb30-534"><a href="#cb30-534" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(symbol) <span class="sc">%&gt;%</span></span>
<span id="cb30-535"><a href="#cb30-535" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-536"><a href="#cb30-536" aria-hidden="true" tabindex="-1"></a>    <span class="at">windowmax =</span> <span class="fu">rollmax</span>(close, <span class="at">k=</span><span class="dv">10</span>, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"left"</span>),</span>
<span id="cb30-537"><a href="#cb30-537" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred_new =</span> <span class="fu">ifelse</span>(predict <span class="sc">&gt;</span> target <span class="sc">&amp;</span> windowmax <span class="sc">&gt;</span> close, windowmax, pred)) <span class="sc">%&gt;%</span></span>
<span id="cb30-538"><a href="#cb30-538" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(predict <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-539"><a href="#cb30-539" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gain =</span> pred_new <span class="sc">/</span> close) <span class="sc">%&gt;%</span></span>
<span id="cb30-540"><a href="#cb30-540" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-541"><a href="#cb30-541" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mean_gain =</span> <span class="fu">mean</span>(gain, <span class="at">na.rm=</span>T))</span>
<span id="cb30-542"><a href="#cb30-542" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-543"><a href="#cb30-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-544"><a href="#cb30-544" aria-hidden="true" tabindex="-1"></a><span class="fu">### Simulate Buys And Sells</span></span>
<span id="cb30-545"><a href="#cb30-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-546"><a href="#cb30-546" aria-hidden="true" tabindex="-1"></a>Given the above sell strategy and the regression model, I now conduct 30 simulations of buying and selling stocks in 2021. I'll assume I start with \$50,000 to invest, and I'll buy stocks \$5,000 at a time. I'll sell when a stock has gained at least 6%. Below is a summary of the distribution of the profits from all simulations. At least there **is** profit for 2022, which actually pretty good.</span>
<span id="cb30-547"><a href="#cb30-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-550"><a href="#cb30-550" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-551"><a href="#cb30-551" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(furrr)</span>
<span id="cb30-552"><a href="#cb30-552" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="st">"future::multisession"</span>)</span>
<span id="cb30-553"><a href="#cb30-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-554"><a href="#cb30-554" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> res <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>()</span>
<span id="cb30-555"><a href="#cb30-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-556"><a href="#cb30-556" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span> <span class="sc">%&gt;%</span> <span class="fu">future_map</span>(<span class="cf">function</span>(x){</span>
<span id="cb30-557"><a href="#cb30-557" aria-hidden="true" tabindex="-1"></a>  bank <span class="ot">&lt;-</span> <span class="dv">50000</span></span>
<span id="cb30-558"><a href="#cb30-558" aria-hidden="true" tabindex="-1"></a>  buy_amt <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb30-559"><a href="#cb30-559" aria-hidden="true" tabindex="-1"></a>  thresh <span class="ot">&lt;-</span> <span class="fl">1.06</span></span>
<span id="cb30-560"><a href="#cb30-560" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (d <span class="cf">in</span> <span class="fu">unique</span>(res<span class="sc">$</span>date)){</span>
<span id="cb30-561"><a href="#cb30-561" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(d)</span>
<span id="cb30-562"><a href="#cb30-562" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (d <span class="sc">==</span> <span class="st">"2022-01-03"</span>){</span>
<span id="cb30-563"><a href="#cb30-563" aria-hidden="true" tabindex="-1"></a>      buy <span class="ot">&lt;-</span> res <span class="sc">%&gt;%</span> <span class="fu">filter</span>(date <span class="sc">==</span> d <span class="sc">&amp;</span> pred <span class="sc">&gt;</span> close)</span>
<span id="cb30-564"><a href="#cb30-564" aria-hidden="true" tabindex="-1"></a>      id <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(buy), bank<span class="sc">/</span>buy_amt, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb30-565"><a href="#cb30-565" aria-hidden="true" tabindex="-1"></a>      cur_stocks <span class="ot">&lt;-</span> buy <span class="sc">%&gt;%</span> <span class="fu">slice</span>(id) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>new_close, <span class="sc">-</span>pred)</span>
<span id="cb30-566"><a href="#cb30-566" aria-hidden="true" tabindex="-1"></a>      bank <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb30-567"><a href="#cb30-567" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-568"><a href="#cb30-568" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-569"><a href="#cb30-569" aria-hidden="true" tabindex="-1"></a>    today <span class="ot">&lt;-</span> res <span class="sc">%&gt;%</span> <span class="fu">filter</span>(date <span class="sc">==</span> d <span class="sc">&amp;</span> symbol <span class="sc">%in%</span> (cur_stocks <span class="sc">%&gt;%</span> .<span class="sc">$</span>symbol)) <span class="sc">%&gt;%</span> </span>
<span id="cb30-570"><a href="#cb30-570" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>new_close, <span class="sc">-</span>pred) <span class="sc">%&gt;%</span></span>
<span id="cb30-571"><a href="#cb30-571" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="st">"new_close"</span> <span class="ot">=</span> <span class="st">"close"</span>, <span class="st">"new_date"</span> <span class="ot">=</span> <span class="st">"date"</span>)</span>
<span id="cb30-572"><a href="#cb30-572" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-573"><a href="#cb30-573" aria-hidden="true" tabindex="-1"></a>    sell <span class="ot">&lt;-</span> cur_stocks <span class="sc">%&gt;%</span> </span>
<span id="cb30-574"><a href="#cb30-574" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(today, <span class="at">by =</span> <span class="st">"symbol"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-575"><a href="#cb30-575" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">gain =</span> new_close <span class="sc">/</span> close) <span class="sc">%&gt;%</span></span>
<span id="cb30-576"><a href="#cb30-576" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(gain <span class="sc">&gt;=</span> thresh)</span>
<span id="cb30-577"><a href="#cb30-577" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-578"><a href="#cb30-578" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(sell) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb30-579"><a href="#cb30-579" aria-hidden="true" tabindex="-1"></a>      bank <span class="ot">&lt;-</span> bank <span class="sc">+</span> sell <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">dollars =</span> gain <span class="sc">*</span> buy_amt) <span class="sc">%&gt;%</span> <span class="fu">select</span>(dollars) <span class="sc">%&gt;%</span> <span class="fu">sum</span>()</span>
<span id="cb30-580"><a href="#cb30-580" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">exists</span>(<span class="st">"actions"</span>)){actions <span class="ot">&lt;-</span> actions <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>(sell)}<span class="cf">else</span>{actions <span class="ot">&lt;-</span> sell}</span>
<span id="cb30-581"><a href="#cb30-581" aria-hidden="true" tabindex="-1"></a>      cur_stocks <span class="ot">&lt;-</span> cur_stocks <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>symbol <span class="sc">%in%</span> (sell <span class="sc">%&gt;%</span> .<span class="sc">$</span>symbol))</span>
<span id="cb30-582"><a href="#cb30-582" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb30-583"><a href="#cb30-583" aria-hidden="true" tabindex="-1"></a>      buy <span class="ot">&lt;-</span> res <span class="sc">%&gt;%</span> <span class="fu">filter</span>(date <span class="sc">==</span> d <span class="sc">&amp;</span> pred <span class="sc">&gt;</span> close)</span>
<span id="cb30-584"><a href="#cb30-584" aria-hidden="true" tabindex="-1"></a>      id <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(buy), <span class="fu">floor</span>(bank <span class="sc">/</span> buy_amt), <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb30-585"><a href="#cb30-585" aria-hidden="true" tabindex="-1"></a>      bank <span class="ot">&lt;-</span> bank <span class="sc">-</span> <span class="fu">floor</span>(bank <span class="sc">/</span> buy_amt) <span class="sc">*</span> buy_amt</span>
<span id="cb30-586"><a href="#cb30-586" aria-hidden="true" tabindex="-1"></a>      cur_stocks <span class="ot">&lt;-</span> cur_stocks <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>(buy <span class="sc">%&gt;%</span> <span class="fu">slice</span>(id) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>new_close, <span class="sc">-</span>pred))</span>
<span id="cb30-587"><a href="#cb30-587" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb30-588"><a href="#cb30-588" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-589"><a href="#cb30-589" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-590"><a href="#cb30-590" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-591"><a href="#cb30-591" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-592"><a href="#cb30-592" aria-hidden="true" tabindex="-1"></a>  actions <span class="sc">%&gt;%</span> </span>
<span id="cb30-593"><a href="#cb30-593" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dollars =</span> gain <span class="sc">*</span> buy_amt) <span class="sc">%&gt;%</span> </span>
<span id="cb30-594"><a href="#cb30-594" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(dollars) <span class="sc">%&gt;%</span> </span>
<span id="cb30-595"><a href="#cb30-595" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>() <span class="sc">-</span> buy_amt <span class="sc">*</span> <span class="fu">nrow</span>(actions)</span>
<span id="cb30-596"><a href="#cb30-596" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-597"><a href="#cb30-597" aria-hidden="true" tabindex="-1"></a>}, <span class="at">.options =</span> <span class="fu">furrr_options</span>(<span class="at">seed =</span> T)) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>()</span>
<span id="cb30-598"><a href="#cb30-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-599"><a href="#cb30-599" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(temp)</span>
<span id="cb30-600"><a href="#cb30-600" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-601"><a href="#cb30-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-602"><a href="#cb30-602" aria-hidden="true" tabindex="-1"></a><span class="fu">### Some Plots</span></span>
<span id="cb30-603"><a href="#cb30-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-604"><a href="#cb30-604" aria-hidden="true" tabindex="-1"></a>Predicted versus actual close price. There's a noticeable error or predicting slightly higher than the actual close price.</span>
<span id="cb30-605"><a href="#cb30-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-608"><a href="#cb30-608" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-609"><a href="#cb30-609" aria-hidden="true" tabindex="-1"></a>res <span class="sc">%&gt;%</span></span>
<span id="cb30-610"><a href="#cb30-610" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb30-611"><a href="#cb30-611" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope=</span><span class="dv">1</span>, <span class="at">color=</span><span class="st">'red'</span>, <span class="at">linewidth=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb30-612"><a href="#cb30-612" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>new_close, <span class="at">y=</span>pred), <span class="at">alpha=</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb30-613"><a href="#cb30-613" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Actual Close Price"</span>) <span class="sc">+</span></span>
<span id="cb30-614"><a href="#cb30-614" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Predicted Close Price"</span>) <span class="sc">+</span></span>
<span id="cb30-615"><a href="#cb30-615" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb30-616"><a href="#cb30-616" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb30-617"><a href="#cb30-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-618"><a href="#cb30-618" aria-hidden="true" tabindex="-1"></a>These were nine of the top performing stocks in 2021, if I remember right. Just seeing how they look in 2022 and how closely the model predictions match actual close prices for various individual stocks.</span>
<span id="cb30-619"><a href="#cb30-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-622"><a href="#cb30-622" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb30-623"><a href="#cb30-623" aria-hidden="true" tabindex="-1"></a>top9 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"DXCM"</span>, <span class="st">"AMD"</span>, <span class="st">"URI"</span>, <span class="st">"NFLX"</span>, <span class="st">"NVDA"</span>, <span class="st">"MU"</span>, <span class="st">"FCX"</span>, <span class="st">"ABMD"</span>, <span class="st">"FTNT"</span>)</span>
<span id="cb30-624"><a href="#cb30-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-625"><a href="#cb30-625" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(res <span class="sc">%&gt;%</span> <span class="fu">filter</span>(date <span class="sc">&gt;=</span> <span class="st">"2022-01-01"</span> <span class="sc">&amp;</span> symbol <span class="sc">%in%</span> top9)) <span class="sc">+</span></span>
<span id="cb30-626"><a href="#cb30-626" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>date, <span class="at">y=</span>new_close, <span class="at">group=</span>symbol), <span class="at">size=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb30-627"><a href="#cb30-627" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>date<span class="dv">-3</span>, <span class="at">y=</span>pred), <span class="at">color=</span><span class="st">"red"</span>, <span class="at">size=</span><span class="dv">2</span>, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb30-628"><a href="#cb30-628" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_trans</span>(<span class="at">y=</span><span class="st">"log10"</span>) <span class="sc">+</span></span>
<span id="cb30-629"><a href="#cb30-629" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>symbol) <span class="sc">+</span></span>
<span id="cb30-630"><a href="#cb30-630" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Close"</span>) <span class="sc">+</span></span>
<span id="cb30-631"><a href="#cb30-631" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"2022 Closing Prices</span><span class="sc">\n</span><span class="st">Actual: Black, Predicted: Red"</span>) <span class="sc">+</span></span>
<span id="cb30-632"><a href="#cb30-632" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb30-633"><a href="#cb30-633" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2022, John King</div>   
  </div>
</footer>



</body></html>